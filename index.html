<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <!-- S·ª≠ d·ª•ng dvh v√† fit=cover ƒë·ªÉ t√≠nh to√°n chi·ªÅu cao ch√≠nh x√°c. interactive-widget=resizes-content -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>AI Tutor: v2.0 (Fixed Keyboard UI)</title>
    
    <!-- PWA Setup -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#FEF9C3">
    
    <!-- Placeholder Links for Icons -->
    <link rel="apple-touch-icon" id="apple-icon" href="">
    <link rel="icon" id="fav-icon" type="image/png" href="">
    <link rel="manifest" id="my-manifest-placeholder">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        /* S·ª≠ d·ª•ng dvh cho chi·ªÅu cao ch√≠nh x√°c tr√™n mobile */
        body { 
            font-family: 'Quicksand', sans-serif; 
            background-color: #fdfbf7; 
            height: 100dvh; /* Chi·ªÅu cao ƒë·ªông (Dynamic Viewport Height) */
            overflow: hidden; 
        }
        
        #app-container { height: 100%; display: flex; flex-direction: column; background-color: #fdfbf7; }
        #app { background-color: white; height: 100%; width: 100%; display: flex; flex-direction: column; }
        
        @media (min-width: 768px) {
            #app { max-width: 28rem; margin: 0 auto; border-left: 1px solid #f3f4f6; border-right: 1px solid #f3f4f6; }
        }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #F59E0B; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        
        .tab-active { background-color: #FBBF24; color: #78350F; }
        .tab-inactive { background-color: #F3F4F6; color: #6B7280; }
        .level-card.selected { border-color: #F59E0B; background-color: #FFFBEB; }
        
        @keyframes pop { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .pop-in { animation: pop 0.2s ease-out forwards; }
        
        /* Enhanced Safe Area Padding for Footer text visibility */
        .safe-pb-footer { padding-bottom: calc(var(--sab) + 2rem); }
        .safe-pt { padding-top: calc(var(--sat) + 0.5rem); }

        /* --- SMART KEYBOARD MODE STYLES (v2.0 FIXED) --- */
        
        /* 1. ·∫®n c√°c th√†nh ph·∫ßn kh√¥ng c·∫ßn thi·∫øt tr√™n m√†n h√¨nh Start */
        body.keyboard-mode #logo-container { display: none !important; } 
        body.keyboard-mode #configSection { display: none !important; } 
        body.keyboard-mode #startScreenContent { 
            justify-content: flex-start; /* ƒê·∫©y n·ªôi dung l√™n tr√™n */
            padding-top: 1rem;
        }

        /* 2. ƒêi·ªÅu ch·ªânh khu v·ª±c hi·ªÉn th·ªã c√¢u h·ªèi tr√™n m√†n h√¨nh Game */
        body.keyboard-mode #gameDisplayWrapper {
            flex-grow: 1; /* Cho ph√©p n√≥ co l·∫°i trong kh√¥ng gian h·∫πp */
            min-height: 0; /* Quan tr·ªçng ƒë·ªÉ flex-grow ho·∫°t ƒë·ªông */
            max-height: 45vh; /* Gi·ªõi h·∫°n chi·ªÅu cao t·ªëi ƒëa c·ªßa v√πng c√¢u h·ªèi */
            overflow-y: auto; /* Cho ph√©p cu·ªôn n·∫øu c√¢u h·ªèi qu√° d√†i */
            justify-content: center;
            align-items: center;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }

        body.keyboard-mode #mainDisplay { 
            font-size: 1.5rem; 
            line-height: 1.2;
        }
        body.keyboard-mode #subDisplay { font-size: 0.875rem; padding: 0.1rem 0.4rem; }
        
        /* 3. T·ªëi ∆∞u Input Container */
        body.keyboard-mode #inputContainer { 
            padding-bottom: 0.5rem; 
            margin-top: 0.5rem; 
        }
        body.keyboard-mode #inputContainer #checkBtn {
            margin-bottom: 0 !important;
        }

        /* ƒê·∫£m b·∫£o #gameHeader v√† #mainHeader kh√¥ng b·ªã co */
        #mainHeader, #gameHeader, #progressBarContainer {
            flex-shrink: 0;
        }
        
    </style>
</head>
<body>

    <div id="app-container">
        <div id="app">
            
            <!-- HEADER (LU√îN HI·ªÇN TH·ªä) -->
            <div id="mainHeader" class="px-3 pb-3 pt-[calc(env(safe-area-inset-top)+0.5rem)] bg-yellow-100/90 backdrop-blur-md flex justify-between items-center z-20 shrink-0 border-b border-yellow-200 sticky top-0 transition-all duration-300">
                <div class="flex items-center gap-2">
                    <button onclick="resetGame()" class="w-10 h-10 flex items-center justify-center text-yellow-800 rounded-full hover:bg-yellow-200/50"><i class="fas fa-home text-lg"></i></button>
                    <h1 class="text-lg font-bold text-yellow-800 flex items-center gap-2 cursor-pointer" onclick="resetGame()"><span class="text-2xl">ü•ë</span> AI Tutor</h1>
                </div>
                <div class="flex gap-1">
                    <button onclick="openDictModal()" class="w-10 h-10 flex items-center justify-center text-yellow-800 rounded-full hover:bg-yellow-200/50"><i class="fas fa-search text-lg"></i></button>
                    <button onclick="openTheoryModal()" class="w-10 h-10 flex items-center justify-center text-yellow-800 rounded-full hover:bg-yellow-200/50"><i class="fas fa-book text-lg"></i></button>
                    <button onclick="toggleSettings()" class="w-10 h-10 flex items-center justify-center text-yellow-800 rounded-full hover:bg-yellow-200/50"><i class="fas fa-cog text-lg"></i></button>
                </div>
            </div>
            
            <!-- SETTINGS MODAL -->
            <div id="settingsPanel" class="hidden absolute inset-0 bg-white z-50 flex flex-col animate-fade-in pt-[calc(env(safe-area-inset-top))]">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                    <h2 class="text-lg font-bold text-gray-800">C√†i ƒë·∫∑t</h2>
                    <button onclick="toggleSettings()" class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-6 flex-1 overflow-y-auto safe-pb-footer">
                    <div class="mb-6 p-5 bg-purple-50 rounded-2xl border border-purple-100 shadow-sm">
                        <label class="block text-sm font-bold text-purple-900 mb-2"><i class="fas fa-key"></i> Google Gemini API Key</label>
                        <p class="text-xs text-gray-600 mb-3">Key gi√∫p t·∫°o b√†i t·∫≠p v√¥ h·∫°n v√† gi·∫£i th√≠ch chi ti·∫øt h∆°n.</p>
                        <input type="password" id="userApiKeyInput" placeholder="D√°n API Key..." class="w-full p-3 bg-white border border-purple-200 rounded-xl mb-3 text-sm">
                        <button onclick="saveApiKey()" class="w-full bg-purple-600 text-white font-bold py-3 rounded-xl hover:bg-purple-700">L∆∞u Key</button>
                        <p id="keyStatus" class="text-xs mt-3 text-center font-medium text-gray-400">Ch∆∞a k·∫øt n·ªëi</p>
                    </div>
                </div>
            </div>

            <!-- DICTIONARY MODAL -->
            <div id="dictModal" class="hidden absolute inset-0 bg-white z-50 flex flex-col animate-fade-in pt-[calc(env(safe-area-inset-top))]">
                <div class="p-3 border-b flex justify-between items-center bg-orange-50 shrink-0">
                    <h2 class="text-base font-bold text-orange-900 truncate flex-1"><i class="fas fa-language mr-2"></i>T·ª´ ƒêi·ªÉn</h2>
                    <button onclick="closeDictModal()" class="w-8 h-8 flex items-center justify-center text-orange-400 hover:text-orange-600 bg-white rounded-full"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-4 border-b bg-white shadow-sm">
                    <div class="relative flex items-center">
                        <input type="text" id="dictInput" placeholder="Nh·∫≠p t·ª´..." class="w-full pl-10 pr-12 py-3 bg-gray-100 border-2 border-transparent focus:bg-white focus:border-orange-300 rounded-xl focus:outline-none transition text-gray-800 font-medium">
                        <i class="fas fa-search absolute left-4 text-gray-400"></i>
                        <button onclick="lookupDictionary()" class="absolute right-2 text-orange-500 hover:bg-orange-100 p-2 rounded-lg"><i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-4 custom-scroll bg-gray-50 safe-pb-footer" id="dictResultArea">
                    <div class="flex flex-col items-center justify-center h-64 text-gray-400">
                        <i class="fas fa-spell-check text-4xl mb-3 opacity-50"></i>
                        <p class="text-sm">H·ªá th·ªëng t·ª± ƒë·ªông d·ªãch.</p>
                    </div>
                </div>
            </div>

            <!-- THEORY MODAL -->
            <div id="theoryModal" class="hidden absolute inset-0 bg-white z-50 flex flex-col animate-fade-in pt-[calc(env(safe-area-inset-top))]">
                <div class="p-3 border-b flex justify-between items-center bg-indigo-50 shrink-0">
                    <h2 class="text-base font-bold text-indigo-900 truncate flex-1"><i class="fas fa-graduation-cap mr-2"></i>S·ªï tay Offline</h2>
                    <button onclick="closeTheoryModal()" class="w-8 h-8 flex items-center justify-center text-indigo-400 hover:text-indigo-600 bg-white rounded-full"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex border-b border-gray-100" id="theoryTabs">
                    <button onclick="switchTheoryTab('grammar')" id="btnTheoryGrammar" class="flex-1 py-3 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50/50">12 Th√¨</button>
                    <button onclick="switchTheoryTab('forms')" id="btnTheoryForms" class="flex-1 py-3 text-sm font-bold text-gray-500 hover:text-indigo-600">Bi·∫øn th·ªÉ</button>
                </div>
                <div class="flex-1 overflow-y-auto p-4 custom-scroll bg-gray-50 safe-pb-footer" id="theoryContent">
                    <div id="theoryListGrammar" class="grid grid-cols-1 gap-2"></div>
                    <div id="theoryListForms" class="hidden grid grid-cols-1 gap-2"></div>
                    <div id="theoryDetail" class="hidden h-full flex flex-col">
                        <button onclick="backToTheoryList()" class="inline-flex items-center text-sm font-semibold text-gray-500 mb-4 bg-white px-3 py-2 rounded-lg shadow-sm w-fit"><i class="fas fa-arrow-left mr-2"></i> Quay l·∫°i</button>
                        <div id="theoryDetailContent" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 text-sm leading-relaxed text-gray-800 flex-1 overflow-y-auto custom-scroll"></div>
                    </div>
                </div>
            </div>

            <!-- LOADING -->
            <div id="loadingOverlay" class="hidden absolute inset-0 bg-white/90 z-[60] flex flex-col items-center justify-center backdrop-blur-sm">
                <div class="loader mb-4"></div><p id="loadingText" class="text-gray-600 font-semibold text-sm animate-pulse">ƒêang x·ª≠ l√Ω...</p>
            </div>

            <!-- MAIN CONTENT -->
            <!-- Lo·∫°i b·ªè overflow-y:auto ·ªü ƒë√¢y v√† chuy·ªÉn xu·ªëng gameScreen/startScreen -->
            <div id="mainContent" class="flex-1 flex flex-col p-4 relative">
                
                <!-- START SCREEN -->
                <div id="startScreen" class="flex-1 flex flex-col h-full overflow-y-auto custom-scroll">
                    <!-- Tabs -->
                    <div class="flex bg-gray-100 p-1.5 rounded-2xl mb-4 shrink-0 shadow-inner">
                        <button onclick="setMode('vocab')" id="tabVocab" class="flex-1 py-2 rounded-xl text-xs sm:text-sm font-bold transition tab-active">T·ª´ V·ª±ng</button>
                        <button onclick="setMode('grammar')" id="tabGrammar" class="flex-1 py-2 rounded-xl text-xs sm:text-sm font-bold transition tab-inactive">Ng·ªØ Ph√°p</button>
                        <button onclick="setMode('forms')" id="tabForms" class="flex-1 py-2 rounded-xl text-xs sm:text-sm font-bold transition tab-inactive">Bi·∫øn Th·ªÉ</button>
                    </div>

                    <!-- Center Content -->
                    <div id="startScreenContent" class="flex-1 flex flex-col justify-center min-h-0 w-full max-w-md mx-auto transition-all duration-300">
                        
                        <!-- Input Views -->
                        <div class="mb-4">
                            <div id="viewVocab" class="flex flex-col items-center text-center w-full">
                                <div id="logo-container" class="text-4xl sm:text-5xl mb-4 animate-bounce-slow">ü•ë</div>
                                <h2 class="text-lg sm:text-xl font-bold mb-2 text-gray-800">T·ª´ V·ª±ng</h2>
                                <div class="w-full relative">
                                    <div id="onlineVocabInput" class="w-full"><input type="text" id="vocabTopicInput" placeholder="Ch·ªß ƒë·ªÅ (c·∫ßn Key)..." class="w-full p-4 border-2 border-yellow-100 rounded-2xl focus:outline-none focus:border-yellow-400 text-center shadow-sm"></div>
                                    <div id="offlineVocabSelect" class="w-full hidden"><select id="vocabTopicSelect" class="w-full p-4 border-2 border-gray-200 rounded-2xl bg-white text-base shadow-sm appearance-none text-gray-700 font-medium text-center"></select><div class="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-gray-400"><i class="fas fa-chevron-down"></i></div></div>
                                </div>
                            </div>

                            <div id="viewGrammar" class="hidden flex flex-col items-center text-center w-full">
                                <div id="logo-container" class="text-4xl sm:text-5xl mb-4">üìù</div>
                                <h2 class="text-lg sm:text-xl font-bold mb-2 text-gray-800">Luy·ªán 12 Th√¨</h2>
                                <div class="w-full px-2 relative"><select id="grammarTenseSelect" class="w-full p-4 border-2 border-indigo-100 rounded-2xl bg-white text-base shadow-sm appearance-none text-center"></select><div class="absolute right-6 top-1/2 transform -translate-y-1/2 pointer-events-none text-gray-400"><i class="fas fa-chevron-down"></i></div></div>
                            </div>

                            <div id="viewForms" class="hidden flex flex-col items-center text-center w-full">
                                <div id="logo-container" class="text-4xl sm:text-5xl mb-4">üîÄ</div>
                                <h2 class="text-lg sm:text-xl font-bold mb-2 text-gray-800">Lo·∫°i T·ª´ & Bi·∫øn Th·ªÉ</h2>
                                <div class="w-full px-2 relative"><select id="formsTypeSelect" class="w-full p-4 border-2 border-green-100 rounded-2xl bg-white text-base shadow-sm appearance-none text-gray-700 text-center"></select><div class="absolute right-6 top-1/2 transform -translate-y-1/2 pointer-events-none text-gray-400"><i class="fas fa-chevron-down"></i></div></div>
                            </div>
                        </div>

                        <!-- Config Section -->
                        <div id="configSection" class="w-full mb-4 space-y-4 bg-gray-50 p-3 rounded-xl border border-gray-100">
                            <input type="hidden" id="levelSelect" value="A1-A2">
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Tr√¨nh ƒë·ªô</label>
                                </div>
                                <div class="grid grid-cols-4 gap-1 sm:gap-2">
                                    <div onclick="updateLevel('A1-A2', this)" class="level-card selected cursor-pointer p-2 rounded-lg bg-white border border-transparent text-center">
                                        <div class="text-xl">üå±</div><div class="text-[10px] text-gray-600 font-bold mt-1">D·ªÖ</div>
                                    </div>
                                    <div onclick="updateLevel('B1-B2', this)" class="level-card cursor-pointer p-2 rounded-lg bg-white border border-transparent text-center">
                                        <div class="text-xl">üöÄ</div><div class="text-[10px] text-gray-600 font-bold mt-1">TB</div>
                                    </div>
                                    <div onclick="updateLevel('C1-C2', this)" class="level-card cursor-pointer p-2 rounded-lg bg-white border border-transparent text-center">
                                        <div class="text-xl">üî•</div><div class="text-[10px] text-gray-600 font-bold mt-1">Kh√≥</div>
                                    </div>
                                    <div onclick="updateLevel('IELTS', this)" class="level-card cursor-pointer p-2 rounded-lg bg-white border border-transparent text-center">
                                        <div class="text-xl">üéì</div><div class="text-[10px] text-gray-600 font-bold mt-1">IELTS</div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">S·ªë l∆∞·ª£ng</label>
                                    <span id="qtyDisplay" class="text-[10px] font-bold text-yellow-700 bg-yellow-100 px-2 py-0.5 rounded-full">10 c√¢u</span>
                                </div>
                                <input type="range" id="quantityRange" min="5" max="50" step="5" value="10" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-yellow-400">
                            </div>
                        </div>

                        <button onclick="startGeneration()" id="startBtn" class="w-full bg-yellow-400 text-yellow-900 font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition flex items-center justify-center gap-2 mt-2"><i class="fas fa-play"></i> T·∫°o B√†i T·∫≠p</button>
                    </div>
                    
                    <!-- Footer -->
                    <div class="mt-auto pt-4 text-center shrink-0 safe-pb-footer">
                        <p id="dataSourceText" class="text-[10px] text-gray-400 font-medium bg-gray-50 px-3 py-1 rounded-full inline-block border border-gray-100 shadow-sm">Source: Offline</p>
                    </div>
                </div>

                <!-- GAME SCREEN -->
                <div id="gameScreen" class="hidden flex-1 flex flex-col h-full">
                    <!-- GAME HEADER (Header n√†y n·∫±m trong khu v·ª±c scrollable, d∆∞·ªõi mainHeader) -->
                    <div id="gameHeader" class="flex justify-between items-center mb-3 shrink-0">
                        <span class="font-bold text-gray-500 text-xs uppercase tracking-wider truncate max-w-[60%]" id="gameTitle">B√†i h·ªçc</span>
                        <div class="bg-gray-100 px-2 py-1 rounded-lg text-xs font-mono text-gray-600"><span id="currentQ">1</span>/<span id="totalQ">10</span></div>
                    </div>
                    <div id="progressBarContainer" class="w-full bg-gray-100 rounded-full h-1.5 mb-6 shrink-0"><div id="progressBar" class="bg-yellow-400 h-full rounded-full transition-all duration-300 ease-out" style="width: 10%"></div></div>
                    
                    <!-- Game Display Wrapper (T·ªëi ∆∞u cho Keyboard) -->
                    <div id="gameDisplayWrapper" class="flex-1 flex flex-col justify-center items-center mb-4 min-h-0 transition-all duration-300">
                        <!-- Instruction -->
                        <span id="instructionText" class="text-xs font-semibold text-gray-400 uppercase tracking-widest mb-4 bg-gray-50 px-3 py-1 rounded-full shrink-0">Instruction</span>
                        
                        <!-- Content -->
                        <div class="w-full flex flex-col items-center justify-center py-4 flex-1 min-h-0 overflow-y-hidden">
                            <h2 id="mainDisplay" class="text-3xl sm:text-4xl font-black text-center text-gray-800 mb-2 px-2 leading-tight break-words max-w-full transition-all duration-300">Loading...</h2>
                            <p id="subDisplay" class="text-indigo-500 font-medium text-base hidden bg-indigo-50 px-3 py-1 rounded-lg mt-2 transition-all duration-300 shrink-0">(hint)</p>
                        </div>
                    </div>
                    
                    <!-- Input Area -->
                    <div id="inputContainer" class="mt-auto w-full pb-2 flex flex-col transition-all duration-300 shrink-0">
                        <input type="text" id="answerInput" class="w-full bg-white border-2 border-gray-200 text-center text-xl p-4 rounded-2xl focus:outline-none focus:border-yellow-400 mb-3 transition-all duration-300" placeholder="Nh·∫≠p ƒë√°p √°n..." autocomplete="off">
                        <button id="checkBtn" onclick="checkAnswer()" class="w-full bg-gray-800 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 flex items-center justify-center gap-2"><i class="fas fa-check-circle text-xl mr-2"></i><span>Ki·ªÉm tra</span></button>
                        <div class="h-safe-keyboard hidden"></div>
                    </div>
                </div>

                <!-- FEEDBACK & RESULT -->
                <div id="feedbackOverlay" class="hidden fixed inset-0 z-50 bg-white/95 backdrop-blur-md flex flex-col items-center justify-center text-center p-6 pop-in">
                    <div class="flex-1 flex flex-col items-center justify-center w-full min-h-0 safe-pb-footer">
                        <div id="feedbackIcon" class="text-6xl mb-4">üéâ</div>
                        <h3 id="feedbackTitle" class="text-2xl font-bold mb-6">Ch√≠nh x√°c!</h3>
                        <div class="bg-gray-50 rounded-2xl p-6 w-full max-w-sm mb-6 border border-gray-100 shadow-sm relative overflow-hidden shrink-0">
                             <div class="absolute top-0 left-0 w-1 h-full bg-green-500" id="feedbackBorder"></div>
                             <p class="text-gray-400 text-[10px] uppercase font-bold tracking-widest mb-2">ƒê√ÅP √ÅN ƒê√öNG</p>
                             <div class="flex flex-col items-center justify-center gap-3">
                                 <span id="correctAnswerText" class="text-2xl font-black text-gray-800 break-words w-full">Answer</span>
                                 <button onclick="playTTS()" class="w-12 h-12 rounded-full bg-white border border-gray-200 text-gray-700 flex items-center justify-center shadow-sm active:scale-95 transition mt-2"><i class="fas fa-volume-up text-lg"></i></button>
                             </div>
                             <p id="grammarExplanation" class="text-sm text-indigo-600 mt-4 pt-3 border-t border-gray-200 italic hidden leading-relaxed text-left"></p>
                        </div>
                    </div>
                    <button onclick="nextQuestion()" id="nextBtn" class="w-full bg-yellow-400 text-yellow-900 font-bold py-4 rounded-2xl shadow-lg mt-auto mb-4 shrink-0 safe-pb-footer">Ti·∫øp t·ª•c <i class="fas fa-arrow-right ml-2"></i></button>
                </div>

                <div id="resultScreen" class="hidden flex-1 flex flex-col justify-center items-center text-center h-full safe-pb-footer">
                    <div class="text-6xl mb-4 animate-bounce">üèÜ</div>
                    <h2 class="text-2xl font-bold mb-2 text-gray-800">Ho√†n th√†nh!</h2>
                    <div class="flex items-center gap-2 mb-6 bg-yellow-50 px-4 py-2 rounded-full border border-yellow-100">
                        <span class="text-gray-500 text-sm">ƒêi·ªÉm s·ªë:</span>
                        <div class="flex items-baseline">
                             <span id="finalScore" class="font-black text-yellow-600 text-xl">0</span>
                             <span class="text-gray-400 mx-1 text-sm">/</span>
                             <span id="totalScoreQ" class="font-bold text-gray-500 text-lg">10</span>
                        </div>
                    </div>
                    <div id="resultList" class="w-full flex-1 bg-white rounded-2xl border border-gray-100 mb-6 overflow-y-auto custom-scroll text-left shadow-inner"></div>
                    <button onclick="resetGame()" class="w-full bg-gray-800 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition shrink-0 mb-4"><i class="fas fa-home mr-2"></i> M√†n h√¨nh ch√≠nh</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        (function setupPWAIcon() {
            const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512; const ctx = canvas.getContext('2d');
            const grd = ctx.createLinearGradient(0, 0, 0, 512); grd.addColorStop(0, '#FFFBEB'); grd.addColorStop(1, '#FBBF24');
            ctx.fillStyle = grd; ctx.fillRect(0, 0, 512, 512);
            const img = new Image(); img.crossOrigin = "Anonymous"; img.src = "https://img.icons8.com/color/480/avocado.png";
            img.onload = () => { ctx.drawImage(img, 56, 56, 400, 400); updateManifest(canvas.toDataURL('image/png')); };
            img.onerror = () => { ctx.font = '300px serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('ü•ë', 256, 270); updateManifest(canvas.toDataURL('image/png')); };
            function updateManifest(url) {
                const appleIcon = document.getElementById('apple-icon'); const favIcon = document.getElementById('fav-icon');
                if(appleIcon) appleIcon.href = url; if(favIcon) favIcon.href = url;
                const manifest = { "name": "AI Tutor Pro", "short_name": "AITutor", "start_url": ".", "display": "standalone", "background_color": "#FEF9C3", "theme_color": "#FEF9C3", "icons": [{ "src": url, "sizes": "512x512", "type": "image/png" }] };
                const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
                const manifestEl = document.querySelector('#my-manifest-placeholder'); if (manifestEl) manifestEl.setAttribute('href', URL.createObjectURL(blob));
            }
        })();

        // --- FULL RESTORED DATA ---
        const offlineData = {
            vocab: { "Daily Life": [{vi: "C√† ph√™", en: "coffee"}, {vi: "M√°y t√≠nh", en: "computer"}, {vi: "S√°ch", en: "book"}, {vi: "B√∫t", en: "pen"}, {vi: "Tr∆∞·ªùng h·ªçc", en: "school"}, {vi: "B·∫°n b√®", en: "friend"}, {vi: "Gia ƒë√¨nh", en: "family"}, {vi: "N∆∞·ªõc", en: "water"}, {vi: "Th·ª©c ƒÉn", en: "food"}, {vi: "Ti·ªÅn", en: "money"}, {vi: "C·ª≠a", en: "door"}, {vi: "Gh·∫ø", en: "chair"}, {vi: "B√†n", en: "table"}, {vi: "Th√†nh ph·ªë", en: "city"}, {vi: "C√¥ng vi·ªác", en: "job"}, {vi: "Gi∆∞·ªùng ng·ªß", en: "bed"}, {vi: "B·∫øp", en: "kitchen"}, {vi: "ƒêi·ªán tho·∫°i", en: "phone"}, {vi: "Xe bu√Ωt", en: "bus"}, {vi: "B·ªØa s√°ng", en: "breakfast"}], "Work & Business": [{vi: "Ph√°t tri·ªÉn", en: "develop"}, {vi: "Th√†nh t·ª±u", en: "achievement"}, {vi: "Th·ª≠ th√°ch", en: "challenge"}, {vi: "M√¥i tr∆∞·ªùng", en: "environment"}, {vi: "X√£ h·ªôi", en: "society"}, {vi: "Kinh t·∫ø", en: "economy"}, {vi: "VƒÉn h√≥a", en: "culture"}, {vi: "Gi·∫£i ph√°p", en: "solution"}, {vi: "C∆° h·ªôi", en: "opportunity"}, {vi: "Ki·∫øn th·ª©c", en: "knowledge"}, {vi: "Kinh nghi·ªám", en: "experience"}, {vi: "Quy·∫øt ƒë·ªãnh", en: "decision"}, {vi: "·∫¢nh h∆∞·ªüng", en: "influence"}, {vi: "C√¥ng ngh·ªá", en: "technology"}, {vi: "S√°ng t·∫°o", en: "creative"}, {vi: "Th·ªã tr∆∞·ªùng", en: "market"}, {vi: "Kh√°ch h√†ng", en: "customer"}, {vi: "ƒê·∫ßu t∆∞", en: "investment"}, {vi: "L·ª£i nhu·∫≠n", en: "profit"}, {vi: "Qu·∫£n l√Ω", en: "management"}], "Academic & IELTS": [{vi: "To√†n di·ªán", en: "comprehensive"}, {vi: "ƒê√°ng k·ªÉ", en: "significant"}, {vi: "S√¢u s·∫Øc", en: "profound"}, {vi: "M∆° h·ªì", en: "ambiguous"}, {vi: "T·ªâ m·ªâ", en: "meticulous"}, {vi: "B·ªÅn v·ªØng", en: "sustainable"}, {vi: "Thi·∫øt y·∫øu", en: "indispensable"}, {vi: "L·ªói th·ªùi", en: "obsolete"}, {vi: "Th·ªãnh v∆∞·ª£ng", en: "prosperous"}, {vi: "B·∫•t l·ª£i", en: "detrimental"}, {vi: "Thuy·∫øt ph·ª•c", en: "persuasive"}, {vi: "Nh·∫•t qu√°n", en: "consistent"}, {vi: "Kh√≥ n·∫Øm b·∫Øt", en: "elusive"}, {vi: "Tinh t·∫ø", en: "exquisite"}, {vi: "Ki√™n c∆∞·ªùng", en: "resilient"}, {vi: "Gi·∫£m nh·∫π", en: "mitigate"}, {vi: "L√†m tr·∫ßm tr·ªçng", en: "exacerbate"}, {vi: "Ph·ªï bi·∫øn", en: "prevalent"}, {vi: "B·∫•t b√¨nh ƒë·∫≥ng", en: "inequality"}, {vi: "ƒê√¥ th·ªã h√≥a", en: "urbanization"}], "Travel & Food": [{vi: "H√†nh l√Ω", en: "luggage"}, {vi: "H·ªô chi·∫øu", en: "passport"}, {vi: "ƒê·∫∑t ph√≤ng", en: "reservation"}, {vi: "Th·ª±c ƒë∆°n", en: "menu"}, {vi: "Ngon", en: "delicious"}, {vi: "S√¢n bay", en: "airport"}, {vi: "Kh√°ch s·∫°n", en: "hotel"}, {vi: "B·∫£n ƒë·ªì", en: "map"}, {vi: "Du kh√°ch", en: "tourist"}, {vi: "Chuy·∫øn bay", en: "flight"}, {vi: "ƒê·∫∑c s·∫£n", en: "specialty"}, {vi: "Cay", en: "spicy"}, {vi: "M·∫∑n", en: "salty"}, {vi: "Ng·ªçt", en: "sweet"}, {vi: "Chua", en: "sour"}] },
            grammar: { "Present Simple": [{question: "She usually ___ (walk) to work.", verb: "walk", answer: "walks", explanation: "Th√≥i quen ·ªü hi·ªán t·∫°i (She -> V+s)."}, {question: "The sun ___ (rise) in the East.", verb: "rise", answer: "rises", explanation: "S·ª± th·∫≠t hi·ªÉn nhi√™n."}], "Present Continuous": [{question: "Look! It ___ (rain) outside.", verb: "rain", answer: "is raining", explanation: "ƒêang x·∫£y ra l√∫c n√≥i (Look!)."}, {question: "I ___ (study) now.", verb: "study", answer: "am studying", explanation: "ƒêang di·ªÖn ra (now)."}], "Present Perfect": [{question: "I ___ (see) that movie twice.", verb: "see", answer: "have seen", explanation: "Kinh nghi·ªám trong qu√° kh·ª©."}], "Present Perfect Continuous": [{question: "It ___ (rain) for 3 hours.", verb: "rain", answer: "has been raining", explanation: "Nh·∫•n m·∫°nh qu√° tr√¨nh li√™n t·ª•c."}], "Past Simple": [{question: "I ___ (go) to the cinema yesterday.", verb: "go", answer: "went", explanation: "ƒê√£ x·∫£y ra v√† k·∫øt th√∫c (yesterday)."}], "Past Continuous": [{question: "I ___ (read) when he came.", verb: "read", answer: "was reading", explanation: "ƒêang x·∫£y ra th√¨ h√†nh ƒë·ªông kh√°c xen v√†o."}], "Past Perfect": [{question: "When I arrived, the train ___ (leave).", verb: "leave", answer: "had left", explanation: "X·∫£y ra tr∆∞·ªõc 1 h√†nh ƒë·ªông QK kh√°c."}], "Past Perfect Continuous": [{question: "He was tired because he ___ (work) all day.", verb: "work", answer: "had been working", explanation: "Nguy√™n nh√¢n c·ªßa tr·∫°ng th√°i QK."}], "Future Simple": [{question: "I think it ___ (rain) tomorrow.", verb: "rain", answer: "will rain", explanation: "D·ª± ƒëo√°n kh√¥ng cƒÉn c·ª©."}], "Future Continuous": [{question: "At 9 AM tomorrow, I ___ (work).", verb: "work", answer: "will be working", explanation: "Th·ªùi ƒëi·ªÉm c·ª• th·ªÉ trong TL."}], "Future Perfect": [{question: "By next year, I ___ (graduate).", verb: "graduate", answer: "will have graduated", explanation: "Ho√†n th√†nh tr∆∞·ªõc m·ªëc TL (By)."}], "Future Perfect Continuous": [{question: "By 2030, I ___ (teach) for 20 years.", verb: "teach", answer: "will have been teaching", explanation: "Qu√° tr√¨nh t√≠nh ƒë·∫øn m·ªëc TL."}] },
            forms: { "irregular": [{question: "go (V2)", answer: "went", explanation: "go - went - gone"}, {question: "buy (V2)", answer: "bought", explanation: "buy - bought - bought"}], "irregular_v3": [{question: "go (V3)", answer: "gone", explanation: "go - went - gone"}, {question: "write (V3)", answer: "written", explanation: "write - wrote - written"}], "noun_suffix": [{question: "inform (Noun -tion)", answer: "information", explanation: "Th√™m -ation."}, {question: "develop (Noun -ment)", answer: "development", explanation: "Th√™m -ment."}], "adj_suffix": [{question: "beauty (Adj -ful)", answer: "beautiful", explanation: "y -> i + ful."}, {question: "care (Adj -less)", answer: "careless", explanation: "Th√™m -less."}], "prefixes": [{question: "happy (Prefix: not)", answer: "unhappy", explanation: "Th√™m un-."}, {question: "agree (Prefix: not)", answer: "disagree", explanation: "Th√™m dis-."}], "verb_noun": [{question: "decide (Noun)", answer: "decision", explanation: "de -> sion."}, {question: "arrive (Noun)", answer: "arrival", explanation: "e -> al."}], "noun_adj": [{question: "danger (Adj)", answer: "dangerous", explanation: "+ ous."}, {question: "fame (Adj)", answer: "famous", explanation: "e -> ous."}], "adj_adv": [{question: "quick (Adv)", answer: "quickly", explanation: "+ ly."}, {question: "happy (Adv)", "answer": "happily", explanation: "y -> i + ly."}], "ing": [{question: "run", answer: "running", explanation: "G·∫•p ƒë√¥i ph·ª• √¢m."}, {question: "swim", answer: "swimming", explanation: "G·∫•p ƒë√¥i ph·ª• √¢m."}], "ed": [{question: "stop", answer: "stopped", explanation: "G·∫•p ƒë√¥i ph·ª• √¢m."}, {question: "plan", answer: "planned", explanation: "G·∫•p ƒë√¥i ph·ª• √¢m."}], "classify": [{question: "She runs [fast]. (Type?)", answer: "adverb", explanation: "B·ªï nghƒ©a cho ƒë·ªông t·ª´ runs."}, {question: "It is a [fast] car. (Type?)", answer: "adjective", explanation: "B·ªï nghƒ©a cho danh t·ª´ car."}] },
            theory: {
                "Present Simple": { title: "Th√¨ Hi·ªán T·∫°i ƒê∆°n (Present Simple)", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono"><div class="mb-1"><span class="text-green-600 font-bold">(+)</span> S + V(s/es)</div><div class="mb-1"><span class="text-red-500 font-bold">(-)</span> S + do/does + not + V</div><div><span class="text-blue-500 font-bold">(?)</span> Do/Does + S + V?</div></div><h3 class="font-bold text-indigo-700 mb-2">2. C√°ch d√πng</h3><ul class="list-disc list-inside space-y-1 mb-4 text-gray-700"><li>Di·ªÖn t·∫£ th√≥i quen, h√†nh ƒë·ªông l·∫∑p ƒëi l·∫∑p l·∫°i.</li><li>Di·ªÖn t·∫£ s·ª± th·∫≠t hi·ªÉn nhi√™n.</li><li>L·ªãch tr√¨nh c·ªë ƒë·ªãnh.</li></ul><h3 class="font-bold text-indigo-700 mb-2">3. D·∫•u hi·ªáu</h3><p class="text-gray-700 italic">Always, usually, often, every day...</p>` },
                "Present Continuous": { title: "Th√¨ Hi·ªán T·∫°i Ti·∫øp Di·ªÖn", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono"><div class="mb-1"><span class="text-green-600 font-bold">(+)</span> S + am/is/are + V-ing</div></div><h3 class="font-bold text-indigo-700 mb-2">2. C√°ch d√πng</h3><ul class="list-disc list-inside space-y-1 mb-4 text-gray-700"><li>H√†nh ƒë·ªông ƒëang x·∫£y ra l√∫c n√≥i.</li><li>H√†nh ƒë·ªông ƒëang di·ªÖn ra xung quanh th·ªùi ƒëi·ªÉm n√≥i.</li></ul><h3 class="font-bold text-indigo-700 mb-2">3. D·∫•u hi·ªáu</h3><p class="text-gray-700 italic">Now, at the moment, Look!...</p>` },
                "Present Perfect": { title: "Th√¨ Hi·ªán T·∫°i Ho√†n Th√†nh", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono"><div class="mb-1"><span class="text-green-600 font-bold">(+)</span> S + have/has + V3/ed</div></div><h3 class="font-bold text-indigo-700 mb-2">2. C√°ch d√πng</h3><ul class="list-disc list-inside space-y-1 mb-4 text-gray-700"><li>H√†nh ƒë·ªông b·∫Øt ƒë·∫ßu trong QK k√©o d√†i ƒë·∫øn HT.</li><li>V·ª´a m·ªõi x·∫£y ra.</li><li>Kinh nghi·ªám.</li></ul><h3 class="font-bold text-indigo-700 mb-2">3. D·∫•u hi·ªáu</h3><p class="text-gray-700 italic">Just, recently, since, for, already...</p>` },
                "Present Perfect Continuous": { title: "HT Ho√†n Th√†nh Ti·∫øp Di·ªÖn", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + have/has + been + V-ing</div><p class="text-gray-700">Nh·∫•n m·∫°nh t√≠nh li√™n t·ª•c c·ªßa h√†nh ƒë·ªông t·ª´ QK ƒë·∫øn HT.</p>` },
                "Past Simple": { title: "Th√¨ Qu√° Kh·ª© ƒê∆°n", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + V2/ed</div><p class="text-gray-700">H√†nh ƒë·ªông ƒë√£ k·∫øt th√∫c trong qu√° kh·ª©. <br>DH: Yesterday, last week, ago.</p>` },
                "Past Continuous": { title: "Th√¨ Qu√° Kh·ª© Ti·∫øp Di·ªÖn", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + was/were + V-ing</div><p class="text-gray-700">H√†nh ƒë·ªông ƒëang x·∫£y ra t·∫°i 1 th·ªùi ƒëi·ªÉm trong QK.</p>` },
                "Past Perfect": { title: "Th√¨ Qu√° Kh·ª© Ho√†n Th√†nh", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + had + V3/ed</div><p class="text-gray-700">X·∫£y ra tr∆∞·ªõc m·ªôt h√†nh ƒë·ªông kh√°c trong QK.</p>` },
                "Past Perfect Continuous": { title: "QK Ho√†n Th√†nh Ti·∫øp Di·ªÖn", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + had + been + V-ing</div><p class="text-gray-700">Nh·∫•n m·∫°nh qu√° tr√¨nh x·∫£y ra tr∆∞·ªõc 1 h√†nh ƒë·ªông kh√°c trong QK.</p>` },
                "Future Simple": { title: "Th√¨ T∆∞∆°ng Lai ƒê∆°n", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + will + V</div><p class="text-gray-700">D·ª± ƒëo√°n, quy·∫øt ƒë·ªãnh t·ª©c th·ªùi. <br>DH: Tomorrow, next week.</p>` },
                "Future Continuous": { title: "Th√¨ T∆∞∆°ng Lai Ti·∫øp Di·ªÖn", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + will + be + V-ing</div><p class="text-gray-700">S·∫Ω ƒëang x·∫£y ra t·∫°i 1 th·ªùi ƒëi·ªÉm trong TL.</p>` },
                "Future Perfect": { title: "Th√¨ T∆∞∆°ng Lai Ho√†n Th√†nh", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + will + have + V3/ed</div><p class="text-gray-700">S·∫Ω ho√†n th√†nh tr∆∞·ªõc 1 th·ªùi ƒëi·ªÉm trong TL.</p>` },
                "Future Perfect Continuous": { title: "TL Ho√†n Th√†nh Ti·∫øp Di·ªÖn", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + will + have + been + V-ing</div><p class="text-gray-700">Nh·∫•n m·∫°nh qu√° tr√¨nh t√≠nh ƒë·∫øn 1 th·ªùi ƒëi·ªÉm trong TL.</p>` },
                
                // === RESTORED FORMS DATA ===
                "irregular": { 
                    title: "ƒê·ªông t·ª´ B·∫•t Quy T·∫Øc (V2)", 
                    content: `<p class="mb-2 text-gray-600">ƒê√¢y l√† c√°c ƒë·ªông t·ª´ kh√¥ng tu√¢n theo quy t·∫Øc th√™m -ed khi chuy·ªÉn sang qu√° kh·ª© ƒë∆°n.</p><table class="w-full text-sm text-left border rounded-lg overflow-hidden"><thead><tr class="bg-gray-100"><th class="p-2 border">V1 (Hi·ªán t·∫°i)</th><th class="p-2 border">V2 (Qu√° kh·ª©)</th></tr></thead><tbody><tr><td class="p-2 border">Go</td><td class="p-2 border">Went</td></tr><tr><td class="p-2 border">Buy</td><td class="p-2 border">Bought</td></tr><tr><td class="p-2 border">See</td><td class="p-2 border">Saw</td></tr><tr><td class="p-2 border">Do</td><td class="p-2 border">Did</td></tr><tr><td class="p-2 border">Have</td><td class="p-2 border">Had</td></tr></tbody></table>`
                },
                "irregular_v3": { 
                    title: "Qu√° kh·ª© ph√¢n t·ª´ (V3)", 
                    content: `<p class="mb-2 text-gray-600">D√πng trong c√°c th√¨ Ho√†n th√†nh (Perfect tenses) v√† C√¢u b·ªã ƒë·ªông.</p><table class="w-full text-sm text-left border rounded-lg overflow-hidden"><thead><tr class="bg-gray-100"><th class="p-2 border">V1</th><th class="p-2 border">V2</th><th class="p-2 border text-red-600 font-bold">V3</th></tr></thead><tbody><tr><td class="p-2 border">Go</td><td class="p-2 border">Went</td><td class="p-2 border text-red-600">Gone</td></tr><tr><td class="p-2 border">Eat</td><td class="p-2 border">Ate</td><td class="p-2 border text-red-600">Eaten</td></tr><tr><td class="p-2 border">Write</td><td class="p-2 border">Wrote</td><td class="p-2 border text-red-600">Written</td></tr><tr><td class="p-2 border">Take</td><td class="p-2 border">Took</td><td class="p-2 border text-red-600">Taken</td></tr></tbody></table>` 
                },
                "noun_suffix": {
                    title: "H·∫≠u t·ªë Danh t·ª´ (Noun Suffixes)",
                    content: `<h3 class="font-bold text-indigo-700 mb-2">1. Ch·ªâ ng∆∞·ªùi</h3><ul class="list-disc ml-5 mb-2 text-sm"><li><b>-er/or:</b> teacher, actor, worker</li><li><b>-ist:</b> artist, scientist</li><li><b>-ee:</b> employee, trainee</li></ul><h3 class="font-bold text-indigo-700 mb-2">2. Ch·ªâ v·∫≠t/tr·ª´u t∆∞·ª£ng</h3><ul class="list-disc ml-5 text-sm"><li><b>-tion/sion:</b> information, decision</li><li><b>-ment:</b> development, government</li><li><b>-ness:</b> happiness, sadness</li><li><b>-ity:</b> ability, activity</li></ul>`
                },
                "adj_suffix": {
                    title: "H·∫≠u t·ªë T√≠nh t·ª´ (Adjective Suffixes)",
                    content: `<ul class="list-disc ml-5 text-sm space-y-1"><li><b>-ful (ƒë·∫ßy):</b> helpful, beautiful</li><li><b>-less (kh√¥ng):</b> careless, homeless</li><li><b>-able/ible (c√≥ th·ªÉ):</b> comfortable, visible</li><li><b>-ive:</b> active, creative</li><li><b>-ous:</b> dangerous, famous</li><li><b>-y:</b> sunny, rainy, windy</li><li><b>-al:</b> national, traditional</li></ul>`
                },
                "prefixes": {
                    title: "Ti·ªÅn t·ªë ph·ªï bi·∫øn (Prefixes)",
                    content: `<p class="mb-2 text-sm">Th√™m v√†o tr∆∞·ªõc t·ª´ g·ªëc ƒë·ªÉ ƒë·ªïi nghƒ©a (th∆∞·ªùng l√† nghƒ©a ph·ªß ƒë·ªãnh).</p><ul class="list-disc ml-5 text-sm space-y-1"><li><b>un-:</b> unhappy, unsafe</li><li><b>-im (tr∆∞·ªõc p, m):</b> impossible, impolite</li><li><b>in-:</b> incorrect, informal</li><li><b>dis-:</b> disagree, dislike</li><li><b>re- (l√†m l·∫°i):</b> rewrite, replay</li><li><b>pre- (tr∆∞·ªõc):</b> preview, pretest</li></ul>`
                },
                "verb_noun": {
                    title: "Chuy·ªÉn ƒê·ªông t·ª´ th√†nh Danh t·ª´",
                    content: `<div class="bg-green-50 p-3 rounded mb-2 border border-green-200"><span class="font-bold">Quy t·∫Øc chung:</span> Th√™m h·∫≠u t·ªë danh t·ª´ v√†o ƒë·ªông t·ª´.</div><ul class="text-sm space-y-2"><li><b>Decide</b> (v) -> <b>Decision</b> (n)</li><li><b>Solve</b> (v) -> <b>Solution</b> (n)</li><li><b>Arrive</b> (v) -> <b>Arrival</b> (n)</li><li><b>Perform</b> (v) -> <b>Performance</b> (n)</li></ul>`
                },
                "noun_adj": {
                    title: "Chuy·ªÉn Danh t·ª´ th√†nh T√≠nh t·ª´",
                    content: `<div class="bg-blue-50 p-3 rounded mb-2 border border-blue-200"><span class="font-bold">Quy t·∫Øc:</span> Th√™m h·∫≠u t·ªë t√≠nh t·ª´.</div><ul class="text-sm space-y-2"><li><b>Danger</b> (n) -> <b>Dangerous</b> (adj)</li><li><b>Care</b> (n) -> <b>Careful/Careless</b> (adj)</li><li><b>Nature</b> (n) -> <b>Natural</b> (adj)</li><li><b>Sun</b> (n) -> <b>Sunny</b> (adj)</li></ul>`
                },
                "adj_adv": {
                    title: "T√≠nh t·ª´ & Tr·∫°ng t·ª´",
                    content: `<div class="bg-yellow-50 p-3 rounded mb-2 border border-yellow-200"><span class="font-bold">C√¥ng th·ª©c:</span> Adj + ly = Adv</div><ul class="text-sm space-y-1 mb-2"><li>Quick -> Quickly</li><li>Bad -> Badly</li><li>Happy -> Happily (y -> i + ly)</li></ul><p class="font-bold text-red-500 text-sm">Ngo·∫°i l·ªá:</p><ul class="text-sm"><li>Good -> Well</li><li>Fast -> Fast (gi·ªØ nguy√™n)</li><li>Hard -> Hard</li></ul>`
                },
                "ing": {
                    title: "Quy t·∫Øc th√™m ƒëu√¥i -ING",
                    content: `<ol class="list-decimal ml-5 text-sm space-y-2"><li><b>Th√¥ng th∆∞·ªùng:</b> Th√™m -ing (walk -> walking)</li><li><b>T·∫≠n c√πng l√† e:</b> B·ªè e th√™m ing (write -> writing)</li><li><b>T·∫≠n c√πng l√† ie:</b> ƒê·ªïi ie th√†nh y (lie -> lying)</li><li><b>1 √¢m ti·∫øt, t·∫≠n c√πng 1 ph·ª• √¢m, tr∆∞·ªõc l√† 1 nguy√™n √¢m:</b> G·∫•p ƒë√¥i ph·ª• √¢m (run -> running, sit -> sitting)</li></ol>`
                },
                "ed": {
                    title: "Quy t·∫Øc th√™m ƒëu√¥i -ED",
                    content: `<ol class="list-decimal ml-5 text-sm space-y-2"><li><b>Th√¥ng th∆∞·ªùng:</b> Th√™m -ed (watch -> watched)</li><li><b>T·∫≠n c√πng l√† e:</b> Th√™m d (live -> lived)</li><li><b>T·∫≠n c√πng l√† y (tr∆∞·ªõc l√† ph·ª• √¢m):</b> ƒê·ªïi y th√†nh i + ed (study -> studied)</li><li><b>G·∫•p ƒë√¥i ph·ª• √¢m cu·ªëi:</b> stop -> stopped, plan -> planned</li></ol>`
                },
                "classify": {
                    title: "Ph√¢n lo·∫°i t·ª´ (Word Class)",
                    content: `<div class="space-y-3 text-sm"><div><span class="font-bold text-blue-600">Noun (Danh t·ª´):</span> Ch·ªâ ng∆∞·ªùi, v·∫≠t, n∆°i ch·ªën.<br>V·ªã tr√≠: ƒê·∫ßu c√¢u (Ch·ªß ng·ªØ), sau ƒë·ªông t·ª´ (T√¢n ng·ªØ).</div><div><span class="font-bold text-red-600">Verb (ƒê·ªông t·ª´):</span> Ch·ªâ h√†nh ƒë·ªông, tr·∫°ng th√°i.<br>V·ªã tr√≠: Sau ch·ªß ng·ªØ.</div><div><span class="font-bold text-green-600">Adjective (T√≠nh t·ª´):</span> Ch·ªâ t√≠nh ch·∫•t.<br>V·ªã tr√≠: Tr∆∞·ªõc danh t·ª´, sau tobe.</div><div><span class="font-bold text-purple-600">Adverb (Tr·∫°ng t·ª´):</span> B·ªï nghƒ©a cho ƒë·ªông t·ª´/t√≠nh t·ª´.<br>V·ªã tr√≠: Sau ƒë·ªông t·ª´ th∆∞·ªùng, cu·ªëi c√¢u.</div></div>`
                }
            }
        };

        let gameState = { mode: 'vocab', data: [], currentIdx: 0, score: 0, history: [], currentCorrect: "" };
        let theoryTab = 'grammar';

        const els = {
            app: document.getElementById('app'),
            screens: { start: document.getElementById('startScreen'), game: document.getElementById('gameScreen'), result: document.getElementById('resultScreen') },
            tabs: { vocab: document.getElementById('tabVocab'), grammar: document.getElementById('tabGrammar'), forms: document.getElementById('tabForms') },
            views: { vocab: document.getElementById('viewVocab'), grammar: document.getElementById('viewGrammar'), forms: document.getElementById('viewForms') },
            inputs: { vocabTopic: document.getElementById('vocabTopicInput'), vocabSelect: document.getElementById('vocabTopicSelect'), grammarTense: document.getElementById('grammarTenseSelect'), formsType: document.getElementById('formsTypeSelect'), answer: document.getElementById('answerInput'), apiKey: document.getElementById('userApiKeyInput'), dict: document.getElementById('dictInput') },
            config: { level: document.getElementById('levelSelect'), qtyInput: document.getElementById('quantityRange'), qtyDisplay: document.getElementById('qtyDisplay'), section: document.getElementById('configSection'), startBtn: document.getElementById('startBtn') },
            game: { title: document.getElementById('gameTitle'), qNum: document.getElementById('currentQ'), totalQ: document.getElementById('totalQ'), progress: document.getElementById('progressBar'), display: document.getElementById('mainDisplay'), subDisplay: document.getElementById('subDisplay'), instruction: document.getElementById('instructionText') },
            feedback: { overlay: document.getElementById('feedbackOverlay'), icon: document.getElementById('feedbackIcon'), title: document.getElementById('feedbackTitle'), correctText: document.getElementById('correctAnswerText'), explanation: document.getElementById('grammarExplanation'), border: document.getElementById('feedbackBorder') },
            settings: { panel: document.getElementById('settingsPanel'), keyStatus: document.getElementById('keyStatus') },
            loading: { overlay: document.getElementById('loadingOverlay'), text: document.getElementById('loadingText') },
            status: { text: document.getElementById('dataSourceText') },
            theory: { modal: document.getElementById('theoryModal'), listGrammar: document.getElementById('theoryListGrammar'), listForms: document.getElementById('theoryListForms'), detail: document.getElementById('theoryDetail'), content: document.getElementById('theoryDetailContent'), tabs: { grammar: document.getElementById('btnTheoryGrammar'), forms: document.getElementById('btnTheoryForms') } },
            dict: { modal: document.getElementById('dictModal'), result: document.getElementById('dictResultArea'), input: document.getElementById('dictInput') },
            wrappers: { onlineVocab: document.getElementById('onlineVocabInput'), offlineVocab: document.getElementById('offlineVocabSelect') },
            gameScreen: document.getElementById('gameScreen'),
            gameDisplayWrapper: document.getElementById('gameDisplayWrapper')
        };

        const formReadableNames = { "irregular": "ƒê·ªông t·ª´ B·∫•t quy t·∫Øc (V2)", "irregular_v3": "Qu√° kh·ª© ph√¢n t·ª´ (V3)", "noun_suffix": "H·∫≠u t·ªë Danh t·ª´", "adj_suffix": "H·∫≠u t·ªë T√≠nh t·ª´", "prefixes": "Ti·ªÅn t·ªë (Prefixes)", "verb_noun": "ƒê·ªông t·ª´ ‚Üí Danh t·ª´", "noun_adj": "Danh t·ª´ ‚Üí T√≠nh t·ª´", "adj_adv": "T√≠nh t·ª´ ‚Üí Tr·∫°ng t·ª´", "ing": "Quy t·∫Øc th√™m ƒëu√¥i -ING", "ed": "Quy t·∫Øc th√™m ƒëu√¥i -ED", "classify": "Ph√¢n lo·∫°i t·ª´ (Word Class)" };

        els.inputs.grammarTense.innerHTML = Object.keys(offlineData.grammar).map(t => `<option value="${t}">${t}</option>`).join('');
        els.inputs.vocabSelect.innerHTML = Object.keys(offlineData.vocab).map(t => `<option value="${t}">${t}</option>`).join('');
        els.inputs.formsType.innerHTML = Object.keys(offlineData.forms).map(t => `<option value="${t}">${formReadableNames[t] || t}</option>`).join('');

        const getApiKey = () => localStorage.getItem('vocab_ai_key');
        window.saveApiKey = () => { const key = els.inputs.apiKey.value.trim(); if(key) { localStorage.setItem('vocab_ai_key', key); checkKeyStatus(); alert("ƒê√£ l∆∞u Key!"); } };
        
        const checkKeyStatus = () => {
            const key = getApiKey();
            if(key) {
                els.settings.keyStatus.textContent = "‚úÖ ƒê√£ k·∫øt n·ªëi AI Online"; els.settings.keyStatus.className = "text-xs mt-3 text-center font-bold text-green-600"; els.inputs.apiKey.value = key; els.status.text.textContent = "‚ú® AI Online Mode";
                els.wrappers.onlineVocab.classList.remove('hidden'); els.wrappers.offlineVocab.classList.add('hidden');
            } else {
                els.settings.keyStatus.textContent = "‚ö†Ô∏è Ch·∫ø ƒë·ªô Offline"; els.settings.keyStatus.className = "text-xs mt-3 text-center font-medium text-gray-400"; els.status.text.textContent = "üìÇ Offline Mode";
                els.wrappers.onlineVocab.classList.add('hidden'); els.wrappers.offlineVocab.classList.remove('hidden');
            }
        };
        checkKeyStatus();

        // --- DICTIONARY LOGIC (FREE API) ---
        window.openDictModal = () => { els.dict.modal.classList.remove('hidden'); els.dict.input.focus(); };
        window.closeDictModal = () => els.dict.modal.classList.add('hidden');
        function isVietnamese(str) { return /[√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë]/i.test(str); }
        window.lookupDictionary = async () => {
            const word = els.dict.input.value.trim(); if(!word) return;
            els.dict.result.innerHTML = '<div class="flex flex-col items-center justify-center h-48"><div class="loader mb-2"></div><p class="text-xs text-gray-500">ƒêang tra c·ª©u...</p></div>';
            const key = getApiKey();
            try {
                if (isVietnamese(word)) {
                     const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=vi|en`;
                     const res = await fetch(url); const data = await res.json();
                     if(data.responseStatus === 200) {
                         els.dict.result.innerHTML = `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100"><h2 class="text-xl font-bold text-gray-800 mb-1">${word}</h2><p class="text-sm text-gray-500 mb-3 italic">Ti·∫øng Vi·ªát</p><div class="border-t pt-3"><p class="font-bold text-indigo-600 text-lg">${data.responseData.translatedText}</p><p class="text-sm text-gray-500">Ti·∫øng Anh (D·ªãch t·ª± ƒë·ªông)</p></div></div>`;
                     } else { els.dict.result.innerHTML = `<div class="p-4 text-center text-red-500">Kh√¥ng t√¨m th·∫•y b·∫£n d·ªãch.</div>`; }
                } else {
                    let freeApiData = null; let translation = null;
                    try { const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`); if(res.ok) { const data = await res.json(); freeApiData = data[0]; } } catch(e) {}
                    try { const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=en|vi`; const res = await fetch(url); const data = await res.json(); if(data.responseStatus === 200) translation = data.responseData.translatedText; } catch(e) {}
                    if (!freeApiData && !translation) { els.dict.result.innerHTML = `<div class="text-center p-4 text-red-500">Kh√¥ng t√¨m th·∫•y t·ª´ n√†y.</div>`; return; }
                    let html = `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">`;
                    html += `<div class="flex items-center mb-1"><h2 class="text-3xl font-black text-gray-800 capitalize mr-3">${freeApiData ? freeApiData.word : word}</h2>`;
                    if (freeApiData) { const audioSrc = freeApiData.phonetics.find(p => p.audio)?.audio; if(audioSrc) html += `<button onclick="new Audio('${audioSrc}').play()" class="w-8 h-8 bg-orange-100 text-orange-600 rounded-full inline-flex items-center justify-center hover:bg-orange-200"><i class="fas fa-volume-up"></i></button>`; }
                    html += `</div>`;
                    if(freeApiData) { const phonetic = freeApiData.phonetic || (freeApiData.phonetics.find(p => p.text)?.text) || ""; html += `<p class="text-orange-500 font-mono text-sm mb-4">${phonetic}</p>`; }
                    if(translation) { html += `<div class="mb-4 bg-green-50 p-3 rounded-lg border border-green-100"><p class="text-xs text-green-800 font-bold uppercase tracking-wider mb-1">Nghƒ©a Ti·∫øng Vi·ªát</p><p class="text-lg font-bold text-gray-800">${translation}</p></div>`; }
                    if (freeApiData) { html += `<div class="mb-2"><h3 class="font-bold text-gray-700 border-b pb-1 mb-2">ƒê·ªãnh nghƒ©a (Anh-Anh)</h3><ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">${freeApiData.meanings[0].definitions.slice(0, 3).map(d => `<li>${d.definition}</li>`).join('')}</ul></div>`; }
                    html += `</div>`; els.dict.result.innerHTML = html;
                }
            } catch (e) { els.dict.result.innerHTML = `<div class="text-center p-4 text-red-500">L·ªói: ${e.message}</div>`; }
        };
        els.dict.input.addEventListener('keypress', (e) => { if(e.key === 'Enter') lookupDictionary(); });

        // --- THEORY LOGIC (UPDATED v1.2) ---
        window.openTheoryModal = () => { els.theory.modal.classList.remove('hidden'); switchTheoryTab('grammar'); };
        window.closeTheoryModal = () => els.theory.modal.classList.add('hidden');
        window.switchTheoryTab = (tab) => {
            theoryTab = tab;
            els.theory.tabs.grammar.className = tab==='grammar' ? 'flex-1 py-3 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50/50' : 'flex-1 py-3 text-sm font-bold text-gray-500 hover:text-indigo-600';
            els.theory.tabs.forms.className = tab==='forms' ? 'flex-1 py-3 text-sm font-bold text-green-600 border-b-2 border-green-600 bg-green-50/50' : 'flex-1 py-3 text-sm font-bold text-gray-500 hover:text-green-600';
            els.theory.listGrammar.classList.toggle('hidden', tab !== 'grammar');
            els.theory.listForms.classList.toggle('hidden', tab !== 'forms');
            els.theory.detail.classList.add('hidden');
            const dataSrc = tab === 'grammar' ? offlineData.grammar : offlineData.forms;
            const container = tab === 'grammar' ? els.theory.listGrammar : els.theory.listForms;
            container.innerHTML = Object.keys(dataSrc).map(t => 
                `<div onclick="loadTheory('${t}', '${tab}')" class="p-4 bg-white rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:bg-gray-50 transition-all flex justify-between items-center">
                    <span class="font-bold text-gray-700">${tab === 'forms' ? (formReadableNames[t] || t) : t}</span>
                    <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                </div>`
            ).join('');
        };
        window.backToTheoryList = () => { els.theory.detail.classList.add('hidden'); if(theoryTab === 'grammar') els.theory.listGrammar.classList.remove('hidden'); else els.theory.listForms.classList.remove('hidden'); };
        
        // **UPDATED: loadTheory supports AI Synthesis for Forms**
        window.loadTheory = async (topic, type) => {
            els.theory.listGrammar.classList.add('hidden'); els.theory.listForms.classList.add('hidden'); els.theory.detail.classList.remove('hidden');
            els.theory.content.innerHTML = '<div class="flex flex-col items-center justify-center h-48"><div class="loader mb-2"></div><p class="text-xs text-gray-500">ƒêang t·∫£i ki·∫øn th·ª©c...</p></div>';
            
            const key = getApiKey();
            const friendlyName = formReadableNames[topic] || topic;

            // 1. ONLINE MODE: Call Gemini for Synthesis (Reputable API as requested)
            if (key) {
                try {
                    let prompt = "";
                    if (type === 'forms') {
                         prompt = `T·ªïng h·ª£p ki·∫øn th·ª©c ti·∫øng Anh v·ªÅ ch·ªß ƒë·ªÅ: "${friendlyName}" (Ph·∫ßn: Word Forms/Morphology). Tr√¨nh b√†y r√µ r√†ng b·∫±ng HTML v·ªõi Tailwind CSS. Bao g·ªìm: 1. ƒê·ªãnh nghƒ©a/Quy t·∫Øc. 2. C√°c h·∫≠u t·ªë/ti·ªÅn t·ªë ph·ªï bi·∫øn (n·∫øu c√≥). 3. B·∫£ng v√≠ d·ª• minh h·ªça. 4. L∆∞u √Ω quan tr·ªçng.`;
                    } else {
                         prompt = `Gi·∫£i th√≠ch ng·ªØ ph√°p ti·∫øng Anh ch·ªß ƒë·ªÅ: "${topic}". Tr√¨nh b√†y s·∫°ch ƒë·∫πp b·∫±ng HTML. D√πng Tailwind CSS.`;
                    }
                    
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    const aiContent = data.candidates[0].content.parts[0].text.replace(/```html|```/g, '');
                    els.theory.content.innerHTML = aiContent;
                    return; // Stop here if online successful
                } catch(e) {
                    console.log("Online theory failed, falling back to offline.");
                }
            }
            
            // 2. OFFLINE MODE (Data now available for Forms!)
            const offlineContent = offlineData.theory[topic];
            if (offlineContent) {
                els.theory.content.innerHTML = `<h2 class="text-xl font-bold text-indigo-800 mb-4">${offlineContent.title}</h2>${offlineContent.content}`;
            } else {
                els.theory.content.innerHTML = `<div class="text-center p-5"><h2 class="text-xl font-bold text-indigo-800 mb-4">${friendlyName}</h2><p class="text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu.</p></div>`;
            }
        };

        // --- GAME LOGIC ---
        window.startGeneration = () => {
            let mode = 'vocab';
            if (!els.views.vocab.classList.contains('hidden')) mode = 'vocab'; else if (!els.views.grammar.classList.contains('hidden')) mode = 'grammar'; else if (!els.views.forms.classList.contains('hidden')) mode = 'forms';
            generateContent(mode);
        };
        window.generateContent = async (type) => {
            const key = getApiKey();
            const qty = parseInt(els.config.qtyInput.value);
            const level = els.config.level.value;
            window.showLoading(true);
            gameState.mode = type;
            if(key) {
                try {
                    let prompt = "";
                    let context = "";
                    if (type === 'vocab') { context = els.inputs.vocabTopic.value || "General"; prompt = `Generate ${qty} vocabulary pairs for topic '${context}' at level ${level}. Return STRICT JSON only. No explanations. Format: [{"vi":"Vietnamese Word", "en":"English Word"}]. Content: Word only, no definitions.`; }
                    else if (type === 'grammar') { context = els.inputs.grammarTense.value; prompt = `Generate ${qty} grammar fill-in-blank questions for tense '${context}'. JSON Format: [{"question":"...", "verb":"...", "answer":"...", "explanation":"..."}].`; }
                    else if (type === 'forms') { context = els.inputs.formsType.value; prompt = `Generate ${qty} word-form questions for type '${context}'. JSON Format: [{"question":"...", "answer":"...", "explanation":"..."}].`; }
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt + " JSON ONLY." }] }] }) });
                    const data = await res.json();
                    let text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                    gameState.data = JSON.parse(text);
                    if (type === 'forms') context = formReadableNames[context] || context;
                    els.game.title.textContent = `${type.toUpperCase()}: ${context}`;
                    startGame(); window.showLoading(false); return;
                } catch(e) { console.error(e); }
            }
            let source = []; let displayTitle = "";
            if(type === 'vocab') { displayTitle = els.inputs.vocabSelect.value; source = offlineData.vocab[displayTitle] || []; }
            if(type === 'grammar') { displayTitle = els.inputs.grammarTense.value; source = offlineData.grammar[displayTitle] || []; }
            if(type === 'forms') { const rawType = els.inputs.formsType.value; displayTitle = formReadableNames[rawType] || rawType; source = offlineData.forms[rawType] || []; }
            if(!source.length) { alert("D·ªØ li·ªáu offline kh√¥ng c√≥ s·∫µn."); window.showLoading(false); return; }
            let finalData = []; while(finalData.length < qty) { finalData = finalData.concat([...source].sort(()=>0.5-Math.random())); }
            gameState.data = finalData.slice(0, qty); els.game.title.textContent = displayTitle; startGame(); window.showLoading(false);
        };
        window.startGame = () => { gameState.currentIdx = 0; gameState.score = 0; gameState.history = []; els.game.totalQ.textContent = gameState.data.length; switchScreen('game'); updateUI(); };
        window.checkAnswer = () => { 
            const user = els.inputs.answer.value.trim().toLowerCase(); if(!user) return;
            if (gameState.currentIdx >= gameState.data.length) return;
            const item = gameState.data[gameState.currentIdx];
            if (!item) return;

            const correct = gameState.currentCorrect.toLowerCase(); const isCorrect = user === correct;
            gameState.history.push({ q: els.game.display.textContent, a: gameState.currentCorrect, u: els.inputs.answer.value, ok: isCorrect });
            if(isCorrect) gameState.score++;
            els.feedback.title.textContent = isCorrect ? "Ch√≠nh x√°c!" : "Sai r·ªìi!"; els.feedback.title.className = isCorrect ? "text-2xl font-bold mb-6 text-green-600" : "text-2xl font-bold mb-6 text-red-500";
            els.feedback.correctText.textContent = gameState.currentCorrect; els.feedback.explanation.textContent = item.explanation ? "üí° " + item.explanation : "";
            els.feedback.overlay.classList.remove('hidden');
        };
        window.nextQuestion = () => { 
            els.feedback.overlay.classList.add('hidden'); 
            gameState.currentIdx++; 
            if(gameState.currentIdx >= gameState.data.length) {
                finishGame();
            } else {
                updateUI(); 
                if (isKeyboardVisible) {
                    // Kh√¥ng c·∫ßn updateMinimalHeader v√¨ ƒë√£ x√≥a n√≥
                }
            }
        };
        function updateUI() {
            const item = gameState.data[gameState.currentIdx]; els.game.qNum.textContent = gameState.currentIdx + 1; els.game.progress.style.width = `${((gameState.currentIdx + 1) / gameState.data.length) * 100}%`; els.inputs.answer.value = ""; els.inputs.answer.focus();
            if(gameState.mode === 'vocab') { els.game.display.textContent = item.vi; els.game.instruction.textContent = "D·ªãch sang Ti·∫øng Anh"; els.game.subDisplay.classList.add('hidden'); gameState.currentCorrect = item.en; }
            else if (gameState.mode === 'grammar') { els.game.display.textContent = item.question; els.game.instruction.textContent = "Chia ƒë·ªông t·ª´"; els.game.subDisplay.textContent = item.verb ? `Verb: (${item.verb})` : ""; els.game.subDisplay.classList.remove('hidden'); gameState.currentCorrect = item.answer; }
            else if (gameState.mode === 'forms') { els.game.display.textContent = item.question; els.game.instruction.textContent = "ƒêi·ªÅn d·∫°ng ƒë√∫ng"; els.game.subDisplay.classList.add('hidden'); gameState.currentCorrect = item.answer; }
        }
        function finishGame() {
            document.getElementById('finalScore').textContent = gameState.score; 
            const totalEl = document.getElementById('totalScoreQ');
            if(totalEl) totalEl.textContent = gameState.data.length;
            document.getElementById('resultList').innerHTML = gameState.history.map(h => `<div class="p-3 border-b border-gray-100 flex gap-2"><span>${h.ok?'‚úÖ':'‚ùå'}</span><div class="flex-1"><div class="text-xs text-gray-500">${h.q}</div><div class="font-bold text-green-600">${h.a}</div>${!h.ok ? `<div class="text-sm line-through text-red-300">${h.u}</div>` : ''}</div></div>`).join('');
            switchScreen('result');
        }
        window.playTTS = () => { const u = new SpeechSynthesisUtterance(gameState.currentCorrect); u.lang = 'en-US'; speechSynthesis.speak(u); };
        window.setMode = (m) => { ['vocab', 'grammar', 'forms'].forEach(x => { els.tabs[x].className = `flex-1 py-2 rounded-xl text-xs sm:text-sm font-bold transition ${x===m ? 'tab-active' : 'tab-inactive bg-transparent'}`; els.views[x].classList.toggle('hidden', x !== m); }); els.config.section.classList.remove('hidden'); };
        window.resetGame = () => {
             // ƒê·∫£m b·∫£o tho√°t kh·ªèi keyboard mode khi v·ªÅ m√†n h√¨nh ch√≠nh
             exitKeyboardMode();
             switchScreen('start');
        };
        window.switchScreen = (s) => { 
            Object.values(els.screens).forEach(e => e.classList.add('hidden')); 
            els.screens[s].classList.remove('hidden'); 
            
            // N·∫øu chuy·ªÉn sang m√†n h√¨nh Game, ƒë·∫£m b·∫£o c√°c ph·∫ßn t·ª≠ game chi·∫øm ƒë√∫ng kh√¥ng gian
            if (s === 'game') {
                // ƒê·∫∑t l·∫°i display wrapper v·ªÅ ch·∫ø ƒë·ªô m·∫∑c ƒë·ªãnh (flex-grow: 1)
                els.gameDisplayWrapper.classList.remove('flex-grow-0', 'max-h-[40dvh]', 'justify-center', 'items-center', 'padding-top-0_5', 'padding-bottom-0_5', 'overflow-y-auto');
                els.gameDisplayWrapper.classList.add('flex-1', 'justify-center', 'items-center', 'mb-4');
            } else {
                 // ƒê·∫£m b·∫£o kh√¥ng ·ªü keyboard mode khi kh√¥ng ph·∫£i m√†n h√¨nh input
                 exitKeyboardMode();
            }
        };
        window.showLoading = (b) => els.loading.overlay.classList.toggle('hidden', !b);
        window.toggleSettings = () => els.settings.panel.classList.toggle('hidden');
        window.updateLevel = (val, el) => { document.getElementById('levelSelect').value = val; document.querySelectorAll('.level-card').forEach(c => { c.classList.remove('selected', 'bg-yellow-50', 'border-yellow-400'); c.classList.add('bg-gray-50', 'border-transparent'); }); el.classList.add('selected'); };
        els.inputs.answer.addEventListener('keypress', (e) => { if(e.key === 'Enter') checkAnswer(); });
        els.config.qtyInput.addEventListener('input', (e) => { els.config.qtyDisplay.textContent = `${e.target.value} c√¢u`; });

        // --- KEYBOARD HANDLING V2.0 FIXED ---
        let isKeyboardVisible = false;
        
        const enterKeyboardMode = (event) => {
            if (event && event.target.tagName !== 'INPUT' && event.target.tagName !== 'TEXTAREA' && event.target.id !== 'vocabTopicInput' && event.target.id !== 'dictInput') return;
            isKeyboardVisible = true;
            document.body.classList.add('keyboard-mode');
            
            // √Åp d·ª•ng t·ªëi ∆∞u UI khi keyboard hi·ªán
            if (!els.screens.game.classList.contains('hidden')) {
                // Ch·∫ø ƒë·ªô t·ªëi gi·∫£n cho Game Display Wrapper: co l·∫°i v√† cho ph√©p cu·ªôn
                els.gameDisplayWrapper.classList.remove('flex-1', 'justify-center', 'items-center', 'mb-4');
                els.gameDisplayWrapper.classList.add('flex-grow-0', 'max-h-[40dvh]', 'justify-start', 'items-center', 'overflow-y-auto');
            } else if (!els.screens.start.classList.contains('hidden')) {
                // T·ªëi ∆∞u m√†n h√¨nh Start
                 document.getElementById('startScreenContent').classList.add('justify-content-flex-start');
            }
        };

        const exitKeyboardMode = () => {
            isKeyboardVisible = false;
            document.body.classList.remove('keyboard-mode');
            
            // Kh√¥i ph·ª•c UI v·ªÅ tr·∫°ng th√°i b√¨nh th∆∞·ªùng
            if (!els.screens.game.classList.contains('hidden')) {
                els.gameDisplayWrapper.classList.remove('flex-grow-0', 'max-h-[40dvh]', 'justify-start', 'items-center', 'overflow-y-auto');
                els.gameDisplayWrapper.classList.add('flex-1', 'justify-center', 'items-center', 'mb-4');
            } else if (!els.screens.start.classList.contains('hidden')) {
                document.getElementById('startScreenContent').classList.remove('justify-content-flex-start');
            }
        };

        // G·∫Øn s·ª± ki·ªán focus/blur cho t·∫•t c·∫£ c√°c input c·∫ßn k√≠ch ho·∫°t ch·∫ø ƒë·ªô t·ªëi gi·∫£n
        els.inputs.answer.addEventListener('focus', enterKeyboardMode);
        els.inputs.answer.addEventListener('blur', exitKeyboardMode);
        els.inputs.dict.addEventListener('focus', enterKeyboardMode);
        els.inputs.dict.addEventListener('blur', exitKeyboardMode);
        els.inputs.vocabTopic.addEventListener('focus', enterKeyboardMode);
        els.inputs.vocabTopic.addEventListener('blur', exitKeyboardMode);
        
        setMode('vocab');
    </script>
</body>
</html>
