<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <!-- interactive-widget=resizes-content: H·ªó tr·ª£ Android/iOS resize v√πng nh√¨n -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>AI Tutor: Ultimate Full Version (v2.9.8)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --app-height: 100%;
        }

        html {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #f3f4f6;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 24px 24px;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            overscroll-behavior: none;
            touch-action: none;
        }

        #app-container {
            width: 100%;
            height: var(--app-height);
            display: flex;
            flex-direction: column;
            background-color: #f8fafc;
            position: absolute;
            top: 0; left: 0;
            overflow: hidden;
            transition: height 0.1s ease-out;
        }

        @media (min-width: 768px) {
            body {
                position: relative;
                height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                touch-action: auto;
            }
            #app-container {
                position: relative;
                height: 90vh !important;
                max-height: 850px;
                max-width: 1024px;
                border-radius: 24px;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
                border: 1px solid rgba(255,255,255,0.8);
            }
        }

        .viewport-scroll-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            display: flex;
            flex-direction: column;
        }

        /* --- SCROLLBAR CUSTOMIZATION --- */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes popIn { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .shake-element { animation: shake 0.4s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }

        .hover-lift { transition: transform 0.2s; }

        /* --- LEVEL CHIPS STYLE --- */
        .level-chip {
            border: 1px solid #E2E8F0;
            background-color: #FFFFFF;
            color: #64748B;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        /* Active State */
        .level-chip.active {
            background-color: #4F46E5; /* Indigo 600 */
            border-color: #4F46E5;
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25);
            transform: translateY(-1px);
        }

        .level-chip.active .level-desc { color: rgba(255,255,255,0.8); }
        .level-chip:active { transform: scale(0.98); }

        .mode-card { border: 1px solid #f1f5f9; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
        .mode-card.active { border-color: #F59E0B; background-color: #fffbeb; ring: 2px solid #fcd34d; ring-opacity: 0.5; }

        /* --- ENHANCED CHAT BUBBLES --- */
        .chat-bubble {
            max-width: 85%; /* Gi·∫£m max-width ƒë·ªÉ tr√¥ng g·ªçn h∆°n tr√™n mobile */
            width: fit-content; /* Quan tr·ªçng: Ch·ªâ chi·∫øm ƒë·ªô r·ªông v·ª´a ƒë·ªß n·ªôi dung */
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            word-wrap: break-word; /* ƒê·∫£m b·∫£o t·ª´ d√†i xu·ªëng d√≤ng */
            overflow-wrap: break-word;
            position: relative;
            animation: slideInBubble 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideInBubble {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .chat-bubble.ai {
            align-self: flex-start; /* CƒÉn tr√°i trong Flex container */
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            color: #334155;
            border-bottom-left-radius: 4px;
            margin-right: auto; /* ƒê·∫©y sang tr√°i */
        }

        .chat-bubble.user {
            align-self: flex-end; /* CƒÉn ph·∫£i trong Flex container */
            background-color: #4f46e5;
            color: white;
            border-bottom-right-radius: 4px;
            margin-left: auto; /* ƒê·∫©y sang ph·∫£i */
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
        }

        .word-chip { cursor: pointer; user-select: none; transition: all 0.2s; }
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .mobile-compact-input { padding: 0.75rem 1rem !important; font-size: 1rem !important; }

        /* --- MODAL STYLES --- */
        .custom-modal-overlay {
            position: absolute; inset: 0; z-index: 50;
            background-color: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            padding: 1rem;
        }

        .custom-modal-container {
            background-color: white;
            display: flex; flex-direction: column;
            overflow: hidden; transition: all 0.2s;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            width: 100%; height: 100%; border-radius: 0;
        }

        @media (min-width: 768px) {
            .custom-modal-container {
                border-radius: 24px; width: auto; min-width: 450px; max-width: 900px; height: auto; max-height: 85vh;
            }
            .modal-type-dict { width: 500px; height: 600px; }
            .modal-type-topic { width: 800px; height: 600px; }
            .modal-type-theory { width: 950px; height: 80vh; }
        }

        .modal-header {
            flex-shrink: 0;
            display: flex; align-items: center; justify-content: space-between;
            padding: 1rem;
            background-color: white;
            border-bottom: 1px solid #f1f5f9;
        }

        .modal-body-scroll {
            flex: 1; overflow-y: auto; overscroll-behavior: contain;
        }
    </style>
</head>
<body>
    <canvas id="confetti-canvas"></canvas>

    <!-- APP CONTAINER -->
    <div id="app-container">

        <!-- HEADER -->
        <div id="mainHeader" class="px-4 py-3 md:py-4 bg-white/95 backdrop-blur-md border-b border-gray-100 flex justify-between items-center z-50 shrink-0 shadow-sm transition-transform duration-200">
            <div class="flex items-center gap-3">
                <button onclick="resetGame()" class="w-10 h-10 rounded-xl bg-gray-50 text-gray-400 hover:bg-white hover:text-indigo-600 flex items-center justify-center transition-all border border-transparent hover:border-gray-100 active:scale-90">
                    <i class="fas fa-home"></i>
                </button>
                <div class="cursor-pointer" onclick="resetGame()">
                    <h1 class="text-lg md:text-xl font-extrabold text-slate-800 tracking-tight flex items-center gap-2">
                        <span>ü•ë</span>
                        <div class="flex flex-col leading-none">
                            <span>AI Tutor</span>
                            <!-- COPYRIGHT HEADER -->
                            <span class="text-[9px] text-gray-400 font-semibold tracking-wider mt-0.5 hover:text-indigo-500 transition-colors select-none">¬© nguyenbachtoan</span>
                        </div>
                        <span class="bg-indigo-100 text-indigo-700 text-[9px] px-1.5 py-0.5 rounded-md font-bold ml-1 self-start">v2.9.8</span>
                    </h1>
                </div>
            </div>

            <div class="flex items-center gap-2 md:gap-3">
                <div class="hidden sm:flex bg-orange-50 border border-orange-100 px-3 py-1.5 rounded-full items-center gap-2 shadow-sm">
                    <i class="fas fa-fire text-orange-500 text-sm"></i>
                    <span id="streakCount" class="font-black text-orange-600 text-sm">0</span>
                </div>
                <button onclick="openTheoryModal()" class="w-10 h-10 rounded-xl bg-gray-50 hover:bg-white text-gray-500 hover:text-indigo-600 flex items-center justify-center transition-all active:scale-90" title="S·ªï tay ki·∫øn th·ª©c"><i class="fas fa-graduation-cap"></i></button>
                <button onclick="openDictModal()" class="w-10 h-10 rounded-xl bg-gray-50 hover:bg-white text-gray-500 hover:text-indigo-600 flex items-center justify-center transition-all active:scale-90" title="T·ª´ ƒëi·ªÉn"><i class="fas fa-search"></i></button>
                <button onclick="toggleSettings()" class="w-10 h-10 rounded-full hover:bg-gray-100 text-gray-400 hover:text-gray-600 flex items-center justify-center transition-all active:scale-90"><i class="fas fa-cog"></i></button>
            </div>
        </div>

        <!-- MAIN CONTENT AREA -->
        <div id="mainContent" class="viewport-scroll-content relative bg-[#F8FAFC]">

            <!-- 1. START SCREEN -->
            <div id="startScreen" class="absolute inset-0 overflow-y-auto p-4 md:p-8 w-full h-full">
                <div class="max-w-4xl mx-auto pb-20">

                    <!-- Config & Topic Block -->
                    <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Topic Selector -->
                        <button onclick="openTopicModal()" class="w-full bg-white border border-gray-200 p-5 rounded-2xl shadow-sm text-left relative overflow-hidden active:scale-98 transition-transform">
                            <div class="absolute right-0 bottom-0 w-24 h-24 bg-yellow-100 rounded-tl-full -mr-6 -mb-6 opacity-50"></div>
                            <div class="relative z-10 flex items-center justify-between">
                                <div>
                                    <p class="text-[10px] font-bold text-yellow-600 uppercase tracking-widest mb-1">TH∆Ø VI·ªÜN</p>
                                    <h3 class="font-black text-lg text-gray-800">Ch·ªçn Ch·ªß ƒê·ªÅ</h3>
                                    <p class="text-xs text-gray-400 mt-1 font-medium">H∆°n 50+ ch·ªß ƒë·ªÅ th√¥ng d·ª•ng</p>
                                </div>
                                <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600 shadow-sm"><i class="fas fa-book"></i></div>
                            </div>
                        </button>

                         <!-- Config Box -->
                         <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100/50">
                            <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fas fa-sliders-h"></i> C·∫§U H√åNH</h4>
                            <div class="mb-4">
                                <input type="hidden" id="levelSelect" value="Level A">

                                <!-- === NEW GRID LEVEL SELECTOR (CLEAN) === -->
                                <div class="flex flex-col gap-2">
                                    <!-- Row 1: General Levels -->
                                    <div class="grid grid-cols-3 gap-2">
                                        <div onclick="updateLevel('Level A', this)" class="level-chip active p-2 rounded-xl text-center flex flex-col items-center justify-center min-h-[70px]">
                                            <span class="text-xl mb-0.5">üå±</span>
                                            <span class="font-bold text-[10px] uppercase">C∆° b·∫£n</span>
                                            <span class="text-[9px] level-desc opacity-70">A1-A2</span>
                                        </div>
                                        <div onclick="updateLevel('Level B', this)" class="level-chip p-2 rounded-xl text-center flex flex-col items-center justify-center min-h-[70px]">
                                            <span class="text-xl mb-0.5">üåø</span>
                                            <span class="font-bold text-[10px] uppercase">Trung c·∫•p</span>
                                            <span class="text-[9px] level-desc opacity-70">B1-B2</span>
                                        </div>
                                        <div onclick="updateLevel('Level C', this)" class="level-chip p-2 rounded-xl text-center flex flex-col items-center justify-center min-h-[70px]">
                                            <span class="text-xl mb-0.5">üå≥</span>
                                            <span class="font-bold text-[10px] uppercase">Cao c·∫•p</span>
                                            <span class="text-[9px] level-desc opacity-70">C1+</span>
                                        </div>
                                    </div>
                                    <!-- Row 2: Certificates -->
                                    <div class="grid grid-cols-2 gap-2">
                                        <div onclick="updateLevel('Level TOEIC', this)" class="level-chip px-3 py-2 rounded-xl flex items-center justify-center gap-2">
                                            <span class="text-lg">üéØ</span>
                                            <div class="text-left">
                                                <div class="font-bold text-[10px] uppercase">TOEIC</div>
                                                <div class="text-[9px] level-desc opacity-70">500-900</div>
                                            </div>
                                        </div>
                                        <div onclick="updateLevel('Level IELTS', this)" class="level-chip px-3 py-2 rounded-xl flex items-center justify-center gap-2">
                                            <span class="text-lg">üéì</span>
                                            <div class="text-left">
                                                <div class="font-bold text-[10px] uppercase">IELTS</div>
                                                <div class="text-[9px] level-desc opacity-70">5.0-8.0</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- === END NEW GRID LEVEL === -->

                            </div>
                            <div class="pt-2 border-t border-gray-50">
                                <div class="flex justify-between mb-1"><span class="text-[10px] font-bold text-gray-400 uppercase">S·ªë c√¢u h·ªèi</span><span id="qtyDisplay" class="bg-gray-900 text-white text-[10px] font-bold px-1.5 py-0.5 rounded">10</span></div>
                                <input type="range" id="quantityRange" min="5" max="30" step="5" value="10" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                            </div>
                        </div>
                    </div>

                    <!-- Pinned Topic Banner -->
                    <div id="activeTopicBanner" class="hidden mb-6 bg-indigo-600 text-white p-4 rounded-2xl shadow-lg flex items-center justify-between">
                         <div class="flex items-center gap-3"><div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center"><i class="fas fa-thumbtack text-xs"></i></div><div class="min-w-0"><p class="text-[9px] font-bold text-indigo-200 uppercase tracking-widest">ƒêANG GHIM</p><h3 id="activeTopicName" class="font-black text-base truncate">Topic</h3></div></div>
                         <button onclick="clearTopic()" class="bg-indigo-500 text-white px-3 py-1.5 rounded-lg font-bold text-[10px] border border-indigo-400 whitespace-nowrap">Tho√°t</button>
                    </div>

                    <!-- Modes Grid -->
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-6" id="modeGrid">
                         <div onclick="setMode('roleplay')" id="mode-roleplay" class="mode-card col-span-2 sm:col-span-3 bg-white p-5 rounded-2xl shadow-sm hover:shadow-md active h-auto">
                            <div class="absolute right-0 top-0 px-2 py-0.5 bg-purple-600 text-white text-[9px] font-bold rounded-bl-lg z-10">HOT</div>
                            <div class="flex items-center gap-4 relative z-10">
                                <div class="w-12 h-12 rounded-2xl bg-purple-50 text-purple-600 flex items-center justify-center text-xl border border-purple-100"><i class="fas fa-comments"></i></div>
                                <div class="flex-1"><h3 class="text-base font-black text-gray-800">Th·ª±c Chi·∫øn AI</h3><p class="text-xs text-gray-500 font-medium mt-0.5">Chat h·ªôi tho·∫°i nh·∫≠p vai v·ªõi AI.</p></div>
                            </div>
                         </div>
                         <div onclick="setMode('vocab')" id="mode-vocab" class="mode-card bg-white p-4 rounded-2xl shadow-sm flex flex-col items-center text-center gap-2 hover-lift"><div class="w-10 h-10 rounded-xl bg-yellow-50 text-yellow-600 flex items-center justify-center text-lg"><i class="fas fa-font"></i></div><div><h3 class="font-bold text-gray-700 text-sm">T·ª´ V·ª±ng</h3><p class="text-[10px] text-gray-400 font-bold">Word Matching</p></div></div>
                         <div onclick="setMode('scramble')" id="mode-scramble" class="mode-card bg-white p-4 rounded-2xl shadow-sm flex flex-col items-center text-center gap-2 hover-lift"><div class="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center text-lg"><i class="fas fa-sort-amount-down"></i></div><div><h3 class="font-bold text-gray-700 text-sm">X·∫øp C√¢u</h3><p class="text-[10px] text-gray-400 font-bold">Unscramble</p></div></div>
                         <div onclick="setMode('listening')" id="mode-listening" class="mode-card bg-white p-4 rounded-2xl shadow-sm flex flex-col items-center text-center gap-2 hover-lift"><div class="w-10 h-10 rounded-xl bg-pink-50 text-pink-600 flex items-center justify-center text-lg"><i class="fas fa-headphones"></i></div><div><h3 class="font-bold text-gray-700 text-sm">Nghe Ch√©p</h3><p class="text-[10px] text-gray-400 font-bold">Dictation</p></div></div>
                         <div onclick="setMode('grammar')" id="mode-grammar" class="mode-card bg-white p-4 rounded-2xl shadow-sm flex flex-col items-center text-center gap-2 hover-lift"><div class="w-10 h-10 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center text-lg"><i class="fas fa-pen-nib"></i></div><div><h3 class="font-bold text-gray-700 text-sm">Ng·ªØ Ph√°p</h3><p class="text-[10px] text-gray-400 font-bold">Tenses</p></div></div>
                         <div onclick="setMode('idioms')" id="mode-idioms" class="mode-card bg-white p-4 rounded-2xl shadow-sm flex flex-col items-center text-center gap-2 hover-lift"><div class="w-10 h-10 rounded-xl bg-red-50 text-red-600 flex items-center justify-center text-lg"><i class="fas fa-dragon"></i></div><div><h3 class="font-bold text-gray-700 text-sm">Th√†nh Ng·ªØ</h3><p class="text-[10px] text-gray-400 font-bold">Idioms</p></div></div>
                    </div>

                    <!-- Start Input Area -->
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm sticky bottom-0 z-20">
                         <div id="inputAreaWrapper" class="space-y-3 mb-4">
                             <div id="sharedInputArea" class="w-full">
                                 <input type="text" id="vocabTopicInput" placeholder="VD: Marketing, Football..." class="mobile-compact-input w-full bg-gray-50 border border-gray-200 rounded-xl font-bold text-gray-800 focus:bg-white focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all outline-none shadow-inner" onkeypress="if(event.key==='Enter') startGeneration()">
                             </div>
                             <div id="viewReading" class="hidden"><div class="relative"><select id="readingTopicSelect" class="mobile-compact-input w-full bg-gray-50 border border-gray-200 rounded-xl font-bold appearance-none outline-none focus:border-indigo-400"></select><i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-xs"></i></div></div>
                             <div id="viewGrammar" class="hidden"><div class="relative"><select id="grammarTenseSelect" class="mobile-compact-input w-full bg-gray-50 border border-gray-200 rounded-xl font-bold appearance-none outline-none focus:border-indigo-400"></select><i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-xs"></i></div></div>
                             <div id="viewForms" class="hidden"><div class="relative"><select id="formsTypeSelect" class="mobile-compact-input w-full bg-gray-50 border border-gray-200 rounded-xl font-bold appearance-none outline-none focus:border-indigo-400"></select><i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-xs"></i></div></div>
                         </div>
                         <button onclick="startGeneration()" id="startBtn" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold text-base py-4 rounded-xl shadow-lg shadow-slate-200 active:scale-95 transition-all flex items-center justify-center gap-3"><span>B·∫ÆT ƒê·∫¶U</span> <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- 2. GAME SCREEN -->
            <div id="gameScreen" class="hidden absolute inset-0 w-full h-full flex flex-col bg-slate-50">
                <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between bg-white z-20 shrink-0 shadow-sm">
                    <div class="flex flex-col min-w-[70px]">
                        <span class="text-[9px] font-bold text-gray-400 tracking-widest truncate max-w-[120px] uppercase" id="gameTitle">GENERAL</span>
                        <div id="gameHeaderStats" class="flex items-center gap-1 mt-0.5">
                            <span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded text-[10px] font-bold border border-slate-200"><span id="currentQ" class="text-slate-800">1</span>/<span id="totalQ">10</span></span>
                        </div>
                    </div>
                    <div class="flex-1 mx-4 max-w-md hidden sm:block" id="progressBarContainer">
                         <div class="h-2 bg-gray-100 rounded-full overflow-hidden border border-gray-100"><div id="progressBar" class="h-full bg-yellow-400 rounded-full transition-all duration-500 shadow-[0_0_10px_rgba(250,204,21,0.5)]" style="width: 0%"></div></div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div id="comboBadge" class="hidden bg-gradient-to-r from-orange-500 to-red-500 text-white px-2 py-0.5 rounded-full text-[10px] font-black shadow-lg animate-popIn"><i class="fas fa-fire mr-0.5"></i> <span id="comboCountText">x2</span></div>
                        <button id="endChatBtn" onclick="finishGame()" class="hidden bg-white border border-red-100 text-red-500 px-3 py-1.5 rounded-lg text-[10px] font-bold hover:bg-red-50 transition-colors uppercase tracking-wide">K·∫øt th√∫c</button>
                        <button onclick="resetGame()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center hover:bg-gray-200 sm:hidden active:scale-90"><i class="fas fa-times text-sm"></i></button>
                    </div>
                </div>

                <div class="flex-1 relative overflow-y-auto w-full custom-scroll bg-[#F8FAFC]">
                    <div id="floatingComboContainer" class="absolute inset-0 pointer-events-none z-10"></div>
                    <div class="min-h-full flex flex-col items-center justify-center p-4 pb-4">
                        <div id="gameDisplayWrapper" class="w-full max-w-2xl flex flex-col items-center transition-all duration-300">
                            <span id="instructionText" class="text-[9px] font-bold text-gray-400 uppercase tracking-[0.2em] mb-4 bg-white px-3 py-1 rounded-full border border-gray-100 shadow-sm">INSTRUCTION</span>
                            <div id="readingPassageDisplay" class="hidden w-full bg-white p-5 rounded-2xl border-l-4 border-yellow-400 shadow-sm text-gray-700 mb-6 text-sm leading-relaxed text-justify"></div>

                            <!-- Roleplay Container (Flex Col for correct sizing) -->
                            <div id="roleplayContainer" class="hidden w-full flex-1 min-h-[40vh] flex flex-col">
                                 <div id="chatHistory" class="flex-1 overflow-y-auto p-3 space-y-3 bg-white rounded-2xl border border-gray-200 shadow-inner custom-scroll flex flex-col scroll-smooth">
                                 </div>
                                 <div id="chat-anchor" style="height: 1px;"></div>
                            </div>

                            <div id="scrambleContainer" class="hidden w-full">
                                 <div id="scrambleResult" class="min-h-[80px] bg-white border-2 border-dashed border-indigo-200 rounded-2xl flex flex-wrap items-center justify-center p-3 gap-2 mb-4 transition-colors hover:border-indigo-300"></div>
                                 <div id="scrambleBank" class="flex flex-wrap justify-center gap-2"></div>
                            </div>
                            <div id="listeningDisplay" class="hidden mb-6 flex flex-col items-center">
                                <button onclick="playTTS()" class="w-20 h-20 bg-pink-500 hover:bg-pink-600 text-white rounded-full flex items-center justify-center shadow-lg shadow-pink-200 active:scale-95 transition-all mb-3 group"><i class="fas fa-volume-up text-3xl group-hover:scale-110 transition-transform"></i></button>
                            </div>
                            <h2 id="mainDisplay" class="text-3xl md:text-5xl font-black text-slate-800 text-center mb-3 leading-tight break-words max-w-full tracking-tight px-2 transition-all">Question</h2>
                            <p id="subDisplay" class="hidden text-indigo-600 font-bold bg-indigo-50 px-3 py-1.5 rounded-lg border border-indigo-100 text-xs shadow-sm">(hint)</p>
                            <div id="quickOptions" class="hidden grid grid-cols-1 md:grid-cols-2 gap-3 w-full mt-6"></div>
                            <div class="h-4 w-full shrink-0"></div>
                        </div>
                    </div>
                </div>

                <div id="inputContainer" class="p-3 md:p-4 bg-white border-t border-gray-100 shadow-[0_-10px_40px_rgba(0,0,0,0.03)] z-30 shrink-0">
                    <div class="max-w-2xl mx-auto flex items-center gap-3">
                        <div class="relative flex-1 group" id="inputWrapper">
                            <input type="text" id="answerInput" class="w-full bg-slate-50 border-2 border-slate-100 focus:border-indigo-500 focus:bg-white text-lg font-bold py-3 px-4 rounded-xl focus:outline-none transition-all placeholder-gray-300 shadow-inner" placeholder="Nh·∫≠p ƒë√°p √°n..." autocomplete="off">
                        </div>
                        <button id="checkBtn" class="w-14 h-14 bg-slate-900 hover:bg-slate-800 text-white rounded-xl shadow-lg flex items-center justify-center text-xl active:scale-95 transition-all shrink-0"><i class="fas fa-check"></i></button>
                    </div>
                </div>
            </div>

            <!-- 3. RESULT SCREEN -->
            <div id="resultScreen" class="hidden absolute inset-0 overflow-y-auto p-6 bg-slate-50 flex flex-col items-center justify-center w-full h-full">
                <div class="max-w-md w-full text-center my-auto pb-10">
                    <div class="text-7xl mb-6 animate-bounce filter drop-shadow-md">üèÜ</div>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">K·∫æT QU·∫¢</p>
                    <h2 id="resultTitle" class="text-3xl font-black text-slate-800 mb-6">Ho√†n th√†nh!</h2>
                    <div id="scoreBadge" class="inline-flex items-center gap-4 px-8 py-4 bg-white rounded-full border border-gray-100 mb-8 shadow-sm">
                        <div class="flex flex-col items-center leading-none">
                            <span class="text-[10px] font-bold text-gray-400 uppercase mb-1">ƒêi·ªÉm s·ªë</span>
                            <span class="text-3xl font-black text-yellow-500"><span id="finalScore">0</span><span class="text-lg text-gray-300 mx-1">/</span><span id="totalScoreQ" class="text-lg text-gray-400">10</span></span>
                        </div>
                    </div>
                    <p id="roleplayEndMsg" class="hidden text-gray-500 italic mb-6 text-sm bg-white p-4 rounded-xl shadow-sm border border-gray-100">H·ªôi tho·∫°i ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o l·ªãch s·ª≠.</p>
                    <div id="resultList" class="w-full bg-white rounded-2xl border border-gray-100 p-2 max-h-[30vh] overflow-y-auto text-left mb-6 custom-scroll shadow-inner"></div>
                    <div class="grid grid-cols-1 gap-3 w-full">
                        <button id="reviewBtn" onclick="startReview()" class="hidden w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-orange-200 transition-all active:scale-95"><i class="fas fa-recycle mr-2"></i> H·ªçc l·∫°i l·ªói sai</button>
                        <button onclick="resetGame()" class="w-full bg-white hover:bg-gray-50 text-slate-700 font-bold py-4 rounded-2xl border border-gray-200 shadow-sm transition-all active:scale-95"><i class="fas fa-redo mr-2"></i> V·ªÅ trang ch·ªß</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODALS -->

        <!-- Feedback Overlay -->
        <div id="feedbackOverlay" class="hidden custom-modal-overlay">
            <div class="custom-modal-container max-w-sm rounded-[32px] p-6 md:p-8 text-center animate-popIn bg-white h-auto border border-white/20">
                <div id="feedbackIcon" class="text-6xl mb-4 filter drop-shadow-sm">üéâ</div>
                <h3 id="feedbackTitle" class="text-3xl font-black mb-6 text-slate-800">Ch√≠nh x√°c!</h3>
                <div class="relative bg-slate-50 rounded-2xl p-5 mb-6 text-left border border-slate-100 overflow-hidden">
                    <div id="feedbackBorder" class="absolute left-0 top-0 bottom-0 w-2 bg-green-500"></div>
                    <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-3">ƒê√ÅP √ÅN</p>
                    <div class="flex items-center gap-3">
                        <span id="correctAnswerText" class="text-xl font-black text-slate-800 ml-3 break-words leading-tight">Answer</span>
                        <button onclick="playTTS()" class="shrink-0 w-8 h-8 bg-white border rounded-full flex items-center justify-center text-gray-400 hover:text-indigo-600 hover:border-indigo-200 transition-all active:scale-95"><i class="fas fa-volume-up text-sm"></i></button>
                    </div>
                    <div id="synonymText" class="mt-2 text-xs text-gray-500 italic ml-3 hidden pt-2 border-t border-gray-200"></div>
                    <div id="grammarExplanation" class="mt-2 pt-2 border-t border-gray-200 text-sm text-indigo-600 ml-3 font-medium hidden leading-relaxed"></div>
                </div>
                <button onclick="nextQuestion()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-2xl flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all">Ti·∫øp t·ª•c <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <!-- Dictionary Modal -->
        <div id="dictModal" class="hidden custom-modal-overlay">
            <div id="dictContent" class="custom-modal-container modal-type-dict">
                <div class="modal-header">
                    <h2 class="text-lg font-black text-slate-800"><i class="fas fa-language text-orange-500 mr-2"></i> T·ª´ ƒëi·ªÉn</h2>
                    <button onclick="closeDictModal()" class="w-9 h-9 bg-gray-50 hover:bg-red-50 text-gray-400 hover:text-red-500 rounded-full flex items-center justify-center transition-all"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-4 bg-white shrink-0">
                    <div class="relative">
                        <input type="text" id="dictInput" class="w-full pl-4 pr-12 py-3 bg-gray-50 border border-gray-200 rounded-xl font-bold focus:border-orange-400 focus:bg-white focus:ring-4 focus:ring-orange-50 outline-none transition-all text-base" placeholder="Nh·∫≠p t·ª´ c·∫ßn tra...">
                        <button onclick="lookupDictionary()" class="absolute right-2 top-2 bottom-2 w-10 bg-orange-500 text-white rounded-lg flex items-center justify-center shadow-md hover:bg-orange-600 transition-colors"><i class="fas fa-search"></i></button>
                    </div>
                </div>
                <div id="dictResultArea" class="modal-body-scroll p-4 bg-gray-50/50">
                    <div class="text-center text-gray-300 mt-20"><i class="fas fa-book text-5xl mb-3 opacity-20"></i><p class="text-xs font-medium">Nh·∫≠p t·ª´ v·ª±ng ƒë·ªÉ tra c·ª©u</p></div>
                </div>
            </div>
        </div>

        <!-- Topic Modal -->
        <div id="topicModal" class="hidden custom-modal-overlay">
            <div id="topicContentPanel" class="custom-modal-container modal-type-topic">
                <div class="modal-header">
                    <div><p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-0.5">TH∆Ø VI·ªÜN</p><h2 class="text-xl font-black text-slate-800">Ch·ªçn ch·ªß ƒë·ªÅ</h2></div>
                    <button onclick="closeTopicModal()" class="w-9 h-9 bg-gray-50 hover:bg-red-50 text-gray-400 hover:text-red-500 rounded-full flex items-center justify-center transition-all"><i class="fas fa-times"></i></button>
                </div>
                <div id="topicListContent" class="modal-body-scroll p-4 grid grid-cols-1 sm:grid-cols-2 gap-3 bg-gray-50/30"></div>
            </div>
        </div>

        <!-- Theory Modal -->
        <div id="theoryModal" class="hidden custom-modal-overlay">
            <div id="theoryContentPanel" class="custom-modal-container modal-type-theory flex-col md:flex-row">
                <!-- Sidebar -->
                <div class="w-full md:w-72 bg-gray-50 border-b md:border-b-0 md:border-r border-gray-200 flex flex-col shrink-0">
                    <div class="p-4 flex justify-between items-center border-b border-gray-100 md:border-0 bg-white md:bg-gray-50">
                        <h2 class="font-black text-slate-800 text-lg md:text-xl flex items-center gap-2 md:gap-3"><i class="fas fa-graduation-cap text-indigo-500"></i> S·ªï tay</h2>
                        <!-- Mobile Close Button -->
                        <button onclick="closeTheoryModal()" class="md:hidden w-9 h-9 bg-gray-50 hover:bg-red-50 text-gray-400 hover:text-red-500 rounded-full flex items-center justify-center transition-all"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="px-4 pb-4 md:pt-4 flex md:flex-col gap-2 overflow-x-auto md:overflow-visible no-scrollbar">
                        <button onclick="switchTheoryTab('grammar')" id="btnTheoryGrammar" class="flex-1 md:w-full text-center md:text-left px-3 py-2 rounded-xl font-bold text-xs bg-white border border-gray-200 text-indigo-600 shadow-sm whitespace-nowrap transition-all">Ng·ªØ Ph√°p</button>
                        <button onclick="switchTheoryTab('forms')" id="btnTheoryForms" class="flex-1 md:w-full text-center md:text-left px-3 py-2 rounded-xl font-bold text-xs text-gray-500 hover:bg-white hover:shadow-sm border border-transparent hover:border-gray-200 whitespace-nowrap transition-all">Bi·∫øn Th·ªÉ T·ª´</button>
                    </div>
                </div>
                <!-- Content -->
                <div class="flex-1 flex flex-col bg-white overflow-hidden relative">
                    <!-- Desktop Sticky Header -->
                    <div class="hidden md:flex modal-header bg-white/80 backdrop-blur z-10 sticky top-0">
                        <div id="theoryHeaderTitle" class="text-sm font-bold text-gray-500 uppercase tracking-wider">N·ªôi dung</div>
                        <button onclick="closeTheoryModal()" class="w-9 h-9 bg-gray-50 hover:bg-red-50 text-gray-400 hover:text-red-500 rounded-full flex items-center justify-center transition-all"><i class="fas fa-times"></i></button>
                    </div>

                    <div class="modal-body-scroll p-4 md:p-8" id="theoryContent">
                         <div id="theoryListGrammar" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                         <div id="theoryListForms" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                         <div id="theoryDetail" class="hidden h-full flex flex-col">
                            <button onclick="backToTheoryList()" class="mb-4 text-gray-400 hover:text-indigo-600 font-bold text-xs uppercase tracking-widest flex items-center gap-2 w-fit group"><i class="fas fa-arrow-left group-hover:-translate-x-1 transition-transform"></i> Quay l·∫°i</button>
                            <div id="theoryDetailContent" class="bg-white p-6 rounded-[24px] border border-gray-100 shadow-sm text-gray-700 leading-relaxed text-sm md:text-base"></div>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsPanel" class="hidden custom-modal-overlay">
            <div id="settingsBackdrop" class="absolute inset-0" onclick="toggleSettings()"></div>
            <div id="settingsContent" class="custom-modal-container bg-white p-6 rounded-[32px] w-80 relative transform scale-95 opacity-0 transition-all duration-200 h-auto">
                <h3 class="font-black text-xl text-slate-800 mb-6 flex items-center gap-3"><i class="fas fa-cog text-gray-400"></i> C√†i ƒë·∫∑t</h3>
                <div class="bg-slate-50 p-5 rounded-2xl mb-6 border border-slate-100">
                    <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-3">TH·ªêNG K√ä C√Å NH√ÇN</p>
                    <div class="flex justify-between items-center mb-3 pb-3 border-b border-gray-200">
                        <span class="text-sm font-bold text-gray-600">Chu·ªói ng√†y</span>
                        <span class="font-black text-orange-500 text-base"><span id="settingStreak">0</span> üî•</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold text-gray-600">Ho·∫°t ƒë·ªông cu·ªëi</span>
                        <span id="lastLearnedTime" class="text-[10px] font-bold text-gray-400">--</span>
                    </div>
                </div>
                <div id="keyStatus" class="text-center text-[10px] font-bold text-green-600 bg-green-50 py-2 rounded-xl mb-4 border border-green-100 flex items-center justify-center gap-2"><i class="fas fa-wifi"></i> Server Connected</div>
                <button onclick="toggleSettings()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 rounded-xl transition-colors text-sm">ƒê√≥ng</button>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="hidden absolute inset-0 z-[60] bg-white/95 flex flex-col items-center justify-center backdrop-blur-sm">
            <div class="w-12 h-12 border-4 border-gray-100 border-t-indigo-500 rounded-full animate-spin mb-4"></div>
            <p id="loadingText" class="font-bold text-indigo-900 animate-pulse text-xs tracking-[0.2em]">ƒêANG KH·ªûI T·∫†O...</p>
        </div>

    </div>

    <script type="module">
        (function setupPWA() {})();
        const SERVER_URL = 'https://english-tutor-grammar-server.onrender.com';

        // --- CORE VIEWPORT & SCROLL FIX ---
        const appContainer = document.getElementById('app-container');

        const viewportHandler = () => {
            if (!window.visualViewport) return;
            const height = window.visualViewport.height;
            document.documentElement.style.setProperty('--app-height', `${height}px`);
            if (window.scrollY !== 0 || document.documentElement.scrollTop !== 0) {
                 window.scrollTo(0, 0);
            }
        };

        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', viewportHandler);
            window.visualViewport.addEventListener('scroll', viewportHandler);
        }

        window.addEventListener('scroll', () => {
            if (window.scrollY !== 0) window.scrollTo(0, 0);
        });
        viewportHandler();

        const els = {
            screens: { start: document.getElementById('startScreen'), game: document.getElementById('gameScreen'), result: document.getElementById('resultScreen') },
            views: { sharedInput: document.getElementById('sharedInputArea'), reading: document.getElementById('viewReading'), grammar: document.getElementById('viewGrammar'), forms: document.getElementById('viewForms') },
            inputs: { vocabTopic: document.getElementById('vocabTopicInput'), vocabSelect: document.getElementById('vocabTopicSelect'), readingTopic: document.getElementById('readingTopicInput'), readingSelect: document.getElementById('readingTopicSelect'), grammarTense: document.getElementById('grammarTenseSelect'), formsType: document.getElementById('formsTypeSelect'), answer: document.getElementById('answerInput'), dict: document.getElementById('dictInput') },
            game: { title: document.getElementById('gameTitle'), qNum: document.getElementById('currentQ'), totalQ: document.getElementById('totalQ'), progress: document.getElementById('progressBar'), display: document.getElementById('mainDisplay'), passageDisplay: document.getElementById('readingPassageDisplay'), listeningDisplay: document.getElementById('listeningDisplay'), subDisplay: document.getElementById('subDisplay'), instruction: document.getElementById('instructionText'), quickOptions: document.getElementById('quickOptions'), comboBadge: document.getElementById('comboBadge'), comboText: document.getElementById('comboCountText'), floatingCombo: document.getElementById('floatingComboContainer'), scrambleContainer: document.getElementById('scrambleContainer'), scrambleBank: document.getElementById('scrambleBank'), scrambleResult: document.getElementById('scrambleResult'), roleplayContainer: document.getElementById('roleplayContainer'), chatHistory: document.getElementById('chatHistory') },
            feedback: { overlay: document.getElementById('feedbackOverlay'), title: document.getElementById('feedbackTitle'), correctText: document.getElementById('correctAnswerText'), explanation: document.getElementById('grammarExplanation'), synonym: document.getElementById('synonymText'), border: document.getElementById('feedbackBorder') },
            settings: { panel: document.getElementById('settingsPanel'), content: document.getElementById('settingsContent'), backdrop: document.getElementById('settingsBackdrop'), keyStatus: document.getElementById('keyStatus') },
            dict: { modal: document.getElementById('dictModal'), content: document.getElementById('dictContent'), result: document.getElementById('dictResultArea'), input: document.getElementById('dictInput') },
            theory: { modal: document.getElementById('theoryModal'), content: document.getElementById('theoryContentPanel'), listGrammar: document.getElementById('theoryListGrammar'), listForms: document.getElementById('theoryListForms'), detail: document.getElementById('theoryDetail'), contentText: document.getElementById('theoryDetailContent'), tabs: { grammar: document.getElementById('btnTheoryGrammar'), forms: document.getElementById('btnTheoryForms') } },
            topic: { modal: document.getElementById('topicModal'), content: document.getElementById('topicContentPanel'), list: document.getElementById('topicListContent'), banner: document.getElementById('activeTopicBanner'), bannerName: document.getElementById('activeTopicName') },
            wrappers: { inputWrapper: document.getElementById('inputWrapper') },
            config: { level: document.getElementById('levelSelect'), qtyInput: document.getElementById('quantityRange'), qtyDisplay: document.getElementById('qtyDisplay') },
            loading: { overlay: document.getElementById('loadingOverlay'), text: document.getElementById('loadingText') },
            aiStatus: { dot: document.getElementById('aiStatusDot') },
            checkBtn: document.getElementById('checkBtn'),
            modeCards: { vocab: document.getElementById('mode-vocab'), phrases: document.getElementById('mode-phrases'), idioms: document.getElementById('mode-idioms'), listening: document.getElementById('mode-listening'), reading: document.getElementById('mode-reading'), grammar: document.getElementById('mode-grammar'), forms: document.getElementById('mode-forms'), scramble: document.getElementById('mode-scramble'), roleplay: document.getElementById('mode-roleplay') }
        };

        // --- HELPER FUNCTIONS ---
        function toggleModal(modal, content, backdrop, show) {
            if (show) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    content.classList.remove('scale-95', 'opacity-0');
                    content.classList.add('scale-100', 'opacity-100');
                }, 10);
            } else {
                content.classList.remove('scale-100', 'opacity-100');
                content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => { modal.classList.add('hidden'); }, 200);
            }
        }

        function updateLevel(val, el) {
            document.getElementById('levelSelect').value = val;
            document.querySelectorAll('.level-chip').forEach(c => { c.classList.remove('active'); });
            if(el) el.classList.add('active');
            UserSystem.save();
        }

        function setMode(mode) {
             Object.values(els.modeCards).forEach(c => c && c.classList.remove('active'));
             if(els.modeCards[mode]) els.modeCards[mode].classList.add('active');
             Object.values(els.views).forEach(v => v.classList.add('hidden'));
             if(mode === 'reading') els.views.reading.classList.remove('hidden');
             else if(mode === 'grammar') els.views.grammar.classList.remove('hidden');
             else if(mode === 'forms') els.views.forms.classList.remove('hidden');
             else els.views.sharedInput.classList.remove('hidden');
        }

        function switchScreen(n) {
            els.screens.start.classList.add('hidden');
            els.screens.game.classList.add('hidden');
            els.screens.result.classList.add('hidden');
            els.screens[n].classList.remove('hidden');
        }

        function resetGame() {
            switchScreen('start');
            gameState.currentIdx = 0;
        }

        // --- NEW: CHAT SCROLL HELPER (SMOOTH & DELAYED) ---
        // Helps emulate real chat app behavior by waiting for layout paint
function scrollToBottom() {
    const anchor = document.getElementById('chat-anchor');
    if (anchor) {
        console.log("Scrolling to bottom...");
        // S·ª≠ d·ª•ng requestAnimationFrame ƒë·ªÉ ƒë·∫£m b·∫£o tr√¨nh duy·ªát ƒë√£ v·∫Ω xong tin nh·∫Øn m·ªõi
        requestAnimationFrame(() => {
            anchor.scrollIntoView({
                behavior: 'smooth',
                block: 'end'
            });
        });
    }
}

        function checkExamAnswer() {
            if (gameState.mode === 'roleplay') return;
            let user = els.inputs.answer.value.trim();
            if (gameState.mode === 'scramble') {
                 const normalize = s => s.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").toLowerCase().replace(/\s{2,}/g," ");
                 user = normalize(user);
                 const correctNorm = normalize(gameState.currentCorrect);
                 if (user === correctNorm) user = gameState.currentCorrect.toLowerCase();
            } else { user = user.toLowerCase(); }

            if(!user && gameState.mode !== 'scramble') { els.checkBtn.classList.add('animate-pulse'); setTimeout(()=>els.checkBtn.classList.remove('animate-pulse'), 200); return; }
            if (gameState.currentIdx >= gameState.data.length) return;
            const item = gameState.data[gameState.currentIdx];
            const mainCorrect = gameState.currentCorrect.toLowerCase();
            const isCorrect = user === mainCorrect || gameState.currentOthers.includes(user);

            gameState.history.push({ q: gameState.mode === 'listening' ? `üîä ${item.en}` : (gameState.mode === 'reading' ? `üìñ ${item.question}` : els.game.display.textContent), a: gameState.currentCorrect, u: els.inputs.answer.value, ok: isCorrect });

            if(isCorrect) {
                gameState.score++; comboCount++; triggerComboVisuals(comboCount);
                if (gameState.score / gameState.data.length > 0.8) fireConfetti(true);
                if (gameState.isReviewMode) UserSystem.removeWrongAnswer(item.question || item.vi);
            } else {
                comboCount = 0; els.game.comboBadge.classList.add('hidden');
                els.game.display.classList.add('shake-element'); setTimeout(() => els.game.display.classList.remove('shake-element'), 300);
                if (!gameState.isReviewMode) UserSystem.addWrongAnswer(item, gameState.mode);
            }

            els.feedback.title.textContent = isCorrect ? "Ch√≠nh x√°c!" : "Sai r·ªìi!";
            els.feedback.title.className = isCorrect ? "text-2xl md:text-3xl font-black mb-2 text-green-600" : "text-2xl md:text-3xl font-black mb-2 text-red-500";
            els.feedback.border.className = isCorrect ? "absolute left-0 top-0 bottom-0 w-1.5 bg-green-500" : "absolute left-0 top-0 bottom-0 w-1.5 bg-red-500";
            document.getElementById('feedbackIcon').textContent = isCorrect ? "üéâ" : "üòÖ"; els.feedback.correctText.textContent = gameState.currentCorrect;

            let modeToCheck = gameState.isReviewMode ? item.savedMode : gameState.mode;
            if ((['vocab','listening','phrases','idioms','grammar'].includes(modeToCheck)) && item.others) { els.feedback.synonym.textContent = `Ch·∫•p nh·∫≠n th√™m: ${item.others}`; els.feedback.synonym.classList.remove('hidden'); } else { els.feedback.synonym.classList.add('hidden'); }
            els.feedback.explanation.textContent = item.explanation ? "üí° " + item.explanation : ""; els.feedback.explanation.classList.toggle('hidden', !item.explanation);
            toggleModal(els.feedback.overlay, els.feedback.overlay.firstElementChild, null, true);
            const nextBtn = els.feedback.overlay.querySelector('button');
            if(nextBtn) nextBtn.focus();
        }

        // --- DATA SYSTEM ---
        const UserSystem = {
            data: { streak: 0, lastLoginDate: null, lastActivityTime: null, wrongAnswers: [], config: { level: 'Level A', quantity: 10, pinnedTopic: null, pinnedTopicVi: null } },
            load() {
                const s = localStorage.getItem('aiTutorUser');
                if (s) {
                    try {
                        const parsed = JSON.parse(s);
                        this.data = { ...this.data, ...parsed };
                        if(!this.data.config) this.data.config = { level: 'Level A', quantity: 10, pinnedTopic: null, pinnedTopicVi: null };
                        if(!this.data.wrongAnswers) this.data.wrongAnswers = [];
                    } catch (e) { console.error("Data Load Error", e); }
                }
                this.checkStreak();
                this.applyConfig();
                this.updateUI();
            },
            save() {
                this.data.config.level = document.getElementById('levelSelect').value;
                this.data.config.quantity = document.getElementById('quantityRange').value;
                localStorage.setItem('aiTutorUser', JSON.stringify(this.data));
                this.updateUI();
            },
            saveTopic(en, vi) {
                this.data.config.pinnedTopic = en;
                this.data.config.pinnedTopicVi = vi;
                this.save();
            },
            applyConfig() {
                // Now safe because updateLevel is hoisted/defined above
                updateLevel(this.data.config.level, document.querySelector(`.level-chip[onclick*="${this.data.config.level}"]`));
                document.getElementById('quantityRange').value = this.data.config.quantity;
                document.getElementById('qtyDisplay').textContent = this.data.config.quantity;
                if (this.data.config.pinnedTopic) { selectTopic(this.data.config.pinnedTopic, this.data.config.pinnedTopicVi, false); }
            },
            checkStreak() {
                const today = new Date().toDateString();
                const last = this.data.lastLoginDate;
                if (last && last !== today) {
                    const d1 = new Date(last); const d2 = new Date(today);
                    const diffDays = Math.ceil(Math.abs(d2 - d1) / (1000 * 60 * 60 * 24));
                    if (diffDays > 1) this.data.streak = 0;
                }
            },
            recordActivity() {
                const today = new Date().toDateString();
                if (this.data.lastLoginDate !== today) {
                    const last = this.data.lastLoginDate;
                    if (last) {
                        const d1 = new Date(last); const d2 = new Date(today);
                        const diffDays = Math.ceil(Math.abs(d2 - d1) / (1000 * 60 * 60 * 24));
                        if (diffDays === 1) this.data.streak++; else this.data.streak = 1;
                    } else { this.data.streak = 1; }
                    this.data.lastLoginDate = today;
                }
                this.data.lastActivityTime = new Date().toLocaleString('vi-VN');
                this.save();
            },
            addWrongAnswer(item, mode) {
                const exists = this.data.wrongAnswers.find(w => w.question === item.question || (item.vi && w.question === item.vi));
                if (!exists) { this.data.wrongAnswers.push({ ...item, savedMode: mode, addedDate: new Date().toDateString() }); this.save(); }
            },
            removeWrongAnswer(questionText) {
                this.data.wrongAnswers = this.data.wrongAnswers.filter(w => w.question !== questionText && w.vi !== questionText);
                this.save();
            },
            updateUI() {
                const streakEl = document.getElementById('streakCount'); if (streakEl) streakEl.textContent = this.data.streak;
                const settingStreak = document.getElementById('settingStreak'); if(settingStreak) settingStreak.textContent = this.data.streak;
                const lastTime = document.getElementById('lastLearnedTime'); if(lastTime) lastTime.textContent = this.data.lastActivityTime || "Ch∆∞a c√≥";
            }
        };

        const nopdTopics = {
            "Everyday Language": [{en: "Meeting & Greeting", vi: "Ch√†o h·ªèi & L√†m quen"}, {en: "Time & Date", vi: "Th·ªùi gian & Ng√†y th√°ng"}, {en: "Numbers", vi: "S·ªë ƒë·∫øm"}, {en: "Colors", vi: "M√†u s·∫Øc"}, {en: "Weather", vi: "Th·ªùi ti·∫øt"}, {en: "Money", vi: "Ti·ªÅn t·ªá"}],
            "People": [{en: "Family Members", vi: "Th√†nh vi√™n gia ƒë√¨nh"}, {en: "The Human Body", vi: "C∆° th·ªÉ ng∆∞·ªùi"}, {en: "Face & Hair", vi: "G∆∞∆°ng m·∫∑t & T√≥c"}, {en: "Emotions", vi: "C·∫£m x√∫c"}, {en: "Clothes", vi: "Qu·∫ßn √°o"}, {en: "Daily Routine", vi: "Th√≥i quen h√†ng ng√†y"}],
            "Housing": [{en: "House Exterior", vi: "Ngo·∫°i th·∫•t ng√¥i nh√†"}, {en: "Living Room", vi: "Ph√≤ng kh√°ch"}, {en: "Kitchen", vi: "Nh√† b·∫øp"}, {en: "Bedroom", vi: "Ph√≤ng ng·ªß"}, {en: "Bathroom", vi: "Ph√≤ng t·∫Øm"}, {en: "Household Chores", vi: "Vi·ªác nh√†"}],
            "Food": [{en: "Fruit", vi: "Tr√°i c√¢y"}, {en: "Vegetables", vi: "Rau c·ªß"}, {en: "Meat & Poultry", vi: "Th·ªãt & Gia c·∫ßm"}, {en: "Seafood", vi: "H·∫£i s·∫£n"}, {en: "Drinks", vi: "ƒê·ªì u·ªëng"}, {en: "Supermarket", vi: "Si√™u th·ªã"}, {en: "Restaurant", vi: "Nh√† h√†ng"}],
            "Health": [{en: "Medical Care", vi: "ChƒÉm s√≥c y t·∫ø"}, {en: "Ailments & Injuries", vi: "B·ªánh & Ch·∫•n th∆∞∆°ng"}, {en: "The Hospital", vi: "B·ªánh vi·ªán"}, {en: "Dental Care", vi: "ChƒÉm s√≥c nha khoa"}],
            "Community": [{en: "The City", vi: "Th√†nh ph·ªë"}, {en: "Downtown", vi: "Trung t√¢m th√†nh ph·ªë"}, {en: "Shopping Mall", vi: "Trung t√¢m th∆∞∆°ng m·∫°i"}, {en: "Bank", vi: "Ng√¢n h√†ng"}, {en: "Post Office", vi: "B∆∞u ƒëi·ªán"}, {en: "Library", vi: "Th∆∞ vi·ªán"}],
            "Transport": [{en: "Car Parts", vi: "Ph·ª• t√πng xe h∆°i"}, {en: "Bicycle", vi: "Xe ƒë·∫°p"}, {en: "Public Transportation", vi: "Giao th√¥ng c√¥ng c·ªông"}, {en: "Airport", vi: "S√¢n bay"}, {en: "Traffic Signs", vi: "Bi·ªÉn b√°o giao th√¥ng"}],
            "Work": [{en: "Office", vi: "VƒÉn ph√≤ng"}, {en: "Construction Site", vi: "C√¥ng tr∆∞·ªùng x√¢y d·ª±ng"}, {en: "Farming", vi: "N√¥ng tr·∫°i"}, {en: "Jobs & Occupations", vi: "Ngh·ªÅ nghi·ªáp"}, {en: "Tools", vi: "D·ª•ng c·ª•"}],
            "Nature": [{en: "Animals", vi: "ƒê·ªông v·∫≠t"}, {en: "Birds & Insects", vi: "Chim & C√¥n tr√πng"}, {en: "Plants & Trees", vi: "C√¢y c·ªëi"}, {en: "The Universe", vi: "V≈© tr·ª•"}, {en: "Environment", vi: "M√¥i tr∆∞·ªùng"}],
            "School": [{en: "Classroom", vi: "L·ªõp h·ªçc"}, {en: "School Subjects", vi: "M√¥n h·ªçc"}, {en: "Stationery", vi: "VƒÉn ph√≤ng ph·∫©m"}, {en: "Study Activities", vi: "Ho·∫°t ƒë·ªông h·ªçc t·∫≠p"}],
            "Recreation": [{en: "Sports", vi: "Th·ªÉ thao"}, {en: "Hobbies", vi: "S·ªü th√≠ch"}, {en: "Music", vi: "√Çm nh·∫°c"}, {en: "Beach", vi: "B√£i bi·ªÉn"}, {en: "Camping", vi: "C·∫Øm tr·∫°i"}]
        };

        const offlineData = {
            vocab: { "Daily Life": [
                {vi: "C√† ph√™", en: "coffee", others: "java, joe"},
                {vi: "M√°y t√≠nh", en: "computer", others: "pc, laptop"},
                {vi: "S√°ch", en: "book", others: "volume, novel"},
                {vi: "B√∫t", en: "pen", others: "biro, marker"},
                {vi: "ƒêi·ªán tho·∫°i", en: "phone", others: "cellphone, mobile"},
                {vi: "Xe ƒë·∫°p", en: "bicycle", others: "bike, cycle"}
            ], "Work & Business": [{vi: "Ph√°t tri·ªÉn", en: "develop", others: "grow, expand"}]},
            phrases: { "General": [
                {vi: "B·ªè cu·ªôc", en: "give up", others: "quit, surrender"},
                {vi: "ChƒÉm s√≥c", en: "look after", others: "take care of"},
                {vi: "T√¨m ki·∫øm", en: "look for", others: "search, seek"},
                {vi: "Tham gia", en: "take part in", others: "participate, join"}
            ] },
            idioms: { "General": [
                {vi: "M·ªôt m≈©i t√™n tr√∫ng hai ƒë√≠ch", en: "kill two birds with one stone", others: ""},
                {vi: "M∆∞a nh∆∞ tr√∫t n∆∞·ªõc", en: "raining cats and dogs", others: ""},
                {vi: "D·ªÖ nh∆∞ ƒÉn k·∫πo", en: "piece of cake", others: "easy, simple"},
                {vi: "T·ªën k√©m", en: "cost an arm and a leg", others: "expensive, pricey"}
            ] },
            grammar: {
                "Present Simple": [
                    {question: "She usually ___ (walk) to work.", verb: "walk", answer: "walks", explanation: "Th√≥i quen ·ªü hi·ªán t·∫°i (She -> V+s)."},
                    {question: "The sun ___ (rise) in the East.", verb: "rise", answer: "rises", explanation: "S·ª± th·∫≠t hi·ªÉn nhi√™n."}
                ],
                "Present Continuous": [
                    {question: "Look! It ___ (rain) outside.", verb: "rain", answer: "is raining", explanation: "ƒêang x·∫£y ra l√∫c n√≥i (Look!)."},
                    {question: "I ___ (study) now.", verb: "study", answer: "am studying", explanation: "ƒêang di·ªÖn ra (now)."}
                ],
                "Present Perfect": [{question: "I ___ (see) that movie twice.", verb: "see", answer: "have seen", explanation: "Kinh nghi·ªám trong qu√° kh·ª©."}],
                "Present Perfect Continuous": [{question: "It ___ (rain) for 3 hours.", verb: "rain", answer: "has been raining", explanation: "Nh·∫•n m·∫°nh qu√° tr√¨nh li√™n t·ª•c."}],
                "Past Simple": [{question: "I ___ (go) to the cinema yesterday.", verb: "go", answer: "went", explanation: "ƒê√£ x·∫£y ra v√† k·∫øt th√∫c (yesterday)."}],
                "Past Continuous": [{question: "I ___ (read) when he came.", verb: "read", answer: "was reading", explanation: "ƒêang x·∫£y ra th√¨ h√†nh ƒë·ªông kh√°c xen v√†o."}],
                "Past Perfect": [{question: "When I arrived, the train ___ (leave).", verb: "leave", answer: "had left", explanation: "X·∫£y ra tr∆∞·ªõc 1 h√†nh ƒë·ªông QK kh√°c."}],
                "Past Perfect Continuous": [{question: "He was tired because he ___ (work) all day.", verb: "work", answer: "had been working", explanation: "Nguy√™n nh√¢n c·ªßa tr·∫°ng th√°i QK."}],
                "Future Simple": [{question: "I think it ___ (rain) tomorrow.", verb: "rain", answer: "will rain", explanation: "D·ª± ƒëo√°n kh√¥ng cƒÉn c·ª©."}],
                "Future Continuous": [{question: "At 9 AM tomorrow, I ___ (work).", verb: "work", answer: "will be working", explanation: "Th·ªùi ƒëi·ªÉm c·ª• th·ªÉ trong TL."}],
                "Future Perfect": [{question: "By next year, I ___ (graduate).", verb: "graduate", answer: "will have graduated", explanation: "Ho√†n th√†nh tr∆∞·ªõc m·ªëc TL (By)."}],
                "Future Perfect Continuous": [{question: "By 2030, I ___ (teach) for 20 years.", verb: "teach", answer: "will have been teaching", explanation: "Qu√° tr√¨nh t√≠nh ƒë·∫øn m·ªëc TL."}]
            },
            forms: {
                "irregular": [
                    {question: "go (V2)", answer: "went", explanation: "go - went - gone"},
                    {question: "buy (V2)", answer: "bought", explanation: "buy - bought - bought"}
                ],
                "irregular_v3": [
                    {question: "go (V3)", answer: "gone", explanation: "go - went - gone"},
                    {question: "write (V3)", answer: "written", explanation: "write - wrote - written"}
                ],
                "noun_suffix": [{question: "inform (Noun -tion)", answer: "information", explanation: "Th√™m -ation."}, {question: "develop (Noun -ment)", answer: "development", explanation: "Th√™m -ment."}],
                "adj_suffix": [{question: "beauty (Adj -ful)", answer: "beautiful", explanation: "y -> i + ful."}, {question: "care (Adj -less)", answer: "careless", explanation: "Th√™m -less."}],
                "prefixes": [{question: "happy (Prefix: not)", answer: "unhappy", explanation: "Th√™m un-."}, {question: "agree (Prefix: not)", answer: "disagree", explanation: "Th√™m dis-."}],
                "verb_noun": [{question: "decide (Noun)", answer: "decision", explanation: "de -> sion."}, {question: "arrive (Noun)", answer: "arrival", explanation: "e -> al."}],
                "noun_adj": [{question: "danger (Adj)", answer: "dangerous", explanation: "+ ous."}, {question: "fame (Adj)", answer: "famous", explanation: "e -> ous."}],
                "adj_adv": [{question: "quick (Adv)", answer: "quickly", explanation: "+ ly."}, {question: "happy (Adv)", "answer": "happily", explanation: "y -> i + ly."}],
                "ing": [{question: "run", answer: "running", explanation: "G·∫•p ƒë√¥i ph·ª• √¢m."}, {question: "swim", answer: "swimming", explanation: "G·∫•p ƒë√¥i ph·ª• √¢m."}],
                "ed": [{question: "stop", answer: "stopped", explanation: "G·∫•p ƒë√¥i ph·ª• √¢m."}, {question: "plan", answer: "planned", explanation: "G·∫•p ƒë√¥i ph·ª• √¢m."}],
                "classify": [{question: "She runs [fast]. (Type?)", answer: "adverb", explanation: "B·ªï nghƒ©a cho ƒë·ªông t·ª´ runs."}, {question: "It is a [fast] car. (Type?)", "answer": "adjective", explanation: "B·ªï nghƒ©a cho danh t·ª´ car."}]
            },
            scramble: { "General": [{vi: "T√¥i ƒëi h·ªçc b·∫±ng xe bu√Ωt.", en: "I go to school by bus"}, {vi: "C√¥ ·∫•y ƒëang n·∫•u ƒÉn trong b·∫øp.", en: "She is cooking in the kitchen"}, {vi: "Anh ·∫•y ch∆°i b√≥ng ƒë√° gi·ªèi.", en: "He plays football well"}] },
            reading: { "Daily Life": [{passage: "My name is John...", question: "What time does John wake up?", answer: "6 AM", options: ["6 AM", "7 AM"], type: "mc", explanation: "Text says: 'I wake up at 6 AM'."}] },
            theory: {
                // FALLBACK ONLY - will try to use AI first
                "Present Simple": { title: "Th√¨ Hi·ªán T·∫°i ƒê∆°n", content: "ƒêang t·∫£i d·ªØ li·ªáu chi ti·∫øt..." }
            }
        };

        const tenseTranslations = { "Present Simple": "Hi·ªán t·∫°i ƒë∆°n", "Present Continuous": "Hi·ªán t·∫°i ti·∫øp di·ªÖn", "Present Perfect": "Hi·ªán t·∫°i ho√†n th√†nh", "Present Perfect Continuous": "HT ho√†n th√†nh ti·∫øp di·ªÖn", "Past Simple": "Qu√° kh·ª© ƒë∆°n", "Past Continuous": "Qu√° kh·ª© ti·∫øp di·ªÖn", "Past Perfect": "Qu√° kh·ª© ho√†n th√†nh", "Past Perfect Continuous": "QK ho√†n th√†nh ti·∫øp di·ªÖn", "Future Simple": "T∆∞∆°ng lai ƒë∆°n", "Future Continuous": "T∆∞∆°ng lai ti·∫øp di·ªÖn", "Future Perfect": "T∆∞∆°ng lai ho√†n th√†nh", "Future Perfect Continuous": "TL ho√†n th√†nh ti·∫øp di·ªÖn" };
        const formReadableNames = { "irregular": "Irregular Verbs (B·∫•t quy t·∫Øc)", "irregular_v3": "Past Participle (Qu√° kh·ª© ph√¢n t·ª´)", "noun_suffix": "Noun Suffixes (H·∫≠u t·ªë Danh t·ª´)", "adj_suffix": "Adjective Suffixes (H·∫≠u t·ªë T√≠nh t·ª´)", "prefixes": "Prefixes (Ti·ªÅn t·ªë)", "verb_noun": "Verb to Noun (ƒê·ªông t·ª´ ‚Üí Danh t·ª´)", "noun_adj": "Noun to Adjective (Danh t·ª´ ‚Üí T√≠nh t·ª´)", "adj_adv": "Adjective to Adverb (T√≠nh t·ª´ ‚Üí Tr·∫°ng t·ª´)", "ing": "-ING Ending (ƒêu√¥i -ING)", "ed": "-ED Ending (ƒêu√¥i -ED)", "classify": "Word Class (Ph√¢n lo·∫°i t·ª´)" };

        let gameState = { mode: 'vocab', data: [], currentIdx: 0, score: 0, history: [], currentCorrect: "", currentOthers: [], isReviewMode: false, roleplayContext: null };
        let currentGlobalTopic = null;
        let currentGlobalTopicVi = null;
        let comboCount = 0;


        const checkKeyStatus = () => { if(els.aiStatus.dot) els.aiStatus.dot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.5)]"; };
        const toggleSettings = () => { const isHidden = els.settings.panel.classList.contains('hidden'); toggleModal(els.settings.panel, els.settings.content, null, isHidden); };
        const openDictModal = () => { toggleModal(els.dict.modal, els.dict.content, null, true); setTimeout(() => els.dict.input.focus(), 300); };
        const closeDictModal = () => toggleModal(els.dict.modal, els.dict.content, null, false);
        const openTheoryModal = () => { toggleModal(els.theory.modal, els.theory.content, null, true); switchTheoryTab('grammar'); };
        const closeTheoryModal = () => toggleModal(els.theory.modal, els.theory.content, null, false);
        const openTopicModal = () => { renderTopicList(); toggleModal(els.topic.modal, els.topic.content, null, true); };
        const closeTopicModal = () => toggleModal(els.topic.modal, els.topic.content, null, false);

        const renderTopicList = () => {
            let html = '';
            for (const [category, topics] of Object.entries(nopdTopics)) {
                html += `<div class="col-span-1 sm:col-span-2 mb-2 border-b border-gray-100 pb-2"><h3 class="font-black text-gray-400 text-[10px] uppercase tracking-widest">${category}</h3></div>`;
                topics.forEach(topic => {
                    html += `<div onclick="selectTopic('${topic.en}', '${topic.vi}', true)" class="bg-gray-50/50 hover:bg-yellow-50 border border-gray-100 hover:border-yellow-200 p-3 rounded-xl cursor-pointer transition-all active:scale-95 group"><span class="font-bold text-gray-700 block mb-0.5 text-xs group-hover:text-yellow-700">${topic.en}</span><span class="text-[10px] text-gray-400 font-bold group-hover:text-yellow-600/70">${topic.vi}</span></div>`;
                });
            }
            els.topic.list.innerHTML = html;
        };

        const selectTopic = (topicEn, topicVi, save = true) => {
            currentGlobalTopic = topicEn; currentGlobalTopicVi = topicVi;
            els.topic.banner.classList.remove('hidden'); els.topic.bannerName.textContent = topicEn;
            els.inputs.vocabTopic.disabled = true; els.inputs.vocabTopic.placeholder = `ƒêang d√πng ch·ªß ƒë·ªÅ: ${topicEn}`; els.inputs.vocabTopic.value = "";
            closeTopicModal();
            const activeCard = document.querySelector('.mode-card.active'); if (activeCard) { setMode(activeCard.id.replace('mode-', '')); }
            if (save) UserSystem.saveTopic(topicEn, topicVi);
        };

        const clearTopic = () => {
            currentGlobalTopic = null; currentGlobalTopicVi = null;
            els.topic.banner.classList.add('hidden');
            els.inputs.vocabTopic.disabled = false; els.inputs.vocabTopic.placeholder = "VD: Marketing, Football...";
            const activeCard = document.querySelector('.mode-card.active'); if (activeCard) { setMode(activeCard.id.replace('mode-', '')); }
            UserSystem.saveTopic(null, null);
        };

        const canvasConfetti = document.getElementById('confetti-canvas');
        const ctxConfetti = canvasConfetti.getContext('2d');
        let particles = [];
        const resizeCanvas = () => { canvasConfetti.width = window.innerWidth; canvasConfetti.height = window.innerHeight; };
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function createParticles(x, y, count) {
            const colors = ['#FCD34D', '#EF4444', '#3B82F6', '#10B981', '#8B5CF6'];
            for (let i = 0; i < count; i++) {
                particles.push({ x: x, y: y, vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 1) * 10 - 2, size: Math.random() * 8 + 4, color: colors[Math.floor(Math.random() * colors.length)], life: 100, decay: Math.random() * 0.05 + 0.02 });
            }
        }
        function updateConfetti() {
            ctxConfetti.clearRect(0, 0, canvasConfetti.width, canvasConfetti.height);
            for (let i = 0; i < particles.length; i++) {
                let p = particles[i]; p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life -= 1; p.size -= p.decay;
                if (p.life > 0 && p.size > 0) { ctxConfetti.fillStyle = p.color; ctxConfetti.beginPath(); ctxConfetti.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctxConfetti.fill(); }
                else { particles.splice(i, 1); i--; }
            }
            if (particles.length > 0) requestAnimationFrame(updateConfetti);
        }
        function fireConfetti(fullScreen = false) {
            let count = fullScreen ? 100 : 30;
            if (window.innerWidth < 768) {
                count = fullScreen ? 40 : 15;
            }
            if (fullScreen) { createParticles(window.innerWidth / 2, window.innerHeight / 2, count); }
            else { createParticles(window.innerWidth / 2, window.innerHeight / 1.5, count); }
            if (particles.length <= (fullScreen ? 150 : 60)) requestAnimationFrame(updateConfetti);
        }
        function triggerComboVisuals(streak) {
            if (streak > 1) { els.game.display.classList.remove('pop-in'); void els.game.display.offsetWidth; els.game.display.classList.add('pop-in'); }
            if (streak >= 2) { els.game.comboBadge.classList.remove('hidden', 'scale-0'); els.game.comboBadge.classList.add('scale-100', 'flex'); els.game.comboText.textContent = `x${streak}`; }
            else { els.game.comboBadge.classList.add('hidden', 'scale-0'); els.game.comboBadge.classList.remove('flex'); }
            if (streak % 5 === 0) fireConfetti(true); else if (streak > 1) fireConfetti(false);
        }

        async function robustFetch(url, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url); if (!res.ok) throw new Error(`HTTP Error: ${res.status}`); return await res.json();
                } catch (e) { if (i === retries - 1) throw e; await new Promise(r => setTimeout(r, 1000 * (i + 1))); }
            }
        }

        async function callServerAI(promptText, jsonMode = true, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(`${SERVER_URL}/api/generate`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt: promptText, jsonMode: jsonMode }) });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);
                    if (jsonMode) {
                        let cleanText = data.result.replace(/```json/g, '').replace(/```/g, '').trim();
                        const parsed = JSON.parse(cleanText);
                        if (Array.isArray(parsed)) { if (parsed.length === 0) throw new Error("Empty Array Returned"); return parsed; }
                        if (typeof parsed === 'object' && parsed !== null) { if (parsed.title || parsed.definition || parsed.reply) return parsed; const values = Object.values(parsed); const foundArray = values.find(v => Array.isArray(v)); if (foundArray && foundArray.length > 0) return foundArray; if (Object.keys(parsed).length > 0) return parsed; }
                        throw new Error("AI returned unrecognized data structure.");
                    } else { return data.result; }
                } catch (e) {
                    console.warn(`Server Attempt ${i + 1} failed: ${e.message}`);
                    const loadingText = document.getElementById('loadingText'); if(loadingText && !loadingText.parentElement.classList.contains('hidden')) loadingText.textContent = `ƒêANG TH·ª¨ L·∫†I (${i+1}/${retries})...`;
                    if (i === retries - 1) throw e; await new Promise(r => setTimeout(r, 1500 * (i + 1)));
                }
            }
        }

        const updateUI = () => {
             const isRoleplay = gameState.mode === 'roleplay';
             const headerStats = document.getElementById('gameHeaderStats');
             const progressBar = document.getElementById('progressBarContainer');
             const endChatBtn = document.getElementById('endChatBtn');

             if (isRoleplay) {
                 headerStats.classList.add('hidden');
                 progressBar.classList.add('hidden');
                 endChatBtn.classList.remove('hidden');
                els.checkBtn.onclick = submitChat;
                els.inputs.answer.onkeypress = (e) => { if(e.key === 'Enter') submitChat(); };
                els.checkBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                els.inputs.answer.placeholder = "Nh·∫≠p tin nh·∫Øn tr·∫£ l·ªùi...";
             } else {
                 headerStats.classList.remove('hidden');
                 progressBar.classList.remove('hidden');
                 endChatBtn.classList.add('hidden');
                els.checkBtn.onclick = checkExamAnswer;
                els.inputs.answer.onkeypress = (e) => { if(e.key === 'Enter') checkExamAnswer(); };
                els.checkBtn.innerHTML = '<i class="fas fa-check"></i>';
                els.inputs.answer.placeholder = "Nh·∫≠p ƒë√°p √°n...";
             }

             if (!isRoleplay && (!gameState.data || !gameState.data[gameState.currentIdx])) return;

             const item = gameState.data[gameState.currentIdx];
             if (!isRoleplay) {
                els.game.qNum.textContent = gameState.currentIdx + 1;
                els.game.progress.style.width = `${((gameState.currentIdx + 1) / (gameState.data.length || 10)) * 100}%`;
             }

            // Clear inputs and states
            els.inputs.answer.value = "";
            els.game.quickOptions.classList.add('hidden'); els.game.quickOptions.innerHTML = '';
            els.game.display.classList.remove('hidden'); els.game.listeningDisplay.classList.add('hidden'); els.game.subDisplay.classList.add('hidden'); els.game.passageDisplay.classList.add('hidden'); els.game.scrambleContainer.classList.add('hidden'); els.game.roleplayContainer.classList.add('hidden');
            els.wrappers.inputWrapper.classList.remove('hidden');

            let modeToRender = gameState.isReviewMode ? item.savedMode : gameState.mode;

            if(modeToRender === 'vocab') { els.game.display.textContent = item.vi; els.game.instruction.textContent = "D·ªäCH T·ª™ SAU SANG TI·∫æNG ANH"; gameState.currentCorrect = item.en; gameState.currentOthers = item.others ? item.others.split(',').map(s => s.trim().toLowerCase()) : []; }
            else if (modeToRender === 'phrases') { els.game.display.textContent = item.vi; els.game.instruction.textContent = "D·ªäCH C·ª§M T·ª™"; gameState.currentCorrect = item.en; gameState.currentOthers = item.others ? item.others.split(',').map(s => s.trim().toLowerCase()) : []; }
            else if (modeToRender === 'idioms') { els.game.display.textContent = item.vi; els.game.instruction.textContent = "D·ªäCH TH√ÄNH NG·ªÆ"; gameState.currentCorrect = item.en; gameState.currentOthers = item.others ? item.others.split(',').map(s => s.trim().toLowerCase()) : []; }
            else if (modeToRender === 'listening') { els.game.display.classList.add('hidden'); els.game.listeningDisplay.classList.remove('hidden'); els.game.instruction.textContent = "NGHE V√Ä VI·∫æT L·∫†I"; els.game.subDisplay.textContent = `(Nghƒ©a: ${item.vi})`; els.game.subDisplay.classList.remove('hidden'); gameState.currentCorrect = item.en; gameState.currentOthers = item.others ? item.others.split(',').map(s => s.trim().toLowerCase()) : []; setTimeout(() => playTTS(), 500); }
            else if (modeToRender === 'reading') {
                els.game.passageDisplay.textContent = item.passage; els.game.passageDisplay.classList.remove('hidden');
                els.game.display.textContent = item.question; els.game.display.classList.remove('text-2xl', 'md:text-6xl'); els.game.display.classList.add('text-base', 'md:text-2xl'); // Adjusted text size
                els.game.instruction.textContent = item.type === 'tf' ? "TRUE OR FALSE?" : (item.type === 'cloze' ? "ƒêI·ªÄN V√ÄO CH·ªñ TR·ªêNG" : "TR·∫ÆC NGHI·ªÜM");
                gameState.currentCorrect = item.answer; gameState.currentOthers = [];
                if (item.type !== 'cloze') { els.wrappers.inputWrapper.classList.add('hidden'); }
                if (item.options && item.options.length > 0 && item.type !== 'cloze') { els.game.quickOptions.classList.remove('hidden'); item.options.forEach(opt => { const btn = document.createElement('button'); btn.className = "bg-white border-2 border-gray-100 hover:border-indigo-400 px-3 py-3 rounded-xl text-sm md:text-lg font-bold text-gray-700 shadow-sm transition-all hover:bg-indigo-50 active:scale-95"; btn.textContent = opt; btn.onclick = () => { els.inputs.answer.value = opt; checkExamAnswer(); }; els.game.quickOptions.appendChild(btn); }); }
            }
            else if (modeToRender === 'grammar') { els.game.display.textContent = item.question; els.game.instruction.textContent = "CHIA ƒê·ªòNG T·ª™"; els.game.subDisplay.textContent = item.verb ? `Verb: (${item.verb})` : ""; els.game.subDisplay.classList.remove('hidden'); gameState.currentCorrect = item.answer; gameState.currentOthers = item.others ? item.others.split(',').map(s => s.trim().toLowerCase()) : []; }
            else if (modeToRender === 'forms') { els.game.display.textContent = item.question; els.game.instruction.textContent = "BI·∫æN ƒê·ªîI T·ª™ LO·∫†I"; els.game.subDisplay.classList.add('hidden'); gameState.currentCorrect = item.answer; gameState.currentOthers = []; }
            else if (modeToRender === 'scramble') {
                els.game.display.textContent = item.vi;
                els.game.instruction.textContent = "S·∫ÆP X·∫æP TH√ÄNH C√ÇU";
                gameState.currentCorrect = item.en;
                els.wrappers.inputWrapper.classList.add('hidden');
                els.game.scrambleContainer.classList.remove('hidden');
                // CLEAN UP & RENDER
                renderScrambleGame(item.en);
            }
            else if (modeToRender === 'roleplay') {
                els.game.display.classList.add('hidden');
                els.game.roleplayContainer.classList.remove('hidden');
                els.game.instruction.textContent = "H·ªòI THO·∫†I AI";
                if(gameState.currentIdx === 0 && els.game.chatHistory.children.length === 0) {
                     addChatBubble('ai', gameState.roleplayContext.aiFirstMessage);
                }
            }
        };

        function applyVocabulary(text, vocabList) {
            if (!vocabList || !Array.isArray(vocabList) || vocabList.length === 0) return text;
            let formattedText = text;
            vocabList.sort((a, b) => b.word.length - a.word.length);
            vocabList.forEach(item => {
                const escapedWord = item.word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${escapedWord})`, 'gi');
                if (regex.test(formattedText)) { formattedText = formattedText.replace(regex, `$1<span class="text-[9px] md:text-[10px] bg-yellow-100 text-yellow-800 px-1 rounded ml-1 border border-yellow-200 cursor-help" title="${item.meaning}">(${item.meaning})</span>`); }
            });
            return formattedText;
        }

        function addChatBubble(sender, text, feedbackHtml = null, isRawHtml = false) {
            const bubble = document.createElement('div'); bubble.className = `chat-bubble ${sender}`;
            if (isRawHtml) bubble.innerHTML = text; else bubble.textContent = text;
            els.game.chatHistory.appendChild(bubble);
            if (feedbackHtml) { const fb = document.createElement('div'); fb.innerHTML = feedbackHtml; els.game.chatHistory.appendChild(fb); }
            scrollToBottom();
        }

        async function submitChat() {
            const userText = els.inputs.answer.value.trim();
            if (!userText) return;
            addChatBubble('user', userText);
            els.inputs.answer.value = '';

            // Create typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-bubble ai italic text-gray-400 text-sm';
            typingDiv.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> AI ƒëang tr·∫£ l·ªùi...';
            typingDiv.id = 'typingIndicator';
            els.game.chatHistory.appendChild(typingDiv);
            scrollToBottom();

            try {
                const prompt = `Context: English learning roleplay. Scenario: "${gameState.roleplayContext.scenario}". My Role (AI): "${gameState.roleplayContext.aiRole}". User Role: "${gameState.roleplayContext.userRole}". User said: "${userText}".
                1. Analyze user errors (Grammar/Vocab). If wrong, provide correction & explanation in Vietnamese.
                2. Reply naturally. Identify 1-3 hard words in reply.
                Output JSON: { "reply": "...", "vocabulary": [{"word": "...", "meaning": "..."}], "analysis": { "isCorrect": bool, "correction": "...", "explanation": "...", "errorType": "..." }, "isFinished": bool }`;
                const response = await callServerAI(prompt);

                if(document.getElementById('typingIndicator')) document.getElementById('typingIndicator').remove();

                let feedbackHtml = null;
                if (response.analysis && !response.analysis.isCorrect && response.analysis.correction) {
                    const uClean = userText.trim().replace(/[.,!?;]/g, '').toLowerCase();
                    const cClean = response.analysis.correction.trim().replace(/[.,!?;]/g, '').toLowerCase();
                    if (uClean !== cClean) {
                         feedbackHtml = `<div class="bg-red-50 p-2 md:p-3 rounded-xl border border-red-100 mb-3 text-xs"><div class="font-bold text-red-500 mb-1 flex items-center gap-1"><i class="fas fa-wrench"></i> ${response.analysis.errorType || "G·ª£i √Ω s·ª≠a l·ªói"}</div><div class="mb-2"><span class="line-through text-gray-400 mr-2">${userText}</span><span class="text-green-600 font-bold bg-green-50 px-2 py-0.5 rounded border border-green-100">${response.analysis.correction}</span></div><div class="text-[10px] md:text-[11px] text-gray-600 bg-white p-2 rounded-lg border border-gray-100">üí° ${response.analysis.explanation || ''}</div></div>`;
                    }
                }
                const richReply = applyVocabulary(response.reply, response.vocabulary);
                addChatBubble('ai', richReply, feedbackHtml, true);

                if (response.isFinished) {
                    addChatBubble('ai', "<i>(Cu·ªôc h·ªôi tho·∫°i ƒë√£ k·∫øt th√∫c. B·∫°n c√≥ th·ªÉ b·∫•m 'K·∫øt th√∫c' ·ªü tr√™n ƒë·ªÉ xem l·∫°i.)</i>", null, true);
                } else {
                    gameState.currentIdx++;
                    if(gameState.currentIdx > 100) { addChatBubble('ai', "<i>(Cu·ªôc h·ªôi tho·∫°i qu√° d√†i. H√£y b·∫•m K·∫øt th√∫c ƒë·ªÉ ngh·ªâ ng∆°i nh√©.)</i>", null, true); }
                }
            } catch (e) {
                if(document.getElementById('typingIndicator')) document.getElementById('typingIndicator').remove();
                addChatBubble('ai', "Xin l·ªói, k·∫øt n·ªëi b·ªã gi√°n ƒëo·∫°n. Vui l√≤ng th·ª≠ l·∫°i.");
            }
        }

        // --- SCRAMBLE LOGIC FIXED ---
        function renderScrambleGame(sentence) {
            const words = sentence.split(' ');
            const shuffled = [...words].sort(() => Math.random() - 0.5);

            // CLEAR EVERYTHING inside container except the structure divs if they exist,
            // but actually we append button to container, so we must clear old buttons.
            // Safe way: clear banks, remove any BUTTONs from container.
            els.game.scrambleBank.innerHTML = '';
            els.game.scrambleResult.innerHTML = '';

            // Remove any existing "Check" buttons to prevent stacking
            const existingBtn = els.game.scrambleContainer.querySelector('#checkScrambleBtn');
            if(existingBtn) existingBtn.remove();

            shuffled.forEach((word, idx) => {
                const chip = document.createElement('div');
                chip.className = 'word-chip bg-white border-2 border-indigo-100 hover:border-indigo-300 text-indigo-700 px-3 py-1.5 md:px-4 md:py-2 rounded-xl font-bold text-sm md:text-base shadow-sm active:scale-95 select-none transition-all';
                chip.textContent = word;
                chip.onclick = () => moveScrambleWord(chip);
                els.game.scrambleBank.appendChild(chip);
            });

             const checkScrambleBtn = document.createElement('button');
             checkScrambleBtn.id = 'checkScrambleBtn'; // Assign ID for easy removal
             checkScrambleBtn.className = "w-full mt-4 md:mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-colors text-sm shadow-md active:scale-95";
             checkScrambleBtn.innerHTML = "KI·ªÇM TRA K·∫æT QU·∫¢";
             checkScrambleBtn.onclick = checkExamAnswer;
             els.game.scrambleContainer.appendChild(checkScrambleBtn);
        }

        function moveScrambleWord(chip) {
            const isResult = chip.parentElement === els.game.scrambleResult;
            if (isResult) { els.game.scrambleBank.appendChild(chip); chip.classList.remove('bg-yellow-100', 'border-yellow-300', 'text-yellow-800'); chip.classList.add('bg-white', 'border-indigo-100', 'text-indigo-700'); }
            else { els.game.scrambleResult.appendChild(chip); chip.classList.remove('bg-white', 'border-indigo-100', 'text-indigo-700'); chip.classList.add('bg-yellow-100', 'border-yellow-300', 'text-yellow-800'); }
            updateScrambleInput();
        }
        function updateScrambleInput() { const words = Array.from(els.game.scrambleResult.children).map(c => c.textContent); els.inputs.answer.value = words.join(' '); }


        const finishGame = () => {
             UserSystem.recordActivity();
             const isRoleplay = gameState.mode === 'roleplay';
             const resultTitle = document.getElementById('resultTitle');
             const scoreBadge = document.getElementById('scoreBadge');
             const roleplayMsg = document.getElementById('roleplayEndMsg');

             if (isRoleplay) {
                 resultTitle.textContent = "K·∫øt th√∫c Roleplay";
                 scoreBadge.classList.add('hidden');
                 roleplayMsg.classList.remove('hidden');
                 document.getElementById('resultList').innerHTML = `<div class="p-4 text-center text-gray-500 italic bg-gray-50 rounded-xl text-xs md:text-sm">To√†n b·ªô ƒëo·∫°n chat ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o b·ªô nh·ªõ t·∫°m ƒë·ªÉ ph√¢n t√≠ch sau.</div>`;
             } else {
                 resultTitle.textContent = "Ho√†n th√†nh!";
                 scoreBadge.classList.remove('hidden');
                 roleplayMsg.classList.add('hidden');
                 const wrongCount = gameState.history.filter(h => !h.ok).length;
                 const reviewBtn = document.getElementById('reviewBtn');
                 if (wrongCount > 0 && !gameState.isReviewMode) { reviewBtn.classList.remove('hidden'); reviewBtn.innerHTML = `<i class="fas fa-recycle mr-2"></i> H·ªçc l·∫°i ngay (${wrongCount})`; } else { reviewBtn.classList.add('hidden'); }
                 document.getElementById('finalScore').textContent = gameState.score;
                 document.getElementById('totalScoreQ').textContent = gameState.data.length || 10;
                 document.getElementById('resultList').innerHTML = gameState.history.map(h => `<div class="p-3 border-b border-gray-100 flex gap-3 items-center last:border-0 bg-white mb-2 rounded-lg shadow-sm"><div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center shrink-0 ${h.ok ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-500'} font-bold text-xs md:text-sm border border-gray-100">${h.ok?'<i class="fas fa-check"></i>':'<i class="fas fa-times"></i>'}</div><div class="flex-1 min-w-0"><div class="text-[9px] md:text-[10px] font-bold text-gray-400 mb-0.5 truncate uppercase tracking-wider">${h.q}</div><div class="font-black text-slate-800 text-sm">${h.a}</div>${!h.ok ? `<div class="text-xs font-medium text-red-400 line-through mt-0.5">${h.u}</div>` : ''}</div></div>`).join('');
             }
             switchScreen('result');
        };

        const nextQuestion = () => {
             toggleModal(els.feedback.overlay, els.feedback.overlay.firstElementChild, null, false);
             gameState.currentIdx++;
             if(gameState.currentIdx >= gameState.data.length) finishGame();
             else { updateUI(); if (gameState.mode !== 'scramble' && gameState.mode !== 'reading' && gameState.mode !== 'roleplay') { setTimeout(() => els.inputs.answer.focus(), 100); } }
        };

        const getRandomSubTopic = () => { const c = Object.keys(nopdTopics); const rc = c[Math.floor(Math.random() * c.length)]; const t = nopdTopics[rc]; return t[Math.floor(Math.random() * t.length)].en; };

        const generateContent = async (type) => {
            const qty = parseInt(els.config.qtyInput.value); const rawLevel = els.config.level.value;
            els.loading.overlay.classList.remove('hidden'); els.loading.text.textContent = "ƒêANG T·∫†O B√ÄI H·ªåC...";
            gameState.mode = type; gameState.isReviewMode = false;

            let context = "", displayTitle = "";
            if (currentGlobalTopic) { context = currentGlobalTopic; displayTitle = currentGlobalTopic; }
            else {
                 let rawInput = (els.inputs.vocabTopic.value || "").trim();
                 if (type === 'vocab' || type === 'phrases' || type === 'idioms' || type === 'listening' || type === 'scramble' || type === 'roleplay') {
                    if(!rawInput) { context = "Mixed Topics"; displayTitle = "T·ªïng h·ª£p"; } else { context = rawInput; displayTitle = context; }
                 }
                 else if (type === 'reading') { context = els.inputs.readingSelect.value || getRandomSubTopic(); displayTitle = context; }
                 else if (type === 'grammar') {
                     let t = els.inputs.grammarTense.value;
                     if(t === 'random') { context = "Mixed Tenses"; displayTitle = "T·ªïng h·ª£p 12 th√¨"; } else { context = t; displayTitle = t; }
                 }
                 else if (type === 'forms') {
                     let t = els.inputs.formsType.value;
                     if(t === 'random') { context = "Mixed Word Forms"; displayTitle = "Bi·∫øn th·ªÉ t·ªïng h·ª£p"; } else { context = t; displayTitle = formReadableNames[t] || t; }
                 }
            }

            let prompt = "";
            let levelPrompt = "";
            if(rawLevel === 'Level A') levelPrompt = "A1 (Basic)";
            else if(rawLevel === 'Level B') levelPrompt = "B1 (Intermediate)";
            else if(rawLevel === 'Level C') levelPrompt = "C1 (Advanced)";
            else if(rawLevel === 'Level TOEIC') levelPrompt = "TOEIC (Business English, Workplace context)";
            else if(rawLevel === 'Level IELTS') levelPrompt = "IELTS (Academic, Formal context)";

            const topicInjection = currentGlobalTopic ? `Topic: '${currentGlobalTopic}'.` : "";
            const randomSeed = Math.floor(Math.random() * 10000);

            if (type === 'vocab') {
                prompt = `List ${qty} English words (Level ${levelPrompt}) about '${context}'. ${topicInjection}
                Response: JSON Array ONLY.
                Format: [{"vi":"<DIRECT_TRANSLATION>","en":"<word>","others":"<synonyms>"}]
                RULES:
                1. 'vi' MUST be direct meaning. NO definitions.
                   (Good: "apple"->"qu·∫£ t√°o", "run"->"ch·∫°y". Bad: "fruit"->"m·ªôt lo·∫°i qu·∫£")
                2. Random order. Seed: ${randomSeed}.`;
            }
            else if (type === 'phrases') {
                prompt = `List ${qty} English phrases/collocations (Level ${levelPrompt}) about '${context}'. ${topicInjection}
                Response: JSON Array ONLY.
                Format: [{"vi":"<DIRECT_MEANING>","en":"<phrase>","others":"<synonyms>"}]
                RULES:
                1. 'vi' MUST be exact meaning. NO descriptions.
                   (Good: "give up"->"t·ª´ b·ªè". Bad: "give up"->"h√†nh ƒë·ªông ng·ª´ng c·ªë g·∫Øng")
                2. Random order. Seed: ${randomSeed}.`;
            }
            else if (type === 'idioms') {
                prompt = `List ${qty} English idioms (Level ${levelPrompt}) about '${context}'.
                Response: JSON Array ONLY.
                Format: [{"vi":"<figurative_meaning_VN>","en":"<idiom>","others":"<literal_meaning>"}]
                Seed: ${randomSeed}.`;
            }
            else if (type === 'listening') {
                prompt = `List ${qty} English words/phrases for listening (Level ${levelPrompt}) about '${context}'.
                Response: JSON Array ONLY.
                Format: [{"vi":"<DIRECT_MEANING>","en":"<text>","others":"..."}]
                RULE: 'vi' must be short, exact translation. NO descriptions.
                Seed: ${randomSeed}.`;
            }
            else if (type === 'scramble') {
                prompt = `Create ${qty} English sentences (5-12 words, Level ${levelPrompt}) about '${context}'.
                Response: JSON Array ONLY.
                Format: [{"vi":"<VN_translation>","en":"<English_sentence>"}]
                RULE: Natural English grammar.
                Seed: ${randomSeed}.`;
            }
            else if (type === 'reading') {
                prompt = `Create ${qty} short reading MCQs (Level ${levelPrompt}) about '${context}'.
                Response: JSON Array ONLY.
                Format: [{"passage":"<text>","question":"<text>","answer":"<correct_opt>","options":["<opt1>","<opt2>","..."],"type":"mc","explanation":"<VN_reason>"}]
                Seed: ${randomSeed}.`;
            }
            else if (type === 'grammar') {
                prompt = `Create ${qty} grammar fill-in-blank questions (Level ${levelPrompt}) on topic: ${context}.
                Response: JSON Array ONLY.
                Format: [{"question":"She ___ (go) home.","verb":"go","answer":"goes","explanation":"<VN_reason>"}]
                RULE: 'answer' is the conjugated verb only.
                Seed: ${randomSeed}.`;
            }
            else if (type === 'forms') {
                prompt = `Create ${qty} Word Form questions (Level ${levelPrompt}) on topic: ${context}.
                Response: JSON Array ONLY.
                Format: [{"question":"<word> (Noun/Adj/...)","answer":"<derived_word>","explanation":"<VN_reason>"}]
                Seed: ${randomSeed}.`;
            }
            else if (type === 'roleplay') {
                let pc = context === "Mixed Topics" ? "ordering coffee" : `${context}`;
                prompt = `Create Roleplay Scenario: ${pc}. Level ${levelPrompt}.
                JSON Output: { "scenario": "Short description", "aiRole": "AI's role", "userRole": "User's role", "aiFirstMessage": "Opening line" }`;
            }

            try {
                const aiResult = await callServerAI(prompt);
                if (type === 'roleplay') {
                    gameState.roleplayContext = aiResult;
                    gameState.data = [];
                    els.game.chatHistory.innerHTML = '';
                    if (currentGlobalTopic) displayTitle = `${currentGlobalTopic} (Sticky)`;
                    els.game.title.textContent = `ROLEPLAY: ${aiResult.scenario}`;
                    startGame();
                    els.loading.overlay.classList.add('hidden');
                    return;
                }
                if (type !== 'reading') aiResult.sort(() => Math.random() - 0.5);
                gameState.data = aiResult;
                if (currentGlobalTopic) displayTitle = `${currentGlobalTopic} (Sticky)`;
                els.game.title.textContent = `${type.toUpperCase()}: ${displayTitle}`;
                startGame(); els.loading.overlay.classList.add('hidden');
            } catch(e) {
                console.error(e);
                if (type === 'roleplay') { alert("Kh√¥ng th·ªÉ kh·ªüi t·∫°o Roleplay do l·ªói Server."); els.loading.overlay.classList.add('hidden'); return; }
                let source = [];
                if (type === 'grammar' && context === 'Mixed Tenses') Object.values(offlineData.grammar).forEach(arr => source = source.concat(arr));
                else if (type === 'forms' && context === 'Mixed Word Forms') Object.values(offlineData.forms).forEach(arr => source = source.concat(arr));
                else if (offlineData[type] && offlineData[type][context]) source = offlineData[type][context];
                else if (offlineData[type]) source = Object.values(offlineData[type]).flat();
                if(!source.length && type==='vocab') source = offlineData.vocab["Daily Life"];
                let finalData = []; while(finalData.length < qty && source.length > 0) finalData = finalData.concat([...source].sort(()=>0.5-Math.random()));
                gameState.data = finalData.slice(0, qty); els.game.title.textContent = `${displayTitle} (Offline)`;
                startGame(); els.loading.overlay.classList.add('hidden');
            }
        };

        const startGame = () => { gameState.currentIdx = 0; gameState.score = 0; comboCount = 0; gameState.history = []; els.game.totalQ.textContent = gameState.data.length || 10; switchScreen('game'); updateUI(); };
        const startGeneration = () => { const activeCard = document.querySelector('.mode-card.active'); let mode = 'vocab'; if (activeCard) { mode = activeCard.id.replace('mode-', ''); } generateContent(mode); };
        const startReview = () => {
             const wrongIndices = gameState.history.map((h, i) => h.ok ? -1 : i).filter(i => i !== -1);
             if (wrongIndices.length === 0) return;
             gameState.data = wrongIndices.map(i => gameState.data[i]); gameState.isReviewMode = false; els.game.title.textContent += " (Review)"; startGame();
        };
        const startDailyReview = () => {
             const data = UserSystem.data.wrongAnswers;
             if (!data || data.length === 0) { alert("Kho sai l·∫ßm tr·ªëng!"); return; }
             gameState.data = data.slice(0, 15); gameState.isReviewMode = true; els.game.title.textContent = "√în T·∫≠p Sai L·∫ßm"; startGame();
        };
        const playTTS = () => { if(gameState.currentCorrect) { const u = new SpeechSynthesisUtterance(gameState.currentCorrect); u.lang = 'en-US'; u.rate = 0.9; speechSynthesis.speak(u); } };
        function isVietnamese(str) { return /[√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë]/i.test(str); }

        const lookupDictionary = async () => {
            const word = els.dict.input.value.trim(); if (!word) return;
            els.dict.result.innerHTML = '<div class="flex flex-col items-center justify-center h-48"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mb-2"></div><p class="text-xs text-gray-500 font-bold">ƒêang tra c·ª©u...</p></div>';
            try {
                if (isVietnamese(word)) {
                    const data = await robustFetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=vi|en`);
                    if (data.responseStatus === 200) els.dict.result.innerHTML = `<div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 animate-fadeIn"><h2 class="text-2xl font-black text-gray-800 mb-1">${word}</h2><p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">VIETNAMESE</p><div class="border-t border-gray-100 pt-4"><p class="font-bold text-indigo-600 text-xl">${data.responseData.translatedText}</p><p class="text-xs text-gray-400 mt-1">English Translation</p></div></div>`;
                    else els.dict.result.innerHTML = `<div class="p-4 text-center text-red-400 font-bold">Kh√¥ng t√¨m th·∫•y b·∫£n d·ªãch.</div>`;
                } else {
                    let freeApiData = null, translation = null;
                    try { const dictData = await robustFetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`); freeApiData = dictData[0]; } catch (e) {}
                    try { const transData = await robustFetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=en|vi`); if (transData.responseStatus === 200) translation = transData.responseData.translatedText; } catch (e) {}
                    if (!freeApiData && !translation) { els.dict.result.innerHTML = `<div class="text-center p-4 text-gray-400 font-medium">Kh√¥ng t√¨m th·∫•y t·ª´ n√†y.</div>`; return; }
                    let html = `<div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 animate-fadeIn"><div class="flex items-center justify-between mb-2"><h2 class="text-3xl font-black text-gray-800 capitalize">${freeApiData ? freeApiData.word : word}</h2>`;
                    if (freeApiData) { const audioSrc = freeApiData.phonetics.find(p => p.audio)?.audio; if (audioSrc) html += `<button onclick="new Audio('${audioSrc}').play()" class="w-10 h-10 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center hover:bg-orange-200 transition-colors"><i class="fas fa-volume-up"></i></button>`; }
                    html += `</div>`;
                    if (freeApiData) { const phonetic = freeApiData.phonetic || (freeApiData.phonetics.find(p => p.text)?.text) || ""; html += `<p class="text-orange-500 font-mono text-sm mb-6 font-bold">${phonetic}</p>`; }
                    if (translation) html += `<div class="mb-6 bg-green-50 p-4 rounded-2xl border border-green-100"><p class="text-[10px] text-green-800 font-black uppercase tracking-widest mb-1">NGHƒ®A TI·∫æNG VI·ªÜT</p><p class="text-xl font-bold text-gray-800">${translation}</p></div>`;
                    if (freeApiData && freeApiData.meanings) { html += `<div class="mb-2"><h3 class="font-bold text-gray-700 text-sm uppercase tracking-wider border-b border-gray-100 pb-2 mb-3">ƒê·ªãnh nghƒ©a (Anh-Anh)</h3><ul class="list-disc pl-5 text-sm text-gray-600 space-y-2 leading-relaxed">`; const defs = freeApiData.meanings[0].definitions.slice(0, 3); defs.forEach(d => { html += `<li>${d.definition}</li>`; }); html += `</ul></div>`; }
                    html += `</div>`; els.dict.result.innerHTML = html;
                }
            } catch (e) { els.dict.result.innerHTML = `<div class="text-center p-4 text-red-500 font-bold">L·ªói k·∫øt n·ªëi ho·∫∑c API qu√° t·∫£i.</div>`; }
        };

        const renderTheoryAI = (data) => {
            let html = `<div class="animate-fadeIn pb-10">`;

            // 1. Title & Definition
            html += `<h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-700 to-purple-600 mb-4 pb-2 border-b border-gray-100">${data.title || "Ki·∫øn th·ª©c"}</h2>`;
            if(data.overview) html += `<div class="bg-blue-50/50 p-4 rounded-2xl border border-blue-100 mb-6 text-gray-700 leading-relaxed font-medium shadow-sm"><i class="fas fa-info-circle text-blue-500 mr-2"></i>${data.overview}</div>`;

            // 2. Formulas (Formatted nicely)
            if(data.formula && data.formula.length > 0) {
                html += `<div class="mb-8">
                            <h3 class="text-sm font-black text-gray-400 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fas fa-flask text-indigo-500"></i> C√îNG TH·ª®C</h3>
                            <div class="grid gap-3">`;
                data.formula.forEach(f => {
                    let colorClass = "bg-white border-gray-200 text-gray-700";
                    let iconClass = "text-gray-400";
                    if(f.type === 'positive') { colorClass = "bg-green-50/50 border-green-200 text-green-900"; iconClass = "text-green-600"; }
                    else if(f.type === 'negative') { colorClass = "bg-red-50/50 border-red-200 text-red-900"; iconClass = "text-red-500"; }
                    else if(f.type === 'question') { colorClass = "bg-indigo-50/50 border-indigo-200 text-indigo-900"; iconClass = "text-indigo-600"; }

                    html += `<div class="${colorClass} p-4 rounded-xl border flex items-center gap-4 shadow-sm transition-transform hover:scale-[1.01]">
                                <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm font-black ${iconClass}">${f.label}</div>
                                <div class="font-mono font-bold text-sm md:text-base tracking-wide">${f.struct}</div>
                             </div>`;
                });
                html += `   </div>
                         </div>`;
            }

            // 3. Usage
            if(data.usage && data.usage.length > 0) {
                 html += `<div class="mb-8">
                            <h3 class="text-sm font-black text-gray-400 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fas fa-lightbulb text-yellow-500"></i> C√ÅCH D√ôNG</h3>
                            <ul class="space-y-3">`;
                 data.usage.forEach(u => {
                     html += `<li class="flex items-start gap-3 bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                                <i class="fas fa-check text-green-500 mt-1"></i>
                                <span class="text-gray-700 text-sm leading-relaxed font-medium">${u}</span>
                              </li>`;
                 });
                 html += `  </ul>
                          </div>`;
            }

            // 4. Signs
            if(data.signs && data.signs.length > 0) {
                html += `<div class="mb-8">
                            <h3 class="text-sm font-black text-gray-400 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fas fa-eye text-pink-500"></i> D·∫§U HI·ªÜU NH·∫¨N BI·∫æT</h3>
                            <div class="flex flex-wrap gap-2">`;
                data.signs.forEach(s => {
                    html += `<span class="bg-pink-50 text-pink-700 px-3 py-1.5 rounded-lg border border-pink-100 text-xs font-bold shadow-sm">${s}</span>`;
                });
                html += `   </div>
                         </div>`;
            }

            // 5. Examples
            if(data.examples && data.examples.length > 0) {
                html += `<div class="mb-6">
                            <h3 class="text-sm font-black text-gray-400 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fas fa-quote-left text-gray-400"></i> V√ç D·ª§ MINH H·ªåA</h3>
                            <div class="space-y-3">`;
                data.examples.forEach(ex => {
                    html += `<div class="bg-gray-50 p-4 rounded-xl border-l-4 border-indigo-500 italic">
                                <p class="text-indigo-900 font-semibold mb-1">"${ex.en}"</p>
                                <p class="text-gray-500 text-xs">${ex.vi}</p>
                             </div>`;
                });
                html += `   </div>
                         </div>`;
            }

            html += `</div>`;
            return html;
        };

        const loadTheory = async (topic, type) => {
             els.theory.listGrammar.classList.add('hidden');
             els.theory.listForms.classList.add('hidden');
             els.theory.detail.classList.remove('hidden');

             // 1. Show Loading State Immediately (Optimistic UI)
             els.theory.contentText.innerHTML = `
                <div class="flex flex-col items-center justify-center h-64 animate-pulse">
                    <div class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-magic text-indigo-500 text-2xl animate-bounce"></i>
                    </div>
                    <p class="text-sm font-bold text-gray-800 mb-1">ƒêang g·ªçi AI...</p>
                    <p class="text-xs text-gray-400">ƒêang t·ªïng h·ª£p ki·∫øn th·ª©c chi ti·∫øt cho b·∫°n</p>
                </div>
             `;

             const friendlyName = formReadableNames[topic] || topic;

             // 2. FORCE AI CALL - NO EARLY RETURN for offline data
             try {
                 let prompt = "";
                 if (type === 'forms') {
                     prompt = `Explain English Word Form topic: "${friendlyName}".
                     Target Audience: Vietnamese learners.
                     Response Format: JSON ONLY (No Markdown).
                     Structure:
                     {
                       "title": "Vietnamese Title for ${friendlyName}",
                       "overview": "Short definition/introduction in Vietnamese",
                       "usage": ["Usage rule 1", "Usage rule 2"],
                       "formula": [
                         {"type": "positive", "label": "Structure", "struct": "Formula or Rule"}
                       ],
                       "signs": ["Signal word 1", "Signal word 2"],
                       "examples": [{"en": "English example", "vi": "Vietnamese translation"}]
                     }`;
                 } else {
                     prompt = `Explain English Grammar topic: "${topic}".
                     Target Audience: Vietnamese learners.
                     Response Format: JSON ONLY (No Markdown).
                     Structure:
                     {
                       "title": "Vietnamese Title for ${topic}",
                       "overview": "Short definition/introduction in Vietnamese",
                       "usage": ["Usage rule 1", "Usage rule 2"],
                       "formula": [
                         {"type": "positive", "label": "(+)", "struct": "S + V..."},
                         {"type": "negative", "label": "(-)", "struct": "S + ..."},
                         {"type": "question", "label": "(?)", "struct": "..."}
                       ],
                       "signs": ["yesterday", "ago", "last week"],
                       "examples": [{"en": "English example", "vi": "Vietnamese translation"}]
                     }`;
                 }

                 const jsonData = await callServerAI(prompt);
                 // 3. Render Beautiful AI Result
                 els.theory.contentText.innerHTML = renderTheoryAI(jsonData);

             } catch(e) {
                 console.error("AI Theory Error", e);
                 // 4. Smart Fallback: Use offline data only if AI fails
                 const offlineContent = offlineData.theory[topic];
                 if (offlineContent) {
                     els.theory.contentText.innerHTML = `
                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-100 text-yellow-700 text-xs mb-4 flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i> K·∫øt n·ªëi AI gi√°n ƒëo·∫°n. Hi·ªÉn th·ªã d·ªØ li·ªáu offline.
                        </div>
                        <div class="animate-fadeIn">${offlineContent.content || "N·ªôi dung ƒëang c·∫≠p nh·∫≠t."}</div>
                     `;
                 } else {
                     els.theory.contentText.innerHTML = `
                        <div class="text-center p-8">
                            <div class="inline-block p-4 bg-red-50 rounded-full text-red-500 mb-3"><i class="fas fa-wifi-slash text-2xl"></i></div>
                            <h3 class="font-bold text-gray-800 mb-1">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</h3>
                            <p class="text-xs text-gray-500 mb-4">Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† th·ª≠ l·∫°i.</p>
                            <button onclick="loadTheory('${topic}', '${type}')" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-all">Th·ª≠ l·∫°i ngay</button>
                        </div>
                     `;
                 }
             }
        };

        let theoryTab = 'grammar';
        const switchTheoryTab = (tab) => {
            theoryTab = tab;
            els.theory.tabs.grammar.className = tab==='grammar' ? 'flex-1 md:w-full text-center md:text-left px-3 py-2 rounded-lg font-bold text-xs md:text-sm bg-indigo-100 text-indigo-700 whitespace-nowrap' : 'flex-1 md:w-full text-center md:text-left px-3 py-2 rounded-lg font-bold text-xs md:text-sm text-gray-500 hover:bg-gray-100 whitespace-nowrap';
            els.theory.tabs.forms.className = tab==='forms' ? 'flex-1 md:w-full text-center md:text-left px-3 py-2 rounded-lg font-bold text-xs md:text-sm bg-indigo-100 text-indigo-700 whitespace-nowrap' : 'flex-1 md:w-full text-center md:text-left px-3 py-2 rounded-lg font-bold text-xs md:text-sm text-gray-500 hover:bg-gray-100 whitespace-nowrap';
            els.theory.listGrammar.classList.toggle('hidden', tab !== 'grammar');
            els.theory.listForms.classList.toggle('hidden', tab !== 'forms');
            els.theory.detail.classList.add('hidden');
            const dataSrc = tab === 'grammar' ? offlineData.grammar : offlineData.forms;
            const container = tab === 'grammar' ? els.theory.listGrammar : els.theory.listForms;
            const keys = Object.keys(dataSrc);
            container.innerHTML = keys.map(t => `<div onclick="loadTheory('${t}', '${tab}')" class="p-3 bg-white rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:bg-gray-50 hover:border-indigo-200 transition-all flex justify-between items-center group active:scale-95"><span class="font-bold text-gray-700 text-sm group-hover:text-indigo-600 transition-colors">${tab === 'forms' ? (formReadableNames[t] || t) : `${t} <span class="text-[10px] font-normal text-gray-500 ml-1 block sm:inline">(${tenseTranslations[t] || ''})</span>`}</span><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div>`).join('');
        };
        const backToTheoryList = () => { els.theory.detail.classList.add('hidden'); if(theoryTab === 'grammar') els.theory.listGrammar.classList.remove('hidden'); else els.theory.listForms.classList.remove('hidden'); };

        // [SECTION: EVENT LISTENERS & INIT]
        Object.assign(window, {
            openTopicModal, closeTopicModal, selectTopic, clearTopic,
            openDictModal, closeDictModal, lookupDictionary,
            switchTheoryTab, openTheoryModal, closeTheoryModal, backToTheoryList, loadTheory,
            toggleSettings, updateLevel, setMode, switchScreen, resetGame,
            checkExamAnswer, submitChat, nextQuestion, startGeneration, playTTS, startReview, startDailyReview, finishGame
        });
        document.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !els.feedback.overlay.classList.contains('hidden')) { e.preventDefault(); nextQuestion(); } });
        els.dict.input.addEventListener('keydown', (e) => { if(e.key === 'Enter') { lookupDictionary(); } });
        els.game.scrambleContainer.addEventListener('keydown', (e) => { if(e.key === 'Enter') checkExamAnswer(); });

        const keyInputs = [els.inputs.answer, els.inputs.vocabTopic];
        keyInputs.forEach(input => {
            if(input) {
                input.addEventListener('focus', () => {
                    document.body.classList.add('keyboard-open');
                    if(!els.screens.game.classList.contains('hidden')) {
                         setTimeout(() => {
                             const wrapper = document.getElementById('gameDisplayWrapper');
                             if(wrapper) wrapper.scrollIntoView({behavior: "smooth", block: "end"});
                         }, 300);
                    }
                });
                input.addEventListener('blur', () => {
                    document.body.classList.remove('keyboard-open');
                });
            }
        });

        try {
            checkKeyStatus();
            UserSystem.load();
            if (els.inputs.grammarTense) {
                let html = '<option value="random">üé≤ T·ªïng h·ª£p (Mixed Tenses)</option>';
                html += Object.keys(offlineData.grammar).map(t => `<option value="${t}">${t} (${tenseTranslations[t] || ''})</option>`).join('');
                els.inputs.grammarTense.innerHTML = html;
            }
            if (els.inputs.formsType) {
                let html = '<option value="random">üé≤ T·ªïng h·ª£p (Mixed Forms)</option>';
                html += Object.keys(offlineData.forms).map(t => `<option value="${t}">${formReadableNames[t] || t}</option>`).join('');
                els.inputs.formsType.innerHTML = html;
            }
            setMode('vocab');
            els.config.qtyInput.addEventListener('input', (e) => {
                els.config.qtyDisplay.textContent = `${e.target.value}`;
                UserSystem.save();
            });
        } catch (e) { console.error("Initialization Error:", e); }
    </script>
</body>
</html>
