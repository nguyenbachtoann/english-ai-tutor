<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>AI Tutor: v1.1.3</title>

    <!-- PWA Setup -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI Tutor">
    <meta name="theme-color" content="#FFFBEB">

    <link rel="apple-touch-icon" id="apple-icon" href="">
    <link rel="icon" id="fav-icon" type="image/png" href="">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --app-height: 100%;
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
        }

        /* 1. KH√ìA CH·∫∂T BODY & HTML */
        html { height: 100%; width: 100%; overflow: hidden; overscroll-behavior: none; position: fixed; }
        body {
            height: 100%; width: 100%; position: fixed; top: 0; left: 0;
            overflow: hidden; font-family: 'Quicksand', sans-serif;
            background-color: #FFFBEB; -webkit-tap-highlight-color: transparent; touch-action: none;
        }

        /* 2. APP SHELL */
        #app-viewport {
            position: absolute; left: 0; width: 100%; height: 100%; top: 0;
            display: flex; flex-direction: column;
            background-color: #FFFBEB; overflow: hidden; z-index: 1; will-change: height, top;
        }

        /* --- 3. LOGIC ULTRA COMPACT & KEYBOARD --- */

        @media (max-height: 550px) {
            #mainHeader { display: none !important; }
        }

        body.keyboard-mode #mainHeader { display: none !important; }
        body.keyboard-mode #gameScreen { padding-top: 0 !important; }
        body.keyboard-mode #gameDisplayWrapper {
            justify-content: flex-end;
            padding-bottom: 0 !important;
        }

        /* Font ch·ªØ si√™u nh·ªè khi g√µ ph√≠m */
        body.keyboard-mode #mainDisplay {
            font-size: 0.85rem !important;
            line-height: 1.15 !important;
            margin-bottom: 0 !important;
            padding: 0 0.5rem;
        }

        /* Reading Passage Compact Mode */
        body.keyboard-mode #readingPassageDisplay {
            max-height: 80px !important; /* Thu nh·ªè ƒëo·∫°n vƒÉn khi hi·ªán ph√≠m */
            font-size: 0.75rem !important;
            padding: 0.5rem !important;
        }

        body.keyboard-mode #listeningDisplay button { width: 2rem !important; height: 2rem !important; font-size: 0.9rem !important; margin-bottom: 0 !important; }
        body.keyboard-mode #listeningDisplay p { display: none; }

        body.keyboard-mode #instructionText {
            font-size: 0.45rem !important;
            margin-bottom: 0 !important;
            padding: 0 0.3rem !important;
            opacity: 0.6;
            height: 14px; display: flex; align-items: center;
        }

        body.keyboard-mode .game-content-box { min-height: 0 !important; padding: 0.15rem 0 !important; gap: 0.1rem !important; }
        body.keyboard-mode #subDisplay { font-size: 0.6rem !important; padding: 0 0.3rem !important; margin-top: 0 !important; }

        /* ULTRA COMPACT INPUT AREA */
        body.keyboard-mode #inputContainer { padding: 0.2rem 0.5rem !important; border-top: 1px solid rgba(0,0,0,0.03); }
        body.keyboard-mode #answerInput { height: 1.85rem !important; padding: 0 0.6rem !important; font-size: 0.85rem !important; border-radius: 0.4rem !important; border-width: 1px !important; }
        body.keyboard-mode #checkBtn { width: 1.85rem !important; height: 1.85rem !important; border-radius: 0.4rem !important; font-size: 0.7rem !important; }

        /* Reading Options Buttons (hidden in keyboard mode usually, or made tiny) */
        body.keyboard-mode #quickOptions { display: none !important; }

        /* --- UTILS --- */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #F59E0B; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .level-card { transition: all 0.2s; border: 2px solid transparent; }
        .level-card.selected { border-color: #F59E0B; background-color: #FFFBEB; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.1); }

        .screen-fade { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .no-shrink { flex-shrink: 0; }
        .scrollable-content { flex-grow: 1; flex-shrink: 1; min-height: 0; overflow-y: auto; overflow-x: hidden; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }

        .input-focus:focus-within { border-color: #FBBF24; box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.2); }
        select { background-image: none !important; }

        .speaker-pulse { animation: speakerPulse 1.5s infinite; }
        @keyframes speakerPulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(245, 158, 11, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }

        .ai-status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-online { background-color: #10B981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
        .status-offline { background-color: #9CA3AF; box-shadow: 0 0 0 2px rgba(156, 163, 175, 0.2); }

        /* Reading Passage Styles */
        .reading-passage-box {
            background-color: #fffbeb;
            border: 2px solid #fde68a;
            border-radius: 12px;
            padding: 12px;
            font-size: 0.9rem;
            color: #4b5563;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
            text-align: left;
            line-height: 1.5;
            width: 100%;
        }
        .option-chip {
            transition: all 0.2s;
            cursor: pointer;
            border: 2px solid #e5e7eb;
        }
        .option-chip:active {
            transform: scale(0.95);
        }
        .option-selected {
            background-color: #FEF3C7 !important;
            border-color: #F59E0B !important;
            color: #92400E !important;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.3);
            font-weight: 800;
        }
        .btn-expanded {
            width: 100% !important;
            border-radius: 1.5rem !important;
        }

        /* NEW MODE CARD STYLES */
        .mode-card {
            transition: all 0.2s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .mode-card:active { transform: scale(0.97); }
        .mode-card.active {
            border-color: #F59E0B;
            background-color: #FFFBEB;
            box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.15);
        }
        .mode-card.active .mode-icon { background-color: #FEF3C7; color: #D97706; }

        .mode-icon {
            transition: all 0.2s;
        }
    </style>
</head>
<body>
    <div id="app-viewport">
        <!-- HEADER -->
        <div id="mainHeader" class="no-shrink px-4 pb-3 pt-[calc(env(safe-area-inset-top)+0.75rem)] bg-[#FFFBEB] flex justify-between items-center z-30 border-b border-yellow-100/50">
            <div class="flex items-center gap-3">
                <button onclick="resetGame()" class="w-10 h-10 flex items-center justify-center text-yellow-800 bg-white rounded-full shadow-sm active:scale-90 transition-transform"><i class="fas fa-home"></i></button>
                <div class="flex flex-col cursor-pointer" onclick="resetGame()">
                    <div class="flex items-baseline gap-1">
                        <h1 class="text-xl font-extrabold text-yellow-900 tracking-tight flex items-center gap-1"><span class="text-2xl filter drop-shadow-sm">ü•ë</span> AI Tutor</h1>
                    </div>
                    <div id="aiStatusBadge" class="flex items-center text-[10px] font-bold text-gray-400 leading-none mt-0.5 ml-1">
                        <span id="aiStatusDot" class="ai-status-dot status-offline"></span>
                        <span id="aiStatusText">OFFLINE</span>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="openDictModal()" class="w-10 h-10 flex items-center justify-center text-yellow-700 bg-white rounded-full shadow-sm active:scale-90 transition-transform"><i class="fas fa-search"></i></button>
                <button onclick="openTheoryModal()" class="w-10 h-10 flex items-center justify-center text-indigo-600 bg-white rounded-full shadow-sm active:scale-90 transition-transform"><i class="fas fa-book-open"></i></button>
                <button onclick="toggleSettings()" class="w-10 h-10 flex items-center justify-center text-gray-600 bg-white rounded-full shadow-sm active:scale-90 transition-transform"><i class="fas fa-cog"></i></button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div id="mainContent" class="flex-1 flex flex-col relative overflow-hidden w-full bg-[#FFFBEB]">

            <!-- START SCREEN -->
            <div id="startScreen" class="flex-1 flex flex-col h-full scrollable-content custom-scroll p-4 w-full screen-fade">

                <div id="startScreenContent" class="w-full max-w-md mx-auto flex-1 flex flex-col pb-20">

                    <!-- NEW: MODE SELECTION GRID (Replaces Tab Bar) -->
                    <div class="mb-4">
                        <label class="text-[10px] font-bold text-gray-400 tracking-wider uppercase mb-2 block ml-1">CH·ªåN CH·∫æ ƒê·ªò H·ªåC</label>
                        <div class="grid grid-cols-2 gap-2" id="modeGrid">
                            <!-- Words & Phrases -->
                            <div onclick="setMode('vocab')" id="mode-vocab" class="mode-card bg-white p-3 rounded-2xl flex items-center gap-3 shadow-sm active">
                                <div class="mode-icon w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center text-lg"><i class="fas fa-font"></i></div>
                                <div><h3 class="text-sm font-bold text-gray-800">T·ª´ V·ª±ng</h3><p class="text-[9px] text-gray-400 font-semibold">T·ª´ ƒë∆°n</p></div>
                            </div>
                            <div onclick="setMode('phrases')" id="mode-phrases" class="mode-card bg-white p-3 rounded-2xl flex items-center gap-3 shadow-sm">
                                <div class="mode-icon w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-lg"><i class="fas fa-quote-right"></i></div>
                                <div><h3 class="text-sm font-bold text-gray-800">C·ª•m T·ª´</h3><p class="text-[9px] text-gray-400 font-semibold">Phrases</p></div>
                            </div>
                            <!-- Idioms & Listening -->
                            <div onclick="setMode('idioms')" id="mode-idioms" class="mode-card bg-white p-3 rounded-2xl flex items-center gap-3 shadow-sm">
                                <div class="mode-icon w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center text-lg"><i class="fas fa-dragon"></i></div>
                                <div><h3 class="text-sm font-bold text-gray-800">T·ª•c Ng·ªØ</h3><p class="text-[9px] text-gray-400 font-semibold">Proverbs</p></div>
                            </div>
                            <div onclick="setMode('listening')" id="mode-listening" class="mode-card bg-white p-3 rounded-2xl flex items-center gap-3 shadow-sm">
                                <div class="mode-icon w-10 h-10 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center text-lg"><i class="fas fa-headphones"></i></div>
                                <div><h3 class="text-sm font-bold text-gray-800">Luy·ªán Nghe</h3><p class="text-[9px] text-gray-400 font-semibold">Dictation</p></div>
                            </div>
                            <!-- Skills -->
                            <div onclick="setMode('reading')" id="mode-reading" class="mode-card bg-white p-3 rounded-2xl flex items-center gap-3 shadow-sm">
                                <div class="mode-icon w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-lg"><i class="fas fa-book-open"></i></div>
                                <div><h3 class="text-sm font-bold text-gray-800">ƒê·ªçc Hi·ªÉu</h3><p class="text-[9px] text-gray-400 font-semibold">Reading</p></div>
                            </div>
                            <div onclick="setMode('grammar')" id="mode-grammar" class="mode-card bg-white p-3 rounded-2xl flex items-center gap-3 shadow-sm">
                                <div class="mode-icon w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-lg"><i class="fas fa-pen-nib"></i></div>
                                <div><h3 class="text-sm font-bold text-gray-800">Ng·ªØ Ph√°p</h3><p class="text-[9px] text-gray-400 font-semibold">Chia ƒê·ªông T·ª´</p></div>
                            </div>
                            <!-- Forms (Full width) -->
                            <div onclick="setMode('forms')" id="mode-forms" class="mode-card bg-white p-3 rounded-2xl flex items-center gap-3 shadow-sm col-span-2">
                                <div class="mode-icon w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-lg"><i class="fas fa-random"></i></div>
                                <div><h3 class="text-sm font-bold text-gray-800">Bi·∫øn Th·ªÉ T·ª´ (Word Forms)</h3><p class="text-[9px] text-gray-400 font-semibold">Noun, Verb, Adjective...</p></div>
                            </div>
                        </div>
                    </div>

                    <!-- INPUT AREAS -->
                    <div id="inputAreaWrapper" class="bg-white p-4 rounded-3xl shadow-sm border border-gray-100 mb-4 transition-all">

                        <!-- Header for Input Area -->
                        <div class="flex items-center gap-2 mb-3">
                            <i id="inputIcon" class="fas fa-lightbulb text-yellow-500"></i>
                            <h3 id="inputTitle" class="text-sm font-bold text-gray-700">Ch·ªß ƒë·ªÅ t·ª´ v·ª±ng</h3>
                        </div>

                        <!-- 1. Shared Input (Vocab, Phrases, Idioms, Listening) -->
                        <div id="sharedInputArea" class="w-full animate-fadeIn">
                            <div id="onlineVocabInput" class="w-full input-focus rounded-xl transition-all duration-200">
                                <input type="text" id="vocabTopicInput" placeholder="Nh·∫≠p ch·ªß ƒë·ªÅ (VD: Travel, Food)..." class="w-full p-3 bg-gray-50 border-2 border-transparent text-center text-sm font-bold text-gray-800 rounded-xl focus:bg-white focus:border-yellow-400 focus:outline-none placeholder-gray-400">
                            </div>
                            <div id="offlineVocabSelect" class="w-full hidden"><div class="relative w-full"><select id="vocabTopicSelect" class="w-full p-3 bg-gray-50 border-none rounded-xl text-sm font-bold text-center text-gray-700 appearance-none focus:ring-0"></select><div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-xs"><i class="fas fa-chevron-down"></i></div></div></div>
                        </div>

                        <!-- 2. Reading Input -->
                        <div id="viewReading" class="hidden w-full animate-fadeIn">
                             <div class="relative w-full"><input type="text" id="readingTopicInput" placeholder="Ch·ªß ƒë·ªÅ b√†i ƒë·ªçc..." class="w-full p-3 bg-gray-50 border-2 border-transparent text-center text-sm font-bold text-gray-800 rounded-xl focus:bg-white focus:border-blue-400 focus:outline-none placeholder-gray-400 hidden"></div>
                             <div class="relative w-full" id="readingSelectWrapper"><select id="readingTopicSelect" class="w-full p-3 bg-gray-50 border-none rounded-xl text-sm font-bold text-center text-gray-700 appearance-none focus:outline-none"></select><div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-xs"><i class="fas fa-chevron-down"></i></div></div>
                        </div>

                        <!-- 3. Grammar Input -->
                        <div id="viewGrammar" class="hidden w-full animate-fadeIn">
                            <div class="relative w-full"><select id="grammarTenseSelect" class="w-full p-3 bg-gray-50 border-none rounded-xl text-sm font-bold text-center text-gray-700 appearance-none focus:outline-none"></select><div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-xs"><i class="fas fa-chevron-down"></i></div></div>
                        </div>

                        <!-- 4. Forms Input -->
                        <div id="viewForms" class="hidden w-full animate-fadeIn">
                            <div class="relative w-full"><select id="formsTypeSelect" class="w-full p-3 bg-gray-50 border-none rounded-xl text-sm font-bold text-center text-gray-700 appearance-none focus:outline-none"></select><div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-xs"><i class="fas fa-chevron-down"></i></div></div>
                        </div>
                    </div>

                    <!-- START BUTTON -->
                    <button onclick="startGeneration()" id="startBtn" class="w-full bg-gray-900 text-white font-bold text-base py-3 rounded-2xl shadow-lg shadow-gray-300/50 active:scale-[0.98] transition-all flex items-center justify-center gap-2 mb-6">
                        <i class="fas fa-play text-yellow-400"></i> B·∫Øt ƒê·∫ßu
                    </button>

                    <!-- COMPACT CONFIG SECTION -->
                    <div id="configSection" class="w-full bg-white p-4 rounded-2xl shadow-sm border border-gray-100 transition-all">
                        <input type="hidden" id="levelSelect" value="Level A">
                        <div class="flex justify-between items-center mb-2"><label class="text-[10px] font-bold text-gray-400 tracking-wider uppercase">ƒê·ªô kh√≥</label></div>

                        <!-- Level Grid Compact -->
                        <div class="grid grid-cols-3 gap-1.5 mb-1.5">
                            <div onclick="updateLevel('Level A', this)" class="level-card selected cursor-pointer py-2 rounded-xl bg-gray-50 text-center"><div class="text-base mb-0.5">üå±</div><div class="text-[9px] font-bold text-gray-600">Level A</div></div>
                            <div onclick="updateLevel('Level B', this)" class="level-card cursor-pointer py-2 rounded-xl bg-gray-50 text-center"><div class="text-base mb-0.5">üåø</div><div class="text-[9px] font-bold text-gray-600">Level B</div></div>
                            <div onclick="updateLevel('Level C', this)" class="level-card cursor-pointer py-2 rounded-xl bg-gray-50 text-center"><div class="text-base mb-0.5">üå≥</div><div class="text-[9px] font-bold text-gray-600">Level C</div></div>
                        </div>
                        <div class="grid grid-cols-2 gap-1.5 mb-4">
                            <div onclick="updateLevel('TOEIC', this)" class="level-card cursor-pointer py-2 rounded-xl bg-gray-50 text-center"><div class="text-base mb-0.5">üíº</div><div class="text-[9px] font-bold text-gray-600">TOEIC</div></div>
                            <div onclick="updateLevel('IELTS', this)" class="level-card cursor-pointer py-2 rounded-xl bg-gray-50 text-center"><div class="text-base mb-0.5">üéì</div><div class="text-[9px] font-bold text-gray-600">IELTS</div></div>
                        </div>

                        <!-- Quantity Slider Compact -->
                        <div class="flex justify-between items-center mb-1"><label class="text-[10px] font-bold text-gray-400 tracking-wider">S·ªê L∆Ø·ª¢NG C√ÇU H·ªéI</label><span id="qtyDisplay" class="text-[10px] font-bold text-white bg-gray-800 px-1.5 py-0.5 rounded">10</span></div>
                        <input type="range" id="quantityRange" min="5" max="30" step="5" value="10" class="w-full h-1.5 bg-gray-100 rounded-lg appearance-none cursor-pointer accent-yellow-500 hover:accent-yellow-400">
                    </div>

                    <!-- SUBTLE VERSION INDICATOR -->
                    <div class="w-full flex justify-end mt-1 pr-1">
                        <span class="text-[0.5rem] text-gray-300 font-mono select-none">v1.1.3</span>
                    </div>

                </div>
            </div>

            <!-- GAME SCREEN (UPDATED COMPACT UI) -->
            <div id="gameScreen" class="hidden flex-1 flex flex-col h-full w-full screen-fade bg-white">
                <div class="no-shrink px-4 pt-2 pb-1 bg-white z-10 transition-all border-b border-gray-50">
                    <div id="gameHeader" class="flex justify-between items-center mb-1.5 transition-all">
                        <span class="font-bold text-gray-400 text-[10px] uppercase tracking-wider truncate max-w-[60%]" id="gameTitle">General</span>
                        <div class="bg-gray-100 px-2 py-0.5 rounded-full text-[10px] font-bold text-gray-600 flex items-center gap-1">
                            <i class="fas fa-flag text-yellow-500"></i> <span id="currentQ">1</span>/<span id="totalQ">10</span>
                        </div>
                    </div>
                    <div id="progressBarContainer" class="w-full bg-gray-100 rounded-full h-1 overflow-hidden transition-all"><div id="progressBar" class="bg-yellow-400 h-full rounded-full transition-all duration-500 ease-out shadow-[0_0_10px_rgba(250,204,21,0.5)]" style="width: 10%"></div></div>
                </div>

                <div id="gameDisplayWrapper" class="scrollable-content px-4 w-full flex items-center justify-center">
                    <div class="game-content-box w-full flex flex-col items-center py-4 justify-center min-h-[100px] transition-all">
                        <span id="instructionText" class="text-[9px] font-bold text-gray-300 uppercase tracking-[0.2em] mb-2 bg-gray-50 px-3 py-1 rounded-full transition-all">Translate</span>

                        <!-- READING PASSAGE AREA (Hidden by default) -->
                        <div id="readingPassageDisplay" class="reading-passage-box hidden custom-scroll">
                            This is where the reading passage will go. It can be quite long so we need it to scroll if necessary.
                        </div>

                        <!-- Extra Compact Main Display -->
                        <h2 id="mainDisplay" class="text-xl sm:text-2xl font-black text-center text-gray-800 mb-2 leading-tight break-words max-w-full drop-shadow-sm transition-all">Loading...</h2>

                        <!-- Smaller Listening Icon -->
                        <div id="listeningDisplay" class="hidden flex flex-col items-center">
                            <button onclick="playTTS()" class="w-16 h-16 rounded-full bg-pink-100 text-pink-500 flex items-center justify-center text-2xl shadow-md active:scale-95 transition-transform mb-2 speaker-pulse"><i class="fas fa-volume-up"></i></button>
                            <p class="text-gray-400 text-[10px] font-bold">Tap to listen</p>
                        </div>

                        <p id="subDisplay" class="text-indigo-500 font-bold text-xs hidden bg-indigo-50 px-3 py-1 rounded-lg mt-1 animate-bounce-slow border border-indigo-100 transition-all">(hint)</p>

                        <!-- Quick Options for Reading/Quiz -->
                        <div id="quickOptions" class="hidden flex-wrap justify-center gap-2 mt-2 w-full">
                            <!-- JS will inject buttons here -->
                        </div>
                    </div>
                </div>

                <!-- COMPACT INPUT ROW (Size decreased) -->
                <div id="inputContainer" class="no-shrink p-2 bg-white border-t border-gray-50 w-full z-10 shadow-[0_-5px_20px_rgba(0,0,0,0.02)] transition-all">
                    <div class="flex items-center gap-2 w-full">
                        <div class="relative flex-1 group" id="inputWrapper">
                            <input type="text" id="answerInput" class="w-full bg-gray-50 border-2 border-transparent text-base font-bold py-2.5 px-4 rounded-xl focus:outline-none focus:bg-white focus:border-yellow-400 transition-all shadow-inner placeholder-gray-300" placeholder="Nh·∫≠p ƒë√°p √°n..." autocomplete="off">
                        </div>
                        <!-- N√∫t check linh ho·∫°t -->
                        <button id="checkBtn" onclick="checkAnswer()" class="no-shrink w-11 h-11 bg-gray-900 text-white text-base rounded-xl shadow-lg shadow-gray-400/30 active:scale-[0.9] transition-all flex items-center justify-center hover:bg-black">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- RESULT SCREEN -->
            <div id="resultScreen" class="hidden flex-1 flex flex-col h-full scrollable-content custom-scroll p-6 text-center screen-fade bg-[#FFFBEB]">
                <div class="flex-1 flex flex-col items-center justify-center w-full max-w-md mx-auto">
                    <div class="relative mb-6">
                        <div class="absolute inset-0 bg-yellow-300 blur-2xl opacity-30 rounded-full"></div>
                        <div class="text-7xl relative animate-bounce">üèÜ</div>
                    </div>
                    <h2 class="text-3xl font-black mb-2 text-gray-800">Ho√†n th√†nh!</h2>
                    <div class="flex items-center gap-3 mb-8 bg-white px-6 py-3 rounded-full border border-yellow-100 shadow-sm">
                         <span class="text-gray-400 text-xs font-bold uppercase tracking-wider">Score</span>
                         <div class="flex items-baseline gap-1">
                            <span id="finalScore" class="font-black text-yellow-500 text-2xl">0</span>
                            <span class="text-gray-300 text-lg">/</span>
                            <span id="totalScoreQ" class="font-bold text-gray-400 text-lg">10</span>
                         </div>
                    </div>
                    <div id="resultList" class="w-full bg-white rounded-3xl border border-white p-2 mb-4 overflow-y-auto max-h-[50vh] custom-scroll text-left shadow-lg shadow-yellow-100/50"></div>
                </div>
                <button onclick="resetGame()" class="w-full bg-gray-900 text-white font-bold py-4 rounded-3xl shadow-lg active:scale-95 no-shrink mb-8"><i class="fas fa-redo mr-2"></i> Ch∆°i l·∫°i</button>
            </div>
        </div>

        <!-- MODALS (Settings, Dict, Theory, etc...) -->
        <div id="settingsPanel" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm pointer-events-auto transition-opacity duration-300 opacity-0" id="settingsBackdrop" onclick="toggleSettings()"></div>
            <div class="bg-white w-full sm:w-[28rem] rounded-t-3xl sm:rounded-3xl p-6 pointer-events-auto transform transition-transform duration-300 translate-y-full safe-pb" id="settingsContent">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fas fa-cog text-gray-400"></i> C√†i ƒë·∫∑t</h2>
                <label class="block text-xs font-bold text-indigo-900 uppercase tracking-wider mb-2">Google Gemini API Key</label>
                <div class="relative mb-4">
                    <input type="password" id="userApiKeyInput" class="w-full p-4 bg-gray-50 border-2 border-transparent focus:border-indigo-500 focus:bg-white rounded-2xl text-sm font-medium transition-all outline-none" placeholder="Paste key here...">
                    <div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"><i class="fas fa-key"></i></div>
                </div>
                <button onclick="saveApiKey()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl hover:bg-indigo-700 shadow-lg shadow-indigo-200">L∆∞u Key</button>
                <p id="keyStatus" class="text-xs mt-4 text-center text-gray-400 font-medium">Ch∆∞a k·∫øt n·ªëi</p>
            </div>
        </div>

        <div id="dictModal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm pointer-events-auto transition-opacity duration-300 opacity-0" id="dictBackdrop" onclick="closeDictModal()"></div>
            <div class="bg-white w-full sm:w-[28rem] h-[85vh] sm:h-[80vh] rounded-t-3xl sm:rounded-3xl flex flex-col pointer-events-auto transform transition-transform duration-300 translate-y-full" id="dictContent">
                <div class="p-4 border-b flex items-center justify-between">
                    <h2 class="font-bold text-lg text-orange-600 flex items-center gap-2"><i class="fas fa-language"></i> T·ª´ ƒêi·ªÉn</h2>
                    <button onclick="closeDictModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-4 bg-gray-50"><div class="relative"><input type="text" id="dictInput" class="w-full pl-11 pr-12 py-3.5 bg-white border-none shadow-sm rounded-2xl font-bold text-gray-700 placeholder-gray-400 focus:ring-2 focus:ring-orange-200" placeholder="Nh·∫≠p t·ª´ c·∫ßn tra..."><i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-300"></i><button onclick="lookupDictionary()" class="absolute right-2 top-2 p-1.5 bg-orange-100 text-orange-600 rounded-xl"><i class="fas fa-arrow-right"></i></button></div></div>
                <div class="flex-1 overflow-y-auto p-5" id="dictResultArea"><div class="text-center text-gray-400 mt-10"><i class="fas fa-book text-4xl mb-2 opacity-20"></i><p class="text-sm">Tra t·ª´ Anh-Vi·ªát / Vi·ªát-Anh</p></div></div>
            </div>
        </div>

        <div id="theoryModal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm pointer-events-auto transition-opacity duration-300 opacity-0" id="theoryBackdrop" onclick="closeTheoryModal()"></div>
            <div class="bg-white w-full sm:w-[28rem] h-[85vh] sm:h-[80vh] rounded-t-3xl sm:rounded-3xl flex flex-col pointer-events-auto transform transition-transform duration-300 translate-y-full" id="theoryContentPanel">
                <div class="p-4 border-b flex items-center justify-between bg-indigo-50/50 rounded-t-3xl">
                    <h2 class="font-bold text-lg text-indigo-900 flex items-center gap-2"><i class="fas fa-graduation-cap"></i> S·ªï tay</h2>
                    <button onclick="closeTheoryModal()" class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-gray-500 shadow-sm"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex p-2 gap-2 bg-white border-b" id="theoryTabs">
                    <button onclick="switchTheoryTab('grammar')" id="btnTheoryGrammar" class="flex-1 py-2.5 rounded-xl text-xs font-bold bg-indigo-100 text-indigo-700 transition-colors">12 Th√¨</button>
                    <button onclick="switchTheoryTab('forms')" id="btnTheoryForms" class="flex-1 py-2.5 rounded-xl text-xs font-bold text-gray-500 hover:bg-gray-50 transition-colors">Bi·∫øn th·ªÉ</button>
                </div>
                <div class="flex-1 overflow-y-auto p-4 bg-gray-50" id="theoryContent">
                    <div id="theoryListGrammar" class="space-y-2"></div>
                    <div id="theoryListForms" class="hidden space-y-2"></div>
                    <div id="theoryDetail" class="hidden h-full flex flex-col">
                        <button onclick="backToTheoryList()" class="mb-4 bg-white px-4 py-2 rounded-xl shadow-sm w-fit text-xs font-bold text-gray-600 border border-gray-100"><i class="fas fa-arrow-left mr-1"></i> Quay l·∫°i</button>
                        <div id="theoryDetailContent" class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 text-sm leading-relaxed text-gray-700"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="loadingOverlay" class="hidden absolute inset-0 bg-white/90 z-[60] flex flex-col items-center justify-center backdrop-blur-sm"><div class="loader mb-4"></div><p id="loadingText" class="text-gray-600 font-bold text-sm tracking-wide animate-pulse">ƒêANG X·ª¨ L√ù...</p></div>

        <div id="feedbackOverlay" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center pointer-events-none">
            <div class="absolute inset-0 bg-white/95 backdrop-blur-md pointer-events-auto animate-fadeIn"></div>
            <div class="relative z-10 flex flex-col items-center justify-center w-full max-w-sm p-6 text-center pointer-events-auto">
                <div id="feedbackIcon" class="text-7xl mb-4 filter drop-shadow-md transform transition-transform hover:scale-110 duration-300">üéâ</div>
                <h3 id="feedbackTitle" class="text-3xl font-black mb-6 tracking-tight">Ch√≠nh x√°c!</h3>
                <div class="bg-white rounded-3xl p-6 w-full mb-8 border border-gray-100 shadow-xl relative overflow-hidden group">
                    <div class="absolute top-0 left-0 w-2 h-full bg-green-500 transition-all group-hover:w-3" id="feedbackBorder"></div>
                    <p class="text-gray-400 text-[10px] uppercase font-black tracking-[0.2em] mb-3">ƒê√ÅP √ÅN ƒê√öNG</p>
                    <div class="flex flex-col items-center gap-4">
                        <span id="correctAnswerText" class="text-3xl font-black text-gray-800 break-words leading-tight">Answer</span>
                        <button onclick="playTTS()" class="w-12 h-12 rounded-full bg-gray-50 border border-gray-200 text-gray-600 flex items-center justify-center shadow-sm active:scale-90 transition-transform"><i class="fas fa-volume-up text-lg"></i></button>
                    </div>
                    <p id="synonymText" class="text-xs text-gray-500 mt-3 hidden bg-gray-50 p-2 rounded-lg italic border-t border-gray-100 pt-2 w-full text-center"></p>
                    <p id="grammarExplanation" class="text-sm text-indigo-600 mt-5 pt-4 border-t border-gray-100 italic hidden text-left bg-indigo-50/50 -mx-6 -mb-6 p-6"></p>
                </div>
                <button onclick="nextQuestion(); document.getElementById('answerInput').focus();" class="w-full bg-gray-900 text-white font-bold text-lg py-4 rounded-3xl shadow-xl shadow-gray-400/40 active:scale-95 transition-transform flex items-center justify-center group">Ti·∫øp t·ª•c <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i></button>
            </div>
        </div>

    </div>

    <script type="module">
        (function setupPWA() {
            // HIGH QUALITY ICON GENERATION
            const canvas = document.createElement('canvas');
            canvas.width = 1024; // High resolution
            canvas.height = 1024;
            const ctx = canvas.getContext('2d');

            // 1. Background: Vibrant Gradient (Amber Theme)
            const grd = ctx.createLinearGradient(0, 0, 1024, 1024);
            grd.addColorStop(0, '#FCD34D'); // Amber 300
            grd.addColorStop(1, '#D97706'); // Amber 600
            ctx.fillStyle = grd;
            ctx.fillRect(0, 0, 1024, 1024);

            // 2. Decorative Circle (Subtle)
            ctx.beginPath();
            ctx.arc(512, 512, 400, 0, 2 * Math.PI);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.fill();

            // 3. Main Icon (Avocado) - Center Aligned
            ctx.font = '600px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            // Offset Y slightly for visual centering
            ctx.fillText('ü•ë', 512, 540);

            const url = canvas.toDataURL('image/png');
            const appleIcon = document.getElementById('apple-icon');
            const favIcon = document.getElementById('fav-icon');
            if (appleIcon) appleIcon.href = url;
            if (favIcon) favIcon.href = url;
        })();

        if (window.visualViewport) {
            function handleVisualResize() {
                const appViewport = document.getElementById('app-viewport');
                const height = window.visualViewport.height;
                const offsetTop = window.visualViewport.offsetTop;

                appViewport.style.height = `${height}px`;
                appViewport.style.top = `${offsetTop}px`;

                if (height < window.innerHeight * 0.75) {
                    document.body.classList.add('keyboard-mode');
                    setTimeout(() => {
                        const activeEl = document.activeElement;
                        if(activeEl && activeEl.id === 'answerInput' && !activeEl.closest('#inputWrapper').classList.contains('hidden')) {
                            activeEl.scrollIntoView({block: "end", behavior: "smooth"});
                        }
                    }, 50);
                } else {
                    document.body.classList.remove('keyboard-mode');
                }
            }
            window.visualViewport.addEventListener('resize', handleVisualResize);
            window.visualViewport.addEventListener('scroll', handleVisualResize);
            handleVisualResize();
        }

        // --- FULL OFFLINE DATA (UPDATED WITH VIETNAMESE EXPLANATIONS) ---
        const offlineData = {
            vocab: { "Daily Life": [{vi: "C√† ph√™", en: "coffee", others: "java, joe"}, {vi: "M√°y t√≠nh", en: "computer", others: "pc, laptop"}, {vi: "S√°ch", en: "book", others: "volume, novel"}, {vi: "B√∫t", en: "pen", others: "biro, marker"}, {vi: "Tr∆∞·ªùng h·ªçc", en: "school", others: "academy, institution"}, {vi: "B·∫°n b√®", en: "friend", others: "pal, mate"}, {vi: "Gia ƒë√¨nh", en: "family", others: "kin, relatives"}, {vi: "N∆∞·ªõc", en: "water", others: "h2o, liquid"}, {vi: "Th·ª©c ƒÉn", en: "food", others: "meal, dish"}, {vi: "Ti·ªÅn", en: "money", others: "cash, fund"}, {vi: "C·ª≠a", en: "door", others: "gate, entrance"}, {vi: "Gh·∫ø", en: "chair", others: "seat, stool"}, {vi: "B√†n", en: "table", others: "desk, counter"}, {vi: "Th√†nh ph·ªë", en: "city", others: "town, urban"}, {vi: "C√¥ng vi·ªác", en: "job", others: "work, career"}, {vi: "Gi∆∞·ªùng ng·ªß", en: "bed", others: "bunk, cot"}, {vi: "B·∫øp", en: "kitchen", others: "cookhouse, galley"}, {vi: "ƒêi·ªán tho·∫°i", en: "phone", others: "mobile, cell"}, {vi: "Xe bu√Ωt", en: "bus", others: "coach, transit"}, {vi: "B·ªØa s√°ng", en: "breakfast", others: "morning meal"}], "Work & Business": [{vi: "Ph√°t tri·ªÉn", en: "develop", others: "grow, expand"}, {vi: "Th√†nh t·ª±u", en: "achievement", others: "success, feat"}, {vi: "Th·ª≠ th√°ch", en: "challenge", others: "test, trial"}, {vi: "M√¥i tr∆∞·ªùng", en: "environment", others: "surroundings, setting"}, {vi: "X√£ h·ªôi", en: "society", others: "community, public"}, {vi: "Kinh t·∫ø", en: "economy", others: "wealth, market"}, {vi: "VƒÉn h√≥a", en: "culture", others: "tradition, custom"}, {vi: "Gi·∫£i ph√°p", en: "solution", others: "answer, fix"}, {vi: "C∆° h·ªôi", en: "opportunity", others: "chance, break"}, {vi: "Ki·∫øn th·ª©c", en: "knowledge", others: "learning, wisdom"}, {vi: "Kinh nghi·ªám", en: "experience", others: "skill, practice"}, {vi: "Quy·∫øt ƒë·ªãnh", en: "decision", others: "choice, ruling"}, {vi: "·∫¢nh h∆∞·ªüng", en: "influence", others: "effect, impact"}, {vi: "C√¥ng ngh·ªá", en: "technology", others: "tech, gear"}, {vi: "S√°ng t·∫°o", en: "creative", others: "inventive, artistic"}, {vi: "Th·ªã tr∆∞·ªùng", en: "market", others: "bazaar, mart"}, {vi: "Kh√°ch h√†ng", en: "customer", others: "client, buyer"}, {vi: "ƒê·∫ßu t∆∞", en: "investment", others: "funding, stake"}, {vi: "L·ª£i nhu·∫≠n", en: "profit", others: "gain, return"}, {vi: "Qu·∫£n l√Ω", en: "management", others: "admin, control"}], "Academic & IELTS": [{vi: "To√†n di·ªán", en: "comprehensive", others: "complete, thorough"}, {vi: "ƒê√°ng k·ªÉ", en: "significant", others: "notable, major"}, {vi: "S√¢u s·∫Øc", en: "profound", others: "deep, intense"}, {vi: "M∆° h·ªì", en: "ambiguous", others: "vague, unclear"}, {vi: "T·ªâ m·ªâ", en: "meticulous", others: "detailed, exact"}, {vi: "B·ªÅn v·ªØng", en: "sustainable", others: "viable, green"}, {vi: "Thi·∫øt y·∫øu", en: "indispensable", others: "crucial, vital"}, {vi: "L·ªói th·ªùi", en: "obsolete", others: "outdated, old"}, {vi: "Th·ªãnh v∆∞·ª£ng", en: "prosperous", others: "rich, wealthy"}, {vi: "B·∫•t l·ª£i", en: "detrimental", others: "harmful, bad"}, {vi: "Thuy·∫øt ph·ª•c", en: "persuasive", others: "convincing, strong"}, {vi: "Nh·∫•t qu√°n", en: "consistent", others: "steady, constant"}, {vi: "Kh√≥ n·∫Øm b·∫Øt", en: "elusive", others: "tricky, slippery"}, {vi: "Tinh t·∫ø", en: "exquisite", others: "delicate, fine"}, {vi: "Ki√™n c∆∞·ªùng", en: "resilient", others: "tough, strong"}, {vi: "Gi·∫£m nh·∫π", en: "mitigate", others: "lessen, ease"}, {vi: "L√†m tr·∫ßm tr·ªçng", en: "exacerbate", others: "worsen, aggravate"}, {vi: "Ph·ªï bi·∫øn", en: "prevalent", others: "common, widespread"}, {vi: "B·∫•t b√¨nh ƒë·∫≥ng", en: "inequality", others: "unfairness, bias"}, {vi: "ƒê√¥ th·ªã h√≥a", en: "urbanization", others: "development, growth"}], "Travel & Food": [{vi: "H√†nh l√Ω", en: "luggage", others: "baggage, cases"}, {vi: "H·ªô chi·∫øu", en: "passport", others: "id, pass"}, {vi: "ƒê·∫∑t ph√≤ng", en: "reservation", others: "booking, order"}, {vi: "Th·ª±c ƒë∆°n", en: "menu", others: "card, list"}, {vi: "Ngon", en: "delicious", others: "tasty, yummy"}, {vi: "S√¢n bay", en: "airport", others: "airfield, strip"}, {vi: "Kh√°ch s·∫°n", en: "hotel", others: "inn, lodge"}, {vi: "B·∫£n ƒë·ªì", en: "map", others: "chart, plan"}, {vi: "Du kh√°ch", en: "tourist", others: "visitor, traveler"}, {vi: "Chuy·∫øn bay", en: "flight", others: "trip, air travel"}, {vi: "ƒê·∫∑c s·∫£n", en: "specialty", others: "delicacy, treat"}, {vi: "Cay", en: "spicy", others: "hot, piquant"}, {vi: "M·∫∑n", en: "salty", others: "briny, savory"}, {vi: "Ng·ªçt", en: "sweet", others: "sugary, honeyed"}, {vi: "Chua", en: "sour", others: "acid, tart"}] },
            phrases: { "General": [{vi: "B·ªè cu·ªôc", en: "give up", others: "quit, surrender"}, {vi: "ChƒÉm s√≥c", en: "look after", others: "take care of"}, {vi: "T√¨m ki·∫øm", en: "look for", others: "search, seek"}, {vi: "Ti·∫øp t·ª•c", en: "carry on", others: "continue"}, {vi: "H·ªßy b·ªè", en: "call off", others: "cancel"}] },
            idioms: { "General": [{vi: "M·ªôt m≈©i t√™n tr√∫ng hai ƒë√≠ch", en: "kill two birds with one stone", others: ""}, {vi: "M∆∞a nh∆∞ tr√∫t n∆∞·ªõc", en: "raining cats and dogs", others: ""}, {vi: "D·ªÖ nh∆∞ ƒÉn b√°nh", en: "piece of cake", others: "easy as pie"}, {vi: "T·ªët g·ªó h∆°n t·ªët n∆∞·ªõc s∆°n", en: "don't judge a book by its cover", others: ""}] },
            grammar: {
                "Present Simple": [{question: "She usually ___ (walk) to work.", verb: "walk", answer: "walks", explanation: "Th√≥i quen ·ªü hi·ªán t·∫°i (She -> V+s)."}, {question: "The sun ___ (rise) in the East.", verb: "rise", answer: "rises", explanation: "S·ª± th·∫≠t hi·ªÉn nhi√™n."}],
                "Present Continuous": [{question: "Look! It ___ (rain) outside.", verb: "rain", answer: "is raining", explanation: "ƒêang x·∫£y ra l√∫c n√≥i (Look!)."}, {question: "I ___ (study) now.", verb: "study", answer: "am studying", explanation: "ƒêang di·ªÖn ra (now)."}],
                "Present Perfect": [{question: "I ___ (see) that movie twice.", verb: "see", answer: "have seen", explanation: "Kinh nghi·ªám trong qu√° kh·ª©."}],
                "Present Perfect Continuous": [{question: "It ___ (rain) for 3 hours.", verb: "rain", answer: "has been raining", explanation: "Nh·∫•n m·∫°nh qu√° tr√¨nh li√™n t·ª•c."}],
                "Past Simple": [{question: "I ___ (go) to the cinema yesterday.", verb: "go", answer: "went", explanation: "ƒê√£ x·∫£y ra v√† k·∫øt th√∫c (yesterday)."}],
                "Past Continuous": [{question: "I ___ (read) when he came.", verb: "read", answer: "was reading", explanation: "ƒêang x·∫£y ra th√¨ h√†nh ƒë·ªông kh√°c xen v√†o."}],
                "Past Perfect": [{question: "When I arrived, the train ___ (leave).", verb: "leave", answer: "had left", explanation: "X·∫£y ra tr∆∞·ªõc 1 h√†nh ƒë·ªông QK kh√°c."}],
                "Past Perfect Continuous": [{question: "He was tired because he ___ (work) all day.", verb: "work", answer: "had been working", explanation: "Nguy√™n nh√¢n c·ªßa tr·∫°ng th√°i QK."}],
                "Future Simple": [{question: "I think it ___ (rain) tomorrow.", verb: "rain", answer: "will rain", explanation: "D·ª± ƒëo√°n kh√¥ng cƒÉn c·ª©."}],
                "Future Continuous": [{question: "At 9 AM tomorrow, I ___ (work).", verb: "work", answer: "will be working", explanation: "Th·ªùi ƒëi·ªÉm c·ª• th·ªÉ trong TL."}],
                "Future Perfect": [{question: "By next year, I ___ (graduate).", verb: "graduate", answer: "will have graduated", explanation: "Ho√†n th√†nh tr∆∞·ªõc m·ªëc TL (By)."}],
                "Future Perfect Continuous": [{question: "By 2030, I ___ (teach) for 20 years.", verb: "teach", answer: "will have been teaching", explanation: "Qu√° tr√¨nh t√≠nh ƒë·∫øn m·ªëc TL."}]
            },
            forms: {
                "irregular": [{question: "go (V2)", answer: "went", explanation: "go - went - gone"}, {question: "buy (V2)", answer: "bought", explanation: "buy - bought - bought"}],
                "irregular_v3": [{question: "go (V3)", answer: "gone", explanation: "go - went - gone"}, {question: "write (V3)", answer: "written", explanation: "write - wrote - written"}],
                "noun_suffix": [{question: "inform (Noun -tion)", answer: "information", explanation: "Th√™m -ation."}, {question: "develop (Noun -ment)", answer: "development", explanation: "Th√™m -ment."}],
                "adj_suffix": [{question: "beauty (Adj -ful)", answer: "beautiful", explanation: "y -> i + ful."}, {question: "care (Adj -less)", answer: "careless", explanation: "Th√™m -less."}],
                "prefixes": [{question: "happy (Prefix: not)", answer: "unhappy", explanation: "Th√™m un-."}, {question: "agree (Prefix: not)", answer: "disagree", explanation: "Th√™m dis-."}],
                "verb_noun": [{question: "decide (Noun)", answer: "decision", explanation: "de -> sion."}, {question: "arrive (Noun)", answer: "arrival", explanation: "e -> al."}],
                "noun_adj": [{question: "danger (Adj)", answer: "dangerous", explanation: "+ ous."}, {question: "fame (Adj)", answer: "famous", explanation: "e -> ous."}],
                "adj_adv": [{question: "quick (Adv)", answer: "quickly", explanation: "+ ly."}, {question: "happy (Adv)", "answer": "happily", explanation: "y -> i + ly."}],
                "ing": [{question: "run", answer: "running", explanation: "G·∫•p ƒë√¥i ph·ª• √¢m."}, {question: "swim", answer: "swimming", explanation: "G·∫•p ƒë√¥i ph·ª• √¢m."}],
                "ed": [{question: "stop", answer: "stopped", explanation: "G·∫•p ƒë√¥i ph·ª• √¢m."}, {question: "plan", answer: "planned", explanation: "G·∫•p ƒë√¥i ph·ª• √¢m."}],
                "classify": [{question: "She runs [fast]. (Type?)", answer: "adverb", explanation: "B·ªï nghƒ©a cho ƒë·ªông t·ª´ runs."}, {question: "It is a [fast] car. (Type?)", "answer": "adjective", explanation: "B·ªï nghƒ©a cho danh t·ª´ car."}]
            },
            reading: {
                "Daily Life": [
                    {passage: "My name is John. I wake up at 6 AM every day. I brush my teeth and have breakfast. I usually eat bread and drink coffee. Then, I go to work by bus.", question: "What time does John wake up?", answer: "6 AM", options: ["6 AM", "7 AM", "8 AM"], type: "mc", explanation: "Trong b√†i c√≥ c√¢u: 'I wake up at 6 AM'."},
                    {passage: "Sarah loves to read books. Her favorite genre is fantasy. She reads about dragons and magic castles. Every weekend, she visits the local library to borrow new books.", question: "Sarah hates reading books.", answer: "False", options: ["True", "False"], type: "tf", explanation: "Trong b√†i c√≥ c√¢u: 'Sarah loves to read books' (Sarah th√≠ch ƒë·ªçc s√°ch)."},
                    {passage: "Tom has a dog named Max. Max is a golden retriever. He is very friendly and loves to play fetch in the park.", question: "Max is a ___ retriever.", answer: "golden", options: ["golden", "black", "white"], type: "cloze", explanation: "Trong b√†i c√≥ c√¢u: 'Max is a golden retriever'."}
                ],
                "Technology": [
                    {passage: "The internet has changed how we communicate. We can send emails instantly. Video calls allow us to see friends far away. However, too much screen time can be bad for our eyes.", question: "Video calls allow us to see friends ___.", answer: "far away", options: ["nearby", "far away", "next door"], type: "mc", explanation: "Trong b√†i c√≥ c√¢u: 'Video calls allow us to see friends far away'."},
                    {passage: "Artificial Intelligence (AI) is becoming popular. It helps machines learn from data. Some people worry about AI taking jobs, while others think it will create new opportunities.", question: "AI stands for Artificial Intelligence.", answer: "True", options: ["True", "False"], type: "tf", explanation: "Ki·∫øn th·ª©c chung/Ng·ªØ c·∫£nh √°m ch·ªâ AI l√† vi·∫øt t·∫Øt c·ªßa Artificial Intelligence."}
                ],
                "Tenses (Mixed)": [
                    {passage: "Last summer, I visited Paris. It was amazing. I ate croissants every morning. Now, I am back home, but I am planning to go again next year.", question: "When did the author visit Paris?", answer: "Last summer", options: ["Next year", "Last summer", "Now"], type: "mc", explanation: "C√¢u ƒë·∫ßu ti√™n: 'Last summer, I visited Paris' (M√πa h√® nƒÉm ngo√°i t√¥i ƒë√£ ƒëi Paris)."},
                    {passage: "John usually walks to work, but yesterday he drove because it was raining heavily. Today, the sun is shining, so he is walking again.", question: "Why did John drive yesterday?", answer: "It was raining", options: ["It was sunny", "He was tired", "It was raining"], type: "mc", explanation: "Trong b√†i c√≥ c√¢u: 'he drove because it was raining heavily' (anh ·∫•y l√°i xe v√¨ tr·ªùi m∆∞a to)."},
                    {passage: "She has lived here for ten years. She moved here in 2014. She still loves this city.", question: "She ___ here for ten years.", answer: "has lived", options: ["lives", "has lived", "lived"], type: "cloze", explanation: "Th√¨ hi·ªán t·∫°i ho√†n th√†nh d√πng cho kho·∫£ng th·ªùi gian: 'has lived'."}
                ],
                "Vocab (Context)": [
                    {passage: "The room was incredibly [cluttered]. There were books, clothes, and toys everywhere. It was hard to find a place to sit.", question: "What is the closest meaning to 'cluttered'?", answer: "messy", options: ["clean", "messy", "empty"], type: "mc", explanation: "Ng·ªØ c·∫£nh: 'books, clothes... everywhere' (s√°ch, qu·∫ßn √°o... kh·∫Øp n∆°i) √°m ch·ªâ b·ª´a b·ªôn (messy)."},
                    {passage: "The movie was [hilarious]. I laughed so hard that I cried. It was the best comedy I have seen in years.", question: "'Hilarious' means very ___.", answer: "funny", options: ["sad", "funny", "scary"], type: "cloze", explanation: "Ng·ªØ c·∫£nh: 'laughed so hard' (c∆∞·ªùi r·∫•t nhi·ªÅu) -> h√†i h∆∞·ªõc (funny)."},
                    {passage: "He felt [exhausted] after running the marathon. He could barely walk and needed to sleep immediately.", question: "True or False: He felt full of energy.", answer: "False", options: ["True", "False"], type: "tf", explanation: "'Exhausted' nghƒ©a l√† r·∫•t m·ªát, kh√¥ng ph·∫£i tr√†n ƒë·∫ßy nƒÉng l∆∞·ª£ng."}
                ],
                "Grammar (Cloze)": [
                    {passage: "London is famous ___ its red buses and black taxis. Many tourists visit the city every year.", question: "famous ___", answer: "for", options: ["of", "for", "with"], type: "cloze", explanation: "C·ª•m t·ª´ c·ªë ƒë·ªãnh: 'famous for' (n·ªïi ti·∫øng v·ªÅ)."},
                    {passage: "I enjoy ___ music in my free time. It helps me relax after a long day at work.", question: "I enjoy ___", answer: "listening to", options: ["listen to", "listening to", "listened to"], type: "mc", explanation: "C·∫•u tr√∫c: Enjoy + V-ing."},
                    {passage: "If it ___ tomorrow, we will stay at home and watch movies.", question: "If it ___", answer: "rains", options: ["rain", "rains", "will rain"], type: "cloze", explanation: "C√¢u ƒëi·ªÅu ki·ªán lo·∫°i 1: If + Hi·ªán t·∫°i ƒë∆°n."}
                ]
            },
            theory: {
                "Present Simple": { title: "Th√¨ Hi·ªán T·∫°i ƒê∆°n (Present Simple)", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono"><div class="mb-1"><span class="text-green-600 font-bold">(+)</span> S + V(s/es)</div><div class="mb-1"><span class="text-red-500 font-bold">(-)</span> S + do/does + not + V</div><div><span class="text-blue-500 font-bold">(?)</span> Do/Does + S + V?</div></div><h3 class="font-bold text-indigo-700 mb-2">2. C√°ch d√πng</h3><ul class="list-disc list-inside space-y-1 mb-4 text-gray-700"><li>Di·ªÖn t·∫£ th√≥i quen, h√†nh ƒë·ªông l·∫∑p ƒëi l·∫∑p l·∫°i.</li><li>Di·ªÖn t·∫£ s·ª± th·∫≠t hi·ªÉn nhi√™n.</li><li>L·ªãch tr√¨nh c·ªë ƒë·ªãnh.</li></ul><h3 class="font-bold text-indigo-700 mb-2">3. D·∫•u hi·ªáu</h3><p class="text-gray-700 italic">Always, usually, often, every day...</p>` },
                "Present Continuous": { title: "Th√¨ Hi·ªán T·∫°i Ti·∫øp Di·ªÖn", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono"><div class="mb-1"><span class="text-green-600 font-bold">(+)</span> S + am/is/are + V-ing</div></div><h3 class="font-bold text-indigo-700 mb-2">2. C√°ch d√πng</h3><ul class="list-disc list-inside space-y-1 mb-4 text-gray-700"><li>H√†nh ƒë·ªông ƒëang x·∫£y ra l√∫c n√≥i.</li><li>H√†nh ƒë·ªông ƒëang di·ªÖn ra xung quanh th·ªùi ƒëi·ªÉm n√≥i.</li></ul><h3 class="font-bold text-indigo-700 mb-2">3. D·∫•u hi·ªáu</h3><p class="text-gray-700 italic">Now, at the moment, Look!...</p>` },
                "Present Perfect": { title: "Th√¨ Hi·ªán T·∫°i Ho√†n Th√†nh", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono"><div class="mb-1"><span class="text-green-600 font-bold">(+)</span> S + have/has + V3/ed</div></div><h3 class="font-bold text-indigo-700 mb-2">2. C√°ch d√πng</h3><ul class="list-disc list-inside space-y-1 mb-4 text-gray-700"><li>H√†nh ƒë·ªông b·∫Øt ƒë·∫ßu trong QK k√©o d√†i ƒë·∫øn HT.</li><li>V·ª´a m·ªõi x·∫£y ra.</li><li>Kinh nghi·ªám.</li></ul><h3 class="font-bold text-indigo-700 mb-2">3. D·∫•u hi·ªáu</h3><p class="text-gray-700 italic">Just, recently, since, for, already, yet, so far...</p>` },
                "Present Perfect Continuous": { title: "HT Ho√†n Th√†nh Ti·∫øp Di·ªÖn", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + have/has + been + V-ing</div><p class="text-gray-700">Nh·∫•n m·∫°nh t√≠nh li√™n t·ª•c c·ªßa h√†nh ƒë·ªông t·ª´ QK ƒë·∫øn HT.</p>` },
                "Past Simple": { title: "Th√¨ Qu√° Kh·ª© ƒê∆°n", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + V2/ed</div><p class="text-gray-700">H√†nh ƒë·ªông ƒë√£ k·∫øt th√∫c trong qu√° kh·ª©. <br>DH: Yesterday, last week, ago.</p>` },
                "Past Continuous": { title: "Th√¨ Qu√° Kh·ª© Ti·∫øp Di·ªÖn", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + was/were + V-ing</div><p class="text-gray-700">H√†nh ƒë·ªông ƒëang x·∫£y ra t·∫°i 1 th·ªùi ƒëi·ªÉm trong QK.</p>` },
                "Past Perfect": { title: "Th√¨ Qu√° Kh·ª© Ho√†n Th√†nh", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + had + V3/ed</div><p class="text-gray-700">X·∫£y ra tr∆∞·ªõc m·ªôt h√†nh ƒë·ªông kh√°c trong QK.</p>` },
                "Past Perfect Continuous": { title: "QK Ho√†n Th√†nh Ti·∫øp Di·ªÖn", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + had + been + V-ing</div><p class="text-gray-700">Nh·∫•n m·∫°nh qu√° tr√¨nh x·∫£y ra tr∆∞·ªõc 1 h√†nh ƒë·ªông kh√°c trong QK.</p>` },
                "Future Simple": { title: "Th√¨ T∆∞∆°ng Lai ƒê∆°n", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + will + V</div><p class="text-gray-700">D·ª± ƒëo√°n, quy·∫øt ƒë·ªãnh t·ª©c th·ªùi. <br>DH: Tomorrow, next week.</p>` },
                "Future Continuous": { title: "Th√¨ T∆∞∆°ng Lai Ti·∫øp Di·ªÖn", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + will + be + V-ing</div><p class="text-gray-700">S·∫Ω ƒëang x·∫£y ra t·∫°i 1 th·ªùi ƒëi·ªÉm trong TL.</p>` },
                "Future Perfect": { title: "Th√¨ T∆∞∆°ng Lai Ho√†n Th√†nh", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + will + have + V3/ed</div><p class="text-gray-700">S·∫Ω ho√†n th√†nh tr∆∞·ªõc 1 th·ªùi ƒëi·ªÉm trong TL.</p>` },
                "Future Perfect Continuous": { title: "TL Ho√†n Th√†nh Ti·∫øp Di·ªÖn", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + will + have + been + V-ing</div><p class="text-gray-700">Nh·∫•n m·∫°nh qu√° tr√¨nh t√≠nh ƒë·∫øn 1 th·ªùi ƒëi·ªÉm trong TL.</p>` },
                "irregular": { title: "ƒê·ªông t·ª´ B·∫•t Quy T·∫Øc (V2)", content: `<p class="mb-2 text-gray-600">ƒê√¢y l√† c√°c ƒë·ªông t·ª´ kh√¥ng tu√¢n theo quy t·∫Øc th√™m -ed khi chuy·ªÉn sang qu√° kh·ª© ƒë∆°n.</p><table class="w-full text-sm text-left border rounded-lg overflow-hidden"><thead><tr class="bg-gray-100"><th class="p-2 border">V1 (Hi·ªán t·∫°i)</th><th class="p-2 border">V2 (Qu√° kh·ª©)</th></tr></thead><tbody><tr><td class="p-2 border">Go</td><td class="p-2 border">Went</td></tr><tr><td class="p-2 border">Buy</td><td class="p-2 border">Bought</td></tr><tr><td class="p-2 border">See</td><td class="p-2 border">Saw</td></tr><tr><td class="p-2 border">Do</td><td class="p-2 border">Did</td></tr><tr><td class="p-2 border">Have</td><td class="p-2 border">Had</td></tr></tbody></table>` },
                "irregular_v3": { title: "Qu√° kh·ª© ph√¢n t·ª´ (V3)", content: `<p class="mb-2 text-gray-600">D√πng trong c√°c th√¨ Ho√†n th√†nh (Perfect tenses) v√† C√¢u b·ªã ƒë·ªông.</p><table class="w-full text-sm text-left border rounded-lg overflow-hidden"><thead><tr class="bg-gray-100"><th class="p-2 border">V1</th><th class="p-2 border">V2</th><th class="p-2 border text-red-600 font-bold">V3</th></tr></thead><tbody><tr><td class="p-2 border">Go</td><td class="p-2 border">Went</td><td class="p-2 border text-red-600">Gone</td></tr><tr><td class="p-2 border">Eat</td><td class="p-2 border">Ate</td><td class="p-2 border text-red-600">Eaten</td></tr><tr><td class="p-2 border">Write</td><td class="p-2 border">Wrote</td><td class="p-2 border text-red-600">Written</td></tr><tr><td class="p-2 border">Take</td><td class="p-2 border">Took</td><td class="p-2 border text-red-600">Taken</td></tr></tbody></table>` },
                "noun_suffix": { title: "H·∫≠u t·ªë Danh t·ª´", content: `<h3 class="font-bold text-indigo-700 mb-2">1. Ch·ªâ ng∆∞·ªùi</h3><ul class="list-disc ml-5 mb-2 text-sm"><li><b>-er/or:</b> teacher, actor, worker</li><li><b>-ist:</b> artist, scientist</li><li><b>-ee:</b> employee, trainee</li></ul><h3 class="font-bold text-indigo-700 mb-2">2. Ch·ªâ v·∫≠t/tr·ª´u t∆∞·ª£ng</h3><ul class="list-disc ml-5 text-sm"><li><b>-tion/sion:</b> information, decision</li><li><b>-ment:</b> development, government</li><li><b>-ness:</b> happiness, sadness</li><li><b>-ity:</b> ability, activity</li></ul>` },
                "adj_suffix": { title: "H·∫≠u t·ªë T√≠nh t·ª´", content: `<ul class="list-disc ml-5 text-sm space-y-1"><li><b>-ful (ƒë·∫ßy):</b> helpful, beautiful</li><li><b>-less (kh√¥ng):</b> careless, homeless</li><li><b>-able/ible (c√≥ th·ªÉ):</b> comfortable, visible</li><li><b>-ive:</b> active, creative</li><li><b>-ous:</b> dangerous, famous</li><li><b>-y:</b> sunny, rainy, windy</li><li><b>-al:</b> national, traditional</li></ul>` },
                "prefixes": { title: "Ti·ªÅn t·ªë ph·ªï bi·∫øn", content: `<p class="mb-2 text-sm">Th√™m v√†o tr∆∞·ªõc t·ª´ g·ªëc ƒë·ªÉ ƒë·ªïi nghƒ©a (th∆∞·ªùng l√† nghƒ©a ph·ªß ƒë·ªãnh).</p><ul class="list-disc ml-5 text-sm space-y-1"><li><b>un-:</b> unhappy, unsafe</li><li><b>-im (tr∆∞·ªõc p, m):</b> impossible, impolite</li><li><b>in-:</b> incorrect, informal</li><li><b>dis-:</b> disagree, dislike</li><li><b>re- (l√†m l·∫°i):</b> rewrite, replay</li><li><b>pre- (tr∆∞·ªõc):</b> preview, pretest</li></ul>` },
                "verb_noun": { title: "Chuy·ªÉn ƒê·ªông t·ª´ th√†nh Danh t·ª´", content: `<div class="bg-green-50 p-3 rounded mb-2 border border-green-200"><span class="font-bold">Quy t·∫Øc chung:</span> Th√™m h·∫≠u t·ªë danh t·ª´ v√†o ƒë·ªông t·ª´.</div><ul class="text-sm space-y-2"><li><b>Decide</b> (v) -> <b>Decision</b> (n)</li><li><b>Solve</b> (v) -> <b>Solution</b> (n)</li><li><b>Arrive</b> (v) -> <b>Arrival</b> (n)</li><li><b>Perform</b> (v) -> <b>Performance</b> (n)</li></ul>` },
                "noun_adj": { title: "Chuy·ªÉn Danh t·ª´ th√†nh T√≠nh t·ª´", content: `<div class="bg-blue-50 p-3 rounded mb-2 border border-blue-200"><span class="font-bold">Quy t·∫Øc:</span> Th√™m h·∫≠u t·ªë t√≠nh t·ª´.</div><ul class="text-sm space-y-2"><li><b>Danger</b> (n) -> <b>Dangerous</b> (adj)</li><li><b>Care</b> (n) -> <b>Careful/Careless</b> (adj)</li><li><b>Nature</b> (n) -> <b>Natural</b> (adj)</li><li><b>Sun</b> (n) -> <b>Sunny</b> (adj)</li></ul>` },
                "adj_adv": { title: "T√≠nh t·ª´ & Tr·∫°ng t·ª´", content: `<div class="bg-yellow-50 p-3 rounded mb-2 border border-yellow-200"><span class="font-bold">C√¥ng th·ª©c:</span> Adj + ly = Adv</div><ul class="text-sm space-y-1 mb-2"><li>Quick -> Quickly</li><li>Bad -> Badly</li><li>Happy -> Happily (y -> i + ly)</li></ul><p class="font-bold text-red-500 text-sm">Ngo·∫°i l·ªá:</p><ul class="text-sm"><li>Good -> Well</li><li>Fast -> Fast (gi·ªØ nguy√™n)</li><li>Hard -> Hard</li></ul>` },
                "ing": { title: "Quy t·∫Øc th√™m ƒëu√¥i -ING", content: `<ol class="list-decimal ml-5 text-sm space-y-2"><li><b>Th√¥ng th∆∞·ªùng:</b> Th√™m -ing (walk -> walking)</li><li><b>T·∫≠n c√πng l√† e:</b> B·ªè e th√™m ing (write -> writing)</li><li><b>T·∫≠n c√πng l√† ie:</b> ƒê·ªïi ie th√†nh y (lie -> lying)</li><li><b>1 √¢m ti·∫øt, t·∫≠n c√πng 1 ph·ª• √¢m, tr∆∞·ªõc l√† 1 nguy√™n √¢m:</b> G·∫•p ƒë√¥i ph·ª• √¢m (run -> running, sit -> sitting)</li></ol>` },
                "ed": { title: "Quy t·∫Øc th√™m ƒëu√¥i -ED", content: `<ol class="list-decimal ml-5 text-sm space-y-2"><li><b>Th√¥ng th∆∞·ªùng:</b> Th√™m -ed (watch -> watched)</li><li><b>T·∫≠n c√πng l√† e:</b> Th√™m d (live -> lived)</li><li><b>T·∫≠n c√πng l√† y (tr∆∞·ªõc l√† ph·ª• √¢m):</b> ƒê·ªïi y th√†nh i + ed (study -> studied)</li><li><b>G·∫•p ƒë√¥i ph·ª• √¢m cu·ªëi:</b> stop -> stopped, plan -> planned</li></ol>` },
                "classify": { title: "Ph√¢n lo·∫°i t·ª´", content: `<div class="space-y-3 text-sm"><div><span class="font-bold text-blue-600">Noun (Danh t·ª´):</span> Ch·ªâ ng∆∞·ªùi, v·∫≠t, n∆°i ch·ªën.<br>V·ªã tr√≠: ƒê·∫ßu c√¢u (Ch·ªß ng·ªØ), sau ƒë·ªông t·ª´ (T√¢n ng·ªØ).</div><div><span class="font-bold text-red-600">Verb (ƒê·ªông t·ª´):</span> Ch·ªâ h√†nh ƒë·ªông, tr·∫°ng th√°i.<br>V·ªã tr√≠: Sau ch·ªß ng·ªØ.</div><div><span class="font-bold text-green-600">Adjective (T√≠nh t·ª´):</span> Ch·ªâ t√≠nh ch·∫•t.<br>V·ªã tr√≠: Tr∆∞·ªõc danh t·ª´, sau tobe.</div><div><span class="font-bold text-purple-600">Adverb (Tr·∫°ng t·ª´):</span> B·ªï nghƒ©a cho ƒë·ªông t·ª´/t√≠nh t·ª´.<br>V·ªã tr√≠: Sau ƒë·ªông t·ª´ th∆∞·ªùng, cu·ªëi c√¢u.</div></div>` }
            }
        };

        let gameState = { mode: 'vocab', data: [], currentIdx: 0, score: 0, history: [], currentCorrect: "", currentOthers: [] };
        let theoryTab = 'grammar';
        const els = {
            app: document.getElementById('app'),
            screens: { start: document.getElementById('startScreen'), game: document.getElementById('gameScreen'), result: document.getElementById('resultScreen') },
            // Removed 'tabs' as we use grid now
            views: {
                // Shared view for vocab, listening, phrases, idioms
                sharedInput: document.getElementById('sharedInputArea'),
                // Specific views
                reading: document.getElementById('viewReading'),
                grammar: document.getElementById('viewGrammar'),
                forms: document.getElementById('viewForms')
            },
            inputs: {
                vocabTopic: document.getElementById('vocabTopicInput'),
                vocabSelect: document.getElementById('vocabTopicSelect'),
                readingTopic: document.getElementById('readingTopicInput'),
                readingSelect: document.getElementById('readingTopicSelect'),
                grammarTense: document.getElementById('grammarTenseSelect'),
                formsType: document.getElementById('formsTypeSelect'),
                answer: document.getElementById('answerInput'),
                apiKey: document.getElementById('userApiKeyInput'),
                dict: document.getElementById('dictInput')
            },
            game: { title: document.getElementById('gameTitle'), qNum: document.getElementById('currentQ'), totalQ: document.getElementById('totalQ'), progress: document.getElementById('progressBar'), display: document.getElementById('mainDisplay'), passageDisplay: document.getElementById('readingPassageDisplay'), listeningDisplay: document.getElementById('listeningDisplay'), subDisplay: document.getElementById('subDisplay'), instruction: document.getElementById('instructionText'), quickOptions: document.getElementById('quickOptions') },
            feedback: { overlay: document.getElementById('feedbackOverlay'), title: document.getElementById('feedbackTitle'), correctText: document.getElementById('correctAnswerText'), explanation: document.getElementById('grammarExplanation'), synonym: document.getElementById('synonymText'), border: document.getElementById('feedbackBorder') },
            settings: { panel: document.getElementById('settingsPanel'), content: document.getElementById('settingsContent'), backdrop: document.getElementById('settingsBackdrop'), keyStatus: document.getElementById('keyStatus') },
            dict: { modal: document.getElementById('dictModal'), content: document.getElementById('dictContent'), backdrop: document.getElementById('dictBackdrop'), result: document.getElementById('dictResultArea'), input: document.getElementById('dictInput') },
            theory: { modal: document.getElementById('theoryModal'), content: document.getElementById('theoryContentPanel'), backdrop: document.getElementById('theoryBackdrop'), listGrammar: document.getElementById('theoryListGrammar'), listForms: document.getElementById('theoryListForms'), detail: document.getElementById('theoryDetail'), contentText: document.getElementById('theoryDetailContent'), tabs: { grammar: document.getElementById('btnTheoryGrammar'), forms: document.getElementById('btnTheoryForms') } },
            wrappers: { onlineVocab: document.getElementById('onlineVocabInput'), offlineVocab: document.getElementById('offlineVocabSelect'), readingInput: document.getElementById('readingTopicInput'), readingSelect: document.getElementById('readingSelectWrapper'), inputWrapper: document.getElementById('inputWrapper'), inputIcon: document.getElementById('inputIcon'), inputTitle: document.getElementById('inputTitle') },
            config: { level: document.getElementById('levelSelect'), qtyInput: document.getElementById('quantityRange'), qtyDisplay: document.getElementById('qtyDisplay'), section: document.getElementById('configSection'), startBtn: document.getElementById('startBtn') },
            loading: { overlay: document.getElementById('loadingOverlay'), text: document.getElementById('loadingText') },
            aiStatus: { dot: document.getElementById('aiStatusDot'), text: document.getElementById('aiStatusText') },
            checkBtn: document.getElementById('checkBtn'),
            modeCards: {
                vocab: document.getElementById('mode-vocab'),
                phrases: document.getElementById('mode-phrases'),
                idioms: document.getElementById('mode-idioms'),
                listening: document.getElementById('mode-listening'),
                reading: document.getElementById('mode-reading'),
                grammar: document.getElementById('mode-grammar'),
                forms: document.getElementById('mode-forms')
            }
        };

        const formReadableNames = { "irregular": "ƒê·ªông t·ª´ B·∫•t quy t·∫Øc", "irregular_v3": "Qu√° kh·ª© ph√¢n t·ª´", "noun_suffix": "H·∫≠u t·ªë Danh t·ª´", "adj_suffix": "H·∫≠u t·ªë T√≠nh t·ª´", "prefixes": "Ti·ªÅn t·ªë", "verb_noun": "ƒê·ªông t·ª´ ‚Üí Danh t·ª´", "noun_adj": "Danh t·ª´ ‚Üí T√≠nh t·ª´", "adj_adv": "T√≠nh t·ª´ ‚Üí Tr·∫°ng t·ª´", "ing": "ƒêu√¥i -ING", "ed": "ƒêu√¥i -ED", "classify": "Ph√¢n lo·∫°i t·ª´" };

        if (els.inputs.grammarTense && offlineData.grammar) els.inputs.grammarTense.innerHTML = Object.keys(offlineData.grammar).map(t => `<option value="${t}">${t}</option>`).join('');
        if (els.inputs.vocabSelect && offlineData.vocab) els.inputs.vocabSelect.innerHTML = Object.keys(offlineData.vocab).map(t => `<option value="${t}">${t}</option>`).join('');
        // Add Safe Check for reading
        if (els.inputs.readingSelect && offlineData.reading) els.inputs.readingSelect.innerHTML = Object.keys(offlineData.reading).map(t => `<option value="${t}">${t}</option>`).join('');
        if (els.inputs.formsType && offlineData.forms) els.inputs.formsType.innerHTML = Object.keys(offlineData.forms).map(t => `<option value="${t}">${formReadableNames[t] || t}</option>`).join('');

        const getApiKey = () => localStorage.getItem('vocab_ai_key');

        const toggleModal = (modal, content, backdrop, show) => {
            if (show) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    backdrop.classList.remove('opacity-0');
                    content.classList.remove('translate-y-full');
                }, 10);
            } else {
                backdrop.classList.add('opacity-0');
                content.classList.add('translate-y-full');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        };

        const checkKeyStatus = () => {
            const key = getApiKey();
            if(key) {
                // Settings Panel Status
                els.settings.keyStatus.textContent = "‚úÖ ƒê√£ k·∫øt n·ªëi AI";
                els.settings.keyStatus.className = "text-xs mt-4 text-center font-bold text-green-600";
                els.inputs.apiKey.value = key;

                // Header Indicator Status
                if(els.aiStatus.dot) {
                    els.aiStatus.dot.className = "ai-status-dot status-online";
                    els.aiStatus.text.textContent = "ONLINE (AI)";
                    els.aiStatus.text.className = "text-green-600";
                }

                if(els.wrappers.onlineVocab) els.wrappers.onlineVocab.classList.remove('hidden');
                if(els.wrappers.offlineVocab) els.wrappers.offlineVocab.classList.add('hidden');

                // Show AI Input for Reading when online
                if(els.wrappers.readingInput) els.wrappers.readingInput.classList.remove('hidden');
                if(els.wrappers.readingSelect) els.wrappers.readingSelect.classList.add('hidden');

            } else {
                // Settings Panel Status
                els.settings.keyStatus.textContent = "‚ö†Ô∏è Ch·∫ø ƒë·ªô Offline";
                els.settings.keyStatus.className = "text-xs mt-4 text-center font-medium text-gray-400";

                // Header Indicator Status
                if(els.aiStatus.dot) {
                    els.aiStatus.dot.className = "ai-status-dot status-offline";
                    els.aiStatus.text.textContent = "OFFLINE";
                    els.aiStatus.text.className = "text-gray-400";
                }

                if(els.wrappers.onlineVocab) els.wrappers.onlineVocab.classList.add('hidden');
                if(els.wrappers.offlineVocab) els.wrappers.offlineVocab.classList.remove('hidden');

                // Show Select for Reading when offline
                if(els.wrappers.readingInput) els.wrappers.readingInput.classList.add('hidden');
                if(els.wrappers.readingSelect) els.wrappers.readingSelect.classList.remove('hidden');
            }
        };

        const saveApiKey = () => { const key = els.inputs.apiKey.value.trim(); if(key) { localStorage.setItem('vocab_ai_key', key); checkKeyStatus(); alert("ƒê√£ l∆∞u Key!"); toggleSettings(); } };

        const toggleSettings = () => { const isHidden = els.settings.panel.classList.contains('hidden'); toggleModal(els.settings.panel, els.settings.content, els.settings.backdrop, isHidden); };
        const openDictModal = () => { toggleModal(els.dict.modal, els.dict.content, els.dict.backdrop, true); setTimeout(() => els.dict.input.focus(), 300); };
        const closeDictModal = () => toggleModal(els.dict.modal, els.dict.content, els.dict.backdrop, false);
        const openTheoryModal = () => { toggleModal(els.theory.modal, els.theory.content, els.theory.backdrop, true); switchTheoryTab('grammar'); };
        const closeTheoryModal = () => toggleModal(els.theory.modal, els.theory.content, els.theory.backdrop, false);

        function isVietnamese(str) { return /[√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë]/i.test(str); }
        const lookupDictionary = async () => {
            const word = els.dict.input.value.trim(); if(!word) return;
            els.dict.result.innerHTML = '<div class="flex flex-col items-center justify-center h-48"><div class="loader mb-2"></div><p class="text-xs text-gray-500 font-bold">ƒêang tra c·ª©u...</p></div>';
            try {
                if (isVietnamese(word)) {
                     const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=vi|en`;
                     const res = await fetch(url); const data = await res.json();
                     if(data.responseStatus === 200) els.dict.result.innerHTML = `<div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100"><h2 class="text-2xl font-black text-gray-800 mb-1">${word}</h2><p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">VIETNAMESE</p><div class="border-t border-gray-100 pt-4"><p class="font-bold text-indigo-600 text-xl">${data.responseData.translatedText}</p><p class="text-xs text-gray-400 mt-1">English Translation</p></div></div>`;
                     else els.dict.result.innerHTML = `<div class="p-4 text-center text-red-400 font-bold">Kh√¥ng t√¨m th·∫•y b·∫£n d·ªãch.</div>`;
                } else {
                    let freeApiData = null; let translation = null;
                    try { const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`); if(res.ok) { const data = await res.json(); freeApiData = data[0]; } } catch(e) {}
                    try { const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=en|vi`; const res = await fetch(url); const data = await res.json(); if(data.responseStatus === 200) translation = data.responseData.translatedText; } catch(e) {}
                    if (!freeApiData && !translation) { els.dict.result.innerHTML = `<div class="text-center p-4 text-gray-400 font-medium">Kh√¥ng t√¨m th·∫•y t·ª´ n√†y.</div>`; return; }
                    let html = `<div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100"><div class="flex items-center justify-between mb-2"><h2 class="text-3xl font-black text-gray-800 capitalize">${freeApiData ? freeApiData.word : word}</h2>`;
                    if (freeApiData) { const audioSrc = freeApiData.phonetics.find(p => p.audio)?.audio; if(audioSrc) html += `<button onclick="new Audio('${audioSrc}').play()" class="w-10 h-10 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center hover:bg-orange-200 transition-colors"><i class="fas fa-volume-up"></i></button>`; }
                    html += `</div>`;
                    if(freeApiData) { const phonetic = freeApiData.phonetic || (freeApiData.phonetics.find(p => p.text)?.text) || ""; html += `<p class="text-orange-500 font-mono text-sm mb-6 font-bold">${phonetic}</p>`; }
                    if(translation) html += `<div class="mb-6 bg-green-50 p-4 rounded-2xl border border-green-100"><p class="text-[10px] text-green-800 font-black uppercase tracking-widest mb-1">NGHƒ®A TI·∫æNG VI·ªÜT</p><p class="text-xl font-bold text-gray-800">${translation}</p></div>`;
                    if (freeApiData) html += `<div class="mb-2"><h3 class="font-bold text-gray-700 text-sm uppercase tracking-wider border-b border-gray-100 pb-2 mb-3">ƒê·ªãnh nghƒ©a (Anh-Anh)</h3><ul class="list-disc pl-5 text-sm text-gray-600 space-y-2 leading-relaxed">${freeApiData.meanings[0].definitions.slice(0, 3).map(d => `<li>${d.definition}</li>`).join('')}</ul></div>`;
                    html += `</div>`; els.dict.result.innerHTML = html;
                }
            } catch (e) { els.dict.result.innerHTML = `<div class="text-center p-4 text-red-500 font-bold">L·ªói k·∫øt n·ªëi.</div>`; }
        };

        const switchTheoryTab = (tab) => {
            theoryTab = tab;
            els.theory.tabs.grammar.className = tab==='grammar' ? 'flex-1 py-2.5 rounded-xl text-xs font-bold bg-indigo-100 text-indigo-700 transition-colors' : 'flex-1 py-2.5 rounded-xl text-xs font-bold text-gray-500 hover:bg-gray-50 transition-colors';
            els.theory.tabs.forms.className = tab==='forms' ? 'flex-1 py-2.5 rounded-xl text-xs font-bold bg-green-100 text-green-700 transition-colors' : 'flex-1 py-2.5 rounded-xl text-xs font-bold text-gray-500 hover:bg-gray-50 transition-colors';
            els.theory.listGrammar.classList.toggle('hidden', tab !== 'grammar');
            els.theory.listForms.classList.toggle('hidden', tab !== 'forms');
            els.theory.detail.classList.add('hidden');
            const dataSrc = tab === 'grammar' ? offlineData.grammar : offlineData.forms;
            const container = tab === 'grammar' ? els.theory.listGrammar : els.theory.listForms;
            container.innerHTML = Object.keys(dataSrc).map(t =>
                `<div onclick="loadTheory('${t}', '${tab}')" class="p-4 bg-white rounded-2xl shadow-sm border border-gray-100 cursor-pointer hover:bg-gray-50 active:scale-[0.98] transition-all flex justify-between items-center group">
                    <span class="font-bold text-gray-700 group-hover:text-indigo-600 transition-colors">${tab === 'forms' ? (formReadableNames[t] || t) : t}</span>
                    <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                </div>`
            ).join('');
        };
        const backToTheoryList = () => { els.theory.detail.classList.add('hidden'); if(theoryTab === 'grammar') els.theory.listGrammar.classList.remove('hidden'); else els.theory.listForms.classList.remove('hidden'); };

        const loadTheory = async (topic, type) => {
            els.theory.listGrammar.classList.add('hidden'); els.theory.listForms.classList.add('hidden'); els.theory.detail.classList.remove('hidden');
            els.theory.contentText.innerHTML = '<div class="flex flex-col items-center justify-center h-48"><div class="loader mb-2"></div><p class="text-xs text-gray-500 font-bold">ƒêang t·∫£i ki·∫øn th·ª©c...</p></div>';
            const key = getApiKey(); const friendlyName = formReadableNames[topic] || topic;
            setTimeout(async () => {
                if (key) {
                    try {
                        let prompt = type === 'forms' ? `T·ªïng h·ª£p ki·∫øn th·ª©c ti·∫øng Anh v·ªÅ ch·ªß ƒë·ªÅ: "${friendlyName}" (Ph·∫ßn: Word Forms/Morphology). Tr√¨nh b√†y r√µ r√†ng b·∫±ng HTML v·ªõi Tailwind CSS. (Ti·∫øng Vi·ªát)` : `Gi·∫£i th√≠ch ng·ªØ ph√°p ti·∫øng Anh ch·ªß ƒë·ªÅ: "${topic}". Tr√¨nh b√†y s·∫°ch ƒë·∫πp b·∫±ng HTML. D√πng Tailwind CSS. (Ti·∫øng Vi·ªát)`;
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                        const data = await res.json();
                        els.theory.contentText.innerHTML = data.candidates[0].content.parts[0].text.replace(/```html|```/g, '');
                        return;
                    } catch(e) {}
                }
                const offlineContent = offlineData.theory[topic];
                els.theory.contentText.innerHTML = offlineContent ? `<h2 class="text-2xl font-black text-indigo-900 mb-6 border-b pb-4">${offlineContent.title}</h2>${offlineContent.content}` : `<div class="text-center p-8"><h2 class="text-xl font-bold text-gray-400 mb-2">${friendlyName}</h2><p class="text-gray-400 text-sm">N·ªôi dung offline ch∆∞a c·∫≠p nh·∫≠t. Vui l√≤ng nh·∫≠p API Key ƒë·ªÉ t·∫£i t·ª´ AI.</p></div>`;
            }, 300);
        };

        const showLoading = (b) => els.loading.overlay.classList.toggle('hidden', !b);
        const updateLevel = (val, el) => { document.getElementById('levelSelect').value = val; document.querySelectorAll('.level-card').forEach(c => { c.classList.remove('selected', 'bg-yellow-50', 'border-yellow-400'); c.classList.add('bg-gray-50', 'border-transparent'); }); el.classList.add('selected'); };

        const setMode = (m) => {
            // 1. Update Mode Cards UI (Grid)
            Object.keys(els.modeCards).forEach(key => {
                if (key === m) els.modeCards[key].classList.add('active');
                else els.modeCards[key].classList.remove('active');
            });

            // 2. Hide all specific views first
            els.views.sharedInput.classList.add('hidden');
            els.views.reading.classList.add('hidden');
            els.views.grammar.classList.add('hidden');
            els.views.forms.classList.add('hidden');

            // 3. Show correct view based on mode
            if (m === 'vocab' || m === 'listening' || m === 'phrases' || m === 'idioms') {
                els.views.sharedInput.classList.remove('hidden');

                // Dynamic Title & Icon
                if (m === 'vocab') { els.wrappers.inputIcon.className = "fas fa-font text-yellow-500"; els.wrappers.inputTitle.textContent = "Ch·ªß ƒë·ªÅ t·ª´ v·ª±ng (T·ª´ ƒë∆°n)"; }
                else if (m === 'phrases') { els.wrappers.inputIcon.className = "fas fa-quote-right text-orange-500"; els.wrappers.inputTitle.textContent = "Ch·ªß ƒë·ªÅ c·ª•m t·ª´ (Phrases)"; }
                else if (m === 'idioms') { els.wrappers.inputIcon.className = "fas fa-dragon text-red-500"; els.wrappers.inputTitle.textContent = "Ch·ªß ƒë·ªÅ t·ª•c ng·ªØ (Proverbs)"; }
                else if (m === 'listening') { els.wrappers.inputIcon.className = "fas fa-headphones text-pink-500"; els.wrappers.inputTitle.textContent = "Ch·ªß ƒë·ªÅ b√†i nghe"; }
            }
            else if (m === 'reading') {
                els.views.reading.classList.remove('hidden');
                els.wrappers.inputIcon.className = "fas fa-book-open text-blue-500"; els.wrappers.inputTitle.textContent = "Ch·ªß ƒë·ªÅ b√†i ƒë·ªçc";
            }
            else if (m === 'grammar') {
                els.views.grammar.classList.remove('hidden');
                els.wrappers.inputIcon.className = "fas fa-pen-nib text-indigo-500"; els.wrappers.inputTitle.textContent = "Ch·ªß ƒëi·ªÉm ng·ªØ ph√°p";
            }
            else if (m === 'forms') {
                els.views.forms.classList.remove('hidden');
                els.wrappers.inputIcon.className = "fas fa-random text-green-500"; els.wrappers.inputTitle.textContent = "Lo·∫°i t·ª´ c·∫ßn luy·ªán";
            }

            // Show config section
            els.config.section.classList.remove('hidden');
        };

        const switchScreen = (s) => {
            Object.values(els.screens).forEach(e => e.classList.add('hidden'));
            els.screens[s].classList.remove('hidden');
        };
        const resetGame = () => { document.body.classList.remove('keyboard-active'); switchScreen('start'); };

        const updateUI = () => {
            const item = gameState.data[gameState.currentIdx];
            els.game.qNum.textContent = gameState.currentIdx + 1;
            els.game.progress.style.width = `${((gameState.currentIdx + 1) / gameState.data.length) * 100}%`;
            els.inputs.answer.value = "";
            els.game.quickOptions.classList.add('hidden');
            els.game.quickOptions.innerHTML = '';

            // Reset displays
            els.game.display.classList.remove('hidden');
            els.game.listeningDisplay.classList.add('hidden');
            els.game.subDisplay.classList.add('hidden');
            els.game.passageDisplay.classList.add('hidden');

            // RESET INPUT CONTAINER
            els.wrappers.inputWrapper.classList.remove('hidden');
            els.checkBtn.classList.remove('btn-expanded', 'w-full', 'rounded-3xl');
            els.checkBtn.classList.add('w-11', 'rounded-xl', 'no-shrink');
            els.checkBtn.innerHTML = '<i class="fas fa-check"></i>';


            if(gameState.mode === 'vocab') {
                els.game.display.textContent = item.vi; els.game.instruction.textContent = "TRANSLATE TO ENGLISH";
                gameState.currentCorrect = item.en;
                gameState.currentOthers = item.others ? item.others.split(',').map(s => s.trim().toLowerCase()) : [];
            }
            else if (gameState.mode === 'phrases') {
                els.game.display.textContent = item.vi; els.game.instruction.textContent = "TRANSLATE PHRASE";
                gameState.currentCorrect = item.en;
                gameState.currentOthers = item.others ? item.others.split(',').map(s => s.trim().toLowerCase()) : [];
            }
            else if (gameState.mode === 'idioms') {
                els.game.display.textContent = item.vi; els.game.instruction.textContent = "TRANSLATE PROVERB";
                gameState.currentCorrect = item.en;
                gameState.currentOthers = item.others ? item.others.split(',').map(s => s.trim().toLowerCase()) : [];
            }
            else if (gameState.mode === 'listening') {
                els.game.display.classList.add('hidden');
                els.game.listeningDisplay.classList.remove('hidden');
                els.game.instruction.textContent = "LISTEN & WRITE";
                els.game.subDisplay.textContent = `(Nghƒ©a: ${item.vi})`;
                els.game.subDisplay.classList.remove('hidden');
                gameState.currentCorrect = item.en;
                gameState.currentOthers = item.others ? item.others.split(',').map(s => s.trim().toLowerCase()) : [];
                setTimeout(() => playTTS(), 500);
            }
            else if (gameState.mode === 'reading') {
                els.game.passageDisplay.textContent = item.passage;
                els.game.passageDisplay.classList.remove('hidden');

                els.game.display.textContent = item.question;
                els.game.display.classList.remove('text-2xl', 'sm:text-2xl');
                els.game.display.classList.add('text-lg', 'sm:text-xl');

                els.game.instruction.textContent = item.type === 'tf' ? "TRUE OR FALSE?" : (item.type === 'cloze' ? "FILL IN THE BLANK" : "MULTIPLE CHOICE");

                gameState.currentCorrect = item.answer;
                gameState.currentOthers = [];

                if (item.type === 'cloze') {
                } else {
                    els.wrappers.inputWrapper.classList.add('hidden');
                    els.checkBtn.classList.remove('w-11', 'rounded-xl', 'no-shrink');
                    els.checkBtn.classList.add('btn-expanded', 'w-full', 'rounded-3xl');
                    els.checkBtn.innerHTML = '<span class="font-bold mr-2">KI·ªÇM TRA</span> <i class="fas fa-check"></i>';
                }

                if (item.options && item.options.length > 0 && item.type !== 'cloze') {
                    els.game.quickOptions.classList.remove('hidden');
                    item.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = "option-chip bg-white px-3 py-2 rounded-xl text-sm font-bold text-gray-700 shadow-sm w-full mb-1";
                        btn.textContent = opt;
                        btn.onclick = () => {
                            Array.from(els.game.quickOptions.children).forEach(c => c.classList.remove('option-selected'));
                            btn.classList.add('option-selected');
                            els.inputs.answer.value = opt;
                        };
                        els.game.quickOptions.appendChild(btn);
                    });
                }
            }
            else if (gameState.mode === 'grammar') {
                els.game.display.textContent = item.question;
                els.game.instruction.textContent = "TYPE THE CONJUGATED VERB"; // Changed instruction
                els.game.subDisplay.textContent = item.verb ? `Verb: (${item.verb})` : "";
                els.game.subDisplay.classList.remove('hidden');
                gameState.currentCorrect = item.answer;
                gameState.currentOthers = item.others ? item.others.split(',').map(s => s.trim().toLowerCase()) : [];
            }
            else if (gameState.mode === 'forms') {
                els.game.display.textContent = item.question; els.game.instruction.textContent = "WORD FORM"; els.game.subDisplay.classList.add('hidden'); gameState.currentCorrect = item.answer; gameState.currentOthers = [];
            }
        };

        const checkAnswer = () => {
            const user = els.inputs.answer.value.trim().toLowerCase();
            if(!user) {
                if(els.checkBtn.classList.contains('btn-expanded')) {
                    els.checkBtn.classList.add('animate-pulse');
                    setTimeout(()=>els.checkBtn.classList.remove('animate-pulse'), 200);
                }
                return;
            }
            if (gameState.currentIdx >= gameState.data.length) return;
            const item = gameState.data[gameState.currentIdx];
            const mainCorrect = gameState.currentCorrect.toLowerCase();

            const isCorrect = user === mainCorrect || gameState.currentOthers.includes(user);

            gameState.history.push({ q: gameState.mode === 'listening' ? `üîä ${item.en}` : (gameState.mode === 'reading' ? `üìñ ${item.question}` : els.game.display.textContent), a: gameState.currentCorrect, u: els.inputs.answer.value, ok: isCorrect });
            if(isCorrect) gameState.score++;

            els.feedback.title.textContent = isCorrect ? "Tuy·ªát v·ªùi!" : "Sai r·ªìi!";
            els.feedback.title.className = isCorrect ? "text-4xl font-black mb-6 tracking-tight text-green-600" : "text-4xl font-black mb-6 tracking-tight text-red-500";
            els.feedback.border.className = isCorrect ? "absolute top-0 left-0 w-2 h-full bg-green-500 transition-all group-hover:w-3" : "absolute top-0 left-0 w-2 h-full bg-red-500 transition-all group-hover:w-3";
            document.getElementById('feedbackIcon').textContent = isCorrect ? "üéâ" : "üòÖ";
            els.feedback.correctText.textContent = gameState.currentCorrect;

            if ((gameState.mode === 'vocab' || gameState.mode === 'listening' || gameState.mode === 'phrases' || gameState.mode === 'idioms' || gameState.mode === 'grammar') && item.others) { // Added grammar to synoym check
                 els.feedback.synonym.textContent = `Also correct: ${item.others}`;
                 els.feedback.synonym.classList.remove('hidden');
            } else {
                 els.feedback.synonym.classList.add('hidden');
            }

            els.feedback.explanation.textContent = item.explanation ? "üí° " + item.explanation : "";
            els.feedback.explanation.classList.toggle('hidden', !item.explanation);
            els.feedback.overlay.classList.remove('hidden');
            document.activeElement?.blur();
        };

        const finishGame = () => {
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('totalScoreQ').textContent = gameState.data.length;
            document.getElementById('resultList').innerHTML = gameState.history.map(h =>
                `<div class="p-4 border-b border-gray-100 flex gap-4 items-center last:border-0">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${h.ok ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-500'} font-bold text-lg">${h.ok?'<i class="fas fa-check"></i>':'<i class="fas fa-times"></i>'}</div>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs font-bold text-gray-400 mb-1 truncate">${h.q}</div>
                        <div class="font-black text-gray-800 text-base">${h.a}</div>
                        ${!h.ok ? `<div class="text-sm font-medium text-red-400 line-through mt-0.5">${h.u}</div>` : ''}
                    </div>
                </div>`
            ).join('');
            switchScreen('result');
        };

        const nextQuestion = () => { els.feedback.overlay.classList.add('hidden'); gameState.currentIdx++; if(gameState.currentIdx >= gameState.data.length) finishGame(); else updateUI(); };
        const startGame = () => { gameState.currentIdx = 0; gameState.score = 0; gameState.history = []; els.game.totalQ.textContent = gameState.data.length; switchScreen('game'); updateUI(); };

        const getRandomTopic = () => {
            const topics = ['Daily Life', 'Travel', 'Work', 'Technology', 'Health', 'Education', 'Entertainment', 'Environment', 'Food & Drink'];
            return topics[Math.floor(Math.random() * topics.length)];
        };

        const fetchAIWithRetry = async (payload, key, retries = 3) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if(data.error) throw new Error(data.error.message);

                    let rawText = data.candidates[0].content.parts[0].text;
                    rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();

                    const parsed = JSON.parse(rawText);
                    if(!Array.isArray(parsed) || parsed.length === 0) throw new Error("Invalid JSON Array Structure");

                    return parsed;
                } catch (e) {
                    console.warn(`Attempt ${i+1}/${retries} failed: ${e.message}`);
                    if (i === retries - 1) throw e;
                    await new Promise(resolve => setTimeout(resolve, 800));
                }
            }
        };

        const generateContent = async (type) => {
            const key = getApiKey(); const qty = parseInt(els.config.qtyInput.value); const level = els.config.level.value;
            showLoading(true); gameState.mode = type;
            let displayTitle = "Offline Data";

            // 1. ONLINE MODE
            if(key) {
                try {
                    let prompt = "", context = "";
                    let rawInput = (els.inputs.vocabTopic.value || els.inputs.readingTopic.value || els.inputs.readingSelect.value || "").trim();
                    context = rawInput || getRandomTopic();

                    if (type === 'vocab') {
                        prompt = `Generate ${qty} SINGLE English vocabulary words (no phrases, no idioms) for topic '${context}'.
                        IMPORTANT: 'en' MUST be a single word (e.g., 'table', 'run'). 'vi' is Vietnamese meaning.
                        LEVEL: ${level}.
                        Format: JSON Array [{"vi": "...", "en": "...", "others": "synonyms"}]`;
                    }
                    else if (type === 'phrases') {
                        prompt = `Generate ${qty} English PHRASAL VERBS or COLLOCATIONS for topic '${context}'.
                        IMPORTANT: 'en' MUST be a phrase (e.g., 'give up', 'take part in'). 'vi' is Vietnamese meaning.
                        LEVEL: ${level}.
                        Format: JSON Array [{"vi": "...", "en": "...", "others": "synonyms"}]`;
                    }
                    else if (type === 'idioms') {
                        prompt = `Generate ${qty} English IDIOMS or PROVERBS for topic '${context}' or general use.
                        IMPORTANT: 'en' is the idiom. 'vi' is the Vietnamese meaning/equivalent.
                        Format: JSON Array [{"vi": "...", "en": "...", "others": "literal meaning if needed"}]`;
                    }
                    else if (type === 'listening') {
                        prompt = `Generate ${qty} English vocabulary words/phrases for listening practice on topic '${context}'.
                        LEVEL: ${level}.
                        Format: JSON Array [{"vi": "...", "en": "...", "others": "..."}]`;
                    }
                    else if (type === 'reading') {
                        prompt = `Generate ${qty} SHORT reading comprehension questions for topic '${context}'.
                        IMPORTANT: Passage, Question, Answers, Options MUST be in English.
                        IMPORTANT: 'explanation' MUST be in VIETNAMESE to explain why the answer is correct (e.g., "Trong b√†i c√≥ ƒëo·∫°n...").
                        LEVEL: ${level}.
                        Mix different types: Multiple Choice (mc), True/False (tf), Cloze/Fill-in-blank (cloze).
                        Format: JSON Array [{"passage": "...", "question": "...", "answer": "...", "options": ["..."], "type": "mc", "explanation": "..."}]`;
                    }
                    else if (type === 'grammar') {
                        context = els.inputs.grammarTense.value;
                        prompt = `Generate ${qty} English grammar questions specifically about '${context}'.
                        LEVEL: ${level}.
                        CRITICAL RULES:
                        1. 'question': Must be a sentence with a blank '___' representing the missing verb. Include the base verb in parentheses (e.g., "She ___ (go) home.").
                        2. 'answer': Must be ONLY the conjugated verb(s) to fill the blank (e.g., "goes", "is going", "went", "will go"). DO NOT write the full sentence.
                        3. 'others': Include alternative correct forms/contractions if applicable (e.g., if answer is "will not", others="won't").
                        4. 'explanation': MUST be in VIETNAMESE to explain the grammar rule clearly.
                        Format: JSON Array [{"question": "...", "verb": "...", "answer": "...", "others": "...", "explanation": "..."}]`;
                    }
                    else if (type === 'forms') {
                        context = els.inputs.formsType.value;
                        const friendlyName = formReadableNames[context] || context;
                        prompt = `Generate ${qty} Word Form / Morphology exercises focusing on '${friendlyName}'.
                        LEVEL: ${level}.
                        'explanation': MUST be in VIETNAMESE.
                        Format: JSON Array [{"question": "...", "answer": "...", "explanation": "..."}]`;
                    }

                    // --- CALL API WITH RETRY ---
                    gameState.data = await fetchAIWithRetry({
                        contents: [{ parts: [{ text: prompt + " RETURN PURE JSON ARRAY ONLY. NO MARKDOWN." }] }]
                    }, key);

                    if (type === 'forms') displayTitle = formReadableNames[context] || context;
                    else displayTitle = context;

                    els.game.title.textContent = `${type.toUpperCase()}: ${displayTitle} (AI)`;
                    startGame(); showLoading(false); return;

                } catch(e) {
                    console.error("Online generation failed final attempt:", e);
                    // SILENT FALLBACK
                }
            }

            // 2. OFFLINE FALLBACK
            let source = [];
            if(type === 'vocab' || type === 'listening') { displayTitle = els.inputs.vocabSelect.value; source = offlineData.vocab[displayTitle] || []; }
            if(type === 'phrases') { source = offlineData.phrases["General"] || []; displayTitle = "C·ª•m t·ª´ c∆° b·∫£n"; }
            if(type === 'idioms') { source = offlineData.idioms["General"] || []; displayTitle = "T·ª•c ng·ªØ ph·ªï bi·∫øn"; }
            if(type === 'reading') { displayTitle = els.inputs.readingSelect.value; source = offlineData.reading[displayTitle] || []; }
            if(type === 'grammar') { displayTitle = els.inputs.grammarTense.value; source = offlineData.grammar[displayTitle] || []; }
            if(type === 'forms') { const rawType = els.inputs.formsType.value; displayTitle = formReadableNames[rawType] || rawType; source = offlineData.forms[rawType] || []; }

            if(!source.length) {
                alert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu (C·∫£ Online & Offline ƒë·ªÅu l·ªói). Vui l√≤ng th·ª≠ l·∫°i.");
                showLoading(false); return;
            }

            let finalData = []; while(finalData.length < qty) { finalData = finalData.concat([...source].sort(()=>0.5-Math.random())); }
            gameState.data = finalData.slice(0, qty);
            els.game.title.textContent = `${displayTitle} (Offline Mode)`;
            startGame(); showLoading(false);
        };

        const startGeneration = () => {
            // Find active mode from cards
            const activeCard = document.querySelector('.mode-card.active');
            let mode = 'vocab';
            if (activeCard) {
                mode = activeCard.id.replace('mode-', '');
            }
            generateContent(mode);
        };

        const playTTS = () => {
            if(gameState.currentCorrect) {
                const u = new SpeechSynthesisUtterance(gameState.currentCorrect);
                u.lang = 'en-US';
                u.rate = 0.9;
                speechSynthesis.speak(u);
            }
        };

        Object.assign(window, { saveApiKey, openDictModal, closeDictModal, lookupDictionary, switchTheoryTab, openTheoryModal, closeTheoryModal, backToTheoryList, loadTheory, showLoading, toggleSettings, updateLevel, setMode, switchScreen, resetGame, checkAnswer, nextQuestion, startGeneration, playTTS });

        checkKeyStatus();
        els.dict.input.addEventListener('keypress', (e) => { if(e.key === 'Enter') lookupDictionary(); });
        els.inputs.answer.addEventListener('keypress', (e) => { if(e.key === 'Enter') checkAnswer(); });
        els.config.qtyInput.addEventListener('input', (e) => { els.config.qtyDisplay.textContent = `${e.target.value}`; });

        // Initialize with Vocab mode
        setMode('vocab');
    </script>
</body>
</html>
