<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>AI Tutor: v2.1 (Fix Inline Vocab)</title>

    <!-- PWA Setup -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI Tutor">
    <meta name="theme-color" content="#FFFBEB">

    <link rel="apple-touch-icon" id="apple-icon" href="">
    <link rel="icon" id="fav-icon" type="image/png" href="">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --app-height: 100%; --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }

        /* 1. KH√ìA CH·∫∂T BODY & HTML */
        html { height: 100%; width: 100%; overflow: hidden; overscroll-behavior: none; position: fixed; }
        body { height: 100%; width: 100%; position: fixed; top: 0; left: 0; overflow: hidden; font-family: 'Quicksand', sans-serif; background-color: #FFFBEB; -webkit-tap-highlight-color: transparent; touch-action: none; }

        /* 2. APP SHELL */
        #app-viewport { position: absolute; left: 0; width: 100%; height: 100%; top: 0; display: flex; flex-direction: column; background-color: #FFFBEB; overflow: hidden; z-index: 1; will-change: height, top; }
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }

        /* --- 3. GAMIFICATION ANIMATIONS --- */
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes firePulse { 0% { transform: scale(1); filter: drop-shadow(0 0 2px orange); } 50% { transform: scale(1.1); filter: drop-shadow(0 0 10px red); } 100% { transform: scale(1); filter: drop-shadow(0 0 2px orange); } }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-50px) scale(1.5); opacity: 0; } }

        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .combo-text { position: absolute; font-weight: 900; color: #ff4500; text-shadow: 2px 2px 0px #fff, 0 0 10px rgba(255, 69, 0, 0.5); pointer-events: none; z-index: 50; animation: floatUp 1s ease-out forwards; }
        .shake-element { animation: shake 0.3s ease-in-out; }
        .fire-badge { background: linear-gradient(to bottom, #fcd34d, #ef4444); color: white; animation: firePulse 1s infinite; border: 2px solid white; box-shadow: 0 4px 6px rgba(239, 68, 68, 0.4); }
        .streak-badge-container { background: linear-gradient(135deg, #fff 0%, #fff7ed 100%); border: 1px solid #fed7aa; box-shadow: 0 2px 4px rgba(251, 146, 60, 0.1); }

        /* --- LOGIC ULTRA COMPACT & KEYBOARD --- */
        @media (max-height: 550px) { #mainHeader { display: none !important; } }
        body.keyboard-mode #mainHeader { display: none !important; }
        body.keyboard-mode #gameScreen { padding-top: 0 !important; }
        body.keyboard-mode #gameDisplayWrapper { justify-content: flex-end; padding-bottom: 0 !important; }
        body.keyboard-mode #mainDisplay { font-size: 0.85rem !important; line-height: 1.15 !important; margin-bottom: 0 !important; padding: 0 0.5rem; }
        body.keyboard-mode #readingPassageDisplay { max-height: 80px !important; font-size: 0.75rem !important; padding: 0.5rem !important; }
        body.keyboard-mode #listeningDisplay button { width: 2rem !important; height: 2rem !important; font-size: 0.9rem !important; margin-bottom: 0 !important; }
        body.keyboard-mode #listeningDisplay p { display: none; }
        body.keyboard-mode #instructionText { font-size: 0.45rem !important; margin-bottom: 0 !important; padding: 0 0.3rem !important; opacity: 0.6; height: 14px; display: flex; align-items: center; }
        body.keyboard-mode .game-content-box { min-height: 0 !important; padding: 0.15rem 0 !important; gap: 0.1rem !important; }
        body.keyboard-mode #subDisplay { font-size: 0.6rem !important; padding: 0 0.3rem !important; margin-top: 0 !important; }
        body.keyboard-mode #inputContainer { padding: 0.2rem 0.5rem !important; border-top: 1px solid rgba(0,0,0,0.03); }
        body.keyboard-mode #answerInput { height: 1.85rem !important; padding: 0 0.6rem !important; font-size: 0.85rem !important; border-radius: 0.4rem !important; border-width: 1px !important; }
        body.keyboard-mode #checkBtn { width: 1.85rem !important; height: 1.85rem !important; border-radius: 0.4rem !important; font-size: 0.7rem !important; }
        body.keyboard-mode #quickOptions { display: none !important; }

        /* --- SCRAMBLE MODE STYLES --- */
        .scramble-box { min-height: 150px; width: 100%; display: flex; flex-direction: column; gap: 1rem; }
        .word-chip { display: inline-flex; align-items: center; justify-content: center; background-color: white; border: 2px solid #e5e7eb; border-bottom-width: 4px; color: #374151; font-weight: 700; font-size: 0.9rem; padding: 0.5rem 0.75rem; border-radius: 0.75rem; cursor: pointer; transition: all 0.1s; user-select: none; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin: 0.2rem; }
        .word-chip:active { transform: translateY(2px); border-bottom-width: 2px; box-shadow: none; }
        .word-chip.used { opacity: 0.3; pointer-events: none; border-color: transparent; background: #f3f4f6; border-bottom-width: 0; box-shadow: none; transform: scale(0.9); }
        .word-chip.selected { background-color: #eff6ff; border-color: #3b82f6; color: #1d4ed8; }
        .result-zone { min-height: 3.5rem; background-color: #f9fafb; border: 2px dashed #d1d5db; border-radius: 1rem; display: flex; flex-wrap: wrap; align-items: center; padding: 0.5rem; gap: 0.25rem; transition: all 0.2s; }
        .result-zone.has-items { background-color: #fff; border-style: solid; border-color: #bfdbfe; }

        /* --- UTILS --- */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #F59E0B; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .level-card { transition: all 0.2s; border: 2px solid transparent; }
        .level-card.selected { border-color: #F59E0B; background-color: #FFFBEB; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.1); }
        .screen-fade { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .no-shrink { flex-shrink: 0; }
        .scrollable-content { flex-grow: 1; flex-shrink: 1; min-height: 0; overflow-y: auto; overflow-x: hidden; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .input-focus:focus-within { border-color: #FBBF24; box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.2); }
        select { background-image: none !important; }
        .ai-status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .status-online { background-color: #10B981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
        .status-offline { background-color: #9CA3AF; box-shadow: 0 0 0 2px rgba(156, 163, 175, 0.2); }
        .speaker-pulse { animation: speakerPulse 1.5s infinite; }
        @keyframes speakerPulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(245, 158, 11, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }

        /* Reading Passage Styles */
        .reading-passage-box { background-color: #fffbeb; border: 2px solid #fde68a; border-radius: 12px; padding: 12px; font-size: 0.9rem; color: #4b5563; max-height: 200px; overflow-y: auto; margin-bottom: 10px; text-align: left; line-height: 1.5; width: 100%; }
        .option-chip { transition: all 0.2s; cursor: pointer; border: 2px solid #e5e7eb; }
        .option-chip:active { transform: scale(0.95); }
        .option-selected { background-color: #FEF3C7 !important; border-color: #F59E0B !important; color: #92400E !important; box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.3); font-weight: 800; }
        .btn-expanded { width: 100% !important; border-radius: 1.5rem !important; }

        /* MODE CARD STYLES */
        .mode-card { transition: all 0.2s ease; cursor: pointer; border: 2px solid transparent; }
        .mode-card:active { transform: scale(0.97); }
        .mode-card.active { border-color: #F59E0B; background-color: #FFFBEB; box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.15); }
        .mode-card.active .mode-icon { background-color: #FEF3C7; color: #D97706; }
        .mode-icon { transition: all 0.2s; }

        /* --- ENHANCED ROLEPLAY STYLES --- */
        .chat-container { width: 100%; display: flex; flex-direction: column; gap: 12px; padding-bottom: 10px; }
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 0.95rem; line-height: 1.6; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .chat-bubble.ai { align-self: flex-start; background-color: #ffffff; color: #374151; border-bottom-left-radius: 4px; border: 1px solid #f3f4f6; }
        .chat-bubble.user { align-self: flex-end; background-color: #3b82f6; color: white; border-bottom-right-radius: 4px; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2); }
        
        /* New Minimal Vocab Note */
        .vocab-note {
            font-size: 0.8rem;
            color: #d97706; /* amber-600 */
            font-weight: 700;
            margin-left: 2px;
            background-color: #fffbeb; /* amber-50 */
            padding: 0 6px;
            border-radius: 6px;
            border: 1px solid #fcd34d;
            vertical-align: text-top;
            display: inline-block;
            line-height: 1.2;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        /* Enhanced Correction Card */
        .correction-card {
            align-self: flex-end;
            max-width: 90%;
            background-color: #fff;
            border: 1px solid #fee2e2;
            border-left: 4px solid #ef4444;
            border-radius: 12px;
            padding: 12px;
            margin-top: 4px;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.05);
            animation: fadeIn 0.4s ease;
        }
        .correction-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            color: #ef4444;
            margin-bottom: 8px;
            letter-spacing: 0.05em;
        }
        .correction-content {
            font-size: 0.9rem;
            color: #1f2937;
        }
        .correction-diff {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #f3f4f6;
        }
        .diff-wrong { text-decoration: line-through; color: #9ca3af; margin-right: 6px; font-size: 0.85em; }
        .diff-right { color: #16a34a; font-weight: 700; background-color: #dcfce7; padding: 2px 6px; rounded: 4px; }
        .correction-explanation {
            font-size: 0.85rem;
            color: #4b5563;
            line-height: 1.5;
        }
        .correction-tag {
            display: inline-block;
            background-color: #f3f4f6;
            color: #6b7280;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 4px;
            font-weight: 600;
        }

        .typing-indicator span { display: inline-block; width: 5px; height: 5px; background-color: #9ca3af; border-radius: 50%; animation: typing 1s infinite; margin: 0 1px; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
    </style>
</head>
<body>
    <canvas id="confetti-canvas"></canvas>
    <div id="app-viewport">
        <!-- HEADER -->
        <div id="mainHeader" class="no-shrink px-4 pb-3 pt-[calc(env(safe-area-inset-top)+0.75rem)] bg-[#FFFBEB] flex justify-between items-center z-30 border-b border-yellow-100/50">
            <div class="flex items-center gap-3">
                <button onclick="resetGame()" class="w-10 h-10 flex items-center justify-center text-yellow-800 bg-white rounded-full shadow-sm active:scale-90 transition-transform"><i class="fas fa-home"></i></button>
                <div class="flex flex-col cursor-pointer" onclick="resetGame()">
                    <div class="flex items-baseline gap-1">
                        <h1 class="text-xl font-extrabold text-yellow-900 tracking-tight flex items-center gap-1"><span class="text-2xl filter drop-shadow-sm">ü•ë</span> AI Tutor</h1>
                    </div>
                    <div id="aiStatusBadge" class="flex items-center mt-1 ml-1" title="Server Status">
                        <span id="aiStatusDot" class="ai-status-dot status-offline"></span>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <div class="streak-badge-container px-2.5 h-10 rounded-full flex items-center gap-1.5 transition-all" title="Chu·ªói ng√†y h·ªçc t·∫≠p">
                    <i class="fas fa-fire text-orange-500 text-sm animate-pulse"></i>
                    <span id="streakCount" class="text-sm font-black text-orange-600">0</span>
                </div>
                <button onclick="openDictModal()" class="w-10 h-10 flex items-center justify-center text-yellow-700 bg-white rounded-full shadow-sm active:scale-90 transition-transform"><i class="fas fa-search"></i></button>
                <button onclick="openTheoryModal()" class="w-10 h-10 flex items-center justify-center text-indigo-600 bg-white rounded-full shadow-sm active:scale-90 transition-transform"><i class="fas fa-book-open"></i></button>
                <button onclick="toggleSettings()" class="w-10 h-10 flex items-center justify-center text-gray-600 bg-white rounded-full shadow-sm active:scale-90 transition-transform"><i class="fas fa-cog"></i></button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div id="mainContent" class="flex-1 flex flex-col relative overflow-hidden w-full bg-[#FFFBEB]">

            <!-- START SCREEN -->
            <div id="startScreen" class="flex-1 flex flex-col h-full scrollable-content custom-scroll p-4 w-full screen-fade">
                <div id="startScreenContent" class="w-full max-w-md mx-auto flex-1 flex flex-col pb-20">

                    <!-- DAILY REVIEW BUTTON -->
                    <div id="dailyReviewContainer" class="hidden mb-4 animate-fadeIn">
                        <button onclick="startDailyReview()" class="w-full bg-red-50 text-red-600 p-3 rounded-2xl border border-red-100 shadow-sm active:scale-[0.98] transition-all flex items-center justify-between group">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center text-xl text-red-500"><i class="fas fa-notes-medical"></i></div>
                                <div class="text-left">
                                    <h3 class="font-bold text-sm leading-tight text-red-700">KHO SAI L·∫¶M</h3>
                                    <p class="text-[10px] text-red-400 font-medium opacity-90">C√≥ <span id="wrongCount" class="font-bold">0</span> c√¢u c·∫ßn √¥n l·∫°i</p>
                                </div>
                            </div>
                            <span class="bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded-full">Review</span>
                        </button>
                    </div>

                    <!-- TOPIC SELECTION -->
                    <div class="mb-4">
                        <button onclick="openTopicModal()" class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 text-white p-4 rounded-2xl shadow-lg shadow-orange-200 active:scale-[0.98] transition-all flex items-center justify-between group">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-xl backdrop-blur-sm">üìö</div>
                                <div class="text-left">
                                    <h3 class="font-black text-base leading-tight">CH·ªåN CH·ª¶ ƒê·ªÄ H·ªåC</h3>
                                    <p class="text-[10px] text-yellow-50 font-medium opacity-90">Theo b·ªô Oxford Picture Dictionary</p>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-white/70 group-hover:translate-x-1 transition-transform"></i>
                        </button>
                    </div>

                    <!-- ACTIVE TOPIC BANNER -->
                    <div id="activeTopicBanner" class="hidden mb-4 bg-indigo-600 text-white p-3 rounded-2xl shadow-md flex items-center justify-between animate-fadeIn">
                        <div class="flex items-center gap-2 overflow-hidden flex-1">
                            <div class="min-w-[16px]"><i class="fas fa-thumbtack text-indigo-200 text-sm"></i></div>
                            <div class="flex flex-col min-w-0">
                                <span class="text-[9px] font-bold text-indigo-200 uppercase tracking-wider">CH·ª¶ ƒê·ªÄ ƒêANG CH·ªåN</span>
                                <div class="flex flex-col">
                                    <span id="activeTopicName" class="font-bold text-sm leading-tight break-words">Family Members</span>
                                    <span id="activeTopicNameVi" class="text-[10px] text-indigo-200 font-medium leading-tight">Th√†nh vi√™n gia ƒë√¨nh</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="clearTopic()" class="bg-indigo-500 hover:bg-indigo-400 text-white text-[10px] font-bold px-3 py-1.5 rounded-lg ml-2 whitespace-nowrap border border-indigo-400 self-center">Tho√°t</button>
                    </div>

                    <!-- MODE SELECTION GRID -->
                    <div class="mb-4">
                        <label class="text-[10px] font-bold text-gray-400 tracking-wider uppercase mb-2 block ml-1">CH·ªåN CH·∫æ ƒê·ªò H·ªåC</label>
                        <div class="grid grid-cols-2 gap-2" id="modeGrid">

                            <!-- AI ROLEPLAY MODE (KILLER FEATURE) -->
                            <div onclick="setMode('roleplay')" id="mode-roleplay" class="mode-card bg-white p-3 rounded-2xl flex items-center gap-3 shadow-sm col-span-2 border-2 border-purple-100 relative overflow-hidden group">
                                <div class="absolute right-0 top-0 p-1 bg-purple-600 text-white text-[8px] font-bold rounded-bl-lg z-10 animate-pulse">HOT</div>
                                <div class="mode-icon w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-lg"><i class="fas fa-comments"></i></div>
                                <div><h3 class="text-sm font-bold text-gray-800">Th·ª±c Chi·∫øn (Roleplay)</h3><p class="text-[9px] text-gray-400 font-semibold">Giao ti·∫øp t√¨nh hu·ªëng th·∫≠t</p></div>
                            </div>

                             <div onclick="setMode('scramble')" id="mode-scramble" class="mode-card bg-white p-3 rounded-2xl flex items-center gap-3 shadow-sm col-span-2 border-2 border-indigo-100 relative overflow-hidden group">
                                <div class="mode-icon w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-lg"><i class="fas fa-puzzle-piece"></i></div>
                                <div><h3 class="text-sm font-bold text-gray-800">S·∫Øp X·∫øp C√¢u</h3><p class="text-[9px] text-gray-400 font-semibold">Sentence Building</p></div>
                            </div>

                            <div onclick="setMode('vocab')" id="mode-vocab" class="mode-card bg-white p-3 rounded-2xl flex items-center gap-3 shadow-sm active">
                                <div class="mode-icon w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center text-lg"><i class="fas fa-font"></i></div>
                                <div><h3 class="text-sm font-bold text-gray-800">T·ª´ V·ª±ng</h3><p class="text-[9px] text-gray-400 font-semibold">T·ª´ ƒë∆°n</p></div>
                            </div>
                            <div onclick="setMode('phrases')" id="mode-phrases" class="mode-card bg-white p-3 rounded-2xl flex items-center gap-3 shadow-sm">
                                <div class="mode-icon w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-lg"><i class="fas fa-quote-right"></i></div>
                                <div><h3 class="text-sm font-bold text-gray-800">C·ª•m T·ª´</h3><p class="text-[9px] text-gray-400 font-semibold">Phrases</p></div>
                            </div>
                            <div onclick="setMode('idioms')" id="mode-idioms" class="mode-card bg-white p-3 rounded-2xl flex items-center gap-3 shadow-sm">
                                <div class="mode-icon w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center text-lg"><i class="fas fa-dragon"></i></div>
                                <div><h3 class="text-sm font-bold text-gray-800">T·ª•c Ng·ªØ</h3><p class="text-[9px] text-gray-400 font-semibold">Proverbs</p></div>
                            </div>
                            <div onclick="setMode('listening')" id="mode-listening" class="mode-card bg-white p-3 rounded-2xl flex items-center gap-3 shadow-sm">
                                <div class="mode-icon w-10 h-10 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center text-lg"><i class="fas fa-headphones"></i></div>
                                <div><h3 class="text-sm font-bold text-gray-800">Luy·ªán Nghe</h3><p class="text-[9px] text-gray-400 font-semibold">Dictation</p></div>
                            </div>
                            <div onclick="setMode('reading')" id="mode-reading" class="mode-card bg-white p-3 rounded-2xl flex items-center gap-3 shadow-sm">
                                <div class="mode-icon w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-lg"><i class="fas fa-book-open"></i></div>
                                <div><h3 class="text-sm font-bold text-gray-800">ƒê·ªçc Hi·ªÉu</h3><p class="text-[9px] text-gray-400 font-semibold">Reading</p></div>
                            </div>
                            <div onclick="setMode('grammar')" id="mode-grammar" class="mode-card bg-white p-3 rounded-2xl flex items-center gap-3 shadow-sm">
                                <div class="mode-icon w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-lg"><i class="fas fa-pen-nib"></i></div>
                                <div><h3 class="text-sm font-bold text-gray-800">Ng·ªØ Ph√°p</h3><p class="text-[9px] text-gray-400 font-semibold">Chia ƒê·ªông T·ª´</p></div>
                            </div>
                            <div onclick="setMode('forms')" id="mode-forms" class="mode-card bg-white p-3 rounded-2xl flex items-center gap-3 shadow-sm col-span-2">
                                <div class="mode-icon w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-lg"><i class="fas fa-random"></i></div>
                                <div><h3 class="text-sm font-bold text-gray-800">Bi·∫øn Th·ªÉ T·ª´ (Word Forms)</h3><p class="text-[9px] text-gray-400 font-semibold">Noun, Verb, Adjective...</p></div>
                            </div>
                        </div>
                    </div>

                    <!-- INPUT AREAS -->
                    <div id="inputAreaWrapper" class="bg-white p-4 rounded-3xl shadow-sm border border-gray-100 mb-4 transition-all relative overflow-hidden">
                        <div class="flex items-center gap-2 mb-3">
                            <i id="inputIcon" class="fas fa-lightbulb text-yellow-500"></i>
                            <h3 id="inputTitle" class="text-sm font-bold text-gray-700">Ch·ªß ƒë·ªÅ t·ª´ v·ª±ng</h3>
                        </div>

                        <!-- OVERLAY IF TOPIC IS LOCKED -->
                        <div id="lockedInputOverlay" class="hidden absolute inset-0 bg-white/95 backdrop-blur-sm z-10 flex flex-col items-center justify-center text-center p-4 animate-fadeIn">
                             <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mb-2"><i class="fas fa-lock"></i></div>
                             <p class="text-xs font-bold text-gray-500">ƒêang h·ªçc theo ch·ªß ƒë·ªÅ:</p>
                             <p id="lockedTopicName" class="text-sm font-black text-indigo-700 mb-0 leading-tight break-words max-w-full px-2">Topic Name</p>
                             <p id="lockedTopicNameVi" class="text-xs font-bold text-indigo-400 mb-2 leading-tight">Topic Name Vi</p>
                             <button onclick="clearTopic()" class="text-[10px] font-bold text-red-500 underline">ƒê·ªïi ch·ªß ƒë·ªÅ</button>
                        </div>

                        <!-- 1. Shared Input -->
                        <div id="sharedInputArea" class="w-full animate-fadeIn">
                            <div id="onlineVocabInput" class="w-full input-focus rounded-xl transition-all duration-200">
                                <input type="text" id="vocabTopicInput" placeholder="Nh·∫≠p ch·ªß ƒë·ªÅ (ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ Random)..." class="w-full p-3 bg-gray-50 border-2 border-transparent text-center text-sm font-bold text-gray-800 rounded-xl focus:bg-white focus:border-yellow-400 focus:outline-none placeholder-gray-400">
                            </div>
                            <div id="offlineVocabSelect" class="w-full hidden"><div class="relative w-full"><select id="vocabTopicSelect" class="w-full p-3 bg-gray-50 border-none rounded-xl text-sm font-bold text-center text-gray-700 appearance-none focus:ring-0"></select><div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-xs"><i class="fas fa-chevron-down"></i></div></div></div>
                        </div>

                        <!-- 2. Reading Input -->
                        <div id="viewReading" class="hidden w-full animate-fadeIn">
                             <div class="relative w-full" id="readingSelectWrapper"><select id="readingTopicSelect" class="w-full p-3 bg-gray-50 border-none rounded-xl text-sm font-bold text-center text-gray-700 appearance-none focus:outline-none"></select><div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-xs"><i class="fas fa-chevron-down"></i></div></div>
                        </div>

                        <!-- 3. Grammar Input -->
                        <div id="viewGrammar" class="hidden w-full animate-fadeIn">
                            <div class="relative w-full"><select id="grammarTenseSelect" class="w-full p-3 bg-gray-50 border-none rounded-xl text-sm font-bold text-center text-gray-700 appearance-none focus:outline-none"></select><div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-xs"><i class="fas fa-chevron-down"></i></div></div>
                        </div>

                        <!-- 4. Forms Input -->
                        <div id="viewForms" class="hidden w-full animate-fadeIn">
                            <div class="relative w-full"><select id="formsTypeSelect" class="w-full p-3 bg-gray-50 border-none rounded-xl text-sm font-bold text-center text-gray-700 appearance-none focus:outline-none"></select><div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-xs"><i class="fas fa-chevron-down"></i></div></div>
                        </div>
                    </div>

                    <!-- START BUTTON -->
                    <button onclick="startGeneration()" id="startBtn" class="w-full bg-gray-900 text-white font-bold text-base py-3 rounded-2xl shadow-lg shadow-gray-300/50 active:scale-[0.98] transition-all flex items-center justify-center gap-2 mb-6">
                        <i class="fas fa-play text-yellow-400"></i> B·∫Øt ƒê·∫ßu
                    </button>

                    <!-- COMPACT CONFIG SECTION -->
                    <div id="configSection" class="w-full bg-white p-4 rounded-2xl shadow-sm border border-gray-100 transition-all">
                        <input type="hidden" id="levelSelect" value="Level A">
                        <div class="flex justify-between items-center mb-2"><label class="text-[10px] font-bold text-gray-400 tracking-wider uppercase">ƒê·ªô kh√≥</label></div>
                        <div class="grid grid-cols-3 gap-1.5 mb-1.5">
                            <div onclick="updateLevel('Level A', this)" class="level-card selected cursor-pointer py-2 rounded-xl bg-gray-50 text-center"><div class="text-base mb-0.5">üå±</div><div class="text-[9px] font-bold text-gray-600">Level A</div></div>
                            <div onclick="updateLevel('Level B', this)" class="level-card cursor-pointer py-2 rounded-xl bg-gray-50 text-center"><div class="text-base mb-0.5">üåø</div><div class="text-[9px] font-bold text-gray-600">Level B</div></div>
                            <div onclick="updateLevel('Level C', this)" class="level-card cursor-pointer py-2 rounded-xl bg-gray-50 text-center"><div class="text-base mb-0.5">üå≥</div><div class="text-[9px] font-bold text-gray-600">Level C</div></div>
                        </div>
                        <div class="grid grid-cols-2 gap-1.5 mb-4">
                            <div onclick="updateLevel('TOEIC', this)" class="level-card cursor-pointer py-2 rounded-xl bg-gray-50 text-center"><div class="text-base mb-0.5">üíº</div><div class="text-[9px] font-bold text-gray-600">TOEIC</div></div>
                            <div onclick="updateLevel('IELTS', this)" class="level-card cursor-pointer py-2 rounded-xl bg-gray-50 text-center"><div class="text-base mb-0.5">üéì</div><div class="text-[9px] font-bold text-gray-600">IELTS</div></div>
                        </div>
                        <div class="flex justify-between items-center mb-1"><label class="text-[10px] font-bold text-gray-400 tracking-wider">S·ªê L∆Ø·ª¢NG C√ÇU H·ªéI</label><span id="qtyDisplay" class="text-[10px] font-bold text-white bg-gray-800 px-1.5 py-0.5 rounded">10</span></div>
                        <input type="range" id="quantityRange" min="5" max="30" step="5" value="10" class="w-full h-1.5 bg-gray-100 rounded-lg appearance-none cursor-pointer accent-yellow-500 hover:accent-yellow-400">
                    </div>
                </div>
            </div>

            <!-- GAME SCREEN -->
            <div id="gameScreen" class="hidden flex-1 flex flex-col h-full w-full screen-fade bg-white">
                <div class="no-shrink px-4 pt-2 pb-1 bg-white z-10 transition-all border-b border-gray-50">
                    <div id="gameHeader" class="flex justify-between items-center mb-1.5 transition-all">
                        <span class="font-bold text-gray-400 text-[10px] uppercase tracking-wider truncate max-w-[60%]" id="gameTitle">General</span>
                        <div class="flex items-center gap-2">
                             <div id="comboBadge" class="hidden fire-badge px-2 py-0.5 rounded-full text-[10px] font-black items-center gap-1 shadow-sm transition-all transform scale-0">
                                <i class="fas fa-fire"></i> <span id="comboCountText">x2</span>
                             </div>
                            <div class="bg-gray-100 px-2 py-0.5 rounded-full text-[10px] font-bold text-gray-600 flex items-center gap-1">
                                <i class="fas fa-flag text-yellow-500"></i> <span id="currentQ">1</span>/<span id="totalQ">10</span>
                            </div>
                        </div>
                    </div>
                    <div id="progressBarContainer" class="w-full bg-gray-100 rounded-full h-1 overflow-hidden transition-all"><div id="progressBar" class="bg-yellow-400 h-full rounded-full transition-all duration-500 ease-out shadow-[0_0_10px_rgba(250,204,21,0.5)]" style="width: 10%"></div></div>
                </div>

                <div id="gameDisplayWrapper" class="scrollable-content px-4 w-full flex items-center justify-center relative">
                    <div id="floatingComboContainer" class="absolute inset-0 pointer-events-none flex justify-center items-center z-50"></div>

                    <div class="game-content-box w-full flex flex-col items-center py-4 justify-center min-h-[100px] transition-all">
                        <span id="instructionText" class="text-[9px] font-bold text-gray-300 uppercase tracking-[0.2em] mb-2 bg-gray-50 px-3 py-1 rounded-full transition-all">Translate</span>

                        <!-- READING PASSAGE AREA -->
                        <div id="readingPassageDisplay" class="reading-passage-box hidden custom-scroll"></div>

                        <!-- MAIN DISPLAY -->
                        <h2 id="mainDisplay" class="text-xl sm:text-2xl font-black text-center text-gray-800 mb-2 leading-tight break-words max-w-full drop-shadow-sm transition-all">Loading...</h2>

                        <!-- SCRAMBLE MODE UI (HIDDEN DEFAULT) -->
                        <div id="scrambleContainer" class="w-full hidden flex-col items-center gap-4 mt-2">
                             <div id="scrambleResult" class="result-zone w-full min-h-[60px] flex justify-center text-center"></div>
                             <div class="w-full border-t border-gray-100"></div>
                             <div id="scrambleBank" class="flex flex-wrap justify-center gap-1.5 w-full"></div>
                        </div>

                        <!-- ROLEPLAY CHAT UI (HIDDEN DEFAULT) -->
                        <div id="roleplayContainer" class="hidden w-full h-full flex flex-col">
                            <div id="chatHistory" class="flex-1 w-full chat-container overflow-y-auto custom-scroll">
                                <!-- Chat bubbles go here -->
                            </div>
                        </div>

                        <!-- LISTENING UI -->
                        <div id="listeningDisplay" class="hidden flex flex-col items-center">
                            <button onclick="playTTS()" class="w-16 h-16 rounded-full bg-pink-100 text-pink-500 flex items-center justify-center text-2xl shadow-md active:scale-95 transition-transform mb-2 speaker-pulse"><i class="fas fa-volume-up"></i></button>
                            <p class="text-gray-400 text-[10px] font-bold">Tap to listen</p>
                        </div>

                        <p id="subDisplay" class="text-indigo-500 font-bold text-xs hidden bg-indigo-50 px-3 py-1 rounded-lg mt-1 animate-bounce-slow border border-indigo-100 transition-all">(hint)</p>

                        <!-- QUICK OPTIONS -->
                        <div id="quickOptions" class="hidden flex-wrap justify-center gap-2 mt-2 w-full"></div>
                    </div>
                </div>

                <!-- COMPACT INPUT ROW -->
                <div id="inputContainer" class="no-shrink p-2 bg-white border-t border-gray-50 w-full z-10 shadow-[0_-5px_20px_rgba(0,0,0,0.02)] transition-all">
                    <div class="flex items-center gap-2 w-full">
                        <div class="relative flex-1 group" id="inputWrapper">
                            <input type="text" id="answerInput" class="w-full bg-gray-50 border-2 border-transparent text-base font-bold py-2.5 px-4 rounded-xl focus:outline-none focus:bg-white focus:border-yellow-400 transition-all shadow-inner placeholder-gray-300" placeholder="Nh·∫≠p ƒë√°p √°n..." autocomplete="off">
                        </div>
                        <button id="checkBtn" onclick="checkAnswer()" class="no-shrink w-11 h-11 bg-gray-900 text-white text-base rounded-xl shadow-lg shadow-gray-400/30 active:scale-[0.9] transition-all flex items-center justify-center hover:bg-black">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- RESULT SCREEN -->
            <div id="resultScreen" class="hidden flex-1 flex flex-col h-full scrollable-content custom-scroll p-6 text-center screen-fade bg-[#FFFBEB]">
                <div class="flex-1 flex flex-col items-center justify-center w-full max-w-md mx-auto">
                    <div class="relative mb-6">
                        <div class="absolute inset-0 bg-yellow-300 blur-2xl opacity-30 rounded-full"></div>
                        <div class="text-7xl relative animate-bounce">üèÜ</div>
                    </div>
                    <h2 class="text-3xl font-black mb-2 text-gray-800">Ho√†n th√†nh!</h2>
                    <div class="flex items-center gap-3 mb-8 bg-white px-6 py-3 rounded-full border border-yellow-100 shadow-sm">
                         <span class="text-gray-400 text-xs font-bold uppercase tracking-wider">Score</span>
                         <div class="flex items-baseline gap-1">
                            <span id="finalScore" class="font-black text-yellow-500 text-2xl">0</span>
                            <span class="text-gray-300 text-lg">/</span>
                            <span id="totalScoreQ" class="font-bold text-gray-400 text-lg">10</span>
                         </div>
                    </div>
                    <div id="resultList" class="w-full bg-white rounded-3xl border border-white p-2 mb-4 overflow-y-auto max-h-[50vh] custom-scroll text-left shadow-lg shadow-yellow-100/50"></div>
                </div>
                <button id="reviewBtn" onclick="startReview()" class="hidden w-full bg-orange-500 text-white font-bold py-4 rounded-3xl shadow-lg shadow-orange-200 active:scale-95 no-shrink mb-3 transition-transform"><i class="fas fa-recycle mr-2"></i> H·ªçc l·∫°i ngay</button>
                <button onclick="resetGame()" class="w-full bg-gray-900 text-white font-bold py-4 rounded-3xl shadow-lg active:scale-95 no-shrink mb-8"><i class="fas fa-redo mr-2"></i> Ch∆°i l·∫°i</button>
            </div>
        </div>

        <!-- MODALS (Hidden by default) -->
        <!-- Topic Modal -->
        <div id="topicModal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm pointer-events-auto transition-opacity duration-300 opacity-0" id="topicBackdrop" onclick="closeTopicModal()"></div>
            <div class="bg-white w-full sm:w-[28rem] h-[90vh] sm:h-[85vh] rounded-t-3xl sm:rounded-3xl flex flex-col pointer-events-auto transform transition-transform duration-300 translate-y-full" id="topicContentPanel">
                <div class="p-5 border-b flex items-center justify-between bg-yellow-50 rounded-t-3xl">
                    <div><h2 class="font-black text-xl text-yellow-800 flex items-center gap-2">üìö Ch·ªçn Ch·ªß ƒê·ªÅ</h2><p class="text-xs text-yellow-600 font-medium">Oxford Picture Dictionary System</p></div>
                    <button onclick="closeTopicModal()" class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-gray-500 shadow-sm"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-4 bg-white" id="topicListContent"></div>
            </div>
        </div>

        <!-- Settings -->
        <div id="settingsPanel" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm pointer-events-auto transition-opacity duration-300 opacity-0" id="settingsBackdrop" onclick="toggleSettings()"></div>
            <div class="bg-white w-full sm:w-[28rem] rounded-t-3xl sm:rounded-3xl p-6 pointer-events-auto transform transition-transform duration-300 translate-y-full safe-pb" id="settingsContent">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fas fa-cog text-gray-400"></i> C√†i ƒë·∫∑t</h2>
                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-4">
                    <p class="text-sm text-indigo-800 font-bold mb-1">Th·ªëng k√™ h·ªçc t·∫≠p</p>
                    <p class="text-xs text-indigo-600 mb-1">Chu·ªói ng√†y (Streak): <span id="settingStreak" class="font-bold">0</span> ng√†y üî•</p>
                    <p class="text-xs text-indigo-600">L·∫ßn h·ªçc cu·ªëi: <span id="lastLearnedTime" class="font-bold">Ch∆∞a c√≥</span></p>
                </div>
                <p id="keyStatus" class="text-xs mt-4 text-center text-green-600 font-bold">‚úÖ ƒê√£ k·∫øt n·ªëi Server</p>
                <div class="mt-4 text-center"><p class="text-[0.6rem] text-gray-400 font-bold">¬© nguyenbachtoan</p></div>
            </div>
        </div>

        <!-- Dictionary -->
        <div id="dictModal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm pointer-events-auto transition-opacity duration-300 opacity-0" id="dictBackdrop" onclick="closeDictModal()"></div>
            <div class="bg-white w-full sm:w-[28rem] h-[85vh] sm:h-[80vh] rounded-t-3xl sm:rounded-3xl flex flex-col pointer-events-auto transform transition-transform duration-300 translate-y-full" id="dictContent">
                <div class="p-4 border-b flex items-center justify-between">
                    <h2 class="font-bold text-lg text-orange-600 flex items-center gap-2"><i class="fas fa-language"></i> T·ª´ ƒêi·ªÉn</h2>
                    <button onclick="closeDictModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-4 bg-gray-50"><div class="relative"><input type="text" id="dictInput" class="w-full pl-11 pr-12 py-3.5 bg-white border-none shadow-sm rounded-2xl font-bold text-gray-700 placeholder-gray-400 focus:ring-2 focus:ring-orange-200" placeholder="Nh·∫≠p t·ª´ c·∫ßn tra..."><i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-300"></i><button onclick="lookupDictionary()" class="absolute right-2 top-2 p-1.5 bg-orange-100 text-orange-600 rounded-xl"><i class="fas fa-arrow-right"></i></button></div></div>
                <div class="flex-1 overflow-y-auto p-5" id="dictResultArea"><div class="text-center text-gray-400 mt-10"><i class="fas fa-book text-4xl mb-2 opacity-20"></i><p class="text-sm">Tra t·ª´ Anh-Vi·ªát / Vi·ªát-Anh</p></div></div>
            </div>
        </div>

        <!-- Theory -->
        <div id="theoryModal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm pointer-events-auto transition-opacity duration-300 opacity-0" id="theoryBackdrop" onclick="closeTheoryModal()"></div>
            <div class="bg-white w-full sm:w-[28rem] h-[85vh] sm:h-[80vh] rounded-t-3xl sm:rounded-3xl flex flex-col pointer-events-auto transform transition-transform duration-300 translate-y-full" id="theoryContentPanel">
                <div class="p-4 border-b flex items-center justify-between bg-indigo-50/50 rounded-t-3xl">
                    <h2 class="font-bold text-lg text-indigo-900 flex items-center gap-2"><i class="fas fa-graduation-cap"></i> S·ªï tay</h2>
                    <button onclick="closeTheoryModal()" class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-gray-500 shadow-sm"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex p-2 gap-2 bg-white border-b" id="theoryTabs">
                    <button onclick="switchTheoryTab('grammar')" id="btnTheoryGrammar" class="flex-1 py-2.5 rounded-xl text-xs font-bold bg-indigo-100 text-indigo-700 transition-colors">12 Th√¨</button>
                    <button onclick="switchTheoryTab('forms')" id="btnTheoryForms" class="flex-1 py-2.5 rounded-xl text-xs font-bold text-gray-500 hover:bg-gray-50 transition-colors">Bi·∫øn th·ªÉ</button>
                </div>
                <div class="flex-1 overflow-y-auto p-4 bg-gray-50" id="theoryContent">
                    <div id="theoryListGrammar" class="space-y-2"></div>
                    <div id="theoryListForms" class="hidden space-y-2"></div>
                    <div id="theoryDetail" class="hidden h-full flex flex-col">
                        <button onclick="backToTheoryList()" class="mb-4 bg-white px-4 py-2 rounded-xl shadow-sm w-fit text-xs font-bold text-gray-600 border border-gray-100"><i class="fas fa-arrow-left mr-1"></i> Quay l·∫°i</button>
                        <div id="theoryDetailContent" class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 text-sm leading-relaxed text-gray-700"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- OVERLAYS -->
        <div id="loadingOverlay" class="hidden absolute inset-0 bg-white/90 z-[60] flex flex-col items-center justify-center backdrop-blur-sm"><div class="loader mb-4"></div><p id="loadingText" class="text-gray-600 font-bold text-sm tracking-wide animate-pulse">ƒêANG X·ª¨ L√ù...</p></div>

        <div id="feedbackOverlay" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center pointer-events-none">
            <div class="absolute inset-0 bg-white/95 backdrop-blur-md pointer-events-auto animate-fadeIn"></div>
            <div class="relative z-10 flex flex-col items-center justify-center w-full max-w-sm p-6 text-center pointer-events-auto">
                <div id="feedbackIcon" class="text-7xl mb-4 filter drop-shadow-md transform transition-transform hover:scale-110 duration-300">üéâ</div>
                <h3 id="feedbackTitle" class="text-3xl font-black mb-6 tracking-tight">Ch√≠nh x√°c!</h3>
                <div class="bg-white rounded-3xl p-6 w-full mb-8 border border-gray-100 shadow-xl relative overflow-hidden group">
                    <div class="absolute top-0 left-0 w-2 h-full bg-green-500 transition-all group-hover:w-3" id="feedbackBorder"></div>
                    <p class="text-gray-400 text-[10px] uppercase font-black tracking-[0.2em] mb-3">ƒê√ÅP √ÅN ƒê√öNG</p>
                    <div class="flex flex-col items-center gap-4">
                        <span id="correctAnswerText" class="text-3xl font-black text-gray-800 break-words leading-tight">Answer</span>
                        <button onclick="playTTS()" class="w-12 h-12 rounded-full bg-gray-50 border border-gray-200 text-gray-600 flex items-center justify-center shadow-sm active:scale-90 transition-transform"><i class="fas fa-volume-up text-lg"></i></button>
                    </div>
                    <p id="synonymText" class="text-xs text-gray-500 mt-3 hidden bg-gray-50 p-2 rounded-lg italic border-t border-gray-100 pt-2 w-full text-center"></p>
                    <p id="grammarExplanation" class="text-sm text-indigo-600 mt-5 pt-4 border-t border-gray-100 italic hidden text-left bg-indigo-50/50 -mx-6 -mb-6 p-6"></p>
                </div>
                <button onclick="nextQuestion()" class="w-full bg-gray-900 text-white font-bold text-lg py-4 rounded-3xl shadow-xl shadow-gray-400/40 active:scale-95 transition-transform flex items-center justify-center group">Ti·∫øp t·ª•c <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i></button>
            </div>
        </div>

    </div>

    <script type="module">
        (function setupPWA() {
            const canvas = document.createElement('canvas'); canvas.width = 1024; canvas.height = 1024; const ctx = canvas.getContext('2d');
            const grd = ctx.createLinearGradient(0, 0, 1024, 1024); grd.addColorStop(0, '#FCD34D'); grd.addColorStop(1, '#D97706');
            ctx.fillStyle = grd; ctx.fillRect(0, 0, 1024, 1024); ctx.beginPath(); ctx.arc(512, 512, 400, 0, 2 * Math.PI); ctx.fillStyle = 'rgba(255, 255, 255, 0.2)'; ctx.fill();
            ctx.font = '600px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('ü•ë', 512, 540);
            const url = canvas.toDataURL('image/png'); document.getElementById('apple-icon').href = url; document.getElementById('fav-icon').href = url;
        })();

        if (window.visualViewport) {
            function handleVisualResize() {
                const appViewport = document.getElementById('app-viewport');
                const height = window.visualViewport.height;
                const offsetTop = window.visualViewport.offsetTop;
                appViewport.style.height = `${height}px`;
                appViewport.style.top = `${offsetTop}px`;
                if (height < window.innerHeight * 0.75) {
                    document.body.classList.add('keyboard-mode');
                    setTimeout(() => {
                        const activeEl = document.activeElement;
                        if(activeEl && activeEl.id === 'answerInput' && !activeEl.closest('#inputWrapper').classList.contains('hidden')) {
                            activeEl.scrollIntoView({block: "end", behavior: "smooth"});
                        }
                    }, 50);
                } else {
                    document.body.classList.remove('keyboard-mode');
                }
            }
            window.visualViewport.addEventListener('resize', handleVisualResize);
            window.visualViewport.addEventListener('scroll', handleVisualResize);
            handleVisualResize();
        }

        const SERVER_URL = 'https://english-tutor-grammar-server.onrender.com';

        // --- USER SYSTEM: STREAK & PERSISTENT DATA ---
        const UserSystem = {
            data: { streak: 0, lastLoginDate: null, lastActivityTime: null, wrongAnswers: [] },
            load() {
                const s = localStorage.getItem('aiTutorUser');
                if (s) { try { const parsed = JSON.parse(s); this.data = { ...this.data, ...parsed }; if(!this.data.wrongAnswers) this.data.wrongAnswers = []; } catch (e) { console.error("Data Load Error", e); } }
                this.checkStreak(); this.updateUI();
            },
            save() { localStorage.setItem('aiTutorUser', JSON.stringify(this.data)); this.updateUI(); },
            checkStreak() {
                const today = new Date().toDateString();
                const last = this.data.lastLoginDate;
                if (last && last !== today) {
                    const d1 = new Date(last); const d2 = new Date(today);
                    const diffDays = Math.ceil(Math.abs(d2 - d1) / (1000 * 60 * 60 * 24));
                    if (diffDays > 1) this.data.streak = 0;
                }
            },
            recordActivity() {
                const today = new Date().toDateString();
                if (this.data.lastLoginDate !== today) {
                    const last = this.data.lastLoginDate;
                    if (last) {
                        const d1 = new Date(last); const d2 = new Date(today);
                        const diffDays = Math.ceil(Math.abs(d2 - d1) / (1000 * 60 * 60 * 24));
                        if (diffDays === 1) this.data.streak++; else this.data.streak = 1;
                    } else { this.data.streak = 1; }
                    this.data.lastLoginDate = today;
                }
                this.data.lastActivityTime = new Date().toLocaleString('vi-VN');
                this.save();
            },
            addWrongAnswer(item, mode) {
                const exists = this.data.wrongAnswers.find(w => w.question === item.question || (item.vi && w.question === item.vi));
                if (!exists) { this.data.wrongAnswers.push({ ...item, savedMode: mode, addedDate: new Date().toDateString() }); this.save(); }
            },
            removeWrongAnswer(questionText) {
                this.data.wrongAnswers = this.data.wrongAnswers.filter(w => w.question !== questionText && w.vi !== questionText);
                this.save();
            },
            updateUI() {
                const streakEl = document.getElementById('streakCount'); if (streakEl) streakEl.textContent = this.data.streak;
                const settingStreak = document.getElementById('settingStreak'); if(settingStreak) settingStreak.textContent = this.data.streak;
                const lastTime = document.getElementById('lastLearnedTime'); if(lastTime) lastTime.textContent = this.data.lastActivityTime || "Ch∆∞a c√≥";
                const reviewContainer = document.getElementById('dailyReviewContainer');
                const wrongCount = document.getElementById('wrongCount');
                if (reviewContainer && wrongCount) {
                    if (this.data.wrongAnswers && this.data.wrongAnswers.length > 0) { reviewContainer.classList.remove('hidden'); wrongCount.textContent = this.data.wrongAnswers.length; }
                    else { reviewContainer.classList.add('hidden'); }
                }
            }
        };

        const nopdTopics = {
            "Everyday Language": [{en: "Meeting & Greeting", vi: "Ch√†o h·ªèi & L√†m quen"}, {en: "Time & Date", vi: "Th·ªùi gian & Ng√†y th√°ng"}, {en: "Numbers", vi: "S·ªë ƒë·∫øm"}, {en: "Colors", vi: "M√†u s·∫Øc"}, {en: "Weather", vi: "Th·ªùi ti·∫øt"}, {en: "Money", vi: "Ti·ªÅn t·ªá"}],
            "People": [{en: "Family Members", vi: "Th√†nh vi√™n gia ƒë√¨nh"}, {en: "The Human Body", vi: "C∆° th·ªÉ ng∆∞·ªùi"}, {en: "Face & Hair", vi: "G∆∞∆°ng m·∫∑t & T√≥c"}, {en: "Emotions", vi: "C·∫£m x√∫c"}, {en: "Clothes", vi: "Qu·∫ßn √°o"}, {en: "Daily Routine", vi: "Th√≥i quen h√†ng ng√†y"}],
            "Housing": [{en: "House Exterior", vi: "Ngo·∫°i th·∫•t ng√¥i nh√†"}, {en: "Living Room", vi: "Ph√≤ng kh√°ch"}, {en: "Kitchen", vi: "Nh√† b·∫øp"}, {en: "Bedroom", vi: "Ph√≤ng ng·ªß"}, {en: "Bathroom", vi: "Ph√≤ng t·∫Øm"}, {en: "Household Chores", vi: "Vi·ªác nh√†"}],
            "Food": [{en: "Fruit", vi: "Tr√°i c√¢y"}, {en: "Vegetables", vi: "Rau c·ªß"}, {en: "Meat & Poultry", vi: "Th·ªãt & Gia c·∫ßm"}, {en: "Seafood", vi: "H·∫£i s·∫£n"}, {en: "Drinks", vi: "ƒê·ªì u·ªëng"}, {en: "Supermarket", vi: "Si√™u th·ªã"}, {en: "Restaurant", vi: "Nh√† h√†ng"}],
            "Health": [{en: "Medical Care", vi: "ChƒÉm s√≥c y t·∫ø"}, {en: "Ailments & Injuries", vi: "B·ªánh & Ch·∫•n th∆∞∆°ng"}, {en: "The Hospital", vi: "B·ªánh vi·ªán"}, {en: "Dental Care", vi: "ChƒÉm s√≥c nha khoa"}],
            "Community": [{en: "The City", vi: "Th√†nh ph·ªë"}, {en: "Downtown", vi: "Trung t√¢m th√†nh ph·ªë"}, {en: "Shopping Mall", vi: "Trung t√¢m th∆∞∆°ng m·∫°i"}, {en: "Bank", vi: "Ng√¢n h√†ng"}, {en: "Post Office", vi: "B∆∞u ƒëi·ªán"}, {en: "Library", vi: "Th∆∞ vi·ªán"}],
            "Transport": [{en: "Car Parts", vi: "Ph·ª• t√πng xe h∆°i"}, {en: "Bicycle", vi: "Xe ƒë·∫°p"}, {en: "Public Transportation", vi: "Giao th√¥ng c√¥ng c·ªông"}, {en: "Airport", vi: "S√¢n bay"}, {en: "Traffic Signs", vi: "Bi·ªÉn b√°o giao th√¥ng"}],
            "Work": [{en: "Office", vi: "VƒÉn ph√≤ng"}, {en: "Construction Site", vi: "C√¥ng tr∆∞·ªùng x√¢y d·ª±ng"}, {en: "Farming", vi: "N√¥ng tr·∫°i"}, {en: "Jobs & Occupations", vi: "Ngh·ªÅ nghi·ªáp"}, {en: "Tools", vi: "D·ª•ng c·ª•"}],
            "Nature": [{en: "Animals", vi: "ƒê·ªông v·∫≠t"}, {en: "Birds & Insects", vi: "Chim & C√¥n tr√πng"}, {en: "Plants & Trees", vi: "C√¢y c·ªëi"}, {en: "The Universe", vi: "V≈© tr·ª•"}, {en: "Environment", vi: "M√¥i tr∆∞·ªùng"}],
            "School": [{en: "Classroom", vi: "L·ªõp h·ªçc"}, {en: "School Subjects", vi: "M√¥n h·ªçc"}, {en: "Stationery", vi: "VƒÉn ph√≤ng ph·∫©m"}, {en: "Study Activities", vi: "Ho·∫°t ƒë·ªông h·ªçc t·∫≠p"}],
            "Recreation": [{en: "Sports", vi: "Th·ªÉ thao"}, {en: "Hobbies", vi: "S·ªü th√≠ch"}, {en: "Music", vi: "√Çm nh·∫°c"}, {en: "Beach", vi: "B√£i bi·ªÉn"}, {en: "Camping", vi: "C·∫Øm tr·∫°i"}]
        };

        const offlineData = {
            vocab: { "Daily Life": [{vi: "C√† ph√™", en: "coffee", others: "java, joe"}, {vi: "M√°y t√≠nh", en: "computer", others: "pc, laptop"}, {vi: "S√°ch", en: "book", others: "volume, novel"}, {vi: "B√∫t", en: "pen", others: "biro, marker"}], "Work & Business": [{vi: "Ph√°t tri·ªÉn", en: "develop", others: "grow, expand"}]},
            phrases: { "General": [{vi: "B·ªè cu·ªôc", en: "give up", others: "quit, surrender"}, {vi: "ChƒÉm s√≥c", en: "look after", others: "take care of"}] },
            idioms: { "General": [{vi: "M·ªôt m≈©i t√™n tr√∫ng hai ƒë√≠ch", en: "kill two birds with one stone", others: ""}, {vi: "M∆∞a nh∆∞ tr√∫t n∆∞·ªõc", en: "raining cats and dogs", others: ""}] },
            grammar: {
                "Present Simple": [{question: "She usually ___ (walk) to work.", verb: "walk", answer: "walks", explanation: "Th√≥i quen ·ªü hi·ªán t·∫°i (She -> V+s)."}, {question: "The sun ___ (rise) in the East.", verb: "rise", answer: "rises", explanation: "S·ª± th·∫≠t hi·ªÉn nhi√™n."}],
                "Present Continuous": [{question: "Look! It ___ (rain) outside.", verb: "rain", answer: "is raining", explanation: "ƒêang x·∫£y ra l√∫c n√≥i (Look!)."}, {question: "I ___ (study) now.", verb: "study", answer: "am studying", explanation: "ƒêang di·ªÖn ra (now)."}],
                "Present Perfect": [{question: "I ___ (see) that movie twice.", verb: "see", answer: "have seen", explanation: "Kinh nghi·ªám trong qu√° kh·ª©."}],
                "Present Perfect Continuous": [{question: "It ___ (rain) for 3 hours.", verb: "rain", answer: "has been raining", explanation: "Nh·∫•n m·∫°nh qu√° tr√¨nh li√™n t·ª•c."}],
                "Past Simple": [{question: "I ___ (go) to the cinema yesterday.", verb: "go", answer: "went", explanation: "ƒê√£ x·∫£y ra v√† k·∫øt th√∫c (yesterday)."}],
                "Past Continuous": [{question: "I ___ (read) when he came.", verb: "read", answer: "was reading", explanation: "ƒêang x·∫£y ra th√¨ h√†nh ƒë·ªông kh√°c xen v√†o."}],
                "Past Perfect": [{question: "When I arrived, the train ___ (leave).", verb: "leave", answer: "had left", explanation: "X·∫£y ra tr∆∞·ªõc 1 h√†nh ƒë·ªông QK kh√°c."}],
                "Past Perfect Continuous": [{question: "He was tired because he ___ (work) all day.", verb: "work", answer: "had been working", explanation: "Nguy√™n nh√¢n c·ªßa tr·∫°ng th√°i QK."}],
                "Future Simple": [{question: "I think it ___ (rain) tomorrow.", verb: "rain", answer: "will rain", explanation: "D·ª± ƒëo√°n kh√¥ng cƒÉn c·ª©."}],
                "Future Continuous": [{question: "At 9 AM tomorrow, I ___ (work).", verb: "work", answer: "will be working", explanation: "Th·ªùi ƒëi·ªÉm c·ª• th·ªÉ trong TL."}],
                "Future Perfect": [{question: "By next year, I ___ (graduate).", verb: "graduate", answer: "will have graduated", explanation: "Ho√†n th√†nh tr∆∞·ªõc m·ªëc TL (By)."}],
                "Future Perfect Continuous": [{question: "By 2030, I ___ (teach) for 20 years.", verb: "teach", answer: "will have been teaching", explanation: "Qu√° tr√¨nh t√≠nh ƒë·∫øn m·ªëc TL."}]
            },
            forms: {
                "irregular": [{question: "go (V2)", answer: "went", explanation: "go - went - gone"}, {question: "buy (V2)", answer: "bought", explanation: "buy - bought - bought"}],
                "irregular_v3": [{question: "go (V3)", answer: "gone", explanation: "go - went - gone"}, {question: "write (V3)", answer: "written", explanation: "write - wrote - written"}],
                "noun_suffix": [{question: "inform (Noun -tion)", answer: "information", explanation: "Th√™m -ation."}, {question: "develop (Noun -ment)", answer: "development", explanation: "Th√™m -ment."}],
                "adj_suffix": [{question: "beauty (Adj -ful)", answer: "beautiful", explanation: "y -> i + ful."}, {question: "care (Adj -less)", answer: "careless", explanation: "Th√™m -less."}],
                "prefixes": [{question: "happy (Prefix: not)", answer: "unhappy", explanation: "Th√™m un-."}, {question: "agree (Prefix: not)", answer: "disagree", explanation: "Th√™m dis-."}],
                "verb_noun": [{question: "decide (Noun)", answer: "decision", explanation: "de -> sion."}, {question: "arrive (Noun)", answer: "arrival", explanation: "e -> al."}],
                "noun_adj": [{question: "danger (Adj)", answer: "dangerous", explanation: "+ ous."}, {question: "fame (Adj)", answer: "famous", explanation: "e -> ous."}],
                "adj_adv": [{question: "quick (Adv)", answer: "quickly", explanation: "+ ly."}, {question: "happy (Adv)", "answer": "happily", explanation: "y -> i + ly."}],
                "ing": [{question: "run", answer: "running", explanation: "G·∫•p ƒë√¥i ph·ª• √¢m."}, {question: "swim", answer: "swimming", explanation: "G·∫•p ƒë√¥i ph·ª• √¢m."}],
                "ed": [{question: "stop", answer: "stopped", explanation: "G·∫•p ƒë√¥i ph·ª• √¢m."}, {question: "plan", answer: "planned", explanation: "G·∫•p ƒë√¥i ph·ª• √¢m."}],
                "classify": [{question: "She runs [fast]. (Type?)", answer: "adverb", explanation: "B·ªï nghƒ©a cho ƒë·ªông t·ª´ runs."}, {question: "It is a [fast] car. (Type?)", "answer": "adjective", explanation: "B·ªï nghƒ©a cho danh t·ª´ car."}]
            },
            scramble: { "General": [{vi: "T√¥i ƒëi h·ªçc b·∫±ng xe bu√Ωt.", en: "I go to school by bus"}, {vi: "C√¥ ·∫•y ƒëang n·∫•u ƒÉn trong b·∫øp.", en: "She is cooking in the kitchen"}] },
            reading: { "Daily Life": [{passage: "My name is John...", question: "What time does John wake up?", answer: "6 AM", options: ["6 AM", "7 AM"], type: "mc", explanation: "Text says: 'I wake up at 6 AM'."}] },
            theory: {
                "Present Simple": { title: "Th√¨ Hi·ªán T·∫°i ƒê∆°n (Present Simple)", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono"><div class="mb-1"><span class="text-green-600 font-bold">(+)</span> S + V(s/es)</div><div class="mb-1"><span class="text-red-500 font-bold">(-)</span> S + do/does + not + V</div><div><span class="text-blue-500 font-bold">(?)</span> Do/Does + S + V?</div></div><h3 class="font-bold text-indigo-700 mb-2">2. C√°ch d√πng</h3><ul class="list-disc list-inside space-y-1 mb-4 text-gray-700"><li>Th√≥i quen ·ªü hi·ªán t·∫°i.</li><li>S·ª± th·∫≠t hi·ªÉn nhi√™n.</li><li>L·ªãch tr√¨nh c·ªë ƒë·ªãnh.</li></ul>` },
                "Present Continuous": { title: "Th√¨ Hi·ªán T·∫°i Ti·∫øp Di·ªÖn", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + am/is/are + V-ing</div><h3 class="font-bold text-indigo-700 mb-2">2. C√°ch d√πng</h3><ul class="list-disc list-inside space-y-1 mb-4 text-gray-700"><li>ƒêang x·∫£y ra l√∫c n√≥i.</li><li>ƒêang di·ªÖn ra xung quanh th·ªùi ƒëi·ªÉm n√≥i.</li></ul>` },
                "Present Perfect": { title: "Th√¨ Hi·ªán T·∫°i Ho√†n Th√†nh", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + have/has + V3/ed</div><h3 class="font-bold text-indigo-700 mb-2">2. C√°ch d√πng</h3><ul class="list-disc list-inside space-y-1 mb-4 text-gray-700"><li>H√†nh ƒë·ªông b·∫Øt ƒë·∫ßu trong QK, c√≤n ti·∫øp di·ªÖn.</li><li>V·ª´a m·ªõi x·∫£y ra.</li><li>Kinh nghi·ªám.</li></ul>` },
                "Present Perfect Continuous": { title: "HT Ho√†n Th√†nh Ti·∫øp Di·ªÖn", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + have/has + been + V-ing</div><p>Nh·∫•n m·∫°nh t√≠nh li√™n t·ª•c c·ªßa h√†nh ƒë·ªông t·ª´ QK ƒë·∫øn HT.</p>` },
                "Past Simple": { title: "Th√¨ Qu√° Kh·ª© ƒê∆°n", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + V2/ed</div><p>H√†nh ƒë·ªông ƒë√£ k·∫øt th√∫c trong qu√° kh·ª©.</p>` },
                "Past Continuous": { title: "Th√¨ Qu√° Kh·ª© Ti·∫øp Di·ªÖn", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + was/were + V-ing</div><p>ƒêang x·∫£y ra t·∫°i 1 th·ªùi ƒëi·ªÉm trong QK.</p>` },
                "Past Perfect": { title: "Th√¨ Qu√° Kh·ª© Ho√†n Th√†nh", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + had + V3/ed</div><p>X·∫£y ra tr∆∞·ªõc 1 h√†nh ƒë·ªông kh√°c trong QK.</p>` },
                "Past Perfect Continuous": { title: "QK Ho√†n Th√†nh Ti·∫øp Di·ªÖn", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + had + been + V-ing</div><p>Nh·∫•n m·∫°nh qu√° tr√¨nh tr∆∞·ªõc 1 hƒë trong QK.</p>` },
                "Future Simple": { title: "Th√¨ T∆∞∆°ng Lai ƒê∆°n", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + will + V</div><p>D·ª± ƒëo√°n, quy·∫øt ƒë·ªãnh t·ª©c th·ªùi.</p>` },
                "Future Continuous": { title: "Th√¨ T∆∞∆°ng Lai Ti·∫øp Di·ªÖn", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + will + be + V-ing</div><p>S·∫Ω ƒëang x·∫£y ra t·∫°i 1 th·ªùi ƒëi·ªÉm c·ª• th·ªÉ trong TL.</p>` },
                "Future Perfect": { title: "Th√¨ T∆∞∆°ng Lai Ho√†n Th√†nh", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + will + have + V3/ed</div><p>S·∫Ω ho√†n th√†nh tr∆∞·ªõc 1 th·ªùi ƒëi·ªÉm trong TL.</p>` },
                "Future Perfect Continuous": { title: "TL Ho√†n Th√†nh Ti·∫øp Di·ªÖn", content: `<h3 class="font-bold text-indigo-700 mb-2">1. C√¥ng th·ª©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + will + have + been + V-ing</div><p>Nh·∫•n m·∫°nh qu√° tr√¨nh t√≠nh ƒë·∫øn TL.</p>` },
                "irregular": { title: "ƒê·ªông t·ª´ B·∫•t Quy T·∫Øc (V2)", content: `<p>Kh√¥ng th√™m -ed. <br>VD: Go -> Went, Buy -> Bought.</p>` },
                "irregular_v3": { title: "Qu√° kh·ª© ph√¢n t·ª´ (V3)", content: `<p>D√πng cho th√¨ Ho√†n th√†nh/B·ªã ƒë·ªông. <br>VD: Go -> Gone, Write -> Written.</p>` },
                "noun_suffix": { title: "H·∫≠u t·ªë Danh t·ª´", content: `<p>Ch·ªâ ng∆∞·ªùi: -er, -or, -ist. <br>Ch·ªâ v·∫≠t: -tion, -ment, -ness.</p>` },
                "adj_suffix": { title: "H·∫≠u t·ªë T√≠nh t·ª´", content: `<p>VD: -ful (ƒë·∫ßy), -less (kh√¥ng), -able (c√≥ th·ªÉ), -ous.</p>` },
                "prefixes": { title: "Ti·ªÅn t·ªë (Prefixes)", content: `<p>Ph·ªß ƒë·ªãnh: un-, dis-, im-, in-. <br>VD: unhappy, dislike.</p>` },
                "verb_noun": { title: "ƒê·ªông t·ª´ ‚Üí Danh t·ª´", content: `<p>VD: decide -> decision, arrive -> arrival.</p>` },
                "noun_adj": { title: "Danh t·ª´ ‚Üí T√≠nh t·ª´", content: `<p>VD: danger -> dangerous, beauty -> beautiful.</p>` },
                "adj_adv": { title: "T√≠nh t·ª´ ‚Üí Tr·∫°ng t·ª´", content: `<p>Th∆∞·ªùng th√™m -ly. <br>VD: quick -> quickly.</p>` },
                "ing": { title: "Quy t·∫Øc th√™m -ING", content: `<p>B·ªè 'e' cu·ªëi (write->writing). G·∫•p ƒë√¥i ph·ª• √¢m (run->running).</p>` },
                "ed": { title: "Quy t·∫Øc th√™m -ED", content: `<p>T·∫≠n c√πng 'y' -> 'ied' (study->studied). G·∫•p ƒë√¥i ph·ª• √¢m (stop->stopped).</p>` },
                "classify": { title: "Ph√¢n lo·∫°i t·ª´", content: `<p>Noun (Danh t·ª´), Verb (ƒê·ªông t·ª´), Adjective (T√≠nh t·ª´), Adverb (Tr·∫°ng t·ª´).</p>` }
            }
        };

        const tenseTranslations = { "Present Simple": "Hi·ªán t·∫°i ƒë∆°n", "Present Continuous": "Hi·ªán t·∫°i ti·∫øp di·ªÖn", "Present Perfect": "Hi·ªán t·∫°i ho√†n th√†nh", "Present Perfect Continuous": "HT ho√†n th√†nh ti·∫øp di·ªÖn", "Past Simple": "Qu√° kh·ª© ƒë∆°n", "Past Continuous": "Qu√° kh·ª© ti·∫øp di·ªÖn", "Past Perfect": "Qu√° kh·ª© ho√†n th√†nh", "Past Perfect Continuous": "QK ho√†n th√†nh ti·∫øp di·ªÖn", "Future Simple": "T∆∞∆°ng lai ƒë∆°n", "Future Continuous": "T∆∞∆°ng lai ti·∫øp di·ªÖn", "Future Perfect": "T∆∞∆°ng lai ho√†n th√†nh", "Future Perfect Continuous": "TL ho√†n th√†nh ti·∫øp di·ªÖn" };
        const formReadableNames = { "irregular": "Irregular Verbs (B·∫•t quy t·∫Øc)", "irregular_v3": "Past Participle (Qu√° kh·ª© ph√¢n t·ª´)", "noun_suffix": "Noun Suffixes (H·∫≠u t·ªë Danh t·ª´)", "adj_suffix": "Adjective Suffixes (H·∫≠u t·ªë T√≠nh t·ª´)", "prefixes": "Prefixes (Ti·ªÅn t·ªë)", "verb_noun": "Verb to Noun (ƒê·ªông t·ª´ ‚Üí Danh t·ª´)", "noun_adj": "Noun to Adjective (Danh t·ª´ ‚Üí T√≠nh t·ª´)", "adj_adv": "Adjective to Adverb (T√≠nh t·ª´ ‚Üí Tr·∫°ng t·ª´)", "ing": "-ING Ending (ƒêu√¥i -ING)", "ed": "-ED Ending (ƒêu√¥i -ED)", "classify": "Word Class (Ph√¢n lo·∫°i t·ª´)" };

        let gameState = { mode: 'vocab', data: [], currentIdx: 0, score: 0, history: [], currentCorrect: "", currentOthers: [], isReviewMode: false, roleplayContext: null };
        let currentGlobalTopic = null;
        let currentGlobalTopicVi = null;
        let comboCount = 0;

        const els = {
            screens: { start: document.getElementById('startScreen'), game: document.getElementById('gameScreen'), result: document.getElementById('resultScreen') },
            views: { sharedInput: document.getElementById('sharedInputArea'), reading: document.getElementById('viewReading'), grammar: document.getElementById('viewGrammar'), forms: document.getElementById('viewForms') },
            inputs: { vocabTopic: document.getElementById('vocabTopicInput'), vocabSelect: document.getElementById('vocabTopicSelect'), readingTopic: document.getElementById('readingTopicInput'), readingSelect: document.getElementById('readingTopicSelect'), grammarTense: document.getElementById('grammarTenseSelect'), formsType: document.getElementById('formsTypeSelect'), answer: document.getElementById('answerInput'), dict: document.getElementById('dictInput') },
            game: { title: document.getElementById('gameTitle'), qNum: document.getElementById('currentQ'), totalQ: document.getElementById('totalQ'), progress: document.getElementById('progressBar'), display: document.getElementById('mainDisplay'), passageDisplay: document.getElementById('readingPassageDisplay'), listeningDisplay: document.getElementById('listeningDisplay'), subDisplay: document.getElementById('subDisplay'), instruction: document.getElementById('instructionText'), quickOptions: document.getElementById('quickOptions'), comboBadge: document.getElementById('comboBadge'), comboText: document.getElementById('comboCountText'), floatingCombo: document.getElementById('floatingComboContainer'), scrambleContainer: document.getElementById('scrambleContainer'), scrambleBank: document.getElementById('scrambleBank'), scrambleResult: document.getElementById('scrambleResult'), roleplayContainer: document.getElementById('roleplayContainer'), chatHistory: document.getElementById('chatHistory') },
            feedback: { overlay: document.getElementById('feedbackOverlay'), title: document.getElementById('feedbackTitle'), correctText: document.getElementById('correctAnswerText'), explanation: document.getElementById('grammarExplanation'), synonym: document.getElementById('synonymText'), border: document.getElementById('feedbackBorder') },
            settings: { panel: document.getElementById('settingsPanel'), content: document.getElementById('settingsContent'), backdrop: document.getElementById('settingsBackdrop'), keyStatus: document.getElementById('keyStatus') },
            dict: { modal: document.getElementById('dictModal'), content: document.getElementById('dictContent'), backdrop: document.getElementById('dictBackdrop'), result: document.getElementById('dictResultArea'), input: document.getElementById('dictInput') },
            theory: { modal: document.getElementById('theoryModal'), content: document.getElementById('theoryContentPanel'), backdrop: document.getElementById('theoryBackdrop'), listGrammar: document.getElementById('theoryListGrammar'), listForms: document.getElementById('theoryListForms'), detail: document.getElementById('theoryDetail'), contentText: document.getElementById('theoryDetailContent'), tabs: { grammar: document.getElementById('btnTheoryGrammar'), forms: document.getElementById('btnTheoryForms') } },
            topic: { modal: document.getElementById('topicModal'), content: document.getElementById('topicContentPanel'), backdrop: document.getElementById('topicBackdrop'), list: document.getElementById('topicListContent'), banner: document.getElementById('activeTopicBanner'), bannerName: document.getElementById('activeTopicName'), bannerNameVi: document.getElementById('activeTopicNameVi') },
            wrappers: { inputWrapper: document.getElementById('inputWrapper'), lockedOverlay: document.getElementById('lockedInputOverlay'), lockedName: document.getElementById('lockedTopicName'), lockedNameVi: document.getElementById('lockedTopicNameVi') },
            config: { level: document.getElementById('levelSelect'), qtyInput: document.getElementById('quantityRange'), qtyDisplay: document.getElementById('qtyDisplay') },
            loading: { overlay: document.getElementById('loadingOverlay'), text: document.getElementById('loadingText') },
            aiStatus: { dot: document.getElementById('aiStatusDot') },
            checkBtn: document.getElementById('checkBtn'),
            modeCards: { vocab: document.getElementById('mode-vocab'), phrases: document.getElementById('mode-phrases'), idioms: document.getElementById('mode-idioms'), listening: document.getElementById('mode-listening'), reading: document.getElementById('mode-reading'), grammar: document.getElementById('mode-grammar'), forms: document.getElementById('mode-forms'), scramble: document.getElementById('mode-scramble'), roleplay: document.getElementById('mode-roleplay') }
        };

        const toggleModal = (modal, content, backdrop, show) => { if (show) { modal.classList.remove('hidden'); setTimeout(() => { backdrop.classList.remove('opacity-0'); content.classList.remove('translate-y-full'); }, 10); } else { backdrop.classList.add('opacity-0'); content.classList.add('translate-y-full'); setTimeout(() => { modal.classList.add('hidden'); }, 300); } };
        const checkKeyStatus = () => { if(els.aiStatus.dot) els.aiStatus.dot.className = "ai-status-dot status-online"; };
        const toggleSettings = () => { const isHidden = els.settings.panel.classList.contains('hidden'); toggleModal(els.settings.panel, els.settings.content, els.settings.backdrop, isHidden); };
        const openDictModal = () => { toggleModal(els.dict.modal, els.dict.content, els.dict.backdrop, true); setTimeout(() => els.dict.input.focus(), 300); };
        const closeDictModal = () => toggleModal(els.dict.modal, els.dict.content, els.dict.backdrop, false);
        const openTheoryModal = () => { toggleModal(els.theory.modal, els.theory.content, els.theory.backdrop, true); switchTheoryTab('grammar'); };
        const closeTheoryModal = () => toggleModal(els.theory.modal, els.theory.content, els.theory.backdrop, false);
        const openTopicModal = () => { renderTopicList(); toggleModal(els.topic.modal, els.topic.content, els.topic.backdrop, true); };
        const closeTopicModal = () => toggleModal(els.topic.modal, els.topic.content, els.topic.backdrop, false);

        const renderTopicList = () => {
            let html = '';
            for (const [category, topics] of Object.entries(nopdTopics)) {
                html += `<div class="mb-4"><h3 class="font-black text-gray-400 text-xs uppercase tracking-widest mb-2 sticky top-0 bg-white py-1 z-10">${category}</h3><div class="grid grid-cols-2 gap-2">${topics.map(topic => `<div onclick="selectTopic('${topic.en}', '${topic.vi}')" class="topic-cat-card bg-gray-50 hover:bg-yellow-50 border border-gray-100 hover:border-yellow-200 p-3 rounded-xl cursor-pointer flex flex-col justify-center min-h-[60px]"><span class="font-bold text-gray-700 text-sm leading-tight mb-1">${topic.en}</span><span class="text-[10px] text-gray-400 font-medium leading-tight">${topic.vi}</span></div>`).join('')}</div></div>`;
            }
            els.topic.list.innerHTML = html;
        };

        const selectTopic = (topicEn, topicVi) => {
            currentGlobalTopic = topicEn; currentGlobalTopicVi = topicVi;
            els.topic.banner.classList.remove('hidden'); els.topic.bannerName.textContent = topicEn; els.topic.bannerNameVi.textContent = topicVi;
            els.wrappers.lockedOverlay.classList.remove('hidden'); els.wrappers.lockedName.textContent = topicEn; els.wrappers.lockedNameVi.textContent = topicVi;
            closeTopicModal();
            const activeCard = document.querySelector('.mode-card.active'); if (activeCard) { setMode(activeCard.id.replace('mode-', '')); }
        };

        const clearTopic = () => { currentGlobalTopic = null; currentGlobalTopicVi = null; els.topic.banner.classList.add('hidden'); els.wrappers.lockedOverlay.classList.add('hidden'); const activeCard = document.querySelector('.mode-card.active'); if (activeCard) { setMode(activeCard.id.replace('mode-', '')); } };

        // --- CONFETTI & COMBO LOGIC ---
        const canvasConfetti = document.getElementById('confetti-canvas');
        const ctxConfetti = canvasConfetti.getContext('2d');
        let particles = [];
        const resizeCanvas = () => { canvasConfetti.width = window.innerWidth; canvasConfetti.height = window.innerHeight; };
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function createParticles(x, y, count) {
            const colors = ['#FCD34D', '#EF4444', '#3B82F6', '#10B981', '#8B5CF6'];
            for (let i = 0; i < count; i++) {
                particles.push({ x: x, y: y, vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 1) * 10 - 2, size: Math.random() * 8 + 4, color: colors[Math.floor(Math.random() * colors.length)], life: 100, decay: Math.random() * 0.05 + 0.02 });
            }
        }
        function updateConfetti() {
            ctxConfetti.clearRect(0, 0, canvasConfetti.width, canvasConfetti.height);
            for (let i = 0; i < particles.length; i++) {
                let p = particles[i]; p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life -= 1; p.size -= p.decay;
                if (p.life > 0 && p.size > 0) { ctxConfetti.fillStyle = p.color; ctxConfetti.beginPath(); ctxConfetti.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctxConfetti.fill(); }
                else { particles.splice(i, 1); i--; }
            }
            if (particles.length > 0) requestAnimationFrame(updateConfetti);
        }
        function fireConfetti(fullScreen = false) {
            if (fullScreen) { createParticles(window.innerWidth / 2, window.innerHeight / 2, 100); }
            else { createParticles(window.innerWidth / 2, window.innerHeight / 1.5, 30); }
            if (particles.length <= 100) requestAnimationFrame(updateConfetti);
        }
        function triggerComboVisuals(streak) {
            if (streak > 1) { els.game.display.classList.remove('pop-in'); void els.game.display.offsetWidth; els.game.display.classList.add('pop-in'); }
            if (streak >= 2) {
                const floatEl = document.createElement('div'); floatEl.className = 'combo-text text-4xl'; floatEl.textContent = `COMBO x${streak}!`;
                floatEl.style.left = '50%'; floatEl.style.top = '40%'; floatEl.style.transform = 'translate(-50%, -50%)';
                els.game.floatingCombo.appendChild(floatEl); setTimeout(() => floatEl.remove(), 1000);
            }
            if (streak >= 2) { els.game.comboBadge.classList.remove('hidden', 'scale-0'); els.game.comboBadge.classList.add('scale-100', 'flex'); els.game.comboText.textContent = `x${streak}`; }
            else { els.game.comboBadge.classList.add('hidden', 'scale-0'); els.game.comboBadge.classList.remove('flex'); }
            if (streak % 5 === 0) fireConfetti(true); else if (streak > 1) fireConfetti(false);
        }

        // --- GAME LOGIC ---
        async function robustFetch(url, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url); if (!res.ok) throw new Error(`HTTP Error: ${res.status}`); return await res.json();
                } catch (e) { if (i === retries - 1) throw e; await new Promise(r => setTimeout(r, 1000 * (i + 1))); }
            }
        }

        async function callServerAI(promptText, jsonMode = true, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(`${SERVER_URL}/api/generate`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt: promptText, jsonMode: jsonMode }) });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);
                    if (jsonMode) {
                        let cleanText = data.result.replace(/```json/g, '').replace(/```/g, '').trim();
                        const parsed = JSON.parse(cleanText);
                        if (Array.isArray(parsed)) { if (parsed.length === 0) throw new Error("Empty Array Returned"); return parsed; }
                        if (typeof parsed === 'object' && parsed !== null) { if (parsed.title || parsed.definition || parsed.reply) return parsed; const values = Object.values(parsed); const foundArray = values.find(v => Array.isArray(v)); if (foundArray && foundArray.length > 0) return foundArray; if (Object.keys(parsed).length > 0) return parsed; }
                        throw new Error("AI returned unrecognized data structure.");
                    } else { return data.result; }
                } catch (e) {
                    console.warn(`Server Attempt ${i + 1} failed: ${e.message}`);
                    const loadingText = document.getElementById('loadingText'); if(loadingText && !loadingText.parentElement.classList.contains('hidden')) loadingText.textContent = `ƒêANG TH·ª¨ L·∫†I (${i+1}/${retries})...`;
                    if (i === retries - 1) throw e; await new Promise(r => setTimeout(r, 1500 * (i + 1)));
                }
            }
        }

        const updateUI = () => {
             if (gameState.mode !== 'roleplay' && (!gameState.data || !gameState.data[gameState.currentIdx])) return;
             const item = gameState.data[gameState.currentIdx];
            els.game.qNum.textContent = gameState.currentIdx + 1;
            els.game.progress.style.width = `${((gameState.currentIdx + 1) / (gameState.data.length || 10)) * 100}%`;
            els.inputs.answer.value = "";
            els.game.quickOptions.classList.add('hidden'); els.game.quickOptions.innerHTML = '';
            els.game.display.classList.remove('hidden'); els.game.listeningDisplay.classList.add('hidden'); els.game.subDisplay.classList.add('hidden'); els.game.passageDisplay.classList.add('hidden'); els.game.scrambleContainer.classList.add('hidden'); els.game.roleplayContainer.classList.add('hidden');
            els.wrappers.inputWrapper.classList.remove('hidden');
            els.checkBtn.classList.remove('btn-expanded', 'w-full', 'rounded-3xl'); els.checkBtn.classList.add('w-11', 'rounded-xl', 'no-shrink'); els.checkBtn.innerHTML = '<i class="fas fa-check"></i>';
            els.inputs.answer.placeholder = "Nh·∫≠p ƒë√°p √°n...";

            let modeToRender = gameState.isReviewMode ? item.savedMode : gameState.mode;

            if(modeToRender === 'vocab') { els.game.display.textContent = item.vi; els.game.instruction.textContent = "TRANSLATE TO ENGLISH"; gameState.currentCorrect = item.en; gameState.currentOthers = item.others ? item.others.split(',').map(s => s.trim().toLowerCase()) : []; }
            else if (modeToRender === 'phrases') { els.game.display.textContent = item.vi; els.game.instruction.textContent = "TRANSLATE PHRASE"; gameState.currentCorrect = item.en; gameState.currentOthers = item.others ? item.others.split(',').map(s => s.trim().toLowerCase()) : []; }
            else if (modeToRender === 'idioms') { els.game.display.textContent = item.vi; els.game.instruction.textContent = "TRANSLATE PROVERB"; gameState.currentCorrect = item.en; gameState.currentOthers = item.others ? item.others.split(',').map(s => s.trim().toLowerCase()) : []; }
            else if (modeToRender === 'listening') { els.game.display.classList.add('hidden'); els.game.listeningDisplay.classList.remove('hidden'); els.game.instruction.textContent = "LISTEN & WRITE"; els.game.subDisplay.textContent = `(Nghƒ©a: ${item.vi})`; els.game.subDisplay.classList.remove('hidden'); gameState.currentCorrect = item.en; gameState.currentOthers = item.others ? item.others.split(',').map(s => s.trim().toLowerCase()) : []; setTimeout(() => playTTS(), 500); }
            else if (modeToRender === 'reading') {
                els.game.passageDisplay.textContent = item.passage; els.game.passageDisplay.classList.remove('hidden');
                els.game.display.textContent = item.question; els.game.display.classList.remove('text-2xl', 'sm:text-2xl'); els.game.display.classList.add('text-lg', 'sm:text-xl');
                els.game.instruction.textContent = item.type === 'tf' ? "TRUE OR FALSE?" : (item.type === 'cloze' ? "FILL IN THE BLANK" : "MULTIPLE CHOICE");
                gameState.currentCorrect = item.answer; gameState.currentOthers = [];
                if (item.type !== 'cloze') { els.wrappers.inputWrapper.classList.add('hidden'); els.checkBtn.classList.remove('w-11', 'rounded-xl', 'no-shrink'); els.checkBtn.classList.add('btn-expanded', 'w-full', 'rounded-3xl'); els.checkBtn.innerHTML = '<span class="font-bold mr-2">KI·ªÇM TRA</span> <i class="fas fa-check"></i>'; }
                if (item.options && item.options.length > 0 && item.type !== 'cloze') { els.game.quickOptions.classList.remove('hidden'); item.options.forEach(opt => { const btn = document.createElement('button'); btn.className = "option-chip bg-white px-3 py-2 rounded-xl text-sm font-bold text-gray-700 shadow-sm w-full mb-1"; btn.textContent = opt; btn.onclick = () => { Array.from(els.game.quickOptions.children).forEach(c => c.classList.remove('option-selected')); btn.classList.add('option-selected'); els.inputs.answer.value = opt; }; els.game.quickOptions.appendChild(btn); }); }
            }
            else if (modeToRender === 'grammar') { els.game.display.textContent = item.question; els.game.instruction.textContent = "TYPE THE CONJUGATED VERB"; els.game.subDisplay.textContent = item.verb ? `Verb: (${item.verb})` : ""; els.game.subDisplay.classList.remove('hidden'); gameState.currentCorrect = item.answer; gameState.currentOthers = item.others ? item.others.split(',').map(s => s.trim().toLowerCase()) : []; }
            else if (modeToRender === 'forms') { els.game.display.textContent = item.question; els.game.instruction.textContent = "WORD FORM"; els.game.subDisplay.classList.add('hidden'); gameState.currentCorrect = item.answer; gameState.currentOthers = []; }
            else if (modeToRender === 'scramble') {
                els.game.display.textContent = item.vi;
                els.game.instruction.textContent = "ARRANGE THE SENTENCE";
                gameState.currentCorrect = item.en;
                els.wrappers.inputWrapper.classList.add('hidden');
                els.game.scrambleContainer.classList.remove('hidden');
                renderScrambleGame(item.en);
                els.checkBtn.classList.remove('w-11', 'rounded-xl', 'no-shrink');
                els.checkBtn.classList.add('btn-expanded', 'w-full', 'rounded-3xl');
                els.checkBtn.innerHTML = '<span class="font-bold mr-2">KI·ªÇM TRA</span> <i class="fas fa-check"></i>';
            }
            else if (modeToRender === 'roleplay') {
                els.game.display.classList.add('hidden');
                els.game.roleplayContainer.classList.remove('hidden');
                els.game.instruction.textContent = "ROLEPLAY CHAT";
                els.inputs.answer.placeholder = "Type your reply...";
                els.checkBtn.innerHTML = '<i class="fas fa-paper-plane"></i>'; // Send icon

                // If starting fresh
                if(gameState.currentIdx === 0 && els.game.chatHistory.children.length === 0) {
                     // Add initial bubble with optional vocabulary marking if context provided it
                     // But usually context just has string.
                     addChatBubble('ai', gameState.roleplayContext.aiFirstMessage);
                }
            }
        };

        // --- ROLEPLAY LOGIC ---
        function applyVocabulary(text, vocabList) {
            if (!vocabList || !Array.isArray(vocabList) || vocabList.length === 0) return text;
            
            let formattedText = text;
            // Sort by length (descending) to avoid partial replacement issues
            vocabList.sort((a, b) => b.word.length - a.word.length);

            vocabList.forEach(item => {
                // Use a simple regex to replace matching words with HTML
                // Note: This is client-side simple replacement.
                // We escape special chars in the word just in case
                const escapedWord = item.word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                
                // FIXED REGEX: No word boundaries (\b) if it causes issues, but ideally \b is good.
                // However, matching case insensitive 'gi' is key.
                const regex = new RegExp(`(${escapedWord})`, 'gi');
                
                // Only replace if it exists (check once to avoid complex replacement logic if possible)
                if (regex.test(formattedText)) {
                    // $1 retains the original casing
                    formattedText = formattedText.replace(regex, `$1<span class="vocab-note">(${item.meaning})</span>`);
                }
            });
            return formattedText;
        }

        function addChatBubble(sender, text, feedbackHtml = null, isRawHtml = false) {
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${sender}`;
            
            if (isRawHtml) bubble.innerHTML = text;
            else bubble.textContent = text;
            
            els.game.chatHistory.appendChild(bubble);

            if (feedbackHtml) {
                const fb = document.createElement('div');
                // Removed chat-feedback class for custom card style
                fb.innerHTML = feedbackHtml;
                els.game.chatHistory.appendChild(fb);
            }
            els.game.chatHistory.scrollTop = els.game.chatHistory.scrollHeight;
        }

        async function handleRoleplaySubmit() {
            const userText = els.inputs.answer.value.trim();
            if (!userText) return;

            addChatBubble('user', userText);
            els.inputs.answer.value = '';

            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-bubble ai typing-indicator';
            typingDiv.innerHTML = '<span></span><span></span><span></span>';
            typingDiv.id = 'typingIndicator';
            els.game.chatHistory.appendChild(typingDiv);
            els.game.chatHistory.scrollTop = els.game.chatHistory.scrollHeight;

            // Generate AI Response
            try {
                // Enhanced Prompt asking for Vocabulary Extraction + Detailed Correction
                const prompt = `
Context: English learning roleplay.
Scenario: "${gameState.roleplayContext.scenario}"
My Role (AI): "${gameState.roleplayContext.aiRole}"
User Role: "${gameState.roleplayContext.userRole}"
User just said: "${userText}"

Instructions:
1.  **Analyze**: Check the user's input for grammar, vocabulary, or pragmatics errors.
    - If PERFECT: set 'isCorrect' to true, 'correction' to null.
    - If WRONG/UNNATURAL: set 'isCorrect' to false. Provide the FULL Corrected Sentence in 'correction'. Provide a detailed explanation in Vietnamese in 'explanation'.
    - 'explanation' must explain WHY it is wrong (tense usage, preposition, unnatural phrasing, context).
    - 'errorType': Categorize as "Grammar", "Vocabulary", or "Context".

2.  **Reply**: Respond naturally to continue the conversation.
    - **Vocabulary Extraction**: Identify 1-3 useful/difficult words/phrases in YOUR reply. Provide their Vietnamese meaning.
    - IMPORTANT: The 'word' field MUST be the EXACT STRING found in your 'reply' (e.g. if reply has "running", 'word' must be "running", not "run").

Output JSON:
{
  "reply": "Your response string...",
  "vocabulary": [ { "word": "exact_substring_from_reply", "meaning": "vietnamese_meaning" } ],
  "analysis": {
    "isCorrect": boolean,
    "correction": "Full corrected sentence OR null",
    "explanation": "Vietnamese explanation OR null",
    "errorType": "Grammar/Vocabulary/Context"
  },
  "isFinished": boolean
}`;

                const response = await callServerAI(prompt);

                if(document.getElementById('typingIndicator')) document.getElementById('typingIndicator').remove();

                // Logic to handle feedback display (Enhanced Correction Card)
                let feedbackHtml = null;
                if (response.analysis && !response.analysis.isCorrect && response.analysis.correction) {
                    // Double check to prevent hallucinated corrections
                    const uClean = userText.trim().replace(/[.,!?;]/g, '').toLowerCase();
                    const cClean = response.analysis.correction.trim().replace(/[.,!?;]/g, '').toLowerCase();

                    if (uClean !== cClean) {
                         feedbackHtml = `
                         <div class="correction-card">
                            <div class="correction-header">
                                <i class="fas fa-wrench"></i> ${response.analysis.errorType || "Suggestion"}
                            </div>
                            <div class="correction-content">
                                <div class="correction-diff">
                                    <span class="diff-wrong">${userText}</span>
                                    <span class="diff-right">${response.analysis.correction}</span>
                                </div>
                                <div class="correction-explanation">
                                    <span class="correction-tag">Gi·∫£i th√≠ch:</span> ${response.analysis.explanation || ''}
                                </div>
                            </div>
                         </div>`;
                    }
                }

                // Apply Vocabulary Notes to the Reply
                const richReply = applyVocabulary(response.reply, response.vocabulary);

                addChatBubble('ai', richReply, feedbackHtml, true); // true = render as HTML

                if (response.isFinished) {
                    setTimeout(() => {
                         alert("Cu·ªôc h·ªôi tho·∫°i ƒë√£ k·∫øt th√∫c th√†nh c√¥ng! +5 ƒëi·ªÉm.");
                         gameState.score += 5;
                         finishGame();
                    }, 3000);
                } else {
                    gameState.currentIdx++; // Increment turn count
                    if(gameState.currentIdx > 15) { // Limit turns
                        setTimeout(() => { alert("Great conversation! You survived 15 turns."); finishGame(); }, 1000);
                    }
                }

            } catch (e) {
                if(document.getElementById('typingIndicator')) document.getElementById('typingIndicator').remove();
                addChatBubble('ai', "Sorry, I lost my train of thought. Please try saying that again.");
                console.error(e);
            }
        }

        // --- SCRAMBLE LOGIC ---
        function renderScrambleGame(sentence) {
            const words = sentence.split(' ');
            const shuffled = [...words].sort(() => Math.random() - 0.5);
            els.game.scrambleBank.innerHTML = ''; els.game.scrambleResult.innerHTML = ''; els.game.scrambleResult.classList.remove('has-items');
            shuffled.forEach((word, idx) => {
                const chip = document.createElement('div'); chip.className = 'word-chip'; chip.textContent = word; chip.dataset.word = word; chip.dataset.id = idx;
                chip.onclick = () => moveScrambleWord(chip); els.game.scrambleBank.appendChild(chip);
            });
        }
        function moveScrambleWord(chip) {
            const isResult = chip.parentElement === els.game.scrambleResult;
            if (isResult) { els.game.scrambleBank.appendChild(chip); chip.classList.remove('selected'); }
            else { els.game.scrambleResult.appendChild(chip); chip.classList.add('selected'); }
            if (els.game.scrambleResult.children.length > 0) els.game.scrambleResult.classList.add('has-items'); else els.game.scrambleResult.classList.remove('has-items');
            updateScrambleInput();
        }
        function updateScrambleInput() { const words = Array.from(els.game.scrambleResult.children).map(c => c.textContent); els.inputs.answer.value = words.join(' '); }

        const checkAnswer = () => {
            if (gameState.mode === 'roleplay') {
                handleRoleplaySubmit();
                return;
            }

            let user = els.inputs.answer.value.trim();
            if (gameState.mode === 'scramble') {
                 const normalize = s => s.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").toLowerCase().replace(/\s{2,}/g," ");
                 user = normalize(user);
                 const correctNorm = normalize(gameState.currentCorrect);
                 if (user === correctNorm) user = gameState.currentCorrect.toLowerCase();
            } else { user = user.toLowerCase(); }

            if(!user && gameState.mode !== 'scramble') { if(els.checkBtn.classList.contains('btn-expanded')) { els.checkBtn.classList.add('animate-pulse'); setTimeout(()=>els.checkBtn.classList.remove('animate-pulse'), 200); } return; }
            if (gameState.currentIdx >= gameState.data.length) return;
            const item = gameState.data[gameState.currentIdx];
            const mainCorrect = gameState.currentCorrect.toLowerCase();
            const isCorrect = user === mainCorrect || gameState.currentOthers.includes(user);

            gameState.history.push({ q: gameState.mode === 'listening' ? `üîä ${item.en}` : (gameState.mode === 'reading' ? `üìñ ${item.question}` : els.game.display.textContent), a: gameState.currentCorrect, u: els.inputs.answer.value, ok: isCorrect });

            if(isCorrect) {
                gameState.score++; comboCount++; triggerComboVisuals(comboCount);
                if (gameState.score / gameState.data.length > 0.8) fireConfetti(true);
                if (gameState.isReviewMode) UserSystem.removeWrongAnswer(item.question || item.vi);
            } else {
                comboCount = 0; els.game.comboBadge.classList.add('hidden');
                els.game.display.classList.add('shake-element'); setTimeout(() => els.game.display.classList.remove('shake-element'), 300);
                if (!gameState.isReviewMode) UserSystem.addWrongAnswer(item, gameState.mode);
            }

            els.feedback.title.textContent = isCorrect ? "Tuy·ªát v·ªùi!" : "Sai r·ªìi!";
            els.feedback.title.className = isCorrect ? "text-4xl font-black mb-6 tracking-tight text-green-600" : "text-4xl font-black mb-6 tracking-tight text-red-500";
            els.feedback.border.className = isCorrect ? "absolute top-0 left-0 w-2 h-full bg-green-500 transition-all group-hover:w-3" : "absolute top-0 left-0 w-2 h-full bg-red-500 transition-all group-hover:w-3";
            document.getElementById('feedbackIcon').textContent = isCorrect ? "üéâ" : "üòÖ"; els.feedback.correctText.textContent = gameState.currentCorrect;

            let modeToCheck = gameState.isReviewMode ? item.savedMode : gameState.mode;
            if ((['vocab','listening','phrases','idioms','grammar'].includes(modeToCheck)) && item.others) { els.feedback.synonym.textContent = `Also correct: ${item.others}`; els.feedback.synonym.classList.remove('hidden'); } else { els.feedback.synonym.classList.add('hidden'); }

            els.feedback.explanation.textContent = item.explanation ? "üí° " + item.explanation : ""; els.feedback.explanation.classList.toggle('hidden', !item.explanation);
            els.feedback.overlay.classList.remove('hidden'); document.activeElement?.blur();
        };

        const finishGame = () => {
             UserSystem.recordActivity();
             const wrongCount = gameState.history.filter(h => !h.ok).length;
             const reviewBtn = document.getElementById('reviewBtn');
             if (wrongCount > 0 && !gameState.isReviewMode) { reviewBtn.classList.remove('hidden'); reviewBtn.innerHTML = `<i class="fas fa-recycle mr-2"></i> H·ªçc l·∫°i ngay (${wrongCount})`; } else { reviewBtn.classList.add('hidden'); }
             document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('totalScoreQ').textContent = gameState.data.length || 10;
            document.getElementById('resultList').innerHTML = gameState.history.map(h => `<div class="p-4 border-b border-gray-100 flex gap-4 items-center last:border-0"><div class="w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${h.ok ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-500'} font-bold text-lg">${h.ok?'<i class="fas fa-check"></i>':'<i class="fas fa-times"></i>'}</div><div class="flex-1 min-w-0"><div class="text-xs font-bold text-gray-400 mb-1 truncate">${h.q}</div><div class="font-black text-gray-800 text-base">${h.a}</div>${!h.ok ? `<div class="text-sm font-medium text-red-400 line-through mt-0.5">${h.u}</div>` : ''}</div></div>`).join('');
            switchScreen('result');
        };

        const nextQuestion = () => {
             els.feedback.overlay.classList.add('hidden');
             gameState.currentIdx++;
             if(gameState.currentIdx >= gameState.data.length) finishGame();
             else {
                 updateUI();
                 if (gameState.mode !== 'scramble' && gameState.mode !== 'reading' && gameState.mode !== 'roleplay') {
                      setTimeout(() => els.inputs.answer.focus(), 100);
                 }
             }
        };

        const getRandomSubTopic = () => { const c = Object.keys(nopdTopics); const rc = c[Math.floor(Math.random() * c.length)]; const t = nopdTopics[rc]; return t[Math.floor(Math.random() * t.length)].en; };

        const generateContent = async (type) => {
            const qty = parseInt(els.config.qtyInput.value); const rawLevel = els.config.level.value;
            els.loading.overlay.classList.remove('hidden'); els.loading.text.textContent = "ƒêANG G·ªåI SERVER...";
            gameState.mode = type; gameState.isReviewMode = false;

            let context = "", displayTitle = "";
            if (currentGlobalTopic) { context = currentGlobalTopic; displayTitle = currentGlobalTopic; }
            else {
                 let rawInput = (els.inputs.vocabTopic.value || "").trim();
                 if (type === 'vocab' || type === 'phrases' || type === 'idioms' || type === 'listening' || type === 'scramble' || type === 'roleplay') {
                    if(!rawInput) { context = "Mixed Topics"; displayTitle = "T·ªïng h·ª£p (Mixed)"; } else { context = rawInput; displayTitle = context; }
                 }
                 else if (type === 'reading') { context = els.inputs.readingSelect.value || getRandomSubTopic(); displayTitle = context; }
                 else if (type === 'grammar') {
                     let t = els.inputs.grammarTense.value;
                     if(t === 'random') { context = "Mixed Tenses"; displayTitle = "T·ªïng h·ª£p 12 th√¨"; } else { context = t; displayTitle = t; }
                 }
                 else if (type === 'forms') {
                     let t = els.inputs.formsType.value;
                     if(t === 'random') { context = "Mixed Word Forms"; displayTitle = "Bi·∫øn th·ªÉ t·ªïng h·ª£p"; } else { context = t; displayTitle = formReadableNames[t] || t; }
                 }
            }

            let prompt = "";
            let levelPrompt = rawLevel === 'Level A' ? "CEFR A1 (Basic)" : (rawLevel === 'Level B' ? "CEFR B1 (Intermediate)" : "CEFR C1 (Advanced)");
            const topicInjection = currentGlobalTopic ? `FOCUS TOPIC: '${currentGlobalTopic}'. Ensure sentences relate to this topic.` : "";
            const randomSeed = Math.floor(Math.random() * 10000);
            const orderInstruction = "LIST IN RANDOM ORDER. DO NOT LIST BY FREQUENCY.";

            if (type === 'vocab') {
                 let pc = context === "Mixed Topics" ? "a RANDOM MIX of common English topics" : `'${context}'`;
                 prompt = `Generate ${qty} SINGLE English vocabulary words related to ${pc}. ${topicInjection} STRICT RULES: 1. 'en' MUST be a single word. 2. 'vi' MUST be ACCURATE Vietnamese definition. LEVEL: ${levelPrompt}. ${orderInstruction} Seed: ${randomSeed}. Format: JSON Array [{"vi": "...", "en": "...", "others": "synonyms"}]`;
            }
            else if (type === 'phrases') {
                 let pc = context === "Mixed Topics" ? "a RANDOM MIX of common English topics" : `'${context}'`;
                 prompt = `Generate ${qty} English PHRASAL VERBS or COLLOCATIONS related to ${pc}. ${topicInjection} STRICT RULES: 1. 'en' MUST be a phrase. 2. 'vi' is natural Vietnamese. LEVEL: ${levelPrompt}. ${orderInstruction} Seed: ${randomSeed}. Format: JSON Array [{"vi": "...", "en": "...", "others": "synonyms"}]`;
            }
            else if (type === 'idioms') {
                 let pc = context === "Mixed Topics" ? "VARIOUS common situations" : `'${context}'`;
                 prompt = `Generate ${qty} English IDIOMS or PROVERBS related to ${pc}. ${topicInjection} STRICT RULES: 1. 'en' is the idiom. 2. 'vi' is figurative meaning. ${orderInstruction} Seed: ${randomSeed}. Format: JSON Array [{"vi": "...", "en": "...", "others": "literal meaning"}]`;
            }
            else if (type === 'listening') {
                 let pc = context === "Mixed Topics" ? "VARIOUS common daily topics" : `'${context}'`;
                 prompt = `Generate ${qty} English words/phrases for listening practice related to ${pc}. ${topicInjection} STRICT RULES: 1. 'en' and 'vi' must be accurate translations. LEVEL: ${levelPrompt}. ${orderInstruction} Seed: ${randomSeed}. Format: JSON Array [{"vi": "...", "en": "...", "others": "..."}]`;
            }
            else if (type === 'scramble') {
                 let pc = context === "Mixed Topics" ? "Daily Conversation" : `'${context}'`;
                 prompt = `Generate ${qty} complete English sentences (5-12 words) related to ${pc}. ${topicInjection} STRICT RULES: 1. 'en' must be grammatically correct, natural English. 2. 'vi' is Vietnamese translation. LEVEL: ${levelPrompt}. ${orderInstruction} Seed: ${randomSeed}. Format: JSON Array [{"vi": "...", "en": "..."}]`;
            }
            else if (type === 'reading') {
                 prompt = `Generate ${qty} SHORT reading comprehension questions related to '${context}'. ${topicInjection} STRICT RULES: 1. 'explanation' in VIETNAMESE. LEVEL: ${levelPrompt}. Seed: ${randomSeed}. Format: JSON Array [{"passage": "...", "question": "...", "answer": "...", "options": ["..."], "type": "mc", "explanation": "..."}]`;
            }
            else if (type === 'grammar') {
                 let pc = context === "Mixed Tenses" ? "a RANDOM MIX of English tenses (Present, Past, Future, Perfect, Continuous...)" : `English grammar questions about '${context}'`;
                 prompt = `Generate ${qty} English grammar questions covering ${pc}. ${topicInjection} STRICT RULES: 1. 'question' has blank '___' and base verb in parens. 2. 'answer' is ONLY conjugated verb. 3. 'explanation' in VIETNAMESE. LEVEL: ${levelPrompt}. ${orderInstruction} Seed: ${randomSeed}. Format: JSON Array [{"question": "...", "verb": "...", "answer": "...", "others": "...", "explanation": "..."}]`;
            }
            else if (type === 'forms') {
                 let pc = context === "Mixed Word Forms" ? "a RANDOM MIX of word forms (Noun, Verb, Adjective, Adverb, Prefixes, Suffixes)" : `Word Form exercises for '${context}'`;
                 prompt = `Generate ${qty} ${pc}. ${topicInjection} STRICT RULES: 1. 'explanation' in VIETNAMESE explaining word class change. LEVEL: ${levelPrompt}. ${orderInstruction} Seed: ${randomSeed}. Format: JSON Array [{"question": "...", "answer": "...", "explanation": "..."}]`;
            }
            else if (type === 'roleplay') {
                let pc = context === "Mixed Topics" ? "ordering coffee OR checking in at a hotel" : `${context}`;
                prompt = `Create a Roleplay Scenario for English learning related to: ${pc}. Level: ${levelPrompt}. Output JSON: { "scenario": "Description of situation...", "aiRole": "Role AI plays (e.g. Barista)", "userRole": "Role user plays (e.g. Customer)", "aiFirstMessage": "First sentence AI says to start conversation" }`;
            }

            try {
                const aiResult = await callServerAI(prompt);

                if (type === 'roleplay') {
                    gameState.roleplayContext = aiResult;
                    gameState.data = []; // Not used in roleplay
                    els.game.chatHistory.innerHTML = ''; // Clear chat
                    if (currentGlobalTopic) displayTitle = `${currentGlobalTopic} (Sticky)`;
                    els.game.title.textContent = `ROLEPLAY: ${aiResult.scenario}`;
                    startGame();
                    els.loading.overlay.classList.add('hidden');
                    return;
                }

                if (type !== 'reading') aiResult.sort(() => Math.random() - 0.5);
                gameState.data = aiResult;
                if (currentGlobalTopic) displayTitle = `${currentGlobalTopic} (Sticky)`;
                els.game.title.textContent = `${type.toUpperCase()}: ${displayTitle}`;
                startGame(); els.loading.overlay.classList.add('hidden');
            } catch(e) {
                console.error(e);
                if (type === 'roleplay') {
                    alert("Kh√¥ng th·ªÉ kh·ªüi t·∫°o Roleplay do l·ªói Server. Vui l√≤ng th·ª≠ l·∫°i.");
                    els.loading.overlay.classList.add('hidden');
                    return;
                }
                let source = [];
                // OFFLINE FALLBACK LOGIC
                if (type === 'grammar' && context === 'Mixed Tenses') Object.values(offlineData.grammar).forEach(arr => source = source.concat(arr));
                else if (type === 'forms' && context === 'Mixed Word Forms') Object.values(offlineData.forms).forEach(arr => source = source.concat(arr));
                else if (offlineData[type] && offlineData[type][context]) source = offlineData[type][context];
                else if (offlineData[type]) source = Object.values(offlineData[type]).flat();

                if(!source.length && type==='vocab') source = offlineData.vocab["Daily Life"];
                if(type === 'scramble' && !source.length) source = offlineData.scramble["General"];

                let finalData = []; while(finalData.length < qty && source.length > 0) finalData = finalData.concat([...source].sort(()=>0.5-Math.random()));
                gameState.data = finalData.slice(0, qty); els.game.title.textContent = `${displayTitle} (Offline)`;
                startGame(); els.loading.overlay.classList.add('hidden');
            }
        };

        const startGame = () => { gameState.currentIdx = 0; gameState.score = 0; comboCount = 0; gameState.history = []; els.game.totalQ.textContent = gameState.data.length || 10; switchScreen('game'); updateUI(); };
        const setMode = (mode) => {
             Object.values(els.modeCards).forEach(c => c && c.classList.remove('active', 'border-yellow-400', 'bg-yellow-50'));
             if(els.modeCards[mode]) els.modeCards[mode].classList.add('active');

             Object.values(els.views).forEach(v => v.classList.add('hidden'));
             if(mode === 'reading') els.views.reading.classList.remove('hidden');
             else if(mode === 'grammar') els.views.grammar.classList.remove('hidden');
             else if(mode === 'forms') els.views.forms.classList.remove('hidden');
             else els.views.sharedInput.classList.remove('hidden');
        };

        const startGeneration = () => { const activeCard = document.querySelector('.mode-card.active'); let mode = 'vocab'; if (activeCard) { mode = activeCard.id.replace('mode-', ''); } generateContent(mode); };

        const switchScreen = (n) => { els.screens.start.classList.add('hidden'); els.screens.game.classList.add('hidden'); els.screens.result.classList.add('hidden'); els.screens[n].classList.remove('hidden'); };
        const resetGame = () => { switchScreen('start'); gameState.currentIdx = 0; };
        const startReview = () => {
             const wrongIndices = gameState.history.map((h, i) => h.ok ? -1 : i).filter(i => i !== -1);
             if (wrongIndices.length === 0) return;
             gameState.data = wrongIndices.map(i => gameState.data[i]); gameState.isReviewMode = false; els.game.title.textContent += " (Review)"; startGame();
        };
        const startDailyReview = () => {
             const data = UserSystem.data.wrongAnswers;
             if (!data || data.length === 0) { alert("Kho sai l·∫ßm tr·ªëng!"); return; }
             gameState.data = data.slice(0, 15); gameState.isReviewMode = true; els.game.title.textContent = "√în T·∫≠p Sai L·∫ßm"; startGame();
        };

        const updateLevel = (val, el) => { document.getElementById('levelSelect').value = val; document.querySelectorAll('.level-card').forEach(c => { c.classList.remove('selected', 'bg-yellow-50', 'border-yellow-400'); c.classList.add('bg-gray-50', 'border-transparent'); }); el.classList.add('selected'); };
        const playTTS = () => { if(gameState.currentCorrect) { const u = new SpeechSynthesisUtterance(gameState.currentCorrect); u.lang = 'en-US'; u.rate = 0.9; speechSynthesis.speak(u); } };

        function isVietnamese(str) { return /[√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë]/i.test(str); }

        const lookupDictionary = async () => {
            const word = els.dict.input.value.trim(); if (!word) return;
            els.dict.result.innerHTML = '<div class="flex flex-col items-center justify-center h-48"><div class="loader mb-2"></div><p class="text-xs text-gray-500 font-bold">ƒêang tra c·ª©u...</p></div>';
            try {
                if (isVietnamese(word)) {
                    const data = await robustFetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=vi|en`);
                    if (data.responseStatus === 200) els.dict.result.innerHTML = `<div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 animate-fadeIn"><h2 class="text-2xl font-black text-gray-800 mb-1">${word}</h2><p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">VIETNAMESE</p><div class="border-t border-gray-100 pt-4"><p class="font-bold text-indigo-600 text-xl">${data.responseData.translatedText}</p><p class="text-xs text-gray-400 mt-1">English Translation</p></div></div>`;
                    else els.dict.result.innerHTML = `<div class="p-4 text-center text-red-400 font-bold">Kh√¥ng t√¨m th·∫•y b·∫£n d·ªãch.</div>`;
                } else {
                    let freeApiData = null, translation = null;
                    try { const dictData = await robustFetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`); freeApiData = dictData[0]; } catch (e) {}
                    try { const transData = await robustFetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=en|vi`); if (transData.responseStatus === 200) translation = transData.responseData.translatedText; } catch (e) {}

                    if (!freeApiData && !translation) { els.dict.result.innerHTML = `<div class="text-center p-4 text-gray-400 font-medium">Kh√¥ng t√¨m th·∫•y t·ª´ n√†y.</div>`; return; }

                    let html = `<div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 animate-fadeIn"><div class="flex items-center justify-between mb-2"><h2 class="text-3xl font-black text-gray-800 capitalize">${freeApiData ? freeApiData.word : word}</h2>`;
                    if (freeApiData) { const audioSrc = freeApiData.phonetics.find(p => p.audio)?.audio; if (audioSrc) html += `<button onclick="new Audio('${audioSrc}').play()" class="w-10 h-10 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center hover:bg-orange-200 transition-colors"><i class="fas fa-volume-up"></i></button>`; }
                    html += `</div>`;

                    if (freeApiData) { const phonetic = freeApiData.phonetic || (freeApiData.phonetics.find(p => p.text)?.text) || ""; html += `<p class="text-orange-500 font-mono text-sm mb-6 font-bold">${phonetic}</p>`; }
                    if (translation) html += `<div class="mb-6 bg-green-50 p-4 rounded-2xl border border-green-100"><p class="text-[10px] text-green-800 font-black uppercase tracking-widest mb-1">NGHƒ®A TI·∫æNG VI·ªÜT</p><p class="text-xl font-bold text-gray-800">${translation}</p></div>`;

                    if (freeApiData && freeApiData.meanings) { html += `<div class="mb-2"><h3 class="font-bold text-gray-700 text-sm uppercase tracking-wider border-b border-gray-100 pb-2 mb-3">ƒê·ªãnh nghƒ©a (Anh-Anh)</h3><ul class="list-disc pl-5 text-sm text-gray-600 space-y-2 leading-relaxed">`; const defs = freeApiData.meanings[0].definitions.slice(0, 3); defs.forEach(d => { html += `<li>${d.definition}</li>`; }); html += `</ul></div>`; }
                    html += `</div>`; els.dict.result.innerHTML = html;
                }
            } catch (e) { els.dict.result.innerHTML = `<div class="text-center p-4 text-red-500 font-bold">L·ªói k·∫øt n·ªëi ho·∫∑c API qu√° t·∫£i.</div>`; }
        };

        const renderTheoryAI = (data) => {
            let html = `<div class="animate-fadeIn"><h2 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-blue-500 mb-4 border-b pb-4">${data.title || "L√Ω thuy·∫øt"}</h2>`;
            if(data.definition) html += `<div class="mb-6"><p class="text-gray-700 text-sm leading-relaxed font-medium">${data.definition}</p></div>`;
            if(data.formulas && data.formulas.length > 0) { html += `<h3 class="text-sm font-bold text-indigo-800 mb-3 flex items-center gap-2"><i class="fas fa-flask text-indigo-500"></i> C√¥ng th·ª©c</h3><div class="space-y-2 mb-6">`; data.formulas.forEach(f => { let icon = '‚Ä¢'; let color = 'text-gray-700'; if(f.type === 'affirmative' || f.type.includes('+')) { icon = '(+)'; color = 'text-green-600'; } else if(f.type === 'negative' || f.type.includes('-')) { icon = '(-)'; color = 'text-red-500'; } else if(f.type === 'question' || f.type.includes('?')) { icon = '(?)'; color = 'text-blue-500'; } html += `<div class="bg-indigo-50/50 p-3 rounded-xl border border-indigo-100 flex items-start gap-3"><span class="${color} font-black text-sm pt-0.5 whitespace-nowrap">${icon}</span><span class="font-mono text-sm text-indigo-900 font-bold">${f.formula || f.structure}</span></div>`; }); html += `</div>`; }
            if(data.rules && data.rules.length > 0) { html += `<h3 class="text-sm font-bold text-green-800 mb-3 flex items-center gap-2"><i class="fas fa-gavel text-green-500"></i> Quy t·∫Øc</h3><div class="space-y-2 mb-6">`; data.rules.forEach(r => { html += `<div class="bg-green-50 p-3 rounded-xl border border-green-100"><div class="font-bold text-gray-800 text-sm mb-1">${r.rule}</div>${r.example ? `<div class="text-xs text-gray-500 italic">VD: ${r.example}</div>` : ''}</div>`; }); html += `</div>`; }
            if(data.usages && data.usages.length > 0) { html += `<h3 class="text-sm font-bold text-orange-800 mb-3 flex items-center gap-2"><i class="fas fa-list-ul text-orange-500"></i> C√°ch d√πng</h3><ul class="space-y-2 mb-6">`; data.usages.forEach(u => { html += `<li class="flex items-start gap-2 text-sm text-gray-700 bg-orange-50/50 p-2 rounded-lg border border-orange-100"><i class="fas fa-check-circle text-orange-400 mt-0.5 text-xs"></i> <span>${u}</span></li>`; }); html += `</ul>`; }
            if(data.signs) html += `<h3 class="text-sm font-bold text-purple-800 mb-3 flex items-center gap-2"><i class="fas fa-eye text-purple-500"></i> D·∫•u hi·ªáu nh·∫≠n bi·∫øt</h3><div class="bg-purple-50 p-3 rounded-xl border border-purple-100 text-sm text-purple-900 font-medium italic mb-6">${data.signs}</div>`;
            if(data.examples && data.examples.length > 0) { html += `<h3 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2"><i class="fas fa-quote-left text-gray-400"></i> V√≠ d·ª•</h3><div class="grid gap-2">`; data.examples.forEach(ex => { html += `<div class="border-l-4 border-gray-200 pl-3 py-1"><div class="text-sm font-bold text-gray-800">${ex.en}</div><div class="text-xs text-gray-500">${ex.vi}</div></div>`; }); html += `</div>`; }
            html += `</div>`; return html;
        };

        const loadTheory = async (topic, type) => {
             els.theory.listGrammar.classList.add('hidden'); els.theory.listForms.classList.add('hidden'); els.theory.detail.classList.remove('hidden');
             els.theory.contentText.innerHTML = '<div class="flex flex-col items-center justify-center h-48"><div class="loader mb-2"></div><p class="text-xs text-gray-500 font-bold">ƒêang t·∫£i ki·∫øn th·ª©c t·ª´ Server...</p></div>';
             const friendlyName = formReadableNames[topic] || topic;
             setTimeout(async () => {
                 try {
                     let prompt = "";
                     if (type === 'forms') prompt = `Generate theory for Word Forms: "${friendlyName}". Return ONLY Valid JSON. Structure: { "title": "${friendlyName}", "definition": "...", "rules": [{"rule": "...", "example": "..."}], "examples": [{"en": "...", "vi": "..."}] }`;
                     else prompt = `Generate theory for English Grammar: "${topic}". Return ONLY Valid JSON. Structure: { "title": "Vietnamese Title", "definition": "...", "formulas": [{"type": "affirmative(+)/negative(-)/question(?)", "formula": "..."}], "usages": ["..."], "signs": "...", "examples": [{"en": "...", "vi": "..."}] }`;
                     const jsonData = await callServerAI(prompt);
                     els.theory.contentText.innerHTML = renderTheoryAI(jsonData);
                 } catch(e) {
                     const offlineContent = offlineData.theory[topic];
                     if (offlineContent) els.theory.contentText.innerHTML = `<h2 class="text-2xl font-black text-indigo-900 mb-6 border-b pb-4">${offlineContent.title} (Offline)</h2>${offlineContent.content}`;
                     else els.theory.contentText.innerHTML = `<div class="text-center p-4 text-red-500 font-bold">L·ªói k·∫øt n·ªëi Server v√† kh√¥ng c√≥ d·ªØ li·ªáu Offline.<br><span class="text-xs font-normal text-gray-500">${e.message}</span><br><button onclick="loadTheory('${topic}', '${type}')" class="mt-4 bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg text-xs font-bold">Th·ª≠ l·∫°i</button></div>`;
                 }
             }, 300);
        };

        let theoryTab = 'grammar';
        const switchTheoryTab = (tab) => {
            theoryTab = tab;
            els.theory.tabs.grammar.className = tab==='grammar' ? 'flex-1 py-2.5 rounded-xl text-xs font-bold bg-indigo-100 text-indigo-700 transition-colors' : 'flex-1 py-2.5 rounded-xl text-xs font-bold text-gray-500 hover:bg-gray-50 transition-colors';
            els.theory.tabs.forms.className = tab==='forms' ? 'flex-1 py-2.5 rounded-xl text-xs font-bold bg-green-100 text-green-700 transition-colors' : 'flex-1 py-2.5 rounded-xl text-xs font-bold text-gray-500 hover:bg-gray-50 transition-colors';
            els.theory.listGrammar.classList.toggle('hidden', tab !== 'grammar');
            els.theory.listForms.classList.toggle('hidden', tab !== 'forms');
            els.theory.detail.classList.add('hidden');
            const dataSrc = tab === 'grammar' ? offlineData.grammar : offlineData.forms;
            const container = tab === 'grammar' ? els.theory.listGrammar : els.theory.listForms;
            const keys = Object.keys(dataSrc);
            container.innerHTML = keys.map(t => `<div onclick="loadTheory('${t}', '${tab}')" class="p-4 bg-white rounded-2xl shadow-sm border border-gray-100 cursor-pointer hover:bg-gray-50 active:scale-[0.98] transition-all flex justify-between items-center group"><span class="font-bold text-gray-700 group-hover:text-indigo-600 transition-colors">${tab === 'forms' ? (formReadableNames[t] || t) : `${t} <span class="text-xs font-normal text-gray-500 ml-1">(${tenseTranslations[t] || ''})</span>`}</span><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div>`).join('');
        };

        const backToTheoryList = () => { els.theory.detail.classList.add('hidden'); if(theoryTab === 'grammar') els.theory.listGrammar.classList.remove('hidden'); else els.theory.listForms.classList.remove('hidden'); };

        // --- GLOBAL ASSIGNMENT (EXPOSE TO HTML) ---
        Object.assign(window, {
            openTopicModal, closeTopicModal, selectTopic, clearTopic,
            openDictModal, closeDictModal, lookupDictionary,
            switchTheoryTab, openTheoryModal, closeTheoryModal, backToTheoryList, loadTheory,
            toggleSettings, updateLevel, setMode, switchScreen, resetGame,
            checkAnswer, nextQuestion, startGeneration, playTTS, startReview, startDailyReview
        });

        // --- INITIALIZATION ---
        try {
            checkKeyStatus();
            UserSystem.load();

            // Init Random Options
            if (els.inputs.grammarTense) {
                let html = '<option value="random">üé≤ T·ªïng h·ª£p (Mixed Tenses)</option>';
                html += Object.keys(offlineData.grammar).map(t => `<option value="${t}">${t} (${tenseTranslations[t] || ''})</option>`).join('');
                els.inputs.grammarTense.innerHTML = html;
            }
            if (els.inputs.formsType) {
                let html = '<option value="random">üé≤ T·ªïng h·ª£p (Mixed Forms)</option>';
                html += Object.keys(offlineData.forms).map(t => `<option value="${t}">${formReadableNames[t] || t}</option>`).join('');
                els.inputs.formsType.innerHTML = html;
            }

            setMode('roleplay'); // Default to showcase
            els.inputs.answer.addEventListener('keypress', (e) => { if(e.key === 'Enter') checkAnswer(); });
            els.config.qtyInput.addEventListener('input', (e) => { els.config.qtyDisplay.textContent = `${e.target.value}`; });
        } catch (e) {
            console.error("Initialization Error:", e);
        }
    </script>
</body>
</html>
