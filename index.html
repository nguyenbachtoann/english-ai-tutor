<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vocab & Grammar AI (Offline)</title>

    <!-- PWA Setup -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#fdfbf7">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/144/avocado.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/144/avocado.png">
    <link rel="manifest" id="my-manifest-placeholder">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Quicksand', sans-serif; background-color: #fdfbf7; overscroll-behavior-y: contain; }

        /* Animations */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake-element { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .pop-in { animation: pop 0.3s ease-out forwards; }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #F59E0B; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .ai-text { background: linear-gradient(to right, #4f46e5, #9333ea); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }

        .tab-active { background-color: #FBBF24; color: #78350F; }
        .tab-inactive { background-color: #F3F4F6; color: #6B7280; }

        /* Theory Modal Specific Styling for Markdown Rendering */
        #aiExplanation strong { color: #4338CA; font-weight: 700; }
        #aiExplanation h3 { font-size: 1.5rem; font-weight: 700; color: #4338CA; margin-top: 1.5rem; margin-bottom: 0.75rem; }
        #aiExplanation h4 { font-size: 1.125rem; font-weight: 600; color: #6366F1; margin-top: 1rem; margin-bottom: 0.5rem; }
        #aiExplanation ul, #aiExplanation ol { list-style-type: disc; margin-left: 1.5rem; padding-left: 0.5rem; }
        #aiExplanation ol { list-style-type: decimal; }
        #aiExplanation li { margin-bottom: 0.5rem; }
        #aiExplanation em { color: #9CA3AF; font-style: normal; }
    </style>
</head>
<body class="text-gray-800 h-screen w-screen flex flex-col items-center justify-center p-0 md:p-4 overflow-hidden">

    <div id="app" class="w-full h-full md:h-auto md:max-w-md bg-white md:rounded-3xl shadow-xl overflow-hidden relative flex flex-col">

        <!-- HEADER -->
        <div class="p-4 bg-yellow-100 flex justify-between items-center relative z-10 shrink-0">
            <h1 class="text-xl font-bold text-yellow-800 flex items-center gap-2 cursor-pointer" onclick="resetGame()">
                ü•ë AI Tutor
            </h1>
            <div class="flex gap-2">
                <button onclick="openTheoryModal()" class="text-yellow-700 hover:text-yellow-900 transition p-2 rounded-full hover:bg-yellow-200" title="S·ªï tay Ng·ªØ ph√°p 12 Th√¨">
                    <i class="fas fa-graduation-cap text-lg"></i>
                </button>
                <button onclick="toggleSettings()" class="text-yellow-700 hover:text-yellow-900 transition p-2 rounded-full hover:bg-yellow-200">
                    <i class="fas fa-cog text-lg"></i>
                </button>
            </div>
        </div>

        <!-- SETTINGS MODAL -->
        <div id="settingsPanel" class="hidden absolute inset-0 bg-white z-50 p-6 flex-col pt-10 animate-fade-in overflow-y-auto">
            <h2 class="text-lg font-bold mb-4 text-gray-700">C√†i ƒë·∫∑t</h2>

            <div class="mb-6 p-4 bg-purple-50 rounded-xl border border-purple-100">
                <label class="block text-sm font-bold text-purple-800 mb-2">üîë Google Gemini API Key</label>
                <p class="text-xs text-gray-500 mb-2">D√πng Key ƒë·ªÉ n·ªôi dung phong ph√∫ v√† t√≠nh nƒÉng TTS.</p>
                <input type="password" id="userApiKeyInput" placeholder="D√°n API Key v√†o ƒë√¢y..."
                       class="w-full p-3 border border-gray-300 rounded-xl mb-2 focus:outline-none focus:border-purple-400 text-sm">
                <button onclick="saveApiKey()" class="w-full bg-purple-600 text-white text-xs font-bold py-2 rounded-lg hover:bg-purple-700">L∆∞u Key</button>
                <p id="keyStatus" class="text-xs mt-2 text-gray-400 italic">Ch∆∞a c√≥ key</p>
            </div>
            <button onclick="toggleSettings()" class="mt-auto w-full text-center text-gray-400 text-sm py-4">ƒê√≥ng</button>
        </div>

        <!-- THEORY MODAL -->
        <div id="theoryModal" class="hidden absolute inset-0 bg-white z-50 flex flex-col">
            <div class="p-4 border-b flex justify-between items-center bg-indigo-50">
                <h2 class="text-lg font-bold text-indigo-900"><i class="fas fa-book mr-2"></i>S·ªï tay Ng·ªØ ph√°p (12 Th√¨)</h2>
                <button onclick="closeTheoryModal()" class="text-indigo-400 hover:text-indigo-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 custom-scroll" id="theoryContent">
                <!-- List of Tenses -->
                <p class="text-gray-500 text-sm mb-4">Ch·ªçn m·ªôt th√¨ ƒë·ªÉ xem l√Ω thuy·∫øt chi ti·∫øt (S·∫µn s√†ng Offline):</p>
                <div class="grid grid-cols-1 gap-3" id="tenseList">
                    <!-- JS will generate buttons here -->
                </div>
                <div id="theoryDetail" class="hidden mt-4">
                    <button onclick="backToTenseList()" class="text-sm text-gray-500 mb-2 hover:text-indigo-600"><i class="fas fa-arrow-left"></i> Quay l·∫°i</button>
                    <div id="aiExplanation" class="prose prose-sm max-w-none text-gray-700 bg-gray-50 p-4 rounded-xl border border-gray-100"></div>
                </div>
            </div>
        </div>

        <!-- LOADING OVERLAY -->
        <div id="loadingOverlay" class="hidden absolute inset-0 bg-white/90 z-[60] flex flex-col items-center justify-center">
            <div class="loader mb-4"></div>
            <p id="loadingText" class="text-gray-600 font-semibold animate-pulse">ƒêang x·ª≠ l√Ω...</p>
        </div>

        <!-- MAIN CONTENT -->
        <div id="mainContent" class="flex-1 flex flex-col p-4 relative overflow-y-auto custom-scroll">

            <!-- START SCREEN -->
            <div id="startScreen" class="flex-1 flex flex-col">
                <!-- Mode Switcher -->
                <div class="flex bg-gray-100 p-1 rounded-2xl mb-6">
                    <button onclick="setMode('vocab')" id="tabVocab" class="flex-1 py-3 rounded-xl text-sm font-bold transition tab-active">T·ª´ V·ª±ng</button>
                    <button onclick="setMode('grammar')" id="tabGrammar" class="flex-1 py-3 rounded-xl text-sm font-bold transition tab-inactive">Ng·ªØ Ph√°p</button>
                </div>

                <!-- VOCAB VIEW -->
                <div id="viewVocab" class="flex-1 flex flex-col justify-center text-center">
                    <div class="text-5xl mb-4">ü•ë</div>
                    <h2 class="text-xl font-bold mb-2">Ch·ªß ƒë·ªÅ t·ª´ v·ª±ng</h2>
                    <p class="text-gray-500 text-sm mb-6">Nh·∫≠p ch·ªß ƒë·ªÅ (C∆° th·ªÉ, Gia ƒë√¨nh...) ho·∫∑c ƒë·ªÉ tr·ªëng.</p>

                    <input type="text" id="vocabTopicInput" placeholder="VD: C∆° th·ªÉ ng∆∞·ªùi..."
                           class="w-full p-4 border-2 border-yellow-100 rounded-2xl mb-2 focus:outline-none focus:border-yellow-400 text-center">

                    <!-- Topic Suggestions Container -->
                    <div id="topicSuggestions" class="w-full max-h-40 overflow-y-auto bg-white rounded-xl shadow-lg border border-gray-100 mb-4 hidden text-left">
                        <p class="text-xs text-gray-500 px-4 pt-2 pb-1 border-b">G·ª£i √Ω ch·ªß ƒë·ªÅ Offline:</p>
                        <ul id="suggestionList" class="divide-y divide-gray-100"></ul>
                    </div>
                    <!-- END Topic Suggestions Container -->

                    <button onclick="generateContent('vocab')" class="w-full bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-4 rounded-2xl shadow-lg transition active:scale-95">
                        T·∫°o b√†i h·ªçc
                    </button>
                    <p id="vocabSource" class="mt-2 text-xs text-gray-400"></p>
                </div>

                <!-- GRAMMAR VIEW -->
                <div id="viewGrammar" class="hidden flex-1 flex flex-col justify-center text-center">
                    <div class="text-5xl mb-4">üìù</div>
                    <h2 class="text-xl font-bold mb-2">Luy·ªán th√¨ (Tenses)</h2>
                    <p class="text-gray-500 text-sm mb-6">Ch·ªçn th√¨ b·∫°n mu·ªën √¥n t·∫≠p.</p>

                    <select id="grammarTenseSelect" class="w-full p-4 border-2 border-indigo-100 rounded-2xl mb-4 focus:outline-none focus:border-indigo-400 bg-white text-lg">
                        <!-- Options generated by JS -->
                    </select>

                    <button onclick="generateContent('grammar')" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg transition active:scale-95">
                        T·∫°o b√†i t·∫≠p
                    </button>
                    <p id="grammarSource" class="mt-2 text-xs text-gray-400"></p>
                </div>
            </div>

            <!-- GAME SCREEN -->
            <div id="gameScreen" class="hidden flex-1 flex flex-col">
                <div class="flex justify-between text-xs text-gray-400 mb-2">
                    <span class="font-bold text-gray-600 truncate" id="gameTitle">B√†i h·ªçc</span>
                    <span>C√¢u <span id="currentQ">1</span>/10</span>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-2 mb-8">
                    <div id="progressBar" class="bg-yellow-400 h-2 rounded-full transition-all duration-300" style="width: 10%"></div>
                </div>

                <!-- Question Area -->
                <div class="flex-1 flex flex-col justify-center items-center mb-6">
                    <span id="instructionText" class="text-sm text-gray-400 uppercase tracking-wider mb-2">D·ªãch sang Ti·∫øng Anh</span>

                    <!-- Content Box -->
                    <div class="w-full min-h-[120px] flex items-center justify-center">
                        <h2 id="mainDisplay" class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-4 px-2 leading-relaxed">
                            Loading...
                        </h2>
                    </div>

                    <!-- Grammar Hint (Verb base form) -->
                    <p id="subDisplay" class="text-indigo-500 font-medium mb-6 text-lg hidden">(go)</p>

                    <input type="text" id="answerInput"
                           class="w-full bg-gray-50 border-2 border-gray-200 text-center text-xl p-4 rounded-2xl focus:outline-none focus:border-yellow-400 focus:bg-white transition"
                           placeholder="Nh·∫≠p ƒë√°p √°n..." autocomplete="off" autocapitalize="off">
                </div>

                <button onclick="checkAnswer()" class="w-full bg-gray-800 text-white font-bold py-4 rounded-2xl hover:bg-gray-900 transition shadow-lg active:scale-95">
                    Ki·ªÉm tra
                </button>
            </div>

            <!-- FEEDBACK OVERLAY -->
            <div id="feedbackOverlay" class="hidden absolute inset-0 z-40 bg-white/95 backdrop-blur-sm flex flex-col items-center justify-center text-center p-6 pop-in">
                <div id="feedbackIcon" class="emoji-feedback mb-2">üéâ</div>
                <h3 id="feedbackTitle" class="text-2xl font-bold mb-2">Ch√≠nh x√°c!</h3>

                <div class="bg-gray-50 rounded-xl p-4 w-full mb-4 border border-gray-100">
                     <p class="text-gray-400 text-xs uppercase mb-1">ƒê√°p √°n ƒë√∫ng:</p>
                     <div class="flex items-center justify-center gap-3">
                         <span id="correctAnswerText" class="text-2xl font-bold text-gray-800">Answer</span>
                         <button onclick="playTTS()" class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center hover:bg-purple-200 transition active:scale-90"><i class="fas fa-volume-up"></i></button>
                     </div>
                     <p id="grammarExplanation" class="text-sm text-indigo-600 mt-2 italic hidden">Gi·∫£i th√≠ch ng·∫Øn g·ªçn...</p>
                </div>

                <button onclick="nextQuestion()" class="w-full bg-yellow-400 text-yellow-900 font-bold py-3 rounded-xl shadow-md hover:bg-yellow-500 transition active:scale-95">
                    C√¢u ti·∫øp theo <i class="fas fa-arrow-right ml-1"></i>
                </button>
            </div>

            <!-- RESULT SCREEN -->
            <div id="resultScreen" class="hidden flex-1 flex flex-col justify-center items-center text-center">
                <div class="text-6xl mb-4">üèÜ</div>
                <h2 class="text-3xl font-bold mb-2">Ho√†n th√†nh!</h2>
                <p class="text-gray-500 mb-6">K·∫øt qu·∫£: <span id="finalScore" class="font-bold text-yellow-600 text-xl">0</span>/10</p>
                <div id="resultList" class="w-full bg-gray-50 rounded-xl p-4 mb-6 h-48 overflow-y-auto custom-scroll text-left"></div>
                <button onclick="resetGame()" class="w-full bg-yellow-400 text-yellow-900 font-bold py-4 rounded-2xl shadow-lg hover:bg-yellow-500 transition">M√†n h√¨nh ch√≠nh</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- PWA SETUP ---
        (function setupPWA() {
            const manifest = {
                "name": "AI Tutor Offline", "short_name": "AITutor", "start_url": ".", "display": "standalone",
                "background_color": "#fdfbf7", "theme_color": "#fdfbf7", "orientation": "portrait",
                "icons": [{ "src": "https://img.icons8.com/color/192/avocado.png", "sizes": "192x192", "type": "image/png" }]
            };
            const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            document.querySelector('#my-manifest-placeholder').setAttribute('href', URL.createObjectURL(blob));
        })();

        // --- OFFLINE DATASET (THE LOCAL DATABASE) ---
        const offlineData = {
            vocab: {
                "c∆° th·ªÉ": [
                    {vi: "ƒê·∫ßu", en: "head"}, {vi: "M·∫Øt", en: "eye"}, {vi: "M≈©i", en: "nose"}, {vi: "Mi·ªáng", en: "mouth"}, {vi: "Tay", en: "hand"},
                    {vi: "Ch√¢n", en: "leg"}, {vi: "Tim", en: "heart"}, {vi: "T√≥c", en: "hair"}, {vi: "Vai", en: "shoulder"}, {vi: "Ng√≥n tay", en: "finger"}
                ],
                "gia ƒë√¨nh": [
                    {vi: "B·ªë", en: "father"}, {vi: "M·∫π", en: "mother"}, {vi: "Anh trai", en: "brother"}, {vi: "Ch·ªã g√°i", en: "sister"}, {vi: "√îng", en: "grandfather"},
                    {vi: "B√†", en: "grandmother"}, {vi: "Ch√∫/B√°c", en: "uncle"}, {vi: "C√¥/D√¨", en: "aunt"}, {vi: "Con trai", en: "son"}, {vi: "Con g√°i", en: "daughter"}
                ],
                "m√†u s·∫Øc": [
                    {vi: "ƒê·ªè", en: "red"}, {vi: "Xanh d∆∞∆°ng", en: "blue"}, {vi: "V√†ng", en: "yellow"}, {vi: "Xanh l√°", en: "green"}, {vi: "ƒêen", en: "black"},
                    {vi: "Tr·∫Øng", en: "white"}, {vi: "Cam", en: "orange"}, {vi: "T√≠m", en: "purple"}, {vi: "H·ªìng", en: "pink"}, {vi: "N√¢u", en: "brown"}
                ],
                "ƒë·ªì ƒÉn": [
                    {vi: "T√°o", en: "apple"}, {vi: "Chu·ªëi", en: "banana"}, {vi: "B√°nh m√¨", en: "bread"}, {vi: "S·ªØa", en: "milk"}, {vi: "Ph√¥ mai", en: "cheese"},
                    {vi: "Tr·ª©ng", en: "egg"}, {vi: "Th·ªãt", en: "meat"}, {vi: "C√°", en: "fish"}, {vi: "Rau", en: "vegetable"}, {vi: "N∆∞·ªõc", en: "water"}
                ],
                // Default topic for when no match is found
                "default": [
                    {vi: "C√† ph√™", en: "coffee"}, {vi: "M√°y t√≠nh", en: "computer"}, {vi: "S√°ch", en: "book"}, {vi: "ƒêi·ªán tho·∫°i", en: "phone"}, {vi: "Nghe", en: "listen"}
                ]
            },
            grammar: {
                "Present Simple": [
                    {question: "She ___ (go) to school everyday.", verb: "go", answer: "goes", explanation: "Ch·ªß ng·ªØ s·ªë √≠t 'She' + ƒë·ªông t·ª´ th√™m s/es."},
                    {question: "I ___ (like) pizza.", verb: "like", answer: "like", explanation: "Ch·ªß ng·ªØ 'I' ƒë·ªông t·ª´ gi·ªØ nguy√™n."},
                    {question: "They ___ (play) football.", verb: "play", answer: "play", explanation: "Ch·ªß ng·ªØ s·ªë nhi·ªÅu 'They' ƒë·ªông t·ª´ gi·ªØ nguy√™n."},
                    {question: "He ___ (watch) TV.", verb: "watch", answer: "watches", explanation: "T·∫≠n c√πng l√† 'ch' n√™n th√™m 'es'."},
                    {question: "The sun ___ (rise) in the East.", verb: "rise", answer: "rises", explanation: "S·ª± th·∫≠t hi·ªÉn nhi√™n, chia hi·ªán t·∫°i ƒë∆°n."},
                    {question: "We ___ (not/want) to go.", verb: "want", answer: "do not want", explanation: "Ph·ªß ƒë·ªãnh hi·ªán t·∫°i ƒë∆°n v·ªõi 'We' d√πng 'do not'."},
                    {question: "___ you (speak) English?", verb: "speak", answer: "Do you speak", explanation: "C√¢u h·ªèi v·ªõi 'You' d√πng tr·ª£ ƒë·ªông t·ª´ 'Do'."},
                    {question: "It ___ (rain) a lot here.", verb: "rain", answer: "rains", explanation: "Ch·ªß ng·ªØ 'It' s·ªë √≠t."},
                    {question: "My dad ___ (work) in a bank.", verb: "work", answer: "works", explanation: "B·ªë t√¥i (He) l√† s·ªë √≠t."},
                    {question: "Birds ___ (fly).", verb: "fly", answer: "fly", explanation: "Lo√†i chim (s·ªë nhi·ªÅu) - s·ª± th·∫≠t hi·ªÉn nhi√™n."}
                ],
                "Past Simple": [
                    {question: "I ___ (visit) my grandma yesterday.", verb: "visit", answer: "visited", explanation: "C√≥ 'yesterday' -> Qu√° kh·ª© ƒë∆°n (c√≥ quy t·∫Øc)."},
                    {question: "She ___ (go) to the cinema last night.", verb: "go", answer: "went", explanation: "B·∫•t quy t·∫Øc: go -> went."},
                    {question: "We ___ (buy) a new car.", verb: "buy", answer: "bought", explanation: "B·∫•t quy t·∫Øc: buy -> bought."},
                    {question: "He ___ (not/see) me.", verb: "see", answer: "did not see", explanation: "Ph·ªß ƒë·ªãnh qu√° kh·ª©: did not + V nguy√™n th·ªÉ."},
                    {question: "They ___ (play) tennis.", verb: "play", answer: "played", explanation: "C√≥ quy t·∫Øc: th√™m 'ed'."},
                    {question: "___ you (eat) dinner?", verb: "eat", answer: "Did you eat", explanation: "C√¢u h·ªèi qu√° kh·ª©: Did + S + V nguy√™n th·ªÉ."},
                    {question: "It ___ (be) cold yesterday.", verb: "be", answer: "was", explanation: "To be qu√° kh·ª© c·ªßa 'It' l√† 'was'."},
                    {question: "We ___ (be) happy.", verb: "be", answer: "were", explanation: "To be qu√° kh·ª© c·ªßa 'We' l√† 'were'."},
                    {question: "The rain ___ (stop) an hour ago.", verb: "stop", answer: "stopped", explanation: "G·∫•p ƒë√¥i ph·ª• √¢m cu·ªëi 'p' r·ªìi th√™m 'ed'."},
                    {question: "I ___ (study) hard.", verb: "study", answer: "studied", explanation: "Y d√†i ƒë·ªïi th√†nh i ng·∫Øn r·ªìi th√™m 'ed'."}
                ]
            },
            theory: {
                "Present Simple": `
                    <h3 class="text-xl font-bold text-indigo-700 mb-2">Th√¨ Hi·ªán T·∫°i ƒê∆°n (Simple Present)</h3>
                    <p class="mb-3">Th√¨ Hi·ªán T·∫°i ƒê∆°n d√πng ƒë·ªÉ di·ªÖn t·∫£ th√≥i quen, s·ª± th·∫≠t hi·ªÉn nhi√™n ho·∫∑c l·ªãch tr√¨nh c·ªë ƒë·ªãnh.</p>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C·∫•u Tr√∫c</h4>
                    <ul class="list-disc ml-6 space-y-1">
                        <li><strong>Kh·∫≥ng ƒê·ªãnh (+):</strong> S + V (s/es) <em class="text-gray-500">(N·∫øu S l√† He/She/It/danh t·ª´ s·ªë √≠t)</em></li>
                        <li><strong>Ph·ªß ƒê·ªãnh (-):</strong> S + do/does + not + V (nguy√™n m·∫´u)</li>
                        <li><strong>Nghi V·∫•n (?):</strong> Do/Does + S + V (nguy√™n m·∫´u)?</li>
                    </ul>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C√°ch S·ª≠ D·ª•ng & V√≠ D·ª•</h4>
                    <ol class="list-decimal ml-6 space-y-2">
                        <li><strong>Th√≥i quen, h√†nh ƒë·ªông l·∫∑p ƒëi l·∫∑p l·∫°i:</strong> Di·ªÖn t·∫£ ho·∫°t ƒë·ªông th∆∞·ªùng xuy√™n x·∫£y ra. <br> <em>V√≠ d·ª•:</em> I <strong>wake</strong> up at 7:00 AM every day.</li>
                        <li><strong>S·ª± th·∫≠t hi·ªÉn nhi√™n, ch√¢n l√Ω:</strong> Nh·ªØng ƒëi·ªÅu lu√¥n ƒë√∫ng. <br> <em>V√≠ d·ª•:</em> The Sun <strong>rises</strong> in the East.</li>
                        <li><strong>Th·ªùi gian bi·ªÉu, l·ªãch tr√¨nh c·ªë ƒë·ªãnh:</strong> <br> <em>V√≠ d·ª•:</em> The train <strong>leaves</strong> at 6:00 PM.</li>
                    </ol>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">D·∫•u Hi·ªáu Nh·∫≠n Bi·∫øt</h4>
                    <p>always, usually, often, sometimes, rarely, never, every day/week/month, once/twice a week, v.v.</p>
                `,
                "Present Continuous": `
                    <h3 class="text-xl font-bold text-indigo-700 mb-2">Th√¨ Hi·ªán T·∫°i Ti·∫øp Di·ªÖn (Present Continuous)</h3>
                    <p class="mb-3">Th√¨ Hi·ªán T·∫°i Ti·∫øp Di·ªÖn d√πng ƒë·ªÉ di·ªÖn t·∫£ h√†nh ƒë·ªông ƒëang x·∫£y ra t·∫°i th·ªùi ƒëi·ªÉm n√≥i ho·∫∑c h√†nh ƒë·ªông t·∫°m th·ªùi.</p>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C·∫•u Tr√∫c</h4>
                    <ul class="list-disc ml-6 space-y-1">
                        <li><strong>Kh·∫≥ng ƒê·ªãnh (+):</strong> S + am/is/are + V-ing</li>
                        <li><strong>Ph·ªß ƒê·ªãnh (-):</strong> S + am/is/are + not + V-ing</li>
                        <li><strong>Nghi V·∫•n (?):</strong> Am/Is/Are + S + V-ing?</li>
                    </ul>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C√°ch S·ª≠ D·ª•ng & V√≠ D·ª•</h4>
                    <ol class="list-decimal ml-6 space-y-2">
                        <li><strong>H√†nh ƒë·ªông ƒëang x·∫£y ra t·∫°i th·ªùi ƒëi·ªÉm n√≥i:</strong> <br> <em>V√≠ d·ª•:</em> They <strong>are studying</strong> English now.</li>
                        <li><strong>H√†nh ƒë·ªông t·∫°m th·ªùi:</strong> X·∫£y ra trong m·ªôt giai ƒëo·∫°n nh·∫•t ƒë·ªãnh. <br> <em>V√≠ d·ª•:</em> I <strong>am working</strong> on a new project this month.</li>
                        <li><strong>S·ª± thay ƒë·ªïi ƒëang di·ªÖn ra:</strong> <br> <em>V√≠ d·ª•:</em> The climate <strong>is getting</strong> warmer.</li>
                    </ol>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">D·∫•u Hi·ªáu Nh·∫≠n Bi·∫øt</h4>
                    <p>now, right now, at the moment, at present, look!, listen!, v.v.</p>
                `,
                "Present Perfect": `
                    <h3 class="text-xl font-bold text-indigo-700 mb-2">Th√¨ Hi·ªán T·∫°i Ho√†n Th√†nh (Present Perfect)</h3>
                    <p class="mb-3">Th√¨ Hi·ªán T·∫°i Ho√†n Th√†nh d√πng ƒë·ªÉ di·ªÖn t·∫£ h√†nh ƒë·ªông b·∫Øt ƒë·∫ßu trong qu√° kh·ª© v√† k√©o d√†i ƒë·∫øn hi·ªán t·∫°i, ho·∫∑c kinh nghi·ªám/k·∫øt qu·∫£ ·ªü hi·ªán t·∫°i.</p>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C·∫•u Tr√∫c</h4>
                    <ul class="list-disc ml-6 space-y-1">
                        <li><strong>Kh·∫≥ng ƒê·ªãnh (+):</strong> S + have/has + V3/ed</li>
                        <li><strong>Ph·ªß ƒê·ªãnh (-):</strong> S + have/has + not + V3/ed</li>
                        <li><strong>Nghi V·∫•n (?):</strong> Have/Has + S + V3/ed?</li>
                    </ul>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C√°ch S·ª≠ D·ª•ng & V√≠ D·ª•</h4>
                    <ol class="list-decimal ml-6 space-y-2">
                        <li><strong>H√†nh ƒë·ªông k√©o d√†i t·ª´ qu√° kh·ª© ƒë·∫øn hi·ªán t·∫°i:</strong> <br> <em>V√≠ d·ª•:</em> She <strong>has lived</strong> in Hanoi for ten years.</li>
                        <li><strong>Kinh nghi·ªám ƒë√£ t·ª´ng x·∫£y ra:</strong> <br> <em>V√≠ d·ª•:</em> I <strong>have been</strong> to Japan twice.</li>
                        <li><strong>H√†nh ƒë·ªông v·ª´a m·ªõi x·∫£y ra:</strong> <br> <em>V√≠ d·ª•:</em> He <strong>has just finished</strong> his report.</li>
                    </ol>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">D·∫•u Hi·ªáu Nh·∫≠n Bi·∫øt</h4>
                    <p>since, for, already, yet, just, never, ever, so far, up to now, recently, this is the first time, v.v.</p>
                `,
                "Present Perfect Continuous": `
                    <h3 class="text-xl font-bold text-indigo-700 mb-2">Th√¨ Hi·ªán T·∫°i Ho√†n Th√†nh Ti·∫øp Di·ªÖn (Present Perfect Continuous)</h3>
                    <p class="mb-3">Th√¨ n√†y nh·∫•n m·∫°nh qu√° tr√¨nh li√™n t·ª•c c·ªßa h√†nh ƒë·ªông b·∫Øt ƒë·∫ßu trong qu√° kh·ª© v√† v·∫´n ti·∫øp di·ªÖn ho·∫∑c v·ª´a m·ªõi k·∫øt th√∫c v·ªõi k·∫øt qu·∫£ r√µ r√†ng ·ªü hi·ªán t·∫°i.</p>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C·∫•u Tr√∫c</h4>
                    <ul class="list-disc ml-6 space-y-1">
                        <li><strong>Kh·∫≥ng ƒê·ªãnh (+):</strong> S + have/has + been + V-ing</li>
                        <li><strong>Ph·ªß ƒê·ªãnh (-):</strong> S + have/has + not + been + V-ing</li>
                        <li><strong>Nghi V·∫•n (?):</strong> Have/Has + S + been + V-ing?</li>
                    </ul>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C√°ch S·ª≠ D·ª•ng & V√≠ D·ª•</h4>
                    <ol class="list-decimal ml-6 space-y-2">
                        <li><strong>Nh·∫•n m·∫°nh qu√° tr√¨nh c·ªßa h√†nh ƒë·ªông:</strong> <br> <em>V√≠ d·ª•:</em> We <strong>have been waiting</strong> for the bus for 30 minutes.</li>
                        <li><strong>H√†nh ƒë·ªông v·ª´a k·∫øt th√∫c nh∆∞ng ƒë·ªÉ l·∫°i k·∫øt qu·∫£ ·ªü hi·ªán t·∫°i:</strong> <br> <em>V√≠ d·ª•:</em> Your eyes are red. <strong>Have you been crying</strong>?</li>
                    </ol>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">D·∫•u Hi·ªáu Nh·∫≠n Bi·∫øt</h4>
                    <p>all day/week/month, since, for, how long, v.v.</p>
                `,
                "Past Simple": `
                    <h3 class="text-xl font-bold text-indigo-700 mb-2">Th√¨ Qu√° Kh·ª© ƒê∆°n (Simple Past)</h3>
                    <p class="mb-3">Th√¨ Qu√° Kh·ª© ƒê∆°n d√πng ƒë·ªÉ di·ªÖn t·∫£ h√†nh ƒë·ªông ƒë√£ x·∫£y ra v√† k·∫øt th√∫c t·∫°i m·ªôt th·ªùi ƒëi·ªÉm x√°c ƒë·ªãnh trong qu√° kh·ª©.</p>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C·∫•u Tr√∫c</h4>
                    <ul class="list-disc ml-6 space-y-1">
                        <li><strong>Kh·∫≥ng ƒê·ªãnh (+):</strong> S + V2/ed</li>
                        <li><strong>Ph·ªß ƒê·ªãnh (-):</strong> S + did + not + V (nguy√™n m·∫´u)</li>
                        <li><strong>Nghi V·∫•n (?):</strong> Did + S + V (nguy√™n m·∫´u)?</li>
                    </ul>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C√°ch S·ª≠ D·ª•ng & V√≠ D·ª•</h4>
                    <ol class="list-decimal ml-6 space-y-2">
                        <li><strong>H√†nh ƒë·ªông ƒë√£ k·∫øt th√∫c t·∫°i m·ªôt th·ªùi ƒëi·ªÉm x√°c ƒë·ªãnh:</strong> <br> <em>V√≠ d·ª•:</em> I <strong>visited</strong> Ho Chi Minh City last year.</li>
                        <li><strong>Chu·ªói h√†nh ƒë·ªông li√™n ti·∫øp trong qu√° kh·ª©:</strong> <br> <em>V√≠ d·ª•:</em> She <strong>opened</strong> the door, <strong>walked</strong> in, and <strong>sat</strong> down.</li>
                    </ol>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">D·∫•u Hi·ªáu Nh·∫≠n Bi·∫øt</h4>
                    <p>yesterday, last night/week/month/year, ago, in 2005 (nƒÉm trong qu√° kh·ª©), v.v.</p>
                `,
                "Past Continuous": `
                    <h3 class="text-xl font-bold text-indigo-700 mb-2">Th√¨ Qu√° Kh·ª© Ti·∫øp Di·ªÖn (Past Continuous)</h3>
                    <p class="mb-3">Th√¨ n√†y d√πng ƒë·ªÉ di·ªÖn t·∫£ h√†nh ƒë·ªông ƒëang x·∫£y ra t·∫°i m·ªôt th·ªùi ƒëi·ªÉm c·ª• th·ªÉ trong qu√° kh·ª© ho·∫∑c h√†nh ƒë·ªông b·ªã h√†nh ƒë·ªông kh√°c xen v√†o.</p>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C·∫•u Tr√∫c</h4>
                    <ul class="list-disc ml-6 space-y-1">
                        <li><strong>Kh·∫≥ng ƒê·ªãnh (+):</strong> S + was/were + V-ing</li>
                        <li><strong>Ph·ªß ƒê·ªãnh (-):</strong> S + was/were + not + V-ing</li>
                        <li><strong>Nghi V·∫•n (?):</strong> Was/Were + S + V-ing?</li>
                    </ul>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C√°ch S·ª≠ D·ª•ng & V√≠ D·ª•</h4>
                    <ol class="list-decimal ml-6 space-y-2">
                        <li><strong>H√†nh ƒë·ªông ƒëang x·∫£y ra t·∫°i th·ªùi ƒëi·ªÉm c·ª• th·ªÉ trong qu√° kh·ª©:</strong> <br> <em>V√≠ d·ª•:</em> At 8 PM yesterday, I <strong>was watching</strong> a movie.</li>
                        <li><strong>H√†nh ƒë·ªông ƒëang x·∫£y ra th√¨ h√†nh ƒë·ªông kh√°c xen v√†o:</strong> <br> <em>V√≠ d·ª•:</em> I <strong>was taking</strong> a shower when the phone rang.</li>
                        <li><strong>Hai h√†nh ƒë·ªông x·∫£y ra song song trong qu√° kh·ª©:</strong> <br> <em>V√≠ d·ª•:</em> While he <strong>was reading</strong>, his sister <strong>was listening</strong> to music.</li>
                    </ol>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">D·∫•u Hi·ªáu Nh·∫≠n Bi·∫øt</h4>
                    <p>at 5 PM yesterday, at this time last week, while, when, v.v.</p>
                `,
                "Past Perfect": `
                    <h3 class="text-xl font-bold text-indigo-700 mb-2">Th√¨ Qu√° Kh·ª© Ho√†n Th√†nh (Past Perfect)</h3>
                    <p class="mb-3">Th√¨ Qu√° Kh·ª© Ho√†n Th√†nh d√πng ƒë·ªÉ di·ªÖn t·∫£ h√†nh ƒë·ªông x·∫£y ra v√† ho√†n th√†nh <strong>tr∆∞·ªõc</strong> m·ªôt h√†nh ƒë·ªông kh√°c trong qu√° kh·ª©.</p>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C·∫•u Tr√∫c</h4>
                    <ul class="list-disc ml-6 space-y-1">
                        <li><strong>Kh·∫≥ng ƒê·ªãnh (+):</strong> S + had + V3/ed</li>
                        <li><strong>Ph·ªß ƒê·ªãnh (-):</strong> S + had + not + V3/ed</li>
                        <li><strong>Nghi V·∫•n (?):</strong> Had + S + V3/ed?</li>
                    </ul>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C√°ch S·ª≠ D·ª•ng & V√≠ D·ª•</h4>
                    <ol class="list-decimal ml-6 space-y-2">
                        <li><strong>H√†nh ƒë·ªông x·∫£y ra tr∆∞·ªõc h√†nh ƒë·ªông kh√°c trong qu√° kh·ª©:</strong> <br> <em>V√≠ d·ª•:</em> She <strong>had finished</strong> her homework before her mother came home.</li>
                        <li><strong>H√†nh ƒë·ªông x·∫£y ra tr∆∞·ªõc m·ªôt th·ªùi ƒëi·ªÉm c·ª• th·ªÉ trong qu√° kh·ª©:</strong> <br> <em>V√≠ d·ª•:</em> By 2010, they <strong>had built</strong> a new school.</li>
                    </ol>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">D·∫•u Hi·ªáu Nh·∫≠n Bi·∫øt</h4>
                    <p>before, after, by the time, as soon as, when, v.v.</p>
                `,
                "Past Perfect Continuous": `
                    <h3 class="text-xl font-bold text-indigo-700 mb-2">Th√¨ Qu√° Kh·ª© Ho√†n Th√†nh Ti·∫øp Di·ªÖn (Past Perfect Continuous)</h3>
                    <p class="mb-3">Th√¨ n√†y nh·∫•n m·∫°nh kho·∫£ng th·ªùi gian c·ªßa m·ªôt h√†nh ƒë·ªông ƒë√£ x·∫£y ra li√™n t·ª•c v√† k·∫øt th√∫c ngay tr∆∞·ªõc h√†nh ƒë·ªông kh√°c trong qu√° kh·ª©.</p>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C·∫•u Tr√∫c</h4>
                    <ul class="list-disc ml-6 space-y-1">
                        <li><strong>Kh·∫≥ng ƒê·ªãnh (+):</strong> S + had + been + V-ing</li>
                        <li><strong>Ph·ªß ƒê·ªãnh (-):</strong> S + had + not + been + V-ing</li>
                        <li><strong>Nghi V·∫•n (?):</strong> Had + S + been + V-ing?</li>
                    </ul>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C√°ch S·ª≠ D·ª•ng & V√≠ D·ª•</h4>
                    <ol class="list-decimal ml-6 space-y-2">
                        <li><strong>Nh·∫•n m·∫°nh kho·∫£ng th·ªùi gian c·ªßa h√†nh ƒë·ªông k√©o d√†i:</strong> <br> <em>V√≠ d·ª•:</em> He was tired because he <strong>had been running</strong> for an hour.</li>
                        <li><strong>H√†nh ƒë·ªông k√©o d√†i li√™n t·ª•c cho ƒë·∫øn khi h√†nh ƒë·ªông kh√°c x·∫£y ra:</strong> <br> <em>V√≠ d·ª•:</em> The ground was wet because it <strong>had been raining</strong> all night.</li>
                    </ol>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">D·∫•u Hi·ªáu Nh·∫≠n Bi·∫øt</h4>
                    <p>since, for, until then, before, v.v.</p>
                `,
                "Future Simple": `
                    <h3 class="text-xl font-bold text-indigo-700 mb-2">Th√¨ T∆∞∆°ng Lai ƒê∆°n (Simple Future)</h3>
                    <p class="mb-3">Th√¨ T∆∞∆°ng Lai ƒê∆°n d√πng ƒë·ªÉ di·ªÖn t·∫£ quy·∫øt ƒë·ªãnh t·ª©c th·ªùi, l·ªùi h·ª©a, l·ªùi ƒë·ªÅ ngh·ªã, ho·∫∑c d·ª± ƒëo√°n kh√¥ng c√≥ cƒÉn c·ª©.</p>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C·∫•u Tr√∫c</h4>
                    <ul class="list-disc ml-6 space-y-1">
                        <li><strong>Kh·∫≥ng ƒê·ªãnh (+):</strong> S + will + V (nguy√™n m·∫´u)</li>
                        <li><strong>Ph·ªß ƒê·ªãnh (-):</strong> S + will not (won't) + V (nguy√™n m·∫´u)</li>
                        <li><strong>Nghi V·∫•n (?):</strong> Will + S + V (nguy√™n m·∫´u)?</li>
                    </ul>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C√°ch S·ª≠ D·ª•ng & V√≠ D·ª•</h4>
                    <ol class="list-decimal ml-6 space-y-2">
                        <li><strong>Quy·∫øt ƒë·ªãnh ngay t·∫°i th·ªùi ƒëi·ªÉm n√≥i:</strong> <br> <em>V√≠ d·ª•:</em> "It's cold." - "I <strong>will close</strong> the window."</li>
                        <li><strong>L·ªùi h·ª©a, l·ªùi ƒë·ªÅ ngh·ªã ho·∫∑c d·ª± ƒëo√°n kh√¥ng c√≥ cƒÉn c·ª©:</strong> <br> <em>V√≠ d·ª•:</em> I think it <strong>will rain</strong> tomorrow.</li>
                        <li><strong>D√πng v·ªõi "Be going to" (d·ª± ƒë·ªãnh, k·∫ø ho·∫°ch c√≥ cƒÉn c·ª©):</strong> <br> <em>V√≠ d·ª•:</em> I <strong>am going to study</strong> abroad next year.</li>
                    </ol>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">D·∫•u Hi·ªáu Nh·∫≠n Bi·∫øt</h4>
                    <p>tomorrow, next week/month/year, in the future, I think, I believe, probably, v.v.</p>
                `,
                "Future Continuous": `
                    <h3 class="text-xl font-bold text-indigo-700 mb-2">Th√¨ T∆∞∆°ng Lai Ti·∫øp Di·ªÖn (Future Continuous)</h3>
                    <p class="mb-3">Th√¨ n√†y d√πng ƒë·ªÉ di·ªÖn t·∫£ h√†nh ƒë·ªông s·∫Ω ƒëang di·ªÖn ra t·∫°i m·ªôt th·ªùi ƒëi·ªÉm c·ª• th·ªÉ trong t∆∞∆°ng lai.</p>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C·∫•u Tr√∫c</h4>
                    <ul class="list-disc ml-6 space-y-1">
                        <li><strong>Kh·∫≥ng ƒê·ªãnh (+):</strong> S + will be + V-ing</li>
                        <li><strong>Ph·ªß ƒê·ªãnh (-):</strong> S + will not be + V-ing</li>
                        <li><strong>Nghi V·∫•n (?):</strong> Will + S + be + V-ing?</li>
                    </ul>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C√°ch S·ª≠ D·ª•ng & V√≠ D·ª•</h4>
                    <ol class="list-decimal ml-6 space-y-2">
                        <li><strong>H√†nh ƒë·ªông ƒëang di·ªÖn ra t·∫°i m·ªôt th·ªùi ƒëi·ªÉm c·ª• th·ªÉ trong t∆∞∆°ng lai:</strong> <br> <em>V√≠ d·ª•:</em> At 10 AM tomorrow, I <strong>will be taking</strong> an exam.</li>
                        <li><strong>H√†nh ƒë·ªông ƒë√£ ƒë∆∞·ª£c d·ª± ƒë·ªãnh/l√™n l·ªãch:</strong> <br> <em>V√≠ d·ª•:</em> I <strong>will be meeting</strong> him tomorrow.</li>
                    </ol>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">D·∫•u Hi·ªáu Nh·∫≠n Bi·∫øt</h4>
                    <p>at this time tomorrow, at... o'clock tomorrow, v.v.</p>
                `,
                "Future Perfect": `
                    <h3 class="text-xl font-bold text-indigo-700 mb-2">Th√¨ T∆∞∆°ng Lai Ho√†n Th√†nh (Future Perfect)</h3>
                    <p class="mb-3">Th√¨ n√†y d√πng ƒë·ªÉ di·ªÖn t·∫£ h√†nh ƒë·ªông s·∫Ω ho√†n th√†nh tr∆∞·ªõc m·ªôt th·ªùi ƒëi·ªÉm ho·∫∑c m·ªôt h√†nh ƒë·ªông kh√°c trong t∆∞∆°ng lai.</p>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C·∫•u Tr√∫c</h4>
                    <ul class="list-disc ml-6 space-y-1">
                        <li><strong>Kh·∫≥ng ƒê·ªãnh (+):</strong> S + will have + V3/ed</li>
                        <li><strong>Ph·ªß ƒê·ªãnh (-):</strong> S + will not have + V3/ed</li>
                        <li><strong>Nghi V·∫•n (?):</strong> Will + S + have + V3/ed?</li>
                    </ul>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C√°ch S·ª≠ D·ª•ng & V√≠ D·ª•</h4>
                    <ol class="list-decimal ml-6 space-y-2">
                        <li><strong>H√†nh ƒë·ªông s·∫Ω ho√†n th√†nh tr∆∞·ªõc m·ªôt m·ªëc th·ªùi gian:</strong> <br> <em>V√≠ d·ª•:</em> By next month, I <strong>will have finished</strong> my course.</li>
                        <li><strong>H√†nh ƒë·ªông s·∫Ω ho√†n th√†nh tr∆∞·ªõc h√†nh ƒë·ªông kh√°c:</strong> <br> <em>V√≠ d·ª•:</em> She <strong>will have graduated</strong> before you start university.</li>
                    </ol>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">D·∫•u Hi·ªáu Nh·∫≠n Bi·∫øt</h4>
                    <p>by + th·ªùi ƒëi·ªÉm t∆∞∆°ng lai, by the time, before, v.v.</p>
                `,
                "Future Perfect Continuous": `
                    <h3 class="text-xl font-bold text-indigo-700 mb-2">Th√¨ T∆∞∆°ng Lai Ho√†n Th√†nh Ti·∫øp Di·ªÖn (Future Perfect Continuous)</h3>
                    <p class="mb-3">Th√¨ n√†y nh·∫•n m·∫°nh kho·∫£ng th·ªùi gian c·ªßa m·ªôt h√†nh ƒë·ªông s·∫Ω k√©o d√†i li√™n t·ª•c cho ƒë·∫øn m·ªôt th·ªùi ƒëi·ªÉm x√°c ƒë·ªãnh trong t∆∞∆°ng lai.</p>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C·∫•u Tr√∫c</h4>
                    <ul class="list-disc ml-6 space-y-1">
                        <li><strong>Kh·∫≥ng ƒê·ªãnh (+):</strong> S + will have been + V-ing</li>
                        <li><strong>Ph·ªß ƒê·ªãnh (-):</strong> S + will not have been + V-ing</li>
                        <li><strong>Nghi V·∫•n (?):</strong> Will + S + have been + V-ing?</li>
                    </ul>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">C√°ch S·ª≠ D·ª•ng & V√≠ D·ª•</h4>
                    <ol class="list-decimal ml-6 space-y-2">
                        <li><strong>Nh·∫•n m·∫°nh kho·∫£ng th·ªùi gian c·ªßa h√†nh ƒë·ªông:</strong> <br> <em>V√≠ d·ª•:</em> By the end of this year, I <strong>will have been working</strong> here for five years.</li>
                    </ol>

                    <h4 class="text-lg font-semibold text-indigo-600 mt-4 mb-2">D·∫•u Hi·ªáu Nh·∫≠n Bi·∫øt</h4>
                    <p>for... by the time/by the end of..., v.v.</p>
                `
            }
        };

        // --- STATE ---
        let gameState = {
            mode: 'vocab',
            data: [],
            currentIdx: 0,
            score: 0,
            history: [],
            currentCorrect: ""
        };
        const API_KEY_STORAGE = 'vocab_ai_user_key';

        // --- DOM ---
        const els = {
            app: document.getElementById('app'),
            screens: { start: document.getElementById('startScreen'), game: document.getElementById('gameScreen'), result: document.getElementById('resultScreen') },
            tabs: { vocab: document.getElementById('tabVocab'), grammar: document.getElementById('tabGrammar') },
            views: { vocab: document.getElementById('viewVocab'), grammar: document.getElementById('viewGrammar') },
            inputs: { vocabTopic: document.getElementById('vocabTopicInput'), grammarTense: document.getElementById('grammarTenseSelect'), answer: document.getElementById('answerInput'), apiKey: document.getElementById('userApiKeyInput') },
            game: { title: document.getElementById('gameTitle'), qNum: document.getElementById('currentQ'), progress: document.getElementById('progressBar'), display: document.getElementById('mainDisplay'), subDisplay: document.getElementById('subDisplay'), instruction: document.getElementById('instructionText') },
            feedback: { overlay: document.getElementById('feedbackOverlay'), icon: document.getElementById('feedbackIcon'), title: document.getElementById('feedbackTitle'), correctText: document.getElementById('correctAnswerText'), explanation: document.getElementById('grammarExplanation') },
            theory: { modal: document.getElementById('theoryModal'), content: document.getElementById('theoryContent'), list: document.getElementById('tenseList'), detail: document.getElementById('theoryDetail'), explanation: document.getElementById('aiExplanation') },
            settings: { panel: document.getElementById('settingsPanel'), keyStatus: document.getElementById('keyStatus') },
            loading: { overlay: document.getElementById('loadingOverlay'), text: document.getElementById('loadingText') },
            status: { vocabSource: document.getElementById('vocabSource'), grammarSource: document.getElementById('grammarSource') },
            suggestions: { container: document.getElementById('topicSuggestions'), list: document.getElementById('suggestionList') }
        };

        // Danh s√°ch 12 Th√¨ Ti·∫øng Anh ƒë·∫ßy ƒë·ªß
        const tensesList = [
            "Present Simple", "Present Continuous", "Present Perfect", "Present Perfect Continuous",
            "Past Simple", "Past Continuous", "Past Perfect", "Past Perfect Continuous",
            "Future Simple", "Future Continuous", "Future Perfect", "Future Perfect Continuous"
        ];

        // C·∫≠p nh·∫≠t Select cho ph·∫ßn B√†i t·∫≠p Ng·ªØ ph√°p
        els.inputs.grammarTense.innerHTML = tensesList.map(t => `<option value="${t}">${getVietnameseTenseName(t)} (${t})</option>`).join('');

        function getVietnameseTenseName(tense) {
            const names = {
                "Present Simple": "Hi·ªán t·∫°i ƒë∆°n", "Present Continuous": "Hi·ªán t·∫°i ti·∫øp di·ªÖn",
                "Present Perfect": "Hi·ªán t·∫°i ho√†n th√†nh", "Present Perfect Continuous": "Hi·ªán t·∫°i ho√†n th√†nh ti·∫øp di·ªÖn",
                "Past Simple": "Qu√° kh·ª© ƒë∆°n", "Past Continuous": "Qu√° kh·ª© ti·∫øp di·ªÖn",
                "Past Perfect": "Qu√° kh·ª© ho√†n th√†nh", "Past Perfect Continuous": "Qu√° kh·ª© ho√†n th√†nh ti·∫øp di·ªÖn",
                "Future Simple": "T∆∞∆°ng lai ƒë∆°n", "Future Continuous": "T∆∞∆°ng lai ti·∫øp di·ªÖn",
                "Future Perfect": "T∆∞∆°ng lai ho√†n th√†nh", "Future Perfect Continuous": "T∆∞∆°ng lai ho√†n th√†nh ti·∫øp di·ªÖn"
            };
            return names[tense] || tense;
        }

        // --- HELPERS ---
        function getApiKey() { return localStorage.getItem(API_KEY_STORAGE) || (typeof __api_key !== 'undefined' ? __api_api_key : ""); }
        function saveApiKey() {
            const key = els.inputs.apiKey.value.trim();
            if (key) { localStorage.setItem(API_KEY_STORAGE, key); checkKeyStatus(); alert("ƒê√£ l∆∞u API Key!"); }
        }
        function checkKeyStatus() {
            const key = getApiKey();
            if (key) {
                els.settings.keyStatus.textContent = "‚úÖ ƒê√£ s·∫µn s√†ng (Online AI & Search)";
                els.settings.keyStatus.className = "text-xs mt-2 text-green-600 font-bold";
                els.inputs.apiKey.value = key;
                els.status.vocabSource.textContent = "Ch·∫ø ƒë·ªô Online - N·ªôi dung kh√¥ng gi·ªõi h·∫°n.";
                els.suggestions.container.classList.add('hidden');
            } else {
                els.settings.keyStatus.textContent = "‚ö†Ô∏è Ch·∫ø ƒë·ªô Offline (D·ªØ li·ªáu gi·ªõi h·∫°n)";
                els.settings.keyStatus.className = "text-xs mt-2 text-gray-500 italic";
                els.status.vocabSource.textContent = "Ch·∫ø ƒë·ªô Offline - S·ª≠ d·ª•ng d·ªØ li·ªáu n·ªôi b·ªô.";
                updateSuggestions();
            }
            return key;
        }
        checkKeyStatus(); // Run once on load

        // --- TOPIC SUGGESTION LOGIC ---
        function updateSuggestions() {
            const key = getApiKey();
            if (key) { els.suggestions.container.classList.add('hidden'); return; }

            const input = els.inputs.vocabTopic.value.trim().toLowerCase();
            const topics = Object.keys(offlineData.vocab).filter(t => t !== 'default');

            const filteredTopics = topics.filter(t => t.includes(input));

            els.suggestions.list.innerHTML = filteredTopics.map(topic => `
                <li onclick="selectTopic('${topic}')"
                    class="p-3 cursor-pointer hover:bg-yellow-50 transition text-gray-700">
                    <i class="fas fa-tag text-yellow-500 mr-2"></i> ${topic.charAt(0).toUpperCase() + topic.slice(1)}
                </li>
            `).join('');

            if (filteredTopics.length > 0) {
                els.suggestions.container.classList.remove('hidden');
            } else {
                els.suggestions.container.classList.add('hidden');
            }
        }

        function selectTopic(topic) {
            els.inputs.vocabTopic.value = topic.charAt(0).toUpperCase() + topic.slice(1);
            els.suggestions.container.classList.add('hidden');
        }

        els.inputs.vocabTopic.addEventListener('input', updateSuggestions);
        els.inputs.vocabTopic.addEventListener('focus', updateSuggestions);
        els.inputs.vocabTopic.addEventListener('blur', () => {
            // Delay hiding to allow click events on suggestions
            setTimeout(() => els.suggestions.container.classList.add('hidden'), 200);
        });

        // --- AI & OFFLINE LOGIC ---

        async function callGemini(prompt, key, useSearch = false, systemPrompt = "") {
            const modelName = 'gemini-2.5-flash-preview-09-2025';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${key}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                ...(useSearch && { tools: [{ "google_search": {} }] }),
                ...(systemPrompt && { systemInstruction: { parts: [{ text: systemPrompt }] } }),
                generationConfig: {
                    responseMimeType: "text/plain"
                }
            };

            for (let i = 0; i < 3; i++) { // Retry up to 3 times
                const delay = Math.pow(2, i) * 1000;
                if (i > 0) await new Promise(resolve => setTimeout(resolve, delay));

                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (response.ok) {
                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    if (!candidate || !candidate.content?.parts?.[0]?.text) throw new Error("Invalid API response structure.");

                    const text = candidate.content.parts[0].text;

                    // Handle citations for grounded calls
                    let citationsHtml = '';
                    if (useSearch) {
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            const sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({ uri: attribution.web?.uri, title: attribution.web?.title }))
                                .filter(source => source.uri && source.title);

                            if (sources.length > 0) {
                                citationsHtml = `<div class="mt-4 pt-4 border-t border-gray-200 text-xs text-gray-500">
                                    <p class="font-bold mb-1">Tham kh·∫£o t·ª´:</p>
                                    <ul class="list-none space-y-1">` +
                                    sources.map((s, index) =>
                                        `<li>${index + 1}. <a href="${s.uri}" target="_blank" class="text-indigo-500 hover:text-indigo-700">${s.title}</a></li>`
                                    ).join('') +
                                    `</ul></div>`;
                            }
                        }
                    }

                    return { text, citationsHtml };

                } else if (response.status !== 429) {
                    throw new Error(`API returned status ${response.status}`);
                }
            }
            throw new Error("API call failed after multiple retries.");
        }

        async function generateContent(type) {
            const key = getApiKey();
            showLoading(true, type === 'vocab' ? "ƒêang chu·∫©n b·ªã..." : "ƒêang so·∫°n b√†i t·∫≠p...");

            // 1. Try Online AI first if Key exists
            if (key) {
                try {
                    let prompt = "";
                    const systemPrompt = "B·∫°n l√† m·ªôt gia s∆∞ ti·∫øng Anh. Cung c·∫•p n·ªôi dung theo ƒë·ªãnh d·∫°ng JSON chu·∫©n. Tuy·ªát ƒë·ªëi kh√¥ng th√™m b·∫•t k·ª≥ vƒÉn b·∫£n gi·∫£i th√≠ch ho·∫∑c bao quanh n√†o b√™n ngo√†i JSON.";

                    if (type === 'vocab') {
                        const topic = els.inputs.vocabTopic.value.trim() || "th√¥ng d·ª•ng";
                        prompt = `Generate a JSON list of 10 Vietnamese-English vocabulary pairs related to the topic '${topic}'. Format strictly as JSON array: [{"vi": "...", "en": "..."}]. Return ONLY the JSON.`;
                        els.status.vocabSource.textContent = "‚ú® ƒê∆∞·ª£c t·∫°o b·ªüi AI";
                    } else {
                        const tense = els.inputs.grammarTense.value;
                        prompt = `Generate 10 fill-in-the-blank English sentences to practice the '${tense}'. Format strictly as JSON array of objects: [{"question": "She ___ (to go) home.", "verb": "go", "answer": "goes", "explanation": "She is singular"}]. Ensure 'answer' is the conjugated verb. 'question' must have '___'. Return ONLY the JSON.`;
                        els.status.grammarSource.textContent = "‚ú® ƒê∆∞·ª£c t·∫°o b·ªüi AI";
                    }

                    const result = await callGemini(prompt, key, false, systemPrompt);

                    // Clean the text: remove markdown code block fences and surrounding text
                    let jsonText = result.text.trim();
                    if (jsonText.startsWith('```')) {
                        jsonText = jsonText.substring(jsonText.indexOf('\n') + 1);
                        jsonText = jsonText.substring(0, jsonText.lastIndexOf('```')).trim();
                    }

                    const newData = JSON.parse(jsonText);

                    if (!Array.isArray(newData) || newData.length === 0) throw new Error("Bad Data from AI");

                    gameState.data = newData;
                    startGame();
                    showLoading(false);
                    return;

                } catch (err) {
                    console.error("Online failed, falling back to offline", err);
                    alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi AI ho·∫∑c l·ªói ƒë·ªãnh d·∫°ng. Chuy·ªÉn sang ch·∫ø ƒë·ªô Offline.");
                }
            }

            // 2. Offline Fallback Logic
            console.log("Using Offline Data");
            if (type === 'vocab') {
                const topicInput = els.inputs.vocabTopic.value.trim().toLowerCase();
                let selectedData = [];

                // Simple keyword matching for offline topics
                const topicKey = Object.keys(offlineData.vocab).find(key => topicInput.includes(key));
                selectedData = offlineData.vocab[topicKey] || offlineData.vocab["default"];

                gameState.data = [...selectedData].sort(() => 0.5 - Math.random()).slice(0, 10);
                els.status.vocabSource.textContent = "üìÇ D·ªØ li·ªáu Offline";

            } else {
                const tense = els.inputs.grammarTense.value;
                const tenseData = offlineData.grammar[tense];

                if (tenseData) {
                    gameState.data = [...tenseData].sort(() => 0.5 - Math.random()).slice(0, 10);
                    els.status.grammarSource.textContent = "üìÇ D·ªØ li·ªáu Offline";
                } else {
                    alert(`Ch·∫ø ƒë·ªô Offline ch∆∞a c√≥ b√†i t·∫≠p cho th√¨ ${tense}. Vui l√≤ng ch·ªçn th√¨ kh√°c ho·∫∑c nh·∫≠p API Key.`);
                    showLoading(false);
                    return;
                }
            }

            showLoading(false);
            startGame();
        }

        async function loadTheory(tense) {
            els.theory.list.classList.add('hidden');
            els.theory.detail.classList.remove('hidden');
            els.theory.explanation.innerHTML = '<div class="flex items-center gap-2"><div class="loader w-6 h-6 border-2"></div> ƒêang t·∫£i l√Ω thuy·∫øt...</div>';

            const key = getApiKey();

            // Try Online with Search Grounding (Better for up-to-date and cited content)
            if (key) {
                try {
                    const prompt = `Gi·∫£i th√≠ch ƒë·∫ßy ƒë·ªß v√† chi ti·∫øt v·ªÅ Th√¨ ${tense} (Tense) trong Ti·∫øng Anh. Bao g·ªìm C√¥ng d·ª•ng, C·∫•u tr√∫c (Kh·∫≥ng ƒë·ªãnh, Ph·ªß ƒë·ªãnh, Nghi v·∫•n), v√† D·∫•u hi·ªáu nh·∫≠n bi·∫øt.`;
                    const systemPrompt = "B·∫°n l√† m·ªôt gia s∆∞ ti·∫øng Anh gi√†u kinh nghi·ªám. D√πng c√¥ng c·ª• t√¨m ki·∫øm ƒë·ªÉ t√¨m v√† gi·∫£i th√≠ch ƒë·∫ßy ƒë·ªß v·ªÅ Th√¨ Ti·∫øng Anh m√† ng∆∞·ªùi d√πng y√™u c·∫ßu. Cung c·∫•p C√¥ng d·ª•ng, C·∫•u tr√∫c (kh·∫≥ng ƒë·ªãnh, ph·ªß ƒë·ªãnh, nghi v·∫•n) v√† c√°c D·∫•u hi·ªáu nh·∫≠n bi·∫øt. ƒê·ªãnh d·∫°ng ph·∫£n h·ªìi c·ªßa b·∫°n b·∫±ng ti·∫øng Vi·ªát, s·ª≠ d·ª•ng c√°c th·∫ª HTML (nh∆∞ <h3>, <h4>, <ul>, <ol>, <li>, <strong>, <p>) ƒë·ªÉ c·∫•u tr√∫c n·ªôi dung m·ªôt c√°ch d·ªÖ ƒë·ªçc. Lu√¥n tr√≠ch d·∫´n ngu·ªìn th√¥ng tin b·∫°n t√¨m th·∫•y.";

                    showLoading(true, `ƒêang tra c·ª©u l√Ω thuy·∫øt "${getVietnameseTenseName(tense)}"...`);
                    const result = await callGemini(prompt, key, true, systemPrompt);
                    showLoading(false);

                    // Clean the text and append citations
                    const cleanHtml = result.text.replace(/```html/g, '').replace(/```/g, '').trim();
                    els.theory.explanation.innerHTML = cleanHtml + result.citationsHtml;
                    return;
                } catch(e) {
                    console.error("Theory online search failed. Using offline data.", e);
                    showLoading(false);
                }
            }

            // Offline Fallback (Full theory guaranteed by user request)
            const theoryContent = offlineData.theory[tense];
            els.theory.explanation.innerHTML = theoryContent;
        }

        async function callGeminiTTS(text) {
            const key = getApiKey();
            if (!key) throw new Error("MISSING_KEY");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${key}`;

            const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" }
                        }
                    }
                }
            };

            for (let i = 0; i < 3; i++) { // Retry with exponential backoff
                const delay = Math.pow(2, i) * 1000;
                if (i > 0) await new Promise(resolve => setTimeout(resolve, delay));

                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (response.ok) {
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].inlineData.data;
                } else if (response.status !== 429) {
                    throw new Error(`TTS API failed with status ${response.status}`);
                }
            }
            throw new Error("TTS call failed after multiple retries.");
        }


        // --- UI & GAMEPLAY ---
        function setMode(mode) {
            gameState.mode = mode;
            if (mode === 'vocab') {
                els.tabs.vocab.className = "flex-1 py-3 rounded-xl text-sm font-bold transition tab-active shadow-sm";
                els.tabs.grammar.className = "flex-1 py-3 rounded-xl text-sm font-bold transition tab-inactive hover:bg-gray-200";
                els.views.vocab.classList.remove('hidden'); els.views.grammar.classList.add('hidden');
                updateSuggestions(); // Show suggestions when switching to vocab mode
            } else {
                els.tabs.grammar.className = "flex-1 py-3 rounded-xl text-sm font-bold transition tab-active shadow-sm";
                els.tabs.vocab.className = "flex-1 py-3 rounded-xl text-sm font-bold transition tab-inactive hover:bg-gray-200";
                els.views.grammar.classList.remove('hidden'); els.views.vocab.classList.add('hidden');
                els.suggestions.container.classList.add('hidden');
            }
        }

        function openTheoryModal() {
            els.theory.modal.classList.remove('hidden');
            // Re-generate list of tenses
            els.theory.list.innerHTML = tensesList.map(t => `<button onclick="loadTheory('${t}')" class="w-full text-left p-4 rounded-xl bg-gray-50 hover:bg-indigo-50 border border-gray-200 mb-2 font-semibold transition flex justify-between">${getVietnameseTenseName(t)} (${t}) <i class="fas fa-chevron-right text-gray-300"></i></button>`).join('');
            els.theory.list.classList.remove('hidden');
            els.theory.detail.classList.add('hidden');
            els.theory.explanation.innerHTML = ''; // Clear previous detail
        }
        function closeTheoryModal() { els.theory.modal.classList.add('hidden'); }
        function backToTenseList() { els.theory.detail.classList.add('hidden'); els.theory.list.classList.remove('hidden'); }

        function startGame() {
            gameState.currentIdx = 0; gameState.score = 0; gameState.history = [];
            switchScreen('game'); updateGameUI();
        }

        function updateGameUI() {
            const item = gameState.data[gameState.currentIdx];
            els.game.qNum.textContent = gameState.currentIdx + 1;
            els.game.progress.style.width = `${((gameState.currentIdx + 1) / 10) * 100}%`;
            els.inputs.answer.value = "";
            els.inputs.answer.focus();

            if (gameState.mode === 'vocab') {
                els.game.title.textContent = "Ch·ªß ƒë·ªÅ: " + (els.inputs.vocabTopic.value || "T·ª´ v·ª±ng");
                els.game.instruction.textContent = "D·ªãch sang Ti·∫øng Anh";
                els.game.display.textContent = item.vi;
                els.game.subDisplay.classList.add('hidden');
                gameState.currentCorrect = item.en;
            } else {
                els.game.title.textContent = els.inputs.grammarTense.value;
                els.game.instruction.textContent = "ƒêi·ªÅn ƒë·ªông t·ª´ ƒë√£ chia";
                els.game.display.textContent = item.question;
                els.game.subDisplay.textContent = `Verb: (${item.verb})`;
                els.game.subDisplay.classList.remove('hidden');
                gameState.currentCorrect = item.answer;
            }
        }

        function checkAnswer() {
            const userAns = els.inputs.answer.value.trim().toLowerCase().replace(/[.,/#!$%^&*;:{}=-_`~()]/g,"").replace(/\s{2,}/g," ");
            if (!userAns) return;

            const item = gameState.data[gameState.currentIdx];
            // Normalize correct answer (remove punctuation/extra spaces for matching)
            const correctAns = gameState.currentCorrect.toLowerCase().replace(/[.,/#!$%^&*;:{}=-_`~()]/g,"").replace(/\s{2,}/g," ");
            const isCorrect = userAns === correctAns;

            gameState.history.push({
                q: gameState.mode === 'vocab' ? item.vi : item.question,
                a: gameState.currentCorrect, // Save original correct answer for display
                u: els.inputs.answer.value.trim(), // Save original user input for display
                ok: isCorrect
            });

            if (isCorrect) {
                gameState.score++;
                els.feedback.icon.textContent = "üéâ";
                els.feedback.title.textContent = "Ch√≠nh x√°c!";
                els.feedback.title.className = "text-2xl font-bold mb-2 text-green-600";
            } else {
                els.feedback.icon.textContent = "ü§£";
                els.feedback.title.textContent = "Sai r·ªìi!";
                els.feedback.title.className = "text-2xl font-bold mb-2 text-red-600";
                els.app.classList.add('shake-element');
                setTimeout(() => els.app.classList.remove('shake-element'), 500);
            }

            els.feedback.correctText.textContent = gameState.currentCorrect;

            if (gameState.mode === 'grammar' && item.explanation) {
                els.feedback.explanation.textContent = "üí° " + item.explanation;
                els.feedback.explanation.classList.remove('hidden');
            } else {
                els.feedback.explanation.classList.add('hidden');
            }

            els.feedback.overlay.classList.remove('hidden');
        }

        function nextQuestion() {
            els.feedback.overlay.classList.add('hidden');
            gameState.currentIdx++;
            if (gameState.currentIdx >= 10 || gameState.currentIdx >= gameState.data.length) endGame();
            else updateGameUI();
        }

        function endGame() {
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('resultList').innerHTML = gameState.history.map(h => {
                const icon = h.ok ? '‚úÖ' : '‚ùå';
                const answerDisplay = h.ok ? `<span class="text-green-600 font-bold">${h.a}</span>` : `<span class="text-red-400 line-through truncate mr-2">${h.u}</span><span class="text-green-600 font-bold">${h.a}</span>`;

                return `
                    <div class="border-b border-gray-100 py-2">
                        <div class="text-sm font-bold text-gray-700">${h.q}</div>
                        <div class="flex justify-between mt-1 items-center">
                            <span class="text-sm flex-1">${answerDisplay}</span>
                            <span class="shrink-0">${icon}</span>
                        </div>
                    </div>
                `;
            }).join('');
            switchScreen('result');
        }

        async function playTTS() {
            const text = gameState.currentCorrect;
            const key = getApiKey();
            if (!key) {
                // Fallback: Browser TTS
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US'; speechSynthesis.speak(u);
                return;
            }
            try {
                // Show a mini loading indicator on the speaker button
                const speakerButton = document.querySelector('#feedbackOverlay .fa-volume-up').parentElement;
                const originalContent = speakerButton.innerHTML;
                speakerButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                const audioBase64 = await callGeminiTTS(text);
                const wavUrl = pcmToWav(audioBase64);

                // Play and then restore button content
                const audio = new Audio(wavUrl);
                audio.play();
                audio.onended = () => speakerButton.innerHTML = originalContent;

            } catch (e) {
                console.error("TTS failed, using browser speech synthesis", e);
                // Fallback to browser TTS if API or key fails
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US'; speechSynthesis.speak(u);

                // Ensure button content is restored on failure too
                const speakerButton = document.querySelector('#feedbackOverlay .fa-spinner')?.parentElement;
                if(speakerButton) speakerButton.innerHTML = originalContent;
                else document.querySelector('#feedbackOverlay .fa-volume-up').parentElement.innerHTML = originalContent;
            }
        }

        // --- UTILS ---
        function switchScreen(name) {
            Object.values(els.screens).forEach(s => s.classList.add('hidden'));
            els.screens[name].classList.remove('hidden');
        }
        function toggleSettings() { els.settings.panel.classList.toggle('hidden'); els.settings.panel.classList.toggle('flex'); }
        function showLoading(show, msg) { els.loading.text.textContent = msg; els.loading.overlay.classList.toggle('hidden', !show); }
        function resetGame() {
            switchScreen('start');
            checkKeyStatus();
            // Reset input fields
            els.inputs.vocabTopic.value = "";
            els.inputs.answer.value = "";
            setMode(gameState.mode); // Re-set mode to update suggestions/source
        }

        function pcmToWav(base64PCM) {
            const binaryString = atob(base64PCM); const len = binaryString.length; const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
            const wavHeader = new ArrayBuffer(44); const view = new DataView(wavHeader);
            const writeString = (v, o, s) => { for (let i = 0; i < s.length; i++) v.setUint8(o + i, s.charCodeAt(i)); };
            // Note: Sample rate is assumed to be 24000 (from typical TTS output)
            const sampleRate = 24000;
            view.setUint8(0, 'R'.charCodeAt(0)); view.setUint8(1, 'I'.charCodeAt(0)); view.setUint8(2, 'F'.charCodeAt(0)); view.setUint8(3, 'F'.charCodeAt(0));
            view.setUint32(4, 36 + len, true);
            view.setUint8(8, 'W'.charCodeAt(0)); view.setUint8(9, 'A'.charCodeAt(0)); view.setUint8(10, 'V'.charCodeAt(0)); view.setUint8(11, 'E'.charCodeAt(0));
            view.setUint8(12, 'f'.charCodeAt(0)); view.setUint8(13, 'm'.charCodeAt(0)); view.setUint8(14, 't'.charCodeAt(0)); view.setUint8(15, ' '.charCodeAt(0));
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true);
            view.setUint8(36, 'd'.charCodeAt(0)); view.setUint8(37, 'a'.charCodeAt(0)); view.setUint8(38, 't'.charCodeAt(0)); view.setUint8(39, 'a'.charCodeAt(0));
            view.setUint32(40, len, true);

            const wavBytes = new Uint8Array(wavHeader.byteLength + len);
            wavBytes.set(new Uint8Array(wavHeader), 0); wavBytes.set(bytes, wavHeader.byteLength);
            return URL.createObjectURL(new Blob([wavBytes], { type: 'audio/wav' }));
        }

        // --- Event Listeners ---
        els.inputs.answer.addEventListener("keypress", (e) => { if (e.key === "Enter") checkAnswer(); });
        els.inputs.vocabTopic.addEventListener("keypress", (e) => { if (e.key === "Enter") generateContent('vocab'); });


        // --- Expose Global Functions for Inline HTML Handlers ---
        // C·∫ßn l√†m cho c√°c h√†m n√†y kh·∫£ d·ª•ng to√†n c·ª•c v√¨ ch√∫ng ƒë∆∞·ª£c g·ªçi t·ª´ onclick="..." trong HTML
        window.resetGame = resetGame;
        window.openTheoryModal = openTheoryModal;
        window.toggleSettings = toggleSettings;
        window.saveApiKey = saveApiKey;
        window.setMode = setMode;
        window.generateContent = generateContent;
        window.checkAnswer = checkAnswer;
        window.nextQuestion = nextQuestion;
        window.playTTS = playTTS;
        window.closeTheoryModal = closeTheoryModal;
        window.backToTenseList = backToTenseList;
        window.selectTopic = selectTopic;
        window.loadTheory = loadTheory;

        // Initialize display mode
        setMode('vocab');
        resetGame();
    </script>
</body>
</html>