<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <!-- interactive-widget=resizes-content: Báº®T BUá»˜C Ä‘á»ƒ viewport co láº¡i khi cÃ³ bÃ n phÃ­m -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>AI Tutor: v3.9.0 (Absolute Fix)</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#FFFBEB">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CORE RESET --- */
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        ::-webkit-scrollbar { width: 0px; background: transparent; display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }

        html, body {
            height: 100%; width: 100%;
            overflow: hidden; /* KhÃ³a cuá»™n toÃ n trang */
            font-family: 'Quicksand', sans-serif;
            background-color: #FFFBEB;
            position: fixed; /* Chá»‘ng trÃ´i trÃªn iOS */
            top: 0; left: 0;
        }

        /* --- LAYOUT TUYá»†T Äá»I (ABSOLUTE LAYOUT) --- */
        /* ÄÃ¢y lÃ  cÃ¡ch layout kiá»ƒu á»©ng dá»¥ng Native: CÃ¡c pháº§n tá»­ Ä‘Æ°á»£c neo cá»©ng vá»‹ trÃ­ */

        /* 1. HEADER: Neo á»Ÿ Ä‘á»‰nh */
        #mainHeader {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: auto;
            z-index: 50;
            background-color: #FFFBEB;
            transition: transform 0.2s ease; /* Hiá»‡u á»©ng áº©n hiá»‡n mÆ°á»£t */
        }

        /* 2. INPUT AREA: Neo á»Ÿ Ä‘Ã¡y */
        #inputContainerWrapper {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            z-index: 60;
            background-color: #FFFBEB;
            /* Height lÃ  auto Ä‘á»ƒ nÃ³ Ã´m láº¥y ná»™i dung bÃªn trong */
        }

        /* 3. MIDDLE CONTENT: Neo giá»¯a Header vÃ  Input */
        /* ChÃºng ta dÃ¹ng JS hoáº·c CSS Calc Ä‘á»ƒ set top/bottom cho pháº§n nÃ y */
        #mainContent {
            position: absolute;
            top: 60px; /* Chiá»u cao Æ°á»›c lÆ°á»£ng cá»§a Header */
            bottom: 140px; /* Chiá»u cao Æ°á»›c lÆ°á»£ng cá»§a Input */
            left: 0; right: 0;
            overflow-y: auto; /* Chá»‰ cuá»™n ná»™i dung trong vÃ¹ng nÃ y */
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            width: 100%;
            -webkit-overflow-scrolling: touch;
            transition: all 0.1s; /* Resize mÆ°á»£t */
        }

        /* --- CSS CHO CÃC MÃ€N HÃŒNH Cá»¤ THá»‚ --- */

        /* MÃ n hÃ¬nh Game: CÄƒn giá»¯a ná»™i dung */
        #gameScreenContent {
            min-height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center; /* CÄƒn giá»¯a dá»c */
            align-items: center;
            padding: 1rem;
        }

        /* --- AUTO-ADAPT KHI CÃ“ BÃ€N PHÃM (Mobile Keyboard Mode) --- */
        /* Khi chiá»u cao mÃ n hÃ¬nh < 500px (tá»©c lÃ  khi bÃ n phÃ­m hiá»‡n lÃªn chiáº¿m chá»—) */
        @media (max-height: 500px) {
            /* 1. áº¨n Header Ä‘á»ƒ láº¥y chá»— */
            #mainHeader {
                transform: translateY(-100%); /* TrÆ°á»£t header lÃªn khá»i mÃ n hÃ¬nh */
                pointer-events: none;
            }

            /* 2. Má»Ÿ rá»™ng pháº§n giá»¯a lÃªn Ä‘á»‰nh (vÃ¬ header Ä‘Ã£ áº©n) */
            #mainContent {
                top: 0 !important;
                bottom: 80px !important; /* Thu nhá» bottom láº¡i vÃ¬ Input input cÅ©ng bÃ© láº¡i */
            }

            /* 3. Tinh chá»‰nh hiá»ƒn thá»‹ ná»™i dung cho gá»n */
            #gameScreenContent {
                justify-content: flex-end !important; /* Äáº©y ná»™i dung xuá»‘ng gáº§n input cho dá»… nhÃ¬n */
                padding-bottom: 0.5rem !important;
            }

            .game-content-box {
                margin-top: 0 !important;
                transform: scale(0.9); /* Thu nhá» nháº¹ ná»™i dung cho vá»«a máº¯t */
                transform-origin: bottom center;
            }

            #mainDisplay { font-size: 1.5rem !important; margin-bottom: 0.25rem !important; }
            #instructionText { margin-bottom: 0.25rem !important; }
            #subDisplay { display: none !important; } /* áº¨n gá»£i Ã½ */

            /* 4. Tinh chá»‰nh Input cho gá»n */
            #inputContainerWrapper {
                padding-top: 0.5rem !important;
                padding-bottom: 0.5rem !important;
            }
            #answerInput {
                padding: 0.5rem 1rem !important;
                font-size: 1rem !important;
                height: 3rem !important;
            }
            #checkBtn {
                padding: 0.5rem !important;
                height: 3rem !important;
                font-size: 1rem !important;
            }
        }

        /* --- UTILS --- */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #F59E0B; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-btn { transition: all 0.2s ease; position: relative; overflow: hidden; }
        .tab-active { background-color: #FFFFFF; color: #B45309; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-inactive { color: #9CA3AF; background-color: transparent; }
        .level-card { transition: all 0.2s; border: 2px solid transparent; }
        .level-card.selected { border-color: #F59E0B; background-color: #FFFBEB; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.1); }
        .screen-fade { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .input-focus:focus-within { border-color: #FBBF24; box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.2); }
    </style>
</head>
<body>
    <!-- HEADER (Absolute Top) -->
    <div id="mainHeader" class="px-4 py-3 pt-[calc(env(safe-area-inset-top)+0.75rem)] flex justify-between items-center border-b border-yellow-100/50">
        <div class="flex items-center gap-3">
            <button onclick="resetGame()" class="w-10 h-10 flex items-center justify-center text-yellow-800 bg-white rounded-full shadow-sm active:scale-90 transition-transform"><i class="fas fa-home"></i></button>
            <h1 class="text-xl font-extrabold text-yellow-900 tracking-tight flex items-center gap-2 cursor-pointer" onclick="resetGame()"><span class="text-2xl filter drop-shadow-sm">ğŸ¥‘</span> AI Tutor</h1>
        </div>
        <div class="flex gap-2">
            <button onclick="openDictModal()" class="w-10 h-10 flex items-center justify-center text-yellow-700 bg-white rounded-full shadow-sm active:scale-90 transition-transform"><i class="fas fa-search"></i></button>
            <button onclick="openTheoryModal()" class="w-10 h-10 flex items-center justify-center text-indigo-600 bg-white rounded-full shadow-sm active:scale-90 transition-transform"><i class="fas fa-book-open"></i></button>
            <button onclick="openSettingsScreen()" class="w-10 h-10 flex items-center justify-center text-gray-600 bg-white rounded-full shadow-sm active:scale-90 transition-transform"><i class="fas fa-cog"></i></button>
        </div>
    </div>

    <!-- MIDDLE CONTENT (Absolute Middle - Resizeable) -->
    <div id="mainContent">
        <!-- START SCREEN -->
        <div id="startScreen" class="w-full min-h-full flex flex-col p-5 screen-fade">
            <div class="flex bg-gray-100/80 p-1.5 rounded-2xl mb-6 shadow-inner shrink-0">
                <button onclick="setMode('vocab')" id="tabVocab" class="tab-btn flex-1 py-2.5 rounded-xl text-xs sm:text-sm font-bold transition tab-active">Tá»« Vá»±ng</button>
                <button onclick="setMode('grammar')" id="tabGrammar" class="tab-btn flex-1 py-2.5 rounded-xl text-xs sm:text-sm font-bold transition tab-inactive">Ngá»¯ PhÃ¡p</button>
                <button onclick="setMode('forms')" id="tabForms" class="tab-btn flex-1 py-2.5 rounded-xl text-xs sm:text-sm font-bold transition tab-inactive">Biáº¿n Thá»ƒ</button>
            </div>

            <div id="startScreenContent" class="w-full max-w-md mx-auto flex-1 flex flex-col justify-center pb-20">
                <div id="viewVocab" class="flex flex-col items-center w-full animate-fadeIn">
                    <div class="w-24 h-24 bg-gradient-to-tr from-yellow-200 to-yellow-400 rounded-3xl flex items-center justify-center text-5xl shadow-lg mb-4 text-white transform rotate-3">ğŸ¥‘</div>
                    <h2 class="text-2xl font-black text-gray-800 mb-1">Há»c Tá»« Vá»±ng</h2>
                    <p class="text-sm text-gray-500 mb-6 font-medium">Nháº­p chá»§ Ä‘á» báº¥t ká»³ Ä‘á»ƒ AI táº¡o bÃ i táº­p</p>
                    <div id="onlineVocabInput" class="w-full input-focus rounded-2xl transition-all duration-200">
                        <input type="text" id="vocabTopicInput" placeholder="VD: Travel, Business, Food..." class="w-full p-5 bg-white border-2 border-transparent text-center text-lg font-bold text-gray-800 rounded-2xl shadow-sm focus:outline-none placeholder-gray-300">
                    </div>
                    <div id="offlineVocabSelect" class="w-full hidden mt-2"><div class="relative w-full"><select id="vocabTopicSelect" class="w-full p-5 bg-white border-none rounded-2xl text-base font-bold text-center text-gray-700 shadow-sm appearance-none focus:ring-0"></select><div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"><i class="fas fa-chevron-down"></i></div></div></div>
                </div>

                <div id="viewGrammar" class="hidden flex flex-col items-center w-full animate-fadeIn">
                    <div class="w-24 h-24 bg-gradient-to-tr from-indigo-300 to-indigo-500 rounded-3xl flex items-center justify-center text-5xl shadow-lg mb-4 text-white transform -rotate-3">ğŸ“</div>
                    <h2 class="text-2xl font-black text-gray-800 mb-1">Luyá»‡n 12 ThÃ¬</h2>
                    <p class="text-sm text-gray-500 mb-6 font-medium">Chá»n thÃ¬ báº¡n muá»‘n Ã´n táº­p</p>
                    <div class="relative w-full"><select id="grammarTenseSelect" class="w-full p-5 bg-white border-none rounded-2xl text-base font-bold text-center text-indigo-900 shadow-sm appearance-none focus:outline-none"></select><div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"><i class="fas fa-chevron-down"></i></div></div>
                </div>

                <div id="viewForms" class="hidden flex flex-col items-center w-full animate-fadeIn">
                    <div class="w-24 h-24 bg-gradient-to-tr from-green-300 to-green-500 rounded-3xl flex items-center justify-center text-5xl shadow-lg mb-4 text-white transform rotate-3">ğŸ”€</div>
                    <h2 class="text-2xl font-black text-gray-800 mb-1">Biáº¿n Thá»ƒ Tá»«</h2>
                    <p class="text-sm text-gray-500 mb-6 font-medium">Luyá»‡n táº­p Word Forms</p>
                    <div class="relative w-full"><select id="formsTypeSelect" class="w-full p-5 bg-white border-none rounded-2xl text-base font-bold text-center text-green-900 shadow-sm appearance-none focus:outline-none"></select><div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"><i class="fas fa-chevron-down"></i></div></div>
                </div>

                <div id="configSection" class="w-full mt-8 mb-6 bg-white p-6 rounded-3xl shadow-sm border border-gray-100 transition-all">
                    <input type="hidden" id="levelSelect" value="A1-A2">
                    <div class="flex justify-between items-center mb-3"><label class="text-xs font-bold text-gray-400 tracking-wider">TRÃŒNH Äá»˜</label></div>
                    <div class="grid grid-cols-4 gap-2 mb-6">
                        <div onclick="updateLevel('A1-A2', this)" class="level-card selected cursor-pointer py-4 rounded-2xl bg-gray-50 text-center"><div class="text-2xl mb-1">ğŸŒ±</div><div class="text-[10px] font-bold text-gray-600">Dá»…</div></div>
                        <div onclick="updateLevel('B1-B2', this)" class="level-card cursor-pointer py-4 rounded-2xl bg-gray-50 text-center"><div class="text-2xl mb-1">ğŸš€</div><div class="text-[10px] font-bold text-gray-600">TB</div></div>
                        <div onclick="updateLevel('C1-C2', this)" class="level-card cursor-pointer py-4 rounded-2xl bg-gray-50 text-center"><div class="text-2xl mb-1">ğŸ”¥</div><div class="text-[10px] font-bold text-gray-600">KhÃ³</div></div>
                        <div onclick="updateLevel('IELTS', this)" class="level-card cursor-pointer py-4 rounded-2xl bg-gray-50 text-center"><div class="text-2xl mb-1">ğŸ“</div><div class="text-[10px] font-bold text-gray-600">IELTS</div></div>
                    </div>
                    <div class="flex justify-between items-center mb-3"><label class="text-xs font-bold text-gray-400 tracking-wider">Sá» LÆ¯á»¢NG</label><span id="qtyDisplay" class="text-xs font-bold text-white bg-gray-900 px-2 py-1 rounded-lg">10 cÃ¢u</span></div>
                    <input type="range" id="quantityRange" min="5" max="30" step="5" value="10" class="w-full h-2 bg-gray-100 rounded-lg appearance-none cursor-pointer accent-yellow-500 hover:accent-yellow-400">
                </div>

                <button onclick="startGeneration()" id="startBtn" class="w-full bg-gray-900 text-white font-bold text-lg py-4 rounded-3xl shadow-xl shadow-gray-300/50 active:scale-[0.98] transition-all flex items-center justify-center gap-3 mt-2">
                    <i class="fas fa-play text-yellow-400"></i> Báº¯t Äáº§u
                </button>
            </div>
        </div>

        <!-- SETTINGS SCREEN -->
        <div id="settingsScreen" class="hidden w-full min-h-full flex flex-col p-5 screen-fade">
            <button onclick="backFromSettings()" class="mb-6 flex items-center gap-2 text-sm font-bold text-gray-500 hover:text-gray-700 bg-gray-100 px-4 py-2 rounded-xl active:scale-95 transition-all w-fit">
                <i class="fas fa-arrow-left"></i> Quay láº¡i
            </button>
            <div class="w-full max-w-lg mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center gap-3"><i class="fas fa-cog text-gray-400"></i> CÃ i Ä‘áº·t á»¨ng dá»¥ng</h2>
                <div class="mb-6 p-6 bg-indigo-50 rounded-3xl border border-indigo-100 shadow-lg">
                    <label class="block text-sm font-bold text-indigo-900 mb-2 uppercase tracking-wider">ğŸ”‘ Google Gemini API Key</label>
                    <input type="password" id="userApiKeyInput" placeholder="DÃ¡n API Key vÃ o Ä‘Ã¢y..."
                           class="w-full p-4 border border-indigo-200 bg-white rounded-xl mb-3 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition text-gray-700 font-mono text-sm">
                    <button onclick="saveApiKey()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 active:scale-[0.99]">LÆ°u Key</button>
                    <p id="keyStatus" class="text-xs mt-3 text-center text-gray-400 font-medium">ChÆ°a káº¿t ná»‘i</p>
                </div>
            </div>
        </div>

        <!-- GAME SCREEN (Ná»™i dung game) -->
        <div id="gameScreen" class="hidden w-full h-full relative">
            <div id="gameScreenContent">
                <!-- Header cá»§a Game (CÃ¢u sá»‘ máº¥y) -->
                <div class="w-full shrink-0 px-2 pb-2 z-10" id="gameHeaderWrapper">
                    <div id="gameHeader" class="flex justify-between items-center mb-2">
                        <span class="font-bold text-gray-400 text-xs uppercase tracking-wider truncate max-w-[60%]" id="gameTitle">General</span>
                        <div class="bg-gray-100 px-3 py-1 rounded-full text-xs font-bold text-gray-600 flex items-center gap-1">
                            <i class="fas fa-flag text-yellow-500"></i> <span id="currentQ">1</span>/<span id="totalQ">10</span>
                        </div>
                    </div>
                    <div id="progressBarContainer" class="w-full bg-gray-100 rounded-full h-2 overflow-hidden"><div id="progressBar" class="bg-yellow-400 h-full rounded-full transition-all duration-500 ease-out shadow-[0_0_10px_rgba(250,204,21,0.5)]" style="width: 10%"></div></div>
                </div>

                <!-- Ná»™i dung chÃ­nh (CÃ¢u há»i) -->
                <div class="game-content-box flex flex-col items-center justify-center p-4 w-full">
                    <span id="instructionText" class="text-[10px] font-bold text-gray-400 uppercase tracking-[0.2em] mb-4 bg-gray-50 px-4 py-1.5 rounded-full border border-gray-100 transition-all">Translate</span>
                    <h2 id="mainDisplay" class="text-3xl sm:text-4xl font-black text-center text-gray-800 mb-3 leading-tight break-words max-w-full drop-shadow-sm transition-all">Loading...</h2>
                    <p id="subDisplay" class="text-indigo-500 font-bold text-sm hidden bg-indigo-50 px-4 py-2 rounded-xl mt-2 border border-indigo-100 transition-all">(hint)</p>
                </div>
            </div>
        </div>

        <!-- RESULT SCREEN -->
        <div id="resultScreen" class="hidden w-full min-h-full flex flex-col p-6 text-center screen-fade">
            <div class="flex-1 flex flex-col items-center justify-center w-full max-w-md mx-auto">
                <div class="relative mb-6">
                    <div class="absolute inset-0 bg-yellow-300 blur-2xl opacity-30 rounded-full"></div>
                    <div class="text-7xl relative animate-bounce">ğŸ†</div>
                </div>
                <h2 class="text-3xl font-black mb-2 text-gray-800">HoÃ n thÃ nh!</h2>
                <div class="flex items-center gap-3 mb-8 bg-white px-6 py-3 rounded-full border border-yellow-100 shadow-sm">
                     <span class="text-gray-400 text-xs font-bold uppercase tracking-wider">Score</span>
                     <div class="flex items-baseline gap-1">
                        <span id="finalScore" class="font-black text-yellow-500 text-2xl">0</span>
                        <span class="text-gray-300 text-lg">/</span>
                        <span id="totalScoreQ" class="font-bold text-gray-400 text-lg">10</span>
                     </div>
                </div>
                <div id="resultList" class="w-full bg-white rounded-3xl border border-white p-2 mb-4 overflow-y-auto max-h-[50vh] text-left shadow-lg shadow-yellow-100/50"></div>
            </div>
            <button onclick="resetGame()" class="w-full bg-gray-900 text-white font-bold py-4 rounded-3xl shadow-lg active:scale-95 shrink-0 mb-8"><i class="fas fa-redo mr-2"></i> ChÆ¡i láº¡i</button>
        </div>
    </div>

    <!-- INPUT CONTAINER (Absolute Bottom) -->
    <div id="inputContainerWrapper" class="px-4 py-4 pb-[max(1rem,env(safe-area-inset-bottom))] shadow-[0_-5px_20px_rgba(0,0,0,0.03)] border-t border-gray-100 hidden">
        <div class="w-full max-w-lg mx-auto">
            <div class="relative w-full mb-3 group">
                <input type="text" id="answerInput" class="w-full bg-gray-50 border-2 border-transparent text-center text-xl font-bold p-4 rounded-3xl focus:outline-none focus:bg-white focus:border-yellow-400 transition-all shadow-inner placeholder-gray-300" placeholder="Nháº­p Ä‘Ã¡p Ã¡n..." autocomplete="off" touch-action="manipulation">
                <div class="absolute inset-y-0 right-4 flex items-center pointer-events-none text-gray-300 group-focus-within:text-yellow-400 transition-colors"><i class="fas fa-pen"></i></div>
            </div>
            <button id="checkBtn" onclick="checkAnswer()" class="w-full bg-gray-900 text-white font-bold text-lg py-4 rounded-3xl shadow-xl shadow-gray-400/30 active:scale-[0.98] transition-all flex items-center justify-center gap-2"><span>Kiá»ƒm tra</span> <i class="fas fa-arrow-up transform rotate-45"></i></button>
        </div>
    </div>

    <!-- MODALS & OVERLAYS (Giá»¯ nguyÃªn) -->
    <div id="dictModal" class="hidden fixed inset-0 z-[100] flex items-end sm:items-center justify-center pointer-events-none">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm pointer-events-auto transition-opacity duration-300 opacity-0" id="dictBackdrop" onclick="closeDictModal()"></div>
        <div class="bg-white w-full sm:w-[28rem] h-[85vh] sm:h-[80vh] rounded-t-3xl sm:rounded-3xl flex flex-col pointer-events-auto transform transition-transform duration-300 translate-y-full" id="dictContent">
            <div class="p-4 border-b flex items-center justify-between">
                <h2 class="font-bold text-lg text-orange-600 flex items-center gap-2"><i class="fas fa-language"></i> Tá»« Äiá»ƒn</h2>
                <button onclick="closeDictModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 bg-gray-50"><div class="relative"><input type="text" id="dictInput" class="w-full pl-11 pr-12 py-3.5 bg-white border-none shadow-sm rounded-2xl font-bold text-gray-700 placeholder-gray-400 focus:ring-2 focus:ring-orange-200" placeholder="Nháº­p tá»« cáº§n tra..."><i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-300"></i><button onclick="lookupDictionary()" class="absolute right-2 top-2 p-1.5 bg-orange-100 text-orange-600 rounded-xl"><i class="fas fa-arrow-right"></i></button></div></div>
            <div class="flex-1 overflow-y-auto p-5" id="dictResultArea"><div class="text-center text-gray-400 mt-10"><i class="fas fa-book text-4xl mb-2 opacity-20"></i><p class="text-sm">Tra tá»« Anh-Viá»‡t / Viá»‡t-Anh</p></div></div>
        </div>
    </div>

    <div id="theoryModal" class="hidden fixed inset-0 z-[100] flex items-end sm:items-center justify-center pointer-events-none">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm pointer-events-auto transition-opacity duration-300 opacity-0" id="theoryBackdrop" onclick="closeTheoryModal()"></div>
        <div class="bg-white w-full sm:w-[28rem] h-[85vh] sm:h-[80vh] rounded-t-3xl sm:rounded-3xl flex flex-col pointer-events-auto transform transition-transform duration-300 translate-y-full" id="theoryContentPanel">
            <div class="p-4 border-b flex items-center justify-between bg-indigo-50/50 rounded-t-3xl">
                <h2 class="font-bold text-lg text-indigo-900 flex items-center gap-2"><i class="fas fa-graduation-cap"></i> Sá»• tay</h2>
                <button onclick="closeTheoryModal()" class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-gray-500 shadow-sm"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex p-2 gap-2 bg-white border-b" id="theoryTabs">
                <button onclick="switchTheoryTab('grammar')" id="btnTheoryGrammar" class="flex-1 py-2.5 rounded-xl text-xs font-bold bg-indigo-100 text-indigo-700 transition-colors">12 ThÃ¬</button>
                <button onclick="switchTheoryTab('forms')" id="btnTheoryForms" class="flex-1 py-2.5 rounded-xl text-xs font-bold text-gray-500 hover:bg-gray-50 transition-colors">Biáº¿n thá»ƒ</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 bg-gray-50" id="theoryContent">
                <div id="theoryListGrammar" class="space-y-2"></div>
                <div id="theoryListForms" class="hidden space-y-2"></div>
                <div id="theoryDetail" class="hidden h-full flex flex-col">
                    <button onclick="backToTheoryList()" class="mb-4 bg-white px-4 py-2 rounded-xl shadow-sm w-fit text-xs font-bold text-gray-600 border border-gray-100"><i class="fas fa-arrow-left mr-1"></i> Quay láº¡i</button>
                    <div id="theoryDetailContent" class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 text-sm leading-relaxed text-gray-700"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="hidden absolute inset-0 bg-white/90 z-[110] flex flex-col items-center justify-center backdrop-blur-sm"><div class="loader mb-4"></div><p id="loadingText" class="text-gray-600 font-bold text-sm tracking-wide animate-pulse">ÄANG Xá»¬ LÃ...</p></div>

    <div id="feedbackOverlay" class="hidden fixed inset-0 z-[120] flex flex-col items-center justify-center pointer-events-none">
        <div class="absolute inset-0 bg-white/95 backdrop-blur-md pointer-events-auto animate-fadeIn"></div>
        <div class="relative z-10 flex flex-col items-center justify-center w-full max-w-sm p-6 text-center pointer-events-auto">
            <div id="feedbackIcon" class="text-7xl mb-4 filter drop-shadow-md transform transition-transform hover:scale-110 duration-300">ğŸ‰</div>
            <h3 id="feedbackTitle" class="text-3xl font-black mb-6 tracking-tight">ChÃ­nh xÃ¡c!</h3>
            <div class="bg-white rounded-3xl p-6 w-full mb-8 border border-gray-100 shadow-xl relative overflow-hidden group">
                <div class="absolute top-0 left-0 w-2 h-full bg-green-500 transition-all group-hover:w-3" id="feedbackBorder"></div>
                <p class="text-gray-400 text-[10px] uppercase font-black tracking-[0.2em] mb-3">ÄÃP ÃN ÄÃšNG</p>
                <div class="flex flex-col items-center gap-4">
                    <span id="correctAnswerText" class="text-3xl font-black text-gray-800 break-words leading-tight">Answer</span>
                    <button onclick="playTTS()" class="w-12 h-12 rounded-full bg-gray-50 border border-gray-200 text-gray-600 flex items-center justify-center shadow-sm active:scale-90 transition-transform"><i class="fas fa-volume-up text-lg"></i></button>
                </div>
                <p id="grammarExplanation" class="text-sm text-indigo-600 mt-5 pt-4 border-t border-gray-100 italic hidden text-left bg-indigo-50/50 -mx-6 -mb-6 p-6"></p>
            </div>
            <button onclick="nextQuestion(); document.getElementById('answerInput').focus();" class="w-full bg-gray-900 text-white font-bold text-lg py-4 rounded-3xl shadow-xl shadow-gray-400/40 active:scale-95 transition-transform flex items-center justify-center group">Tiáº¿p tá»¥c <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i></button>
        </div>
    </div>

    <script type="module">
        (function setupPWA() {
            const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512; const ctx = canvas.getContext('2d');
            const grd = ctx.createLinearGradient(0, 0, 0, 512); grd.addColorStop(0, '#FFFBEB'); grd.addColorStop(1, '#FBBF24');
            ctx.fillStyle = grd; ctx.fillRect(0, 0, 512, 512); ctx.font = '300px serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('ğŸ¥‘', 256, 270);
            const url = canvas.toDataURL('image/png');
            document.getElementById('apple-icon') && (document.getElementById('apple-icon').href = url);
            document.getElementById('fav-icon') && (document.getElementById('fav-icon').href = url);
        })();

        window.onerror = function(msg, url, line, col, error) { console.error("Lá»—i: " + msg); return false; };

        // --- DYNAMIC LAYOUT CALCULATION (Fix overlap) ---
        function updateLayout() {
            const header = document.getElementById('mainHeader');
            const input = document.getElementById('inputContainerWrapper');
            const content = document.getElementById('mainContent');

            // Láº¥y chiá»u cao thá»±c táº¿
            const headerHeight = header.offsetHeight;
            const inputHeight = input.classList.contains('hidden') ? 0 : input.offsetHeight;

            // Cáº­p nháº­t vá»‹ trÃ­ cho pháº§n giá»¯a (content)
            content.style.top = `${headerHeight}px`;
            content.style.bottom = `${inputHeight}px`;
        }

        // Gá»i updateLayout khi resize hoáº·c load
        window.addEventListener('resize', updateLayout);
        // Gá»i Ä‘á»‹nh ká»³ Ä‘á»ƒ Ä‘áº£m báº£o náº¿u layout thay Ä‘á»•i (do animation) thÃ¬ váº«n Ä‘Ãºng
        setInterval(updateLayout, 500);

        // --- DATA ---
        const offlineData = {
            vocab: { "Daily Life": [{vi: "CÃ  phÃª", en: "coffee"}, {vi: "MÃ¡y tÃ­nh", en: "computer"}, {vi: "SÃ¡ch", en: "book"}, {vi: "BÃºt", en: "pen"}, {vi: "TrÆ°á»ng há»c", en: "school"}, {vi: "Báº¡n bÃ¨", en: "friend"}, {vi: "Gia Ä‘Ã¬nh", en: "family"}, {vi: "NÆ°á»›c", en: "water"}, {vi: "Thá»©c Äƒn", en: "food"}, {vi: "Tiá»n", en: "money"}, {vi: "Cá»­a", en: "door"}, {vi: "Gháº¿", en: "chair"}, {vi: "BÃ n", en: "table"}, {vi: "ThÃ nh phá»‘", en: "city"}, {vi: "CÃ´ng viá»‡c", en: "job"}, {vi: "GiÆ°á»ng ngá»§", en: "bed"}, {vi: "Báº¿p", en: "kitchen"}, {vi: "Äiá»‡n thoáº¡i", en: "phone"}, {vi: "Xe buÃ½t", en: "bus"}, {vi: "Bá»¯a sÃ¡ng", en: "breakfast"}], "Work & Business": [{vi: "PhÃ¡t triá»ƒn", en: "develop"}, {vi: "ThÃ nh tá»±u", en: "achievement"}, {vi: "Thá»­ thÃ¡ch", en: "challenge"}, {vi: "MÃ´i trÆ°á»ng", en: "environment"}, {vi: "XÃ£ há»™i", en: "society"}, {vi: "Kinh táº¿", en: "economy"}, {vi: "VÄƒn hÃ³a", en: "culture"}, {vi: "Giáº£i phÃ¡p", en: "solution"}, {vi: "CÆ¡ há»™i", en: "opportunity"}, {vi: "Kiáº¿n thá»©c", en: "knowledge"}, {vi: "Kinh nghiá»‡m", en: "experience"}, {vi: "Quyáº¿t Ä‘á»‹nh", en: "decision"}, {vi: "áº¢nh hÆ°á»Ÿng", en: "influence"}, {vi: "CÃ´ng nghá»‡", en: "technology"}, {vi: "SÃ¡ng táº¡o", en: "creative"}, {vi: "Thá»‹ trÆ°á»ng", en: "market"}, {vi: "KhÃ¡ch hÃ ng", en: "customer"}, {vi: "Äáº§u tÆ°", en: "investment"}, {vi: "Lá»£i nhuáº­n", en: "profit"}, {vi: "Quáº£n lÃ½", en: "management"}], "Academic & IELTS": [{vi: "ToÃ n diá»‡n", en: "comprehensive"}, {vi: "ÄÃ¡ng ká»ƒ", en: "significant"}, {vi: "SÃ¢u sáº¯c", en: "profound"}, {vi: "MÆ¡ há»“", en: "ambiguous"}, {vi: "Tá»‰ má»‰", en: "meticulous"}, {vi: "Bá»n vá»¯ng", en: "sustainable"}, {vi: "Thiáº¿t yáº¿u", en: "indispensable"}, {vi: "Lá»—i thá»i", en: "obsolete"}, {vi: "Thá»‹nh vÆ°á»£ng", en: "prosperous"}, {vi: "Báº¥t lá»£i", en: "detrimental"}, {vi: "Thuyáº¿t phá»¥c", en: "persuasive"}, {vi: "Nháº¥t quÃ¡n", en: "consistent"}, {vi: "KhÃ³ náº¯m báº¯t", en: "elusive"}, {vi: "Tinh táº¿", en: "exquisite"}, {vi: "KiÃªn cÆ°á»ng", en: "resilient"}, {vi: "Giáº£m nháº¹", en: "mitigate"}, {vi: "LÃ m tráº§m trá»ng", en: "exacerbate"}, {vi: "Phá»• biáº¿n", en: "prevalent"}, {vi: "Báº¥t bÃ¬nh Ä‘áº³ng", en: "inequality"}, {vi: "ÄÃ´ thá»‹ hÃ³a", en: "urbanization"}], "Travel & Food": [{vi: "HÃ nh lÃ½", en: "luggage"}, {vi: "Há»™ chiáº¿u", en: "passport"}, {vi: "Äáº·t phÃ²ng", en: "reservation"}, {vi: "Thá»±c Ä‘Æ¡n", en: "menu"}, {vi: "Ngon", en: "delicious"}, {vi: "SÃ¢n bay", en: "airport"}, {vi: "KhÃ¡ch sáº¡n", en: "hotel"}, {vi: "Báº£n Ä‘á»“", en: "map"}, {vi: "Du khÃ¡ch", en: "tourist"}, {vi: "Chuyáº¿n bay", en: "flight"}, {vi: "Äáº·c sáº£n", en: "specialty"}, {vi: "Cay", en: "spicy"}, {vi: "Máº·n", en: "salty"}, {vi: "Ngá»t", en: "sweet"}, {vi: "Chua", en: "sour"}] },
            grammar: {
                "Present Simple": [{question: "She usually ___ (walk) to work.", verb: "walk", answer: "walks", explanation: "ThÃ³i quen á»Ÿ hiá»‡n táº¡i (She -> V+s)."}, {question: "The sun ___ (rise) in the East.", verb: "rise", answer: "rises", explanation: "Sá»± tháº­t hiá»ƒn nhiÃªn."}],
                "Present Continuous": [{question: "Look! It ___ (rain) outside.", verb: "rain", answer: "is raining", explanation: "Äang xáº£y ra lÃºc nÃ³i (Look!)."}, {question: "I ___ (study) now.", verb: "study", answer: "am studying", explanation: "Äang diá»…n ra (now)."}],
                "Present Perfect": [{question: "I ___ (see) that movie twice.", verb: "see", answer: "have seen", explanation: "Kinh nghiá»‡m trong quÃ¡ khá»©."}],
                "Present Perfect Continuous": [{question: "It ___ (rain) for 3 hours.", verb: "rain", answer: "has been raining", explanation: "Nháº¥n máº¡nh quÃ¡ trÃ¬nh liÃªn tá»¥c."}],
                "Past Simple": [{question: "I ___ (go) to the cinema yesterday.", verb: "go", answer: "went", explanation: "ÄÃ£ xáº£y ra vÃ  káº¿t thÃºc (yesterday)."}],
                "Past Continuous": [{question: "I ___ (read) when he came.", verb: "read", answer: "was reading", explanation: "Äang xáº£y ra thÃ¬ hÃ nh Ä‘á»™ng khÃ¡c xen vÃ o."}],
                "Past Perfect": [{question: "When I arrived, the train ___ (leave).", verb: "leave", answer: "had left", explanation: "Xáº£y ra trÆ°á»›c 1 hÃ nh Ä‘á»™ng QK khÃ¡c."}],
                "Past Perfect Continuous": [{question: "He was tired because he ___ (work) all day.", verb: "work", answer: "had been working", explanation: "NguyÃªn nhÃ¢n cá»§a tráº¡ng thÃ¡i QK."}],
                "Future Simple": [{question: "I think it ___ (rain) tomorrow.", verb: "rain", answer: "will rain", explanation: "Dá»± Ä‘oÃ¡n khÃ´ng cÄƒn cá»©."}],
                "Future Continuous": [{question: "At 9 AM tomorrow, I ___ (work).", verb: "work", answer: "will be working", explanation: "Thá»i Ä‘iá»ƒm cá»¥ thá»ƒ trong TL."}],
                "Future Perfect": [{question: "By next year, I ___ (graduate).", verb: "graduate", answer: "will have graduated", explanation: "HoÃ n thÃ nh trÆ°á»›c má»‘c TL (By)."}],
                "Future Perfect Continuous": [{question: "By 2030, I ___ (teach) for 20 years.", verb: "teach", answer: "will have been teaching", explanation: "QuÃ¡ trÃ¬nh tÃ­nh Ä‘áº¿n má»‘c TL."}]
            },
            forms: {
                "irregular": [{question: "go (V2)", answer: "went", explanation: "go - went - gone"}, {question: "buy (V2)", answer: "bought", explanation: "buy - bought - bought"}],
                "irregular_v3": [{question: "go (V3)", answer: "gone", explanation: "go - went - gone"}, {question: "write (V3)", answer: "written", explanation: "write - wrote - written"}],
                "noun_suffix": [{question: "inform (Noun -tion)", answer: "information", explanation: "ThÃªm -ation."}, {question: "develop (Noun -ment)", answer: "development", explanation: "ThÃªm -ment."}],
                "adj_suffix": [{question: "beauty (Adj -ful)", answer: "beautiful", explanation: "y -> i + ful."}, {question: "care (Adj -less)", answer: "careless", explanation: "ThÃªm -less."}],
                "prefixes": [{question: "happy (Prefix: not)", answer: "unhappy", explanation: "ThÃªm un-."}, {question: "agree (Prefix: not)", answer: "disagree", explanation: "ThÃªm dis-."}],
                "verb_noun": [{question: "decide (Noun)", answer: "decision", explanation: "de -> sion."}, {question: "arrive (Noun)", answer: "arrival", explanation: "e -> al."}],
                "noun_adj": [{question: "danger (Adj)", answer: "dangerous", explanation: "+ ous."}, {question: "fame (Adj)", answer: "famous", explanation: "e -> ous."}],
                "adj_adv": [{question: "quick (Adv)", answer: "quickly", explanation: "+ ly."}, {question: "happy (Adv)", "answer": "happily", explanation: "y -> i + ly."}],
                "ing": [{question: "run", answer: "running", explanation: "Gáº¥p Ä‘Ã´i phá»¥ Ã¢m."}, {question: "swim", answer: "swimming", explanation: "Gáº¥p Ä‘Ã´i phá»¥ Ã¢m."}],
                "ed": [{question: "stop", answer: "stopped", explanation: "Gáº¥p Ä‘Ã´i phá»¥ Ã¢m."}, {question: "plan", answer: "planned", explanation: "Gáº¥p Ä‘Ã´i phá»¥ Ã¢m."}],
                "classify": [{question: "She runs [fast]. (Type?)", answer: "adverb", explanation: "Bá»• nghÄ©a cho Ä‘á»™ng tá»« runs."}, {question: "It is a [fast] car. (Type?)", "answer": "adjective", explanation: "Bá»• nghÄ©a cho danh tá»« car."}]
            },
            theory: {
                "Present Simple": { title: "ThÃ¬ Hiá»‡n Táº¡i ÄÆ¡n (Present Simple)", content: `<h3 class="font-bold text-indigo-700 mb-2">1. CÃ´ng thá»©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono"><div class="mb-1"><span class="text-green-600 font-bold">(+)</span> S + V(s/es)</div><div class="mb-1"><span class="text-red-500 font-bold">(-)</span> S + do/does + not + V</div><div><span class="text-blue-500 font-bold">(?)</span> Do/Does + S + V?</div></div><h3 class="font-bold text-indigo-700 mb-2">2. CÃ¡ch dÃ¹ng</h3><ul class="list-disc list-inside space-y-1 mb-4 text-gray-700"><li>Diá»…n táº£ thÃ³i quen, hÃ nh Ä‘á»™ng láº·p Ä‘i láº·p láº¡i.</li><li>Diá»…n táº£ sá»± tháº­t hiá»ƒn nhiÃªn.</li><li>Lá»‹ch trÃ¬nh cá»‘ Ä‘á»‹nh.</li></ul><h3 class="font-bold text-indigo-700 mb-2">3. Dáº¥u hiá»‡u</h3><p class="text-gray-700 italic">Always, usually, often, every day...</p>` },
                "Present Continuous": { title: "ThÃ¬ Hiá»‡n Táº¡i Tiáº¿p Diá»…n", content: `<h3 class="font-bold text-indigo-700 mb-2">1. CÃ´ng thá»©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono"><div class="mb-1"><span class="text-green-600 font-bold">(+)</span> S + am/is/are + V-ing</div></div><h3 class="font-bold text-indigo-700 mb-2">2. CÃ¡ch dÃ¹ng</h3><ul class="list-disc list-inside space-y-1 mb-4 text-gray-700"><li>HÃ nh Ä‘á»™ng Ä‘ang xáº£y ra lÃºc nÃ³i.</li><li>HÃ nh Ä‘á»™ng Ä‘ang diá»…n ra xung quanh thá»i Ä‘iá»ƒm nÃ³i.</li></ul><h3 class="font-bold text-indigo-700 mb-2">3. Dáº¥u hiá»‡u</h3><p class="text-gray-700 italic">Now, at the moment, Look!...</p>` },
                "Present Perfect": { title: "ThÃ¬ Hiá»‡n Táº¡i HoÃ n ThÃ nh", content: `<h3 class="font-bold text-indigo-700 mb-2">1. CÃ´ng thá»©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono"><div class="mb-1"><span class="text-green-600 font-bold">(+)</span> S + have/has + V3/ed</div></div><h3 class="font-bold text-indigo-700 mb-2">2. CÃ¡ch dÃ¹ng</h3><ul class="list-disc list-inside space-y-1 mb-4 text-gray-700"><li>HÃ nh Ä‘á»™ng báº¯t Ä‘áº§u trong QK kÃ©o dÃ i Ä‘áº¿n HT.</li><li>Vá»«a má»›i xáº£y ra.</li><li>Kinh nghiá»‡m.</li></ul><h3 class="font-bold text-indigo-700 mb-2">3. Dáº¥u hiá»‡u</h3><p class="text-gray-700 italic">Just, recently, since, for, already, yet, so far, up to now, recently, this is the first time.</p>` },
                "Present Perfect Continuous": { title: "HT HoÃ n ThÃ nh Tiáº¿p Diá»…n", content: `<h3 class="font-bold text-indigo-700 mb-2">1. CÃ´ng thá»©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + have/has + been + V-ing</div><p class="text-gray-700">Nháº¥n máº¡nh tÃ­nh liÃªn tá»¥c cá»§a hÃ nh Ä‘á»™ng tá»« QK Ä‘áº¿n HT.</p>` },
                "Past Simple": { title: "ThÃ¬ QuÃ¡ Khá»© ÄÆ¡n", content: `<h3 class="font-bold text-indigo-700 mb-2">1. CÃ´ng thá»©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + V2/ed</div><p class="text-gray-700">HÃ nh Ä‘á»™ng Ä‘Ã£ káº¿t thÃºc trong quÃ¡ khá»©. <br>DH: Yesterday, last week, ago.</p>` },
                "Past Continuous": { title: "ThÃ¬ QuÃ¡ Khá»© Tiáº¿p Diá»…n", content: `<h3 class="font-bold text-indigo-700 mb-2">1. CÃ´ng thá»©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + was/were + V-ing</div><p class="text-gray-700">HÃ nh Ä‘á»™ng Ä‘ang xáº£y ra táº¡i 1 thá»i Ä‘iá»ƒm trong QK.</p>` },
                "Past Perfect": { title: "ThÃ¬ QuÃ¡ Khá»© HoÃ n ThÃ nh", content: `<h3 class="font-bold text-indigo-700 mb-2">1. CÃ´ng thá»©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + had + V3/ed</div><p class="text-gray-700">Xáº£y ra trÆ°á»›c má»™t hÃ nh Ä‘á»™ng khÃ¡c trong QK.</p>` },
                "Past Perfect Continuous": { title: "QK HoÃ n ThÃ nh Tiáº¿p Diá»…n", content: `<h3 class="font-bold text-indigo-700 mb-2">1. CÃ´ng thá»©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + had + been + V-ing</div><p class="text-gray-700">Nháº¥n máº¡nh quÃ¡ trÃ¬nh xáº£y ra trÆ°á»›c 1 hÃ nh Ä‘á»™ng khÃ¡c trong QK.</p>` },
                "Future Simple": { title: "ThÃ¬ TÆ°Æ¡ng Lai ÄÆ¡n", content: `<h3 class="font-bold text-indigo-700 mb-2">1. CÃ´ng thá»©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + will + V</div><p class="text-gray-700">Dá»± Ä‘oÃ¡n, quyáº¿t Ä‘á»‹nh tá»©c thá»i. <br>DH: Tomorrow, next week.</p>` },
                "Future Continuous": { title: "ThÃ¬ TÆ°Æ¡ng Lai Tiáº¿p Diá»…n", content: `<h3 class="font-bold text-indigo-700 mb-2">1. CÃ´ng thá»©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + will + be + V-ing</div><p class="text-gray-700">Sáº½ Ä‘ang xáº£y ra táº¡i 1 thá»i Ä‘iá»ƒm trong TL.</p>` },
                "Future Perfect": { title: "ThÃ¬ TÆ°Æ¡ng Lai HoÃ n ThÃ nh", content: `<h3 class="font-bold text-indigo-700 mb-2">1. CÃ´ng thá»©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + will + have + V3/ed</div><p class="text-gray-700">Sáº½ hoÃ n thÃ nh trÆ°á»›c 1 thá»i Ä‘iá»ƒm trong TL.</p>` },
                "Future Perfect Continuous": { title: "TL HoÃ n ThÃ nh Tiáº¿p Diá»…n", content: `<h3 class="font-bold text-indigo-700 mb-2">1. CÃ´ng thá»©c</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm font-mono">S + will + have + been + V-ing</div><p class="text-gray-700">Nháº¥n máº¡nh quÃ¡ trÃ¬nh tÃ­nh Ä‘áº¿n 1 thá»i Ä‘iá»ƒm trong TL.</p>` },
                "irregular": { title: "Äá»™ng tá»« Báº¥t Quy Táº¯c (V2)", content: `<p class="mb-2 text-gray-600">ÄÃ¢y lÃ  cÃ¡c Ä‘á»™ng tá»« khÃ´ng tuÃ¢n theo quy táº¯c thÃªm -ed khi chuyá»ƒn sang quÃ¡ khá»© Ä‘Æ¡n.</p><table class="w-full text-sm text-left border rounded-lg overflow-hidden"><thead><tr class="bg-gray-100"><th class="p-2 border">V1 (Hiá»‡n táº¡i)</th><th class="p-2 border">V2 (QuÃ¡ khá»©)</th></tr></thead><tbody><tr><td class="p-2 border">Go</td><td class="p-2 border">Went</td></tr><tr><td class="p-2 border">Buy</td><td class="p-2 border">Bought</td></tr><tr><td class="p-2 border">See</td><td class="p-2 border">Saw</td></tr><tr><td class="p-2 border">Do</td><td class="p-2 border">Did</td></tr><tr><td class="p-2 border">Have</td><td class="p-2 border">Had</td></tr></tbody></table>` },
                "irregular_v3": { title: "QuÃ¡ khá»© phÃ¢n tá»« (V3)", content: `<p class="mb-2 text-gray-600">DÃ¹ng trong cÃ¡c thÃ¬ HoÃ n thÃ nh (Perfect tenses) vÃ  CÃ¢u bá»‹ Ä‘á»™ng.</p><table class="w-full text-sm text-left border rounded-lg overflow-hidden"><thead><tr class="bg-gray-100"><th class="p-2 border">V1</th><th class="p-2 border">V2</th><th class="p-2 border text-red-600 font-bold">V3</th></tr></thead><tbody><tr><td class="p-2 border">Go</td><td class="p-2 border">Went</td><td class="p-2 border text-red-600">Gone</td></tr><tr><td class="p-2 border">Eat</td><td class="p-2 border">Ate</td><td class="p-2 border text-red-600">Eaten</td></tr><tr><td class="p-2 border">Write</td><td class="p-2 border">Wrote</td><td class="p-2 border text-red-600">Written</td></tr><tr><td class="p-2 border">Take</td><td class="p-2 border">Took</td><td class="p-2 border text-red-600">Taken</td></tr></tbody></table>` },
                "noun_suffix": { title: "Háº­u tá»‘ Danh tá»«", content: `<h3 class="font-bold text-indigo-700 mb-2">1. Chá»‰ ngÆ°á»i</h3><ul class="list-disc ml-5 mb-2 text-sm"><li><b>-er/or:</b> teacher, actor, worker</li><li><b>-ist:</b> artist, scientist</li><li><b>-ee:</b> employee, trainee</li></ul><h3 class="font-bold text-indigo-700 mb-2">2. Chá»‰ váº­t/trá»«u tÆ°á»£ng</h3><ul class="list-disc ml-5 text-sm"><li><b>-tion/sion:</b> information, decision</li><li><b>-ment:</b> development, government</li><li><b>-ness:</b> happiness, sadness</li><li><b>-ity:</b> ability, activity</li></ul>` },
                "adj_suffix": { title: "Háº­u tá»‘ TÃ­nh tá»«", content: `<ul class="list-disc ml-5 text-sm space-y-1"><li><b>-ful (Ä‘áº§y):</b> helpful, beautiful</li><li><b>-less (khÃ´ng):</b> careless, homeless</li><li><b>-able/ible (cÃ³ thá»ƒ):</b> comfortable, visible</li><li><b>-ive:</b> active, creative</li><li><b>-ous:</b> dangerous, famous</li><li><b>-y:</b> sunny, rainy, windy</li><li><b>-al:</b> national, traditional</li></ul>` },
                "prefixes": { title: "Tiá»n tá»‘ phá»• biáº¿n", content: `<p class="mb-2 text-gray-600">ThÃªm vÃ o trÆ°á»›c tá»« gá»‘c Ä‘á»ƒ Ä‘á»•i nghÄ©a (thÆ°á»ng lÃ  nghÄ©a phá»§ Ä‘á»‹nh).</p><ul class="list-disc ml-5 text-sm space-y-1"><li><b>un-:</b> unhappy, unsafe</li><li><b>-im (trÆ°á»›c p, m):</b> impossible, impolite</li><li><b>in-:</b> incorrect, informal</li><li><b>dis-:</b> disagree, dislike</li><li><b>re- (lÃ m láº¡i):</b> rewrite, replay</li><li><b>pre- (trÆ°á»›c):</b> preview, pretest</li></ul>` },
                "verb_noun": { title: "Chuyá»ƒn Äá»™ng tá»« thÃ nh Danh tá»«", content: `<div class="bg-green-50 p-3 rounded mb-2 border border-green-200"><span class="font-bold">Quy táº¯c chung:</span> ThÃªm háº­u tá»‘ danh tá»« vÃ o Ä‘á»™ng tá»«.</div><ul class="text-sm space-y-2"><li><b>Decide</b> (v) -> <b>Decision</b> (n)</li><li><b>Solve</b> (v) -> <b>Solution</b> (n)</li><li><b>Arrive</b> (v) -> <b>Arrival</b> (n)</li><li><b>Perform</b> (v) -> <b>Performance</b> (n)</li></ul>` },
                "noun_adj": { title: "Chuyá»ƒn Danh tá»« thÃ nh TÃ­nh tá»«", content: `<div class="bg-blue-50 p-3 rounded mb-2 border border-blue-200"><span class="font-bold">Quy táº¯c:</span> ThÃªm háº­u tá»‘ tÃ­nh tá»«.</div><ul class="text-sm space-y-2"><li><b>Danger</b> (n) -> <b>Dangerous</b> (adj)</li><li><b>Care</b> (n) -> <b>Careful/Careless</b> (adj)</li><li><b>Nature</b> (n) -> <b>Natural</b> (adj)</li><li><b>Sun</b> (n) -> <b>Sunny</b> (adj)</li></ul>` },
                "adj_adv": { title: "TÃ­nh tá»« & Tráº¡ng tá»«", content: `<div class="bg-yellow-50 p-3 rounded mb-2 border border-yellow-200"><span class="font-bold">CÃ´ng thá»©c:</span> Adj + ly = Adv</div><ul class="text-sm space-y-1 mb-2"><li>Quick -> Quickly</li><li>Bad -> Badly</li><li>Happy -> Happily (y -> i + ly)</li></ul><p class="font-bold text-red-500 text-sm">Ngoáº¡i lá»‡:</p><ul class="text-sm"><li>Good -> Well</li><li>Fast -> Fast (giá»¯ nguyÃªn)</li><li>Hard -> Hard</li></ul>` },
                "ing": { title: "Quy táº¯c thÃªm Ä‘uÃ´i -ING", content: `<ol class="list-decimal ml-5 text-sm space-y-2"><li><b>ThÃ´ng thÆ°á»ng:</b> ThÃªm -ing (walk -> walking)</li><li><b>Táº­n cÃ¹ng lÃ  e:</b> Bá» e thÃªm ing (write -> writing)</li><li><b>Táº­n cÃ¹ng lÃ  ie:</b> Äá»•i ie thÃ nh y (lie -> lying)</li><li><b>1 Ã¢m tiáº¿t, táº­n cÃ¹ng 1 phá»¥ Ã¢m, trÆ°á»›c lÃ  1 nguyÃªn Ã¢m:</b> Gáº¥p Ä‘Ã´i phá»¥ Ã¢m (run -> running, sit -> sitting)</li><li><b>1 Ã¢m tiáº¿t, táº­n cÃ¹ng 1 phá»¥ Ã¢m, trÆ°á»›c lÃ  1 nguyÃªn Ã¢m:</b> Gáº¥p Ä‘Ã´i phá»¥ Ã¢m (run -> running, sit -> sitting)</li></ol>` },
                "ed": { title: "Quy táº¯c thÃªm Ä‘uÃ´i -ED", content: `<ol class="list-decimal ml-5 text-sm space-y-2"><li><b>ThÃ´ng thÆ°á»ng:</b> ThÃªm -ed (watch -> watched)</li><li><b>Táº­n cÃ¹ng lÃ  e:</b> ThÃªm d (live -> lived)</li><li><b>Táº­n cÃ¹ng lÃ  y (trÆ°á»›c lÃ  phá»¥ Ã¢m):</b> Äá»•i y thÃ nh i + ed (study -> studied)</li><li><b>Gáº¥p Ä‘Ã´i phá»¥ Ã¢m cuá»‘i:</b> stop -> stopped, plan -> planned</li></ol>` },
                "classify": { title: "PhÃ¢n loáº¡i tá»«", content: `<div class="space-y-3 text-sm"><div><span class="font-bold text-blue-600">Noun (Danh tá»«):</span> Chá»‰ ngÆ°á»i, váº­t, nÆ¡i chá»‘n.<br>Vá»‹ trÃ­: Äáº§u cÃ¢u (Chá»§ ngá»¯), sau Ä‘á»™ng tá»« (TÃ¢n ngá»¯).</div><div><span class="font-bold text-red-600">Verb (Äá»™ng tá»«):</span> Chá»‰ hÃ nh Ä‘á»™ng, tráº¡ng thÃ¡i.<br>Vá»‹ trÃ­: Sau chá»§ ngá»¯.</div><div><span class="font-bold text-green-600">Adjective (TÃ­nh tá»«):</span> Chá»‰ tÃ­nh cháº¥t.<br>Vá»‹ trÃ­: TrÆ°á»›c danh tá»«, sau tobe.</div><div><span class="font-bold text-purple-600">Adverb (Tráº¡ng tá»«):</span> Bá»• nghÄ©a cho Ä‘á»™ng tá»«/tÃ­nh tá»«.<br>Vá»‹ trÃ­: Sau Ä‘á»™ng tá»« thÆ°á»ng, cuá»‘i cÃ¢u.</div></div>` }
            }
        };

        const formReadableNames = { "irregular": "Äá»™ng tá»« Báº¥t quy táº¯c", "irregular_v3": "QuÃ¡ khá»© phÃ¢n tá»«", "noun_suffix": "Háº­u tá»‘ Danh tá»«", "adj_suffix": "Háº­u tá»‘ TÃ­nh tá»«", "prefixes": "Tiá»n tá»‘", "verb_noun": "Äá»™ng tá»« â†’ Danh tá»«", "noun_adj": "Danh tá»« â†’ TÃ­nh tá»«", "adj_adv": "TÃ­nh tá»« â†’ Tráº¡ng tá»«", "ing": "ÄuÃ´i -ING", "ed": "ÄuÃ´i -ED", "classify": "PhÃ¢n loáº¡i tá»«" };
        let gameState = { mode: 'vocab', data: [], currentIdx: 0, score: 0, history: [], currentCorrect: "" };
        let theoryTab = 'grammar';

        const els = {
            app: document.getElementById('app'),
            screens: { start: document.getElementById('startScreen'), game: document.getElementById('gameScreen'), result: document.getElementById('resultScreen'), settings: document.getElementById('settingsScreen') },
            tabs: { vocab: document.getElementById('tabVocab'), grammar: document.getElementById('tabGrammar'), forms: document.getElementById('tabForms') },
            views: { vocab: document.getElementById('viewVocab'), grammar: document.getElementById('viewGrammar'), forms: document.getElementById('viewForms') },
            inputs: { vocabTopic: document.getElementById('vocabTopicInput'), vocabSelect: document.getElementById('vocabTopicSelect'), grammarTense: document.getElementById('grammarTenseSelect'), formsType: document.getElementById('formsTypeSelect'), answer: document.getElementById('answerInput'), apiKey: document.getElementById('userApiKeyInput'), dict: document.getElementById('dictInput') },
            game: { title: document.getElementById('gameTitle'), qNum: document.getElementById('currentQ'), totalQ: document.getElementById('totalQ'), progress: document.getElementById('progressBar'), display: document.getElementById('mainDisplay'), subDisplay: document.getElementById('subDisplay'), instruction: document.getElementById('instructionText'), inputArea: document.getElementById('inputContainerWrapper') },
            feedback: { overlay: document.getElementById('feedbackOverlay'), title: document.getElementById('feedbackTitle'), correctText: document.getElementById('correctAnswerText'), explanation: document.getElementById('grammarExplanation'), border: document.getElementById('feedbackBorder') },
            settings: { panel: document.getElementById('settingsPanel'), content: document.getElementById('settingsContent'), backdrop: document.getElementById('settingsBackdrop'), keyStatus: document.getElementById('keyStatus') },
            dict: { modal: document.getElementById('dictModal'), content: document.getElementById('dictContent'), backdrop: document.getElementById('dictBackdrop'), result: document.getElementById('dictResultArea'), input: document.getElementById('dictInput') },
            theory: { modal: document.getElementById('theoryModal'), content: document.getElementById('theoryContentPanel'), backdrop: document.getElementById('theoryBackdrop'), listGrammar: document.getElementById('theoryListGrammar'), listForms: document.getElementById('theoryListForms'), detail: document.getElementById('theoryDetail'), contentText: document.getElementById('theoryDetailContent'), tabs: { grammar: document.getElementById('btnTheoryGrammar'), forms: document.getElementById('btnTheoryForms') } },
            wrappers: { onlineVocab: document.getElementById('onlineVocabInput'), offlineVocab: document.getElementById('offlineVocabSelect') },
            config: { level: document.getElementById('levelSelect'), qtyInput: document.getElementById('quantityRange'), qtyDisplay: document.getElementById('qtyDisplay'), section: document.getElementById('configSection'), startBtn: document.getElementById('startBtn') },
            loading: { overlay: document.getElementById('loadingOverlay'), text: document.getElementById('loadingText') }
        };

        try {
            if (els.inputs.grammarTense) els.inputs.grammarTense.innerHTML = Object.keys(offlineData.grammar).map(t => `<option value="${t}">${t}</option>`).join('');
            if (els.inputs.vocabSelect) els.inputs.vocabSelect.innerHTML = Object.keys(offlineData.vocab).map(t => `<option value="${t}">${t}</option>`).join('');
            if (els.inputs.formsType) els.inputs.formsType.innerHTML = Object.keys(offlineData.forms).map(t => `<option value="${t}">${formReadableNames[t] || t}</option>`).join('');
        } catch (e) { console.error("Init Error:", e); }

        const getApiKey = () => localStorage.getItem('vocab_ai_key');

        const toggleModal = (modal, content, backdrop, show) => {
            if (show) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    backdrop.classList.remove('opacity-0');
                    content.classList.remove('translate-y-full');
                }, 10);
            } else {
                backdrop.classList.add('opacity-0');
                content.classList.add('translate-y-full');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        };

        const checkKeyStatus = () => {
            const key = getApiKey();
            if(key) {
                els.settings.keyStatus.textContent = "âœ… ÄÃ£ káº¿t ná»‘i AI"; els.settings.keyStatus.className = "text-xs mt-3 text-center font-bold text-green-600"; els.inputs.apiKey.value = key;
                if(els.wrappers.onlineVocab) els.wrappers.onlineVocab.classList.remove('hidden');
                if(els.wrappers.offlineVocab) els.wrappers.offlineVocab.classList.add('hidden');
            } else {
                els.settings.keyStatus.textContent = "âš ï¸ Cháº¿ Ä‘á»™ Offline"; els.settings.keyStatus.className = "text-xs mt-3 text-center font-medium text-gray-400";
                if(els.wrappers.onlineVocab) els.wrappers.onlineVocab.classList.add('hidden');
                if(els.wrappers.offlineVocab) els.wrappers.offlineVocab.classList.remove('hidden');
            }
        };

        const saveApiKey = () => { const key = els.inputs.apiKey.value.trim(); if(key) { localStorage.setItem('vocab_ai_key', key); checkKeyStatus(); alert("ÄÃ£ lÆ°u Key!"); backFromSettings(); } };

        const openSettingsScreen = () => { switchScreen('settings'); checkKeyStatus(); };
        const backFromSettings = () => { switchScreen('start'); };

        const openDictModal = () => { toggleModal(els.dict.modal, els.dict.content, els.dict.backdrop, true); setTimeout(() => els.dict.input.focus(), 300); };
        const closeDictModal = () => toggleModal(els.dict.modal, els.dict.content, els.dict.backdrop, false);
        const openTheoryModal = () => { toggleModal(els.theory.modal, els.theory.content, els.theory.backdrop, true); switchTheoryTab('grammar'); };
        const closeTheoryModal = () => toggleModal(els.theory.modal, els.theory.content, els.theory.backdrop, false);

        function isVietnamese(str) { return /[Ã Ã¡áº¡áº£Ã£Ã¢áº§áº¥áº­áº©áº«Äƒáº±áº¯áº·áº³áºµÃ¨Ã©áº¹áº»áº½Ãªá»áº¿á»‡á»ƒá»…Ã¬Ã­á»‹á»‰Ä©Ã²Ã³á»á»ÃµÃ´á»“á»‘á»™á»•á»—Æ¡á»á»›á»£á»Ÿá»¡Ã¹Ãºá»¥á»§Å©Æ°á»«á»©á»±á»­á»¯á»³Ã½á»µá»·á»¹Ä‘]/i.test(str); }
        const lookupDictionary = async () => {
            const word = els.dict.input.value.trim(); if(!word) return;
            els.dict.result.innerHTML = '<div class="flex flex-col items-center justify-center h-48"><div class="loader mb-2"></div><p class="text-xs text-gray-500 font-bold">Äang tra cá»©u...</p></div>';
            try {
                if (isVietnamese(word)) {
                     const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=vi|en`;
                     const res = await fetch(url); const data = await res.json();
                     if(data.responseStatus === 200) els.dict.result.innerHTML = `<div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100"><h2 class="text-2xl font-black text-gray-800 mb-1">${word}</h2><p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">VIETNAMESE</p><div class="border-t border-gray-100 pt-4"><p class="font-bold text-indigo-600 text-xl">${data.responseData.translatedText}</p><p class="text-xs text-gray-400 mt-1">English Translation</p></div></div>`;
                     else els.dict.result.innerHTML = `<div class="p-4 text-center text-red-400 font-bold">KhÃ´ng tÃ¬m tháº¥y báº£n dá»‹ch.</div>`;
                } else {
                    let freeApiData = null; let translation = null;
                    try { const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`); if(res.ok) { const data = await res.json(); freeApiData = data[0]; } } catch(e) {}
                    try { const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=en|vi`; const res = await fetch(url); const data = await res.json(); if(data.responseStatus === 200) translation = data.responseData.translatedText; } catch(e) {}
                    if (!freeApiData && !translation) { els.dict.result.innerHTML = `<div class="text-center p-4 text-gray-400 font-medium">KhÃ´ng tÃ¬m tháº¥y tá»« nÃ y.</div>`; return; }
                    let html = `<div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100"><div class="flex items-center justify-between mb-2"><h2 class="text-3xl font-black text-gray-800 capitalize">${freeApiData ? freeApiData.word : word}</h2>`;
                    if (freeApiData) { const audioSrc = freeApiData.phonetics.find(p => p.audio)?.audio; if(audioSrc) html += `<button onclick="new Audio('${audioSrc}').play()" class="w-10 h-10 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center hover:bg-orange-200 transition-colors"><i class="fas fa-volume-up"></i></button>`; }
                    html += `</div>`;
                    if(freeApiData) { const phonetic = freeApiData.phonetic || (freeApiData.phonetics.find(p => p.text)?.text) || ""; html += `<p class="text-orange-500 font-mono text-sm mb-6 font-bold">${phonetic}</p>`; }
                    if(translation) html += `<div class="mb-6 bg-green-50 p-4 rounded-2xl border border-green-100"><p class="text-[10px] text-green-800 font-black uppercase tracking-widest mb-1">NGHÄ¨A TIáº¾NG VIá»†T</p><p class="text-xl font-bold text-gray-800">${translation}</p></div>`;
                    if (freeApiData) html += `<div class="mb-2"><h3 class="font-bold text-gray-700 text-sm uppercase tracking-wider border-b border-gray-100 pb-2 mb-3">Äá»‹nh nghÄ©a (Anh-Anh)</h3><ul class="list-disc pl-5 text-sm text-gray-600 space-y-2 leading-relaxed">${freeApiData.meanings[0].definitions.slice(0, 3).map(d => `<li>${d.definition}</li>`).join('')}</ul></div>`;
                    html += `</div>`; els.dict.result.innerHTML = html;
                }
            } catch (e) { els.dict.result.innerHTML = `<div class="text-center p-4 text-red-500 font-bold">Lá»—i káº¿t ná»‘i.</div>`; }
        };

        const switchTheoryTab = (tab) => {
            theoryTab = tab;
            els.theory.tabs.grammar.className = tab==='grammar' ? 'flex-1 py-2.5 rounded-xl text-xs font-bold bg-indigo-100 text-indigo-700 transition-colors' : 'flex-1 py-2.5 rounded-xl text-xs font-bold text-gray-500 hover:bg-gray-50 transition-colors';
            els.theory.tabs.forms.className = tab==='forms' ? 'flex-1 py-2.5 rounded-xl text-xs font-bold bg-green-100 text-green-700 transition-colors' : 'flex-1 py-2.5 rounded-xl text-xs font-bold text-gray-500 hover:bg-gray-50 transition-colors';
            els.theory.listGrammar.classList.toggle('hidden', tab !== 'grammar');
            els.theory.listForms.classList.toggle('hidden', tab !== 'forms');
            els.theory.detail.classList.add('hidden');
            const dataSrc = tab === 'grammar' ? offlineData.grammar : offlineData.forms;
            const container = tab === 'grammar' ? els.theory.listGrammar : els.theory.listForms;
            container.innerHTML = Object.keys(dataSrc).map(t =>
                `<div onclick="loadTheory('${t}', '${tab}')" class="p-4 bg-white rounded-2xl shadow-sm border border-gray-100 cursor-pointer hover:bg-gray-50 active:scale-[0.98] transition-all flex justify-between items-center group">
                    <span class="font-bold text-gray-700 group-hover:text-indigo-600 transition-colors">${tab === 'forms' ? (formReadableNames[t] || t) : t}</span>
                    <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                </div>`
            ).join('');
        };
        const backToTheoryList = () => { els.theory.detail.classList.add('hidden'); if(theoryTab === 'grammar') els.theory.listGrammar.classList.remove('hidden'); else els.theory.listForms.classList.remove('hidden'); };

        const loadTheory = async (topic, type) => {
            els.theory.listGrammar.classList.add('hidden'); els.theory.listForms.classList.add('hidden'); els.theory.detail.classList.remove('hidden');
            els.theory.contentText.innerHTML = '<div class="flex flex-col items-center justify-center h-48"><div class="loader mb-2"></div><p class="text-xs text-gray-500 font-bold">Äang táº£i kiáº¿n thá»©c...</p></div>';
            const key = getApiKey(); const friendlyName = formReadableNames[topic] || topic;
            setTimeout(async () => {
                if (key) {
                    try {
                        let prompt = type === 'forms' ? `Tá»•ng há»£p kiáº¿n thá»©c tiáº¿ng Anh vá» chá»§ Ä‘á»: "${friendlyName}" (Pháº§n: Word Forms/Morphology). TrÃ¬nh bÃ y rÃµ rÃ ng báº±ng HTML vá»›i Tailwind CSS. (Tiáº¿ng Viá»‡t)` : `Giáº£i thÃ­ch ngá»¯ phÃ¡p tiáº¿ng Anh chá»§ Ä‘á»: "${topic}". TrÃ¬nh bÃ y sáº¡ch Ä‘áº¹p báº±ng HTML. DÃ¹ng Tailwind CSS. (Tiáº¿ng Viá»‡t)`;
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                        const data = await res.json();
                        els.theory.contentText.innerHTML = data.candidates[0].content.parts[0].text.replace(/```html|```/g, '');
                        return;
                    } catch(e) {}
                }
                const offlineContent = offlineData.theory[topic];
                els.theory.contentText.innerHTML = offlineContent ? `<h2 class="text-2xl font-black text-indigo-900 mb-6 border-b pb-4">${offlineContent.title}</h2>${offlineContent.content}` : `<div class="text-center p-8"><h2 class="text-xl font-bold text-gray-400 mb-2">${friendlyName}</h2><p class="text-gray-400 text-sm">Ná»™i dung offline chÆ°a cáº­p nháº­t. Vui lÃ²ng nháº­p API Key Ä‘á»ƒ táº£i tá»« AI.</p></div>`;
            }, 300);
        };

        const showLoading = (b) => els.loading.overlay.classList.toggle('hidden', !b);
        const updateLevel = (val, el) => { document.getElementById('levelSelect').value = val; document.querySelectorAll('.level-card').forEach(c => { c.classList.remove('selected', 'bg-yellow-50', 'border-yellow-400'); c.classList.add('bg-gray-50', 'border-transparent'); }); el.classList.add('selected'); };

        const setMode = (m) => {
            ['vocab', 'grammar', 'forms'].forEach(x => {
                els.tabs[x].className = `tab-btn flex-1 py-2.5 rounded-xl text-xs sm:text-sm font-bold transition ${x===m ? 'tab-active' : 'tab-inactive'}`;
                els.views[x].classList.toggle('hidden', x !== m);
            });
            els.config.section.classList.remove('hidden');
        };

        const switchScreen = (s) => {
            // Hide all
            Object.values(els.screens).forEach(e => e.classList.add('hidden'));
            // Show specific
            els.screens[s].classList.remove('hidden');
            // Show/Hide input area
            if (s === 'game') els.game.inputArea.classList.remove('hidden');
            else els.game.inputArea.classList.add('hidden');
            updateLayout();
        };
        const resetGame = () => {
            switchScreen('start');
        };

        const updateUI = () => {
            const item = gameState.data[gameState.currentIdx];
            els.game.qNum.textContent = gameState.currentIdx + 1;
            els.game.progress.style.width = `${((gameState.currentIdx + 1) / gameState.data.length) * 100}%`;
            els.inputs.answer.value = "";
            els.inputs.answer.focus(); // Auto focus

            if(gameState.mode === 'vocab') {
                els.game.display.textContent = item.vi; els.game.instruction.textContent = "TRANSLATE TO ENGLISH"; els.game.subDisplay.classList.add('hidden'); gameState.currentCorrect = item.en;
            } else if (gameState.mode === 'grammar') {
                els.game.display.textContent = item.question; els.game.instruction.textContent = "VERB CONJUGATION"; els.game.subDisplay.textContent = item.verb ? `Verb: (${item.verb})` : ""; els.game.subDisplay.classList.remove('hidden'); gameState.currentCorrect = item.answer;
            } else if (gameState.mode === 'forms') {
                els.game.display.textContent = item.question; els.game.instruction.textContent = "WORD FORM"; els.game.subDisplay.classList.add('hidden'); gameState.currentCorrect = item.answer;
            }
        };

        const checkAnswer = () => {
            const user = els.inputs.answer.value.trim().toLowerCase(); if(!user) return;
            if (gameState.currentIdx >= gameState.data.length) return;
            const item = gameState.data[gameState.currentIdx]; const correct = gameState.currentCorrect.toLowerCase(); const isCorrect = user === correct;
            gameState.history.push({ q: els.game.display.textContent, a: gameState.currentCorrect, u: els.inputs.answer.value, ok: isCorrect });
            if(isCorrect) gameState.score++;

            els.feedback.title.textContent = isCorrect ? "Tuyá»‡t vá»i!" : "Sai rá»“i!";
            els.feedback.title.className = isCorrect ? "text-4xl font-black mb-6 tracking-tight text-green-600" : "text-4xl font-black mb-6 tracking-tight text-red-500";
            els.feedback.border.className = isCorrect ? "absolute top-0 left-0 w-2 h-full bg-green-500 transition-all group-hover:w-3" : "absolute top-0 left-0 w-2 h-full bg-red-500 transition-all group-hover:w-3";
            document.getElementById('feedbackIcon').textContent = isCorrect ? "ğŸ‰" : "ğŸ˜…";
            els.feedback.correctText.textContent = gameState.currentCorrect;
            els.feedback.explanation.textContent = item.explanation ? "ğŸ’¡ " + item.explanation : "";
            els.feedback.explanation.classList.toggle('hidden', !item.explanation);
            els.feedback.overlay.classList.remove('hidden');
            document.activeElement?.blur();
        };

        const finishGame = () => {
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('totalScoreQ').textContent = gameState.data.length;
            document.getElementById('resultList').innerHTML = gameState.history.map(h =>
                `<div class="p-4 border-b border-gray-100 flex gap-4 items-center last:border-0">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${h.ok ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-500'} font-bold text-lg">${h.ok?'<i class="fas fa-check"></i>':'<i class="fas fa-times"></i>'}</div>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs font-bold text-gray-400 mb-1 truncate">${h.q}</div>
                        <div class="font-black text-gray-800 text-base">${h.a}</div>
                        ${!h.ok ? `<div class="text-sm font-medium text-red-400 line-through mt-0.5">${h.u}</div>` : ''}
                    </div>
                </div>`
            ).join('');
            switchScreen('result');
        };

        const nextQuestion = () => { els.feedback.overlay.classList.add('hidden'); gameState.currentIdx++; if(gameState.currentIdx >= gameState.data.length) finishGame(); else updateUI(); };
        const startGame = () => {
            gameState.currentIdx = 0; gameState.score = 0; gameState.history = []; els.game.totalQ.textContent = gameState.data.length; switchScreen('game'); updateUI();
        };

        const generateContent = async (type) => {
            const key = getApiKey(); const qty = parseInt(els.config.qtyInput.value); const level = els.config.level.value;
            showLoading(true); gameState.mode = type;

            try {
                // 1. ONLINE MODE
                if(key) {
                    let prompt = "", context = "";
                    if (type === 'vocab') { context = els.inputs.vocabTopic.value || "General"; prompt = `Generate ${qty} vocabulary pairs for topic '${context}' at level ${level}. JSON Format: [{"vi":"...", "en":"..."}].`; }
                    else if (type === 'grammar') { context = els.inputs.grammarTense.value; prompt = `Generate ${qty} grammar questions for tense '${context}'. JSON Format: [{"question":"...", "verb":"...", "answer":"...", "explanation":"..."}].`; }
                    else if (type === 'forms') { context = els.inputs.formsType.value; prompt = `Generate ${qty} word-form questions for type '${context}'. JSON Format: [{"question":"...", "answer":"...", "explanation":"..."}].`; }

                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt + " JSON ONLY." }] }] }) });
                    const data = await res.json();
                    gameState.data = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim());
                    if (type === 'forms') context = formReadableNames[context] || context;
                    els.game.title.textContent = `${type.toUpperCase()}: ${context}`;
                    startGame(); showLoading(false); return;
                }

                // 2. OFFLINE FALLBACK
                let source = []; let displayTitle = "";
                if(type === 'vocab') { displayTitle = els.inputs.vocabSelect.value; source = offlineData.vocab[displayTitle] || []; }
                if(type === 'grammar') { displayTitle = els.inputs.grammarTense.value; source = offlineData.grammar[displayTitle] || []; }
                if(type === 'forms') { const rawType = els.inputs.formsType.value; displayTitle = formReadableNames[rawType] || rawType; source = offlineData.forms[rawType] || []; }

                if(!source.length) { alert("Dá»¯ liá»‡u offline khÃ´ng cÃ³ sáºµn."); showLoading(false); return; }
                let finalData = []; while(finalData.length < qty) { finalData = finalData.concat([...source].sort(()=>0.5-Math.random())); }
                gameState.data = finalData.slice(0, qty); els.game.title.textContent = displayTitle; startGame(); showLoading(false);
            } catch (e) {
                console.error(e);
                alert("Lá»—i khi táº¡o dá»¯ liá»‡u: " + e.message);
                showLoading(false);
            }
        };

        const startGeneration = () => {
            let mode = 'vocab';
            if (!els.views.vocab.classList.contains('hidden')) mode = 'vocab'; else if (!els.views.grammar.classList.contains('hidden')) mode = 'grammar'; else if (!els.views.forms.classList.contains('hidden')) mode = 'forms';
            generateContent(mode);
        };

        const playTTS = () => {
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(gameState.currentCorrect);
                u.lang = 'en-US';
                speechSynthesis.speak(u);
            }
        };

        // EXPOSE TO WINDOW FOR HTML EVENT HANDLERS
        Object.assign(window, { saveApiKey, openDictModal, closeDictModal, lookupDictionary, switchTheoryTab, openTheoryModal, closeTheoryModal, backToTheoryList, loadTheory, showLoading, openSettingsScreen, backFromSettings, updateLevel, setMode, switchScreen, resetGame, checkAnswer, nextQuestion, startGeneration, playTTS });

        checkKeyStatus();
        els.dict.input.addEventListener('keypress', (e) => { if(e.key === 'Enter') lookupDictionary(); });
        els.inputs.answer.addEventListener('keypress', (e) => { if(e.key === 'Enter') checkAnswer(); });
        els.config.qtyInput.addEventListener('input', (e) => { els.config.qtyDisplay.textContent = `${e.target.value} cÃ¢u`; });

        resetGame();
        setMode('vocab');
    </script>
</body>
</html>
